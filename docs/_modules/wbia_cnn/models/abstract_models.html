
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>wbia_cnn.models.abstract_models &#8212; wbia-cnn 3.3.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for wbia_cnn.models.abstract_models</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Directory structure of training</span>

<span class="sd">The network directory is the root of the structure and is typically in</span>
<span class="sd">_ibeis_cache/nets for ibeis databases. Otherwise it it custom defined (like in</span>
<span class="sd">.cache/wbia_cnn/training for mnist tests)</span>

<span class="sd"># era=(group of epochs)</span>

<span class="sd">----------------</span>
<span class="sd">|-- netdir &lt;training_dpath&gt;</span>
<span class="sd">----------------</span>

<span class="sd">Datasets contain ingested data packed into a single file for quick loading.</span>
<span class="sd">Data can be presplit into testing /  learning / validation sets.  Metadata is</span>
<span class="sd">always a dictionary where keys specify columns and each item corresponds a row</span>
<span class="sd">of data. Non-corresponding metadata is currently not supported, but should</span>
<span class="sd">probably be located in a manifest.json file.</span>

<span class="sd"># TODO: what is the same data has tasks that use different labels?</span>
<span class="sd"># need to incorporate that structure.</span>

<span class="sd">The model directory must keep track of several things:</span>
<span class="sd">    * The network architecture (which may depend on the dataset being used)</span>
<span class="sd">        - input / output shape</span>
<span class="sd">        - network layers</span>
<span class="sd">    * The state of learning</span>
<span class="sd">        - epoch/era number</span>
<span class="sd">        - learning rate</span>
<span class="sd">        - regularization rate</span>
<span class="sd">    * diagnostic information</span>
<span class="sd">        - graphs of loss / error rates</span>
<span class="sd">        - images of convolutional weights</span>
<span class="sd">        - other visualizations</span>

<span class="sd">The trained model keeps track of the trained weights and is now independant of</span>
<span class="sd">the dataset. Finalized weights should be copied to and loaded from here.</span>

<span class="sd">----------------</span>
<span class="sd">|   |--  &lt;training_dpath&gt;</span>
<span class="sd">|   |   |-- dataset_{dataset_id} *</span>
<span class="sd">|   |   |   |-- full</span>
<span class="sd">|   |   |   |   |-- {dataset_id}_data.pkl</span>
<span class="sd">|   |   |   |   |-- {dataset_id}_labels.pkl</span>
<span class="sd">|   |   |   |   |-- {dataset_id}_labels_{task1}.pkl?</span>
<span class="sd">|   |   |   |   |-- {dataset_id}_labels_{task2}.pkl?</span>
<span class="sd">|   |   |   |   |-- {dataset_id}_metadata.pkl</span>
<span class="sd">|   |   |   |-- splits</span>
<span class="sd">|   |   |   |   |-- {split_id}_{num} *</span>
<span class="sd">|   |   |   |   |   |-- {dataset_id}_{split_id}_data.pkl</span>
<span class="sd">|   |   |   |   |   |-- {dataset_id}_{split_id}_labels.pkl</span>
<span class="sd">|   |   |   |   |   |-- {dataset_id}_{split_id}_metadata.pkl</span>
<span class="sd">|   |   |   |-- models</span>
<span class="sd">|   |   |   |   |-- arch_{archid} *</span>
<span class="sd">|   |   |   |   |   |-- best_results</span>
<span class="sd">|   |   |   |   |   |   |-- model_state.pkl</span>
<span class="sd">|   |   |   |   |   |-- checkpoints</span>
<span class="sd">|   |   |   |   |   |   |-- {history_id} *</span>
<span class="sd">|   |   |   |   |   |   |    |-- model_history.pkl</span>
<span class="sd">|   |   |   |   |   |   |    |-- model_state.pkl</span>
<span class="sd">|   |   |   |   |   |-- progress</span>
<span class="sd">|   |   |   |   |   |   |-- &lt;latest&gt;</span>
<span class="sd">|   |   |   |   |   |-- diagnostics</span>
<span class="sd">|   |   |   |   |   |   |-- {history_id} *</span>
<span class="sd">|   |   |   |   |   |   |   |-- &lt;files&gt;</span>
<span class="sd">|   |   |-- trained_models</span>
<span class="sd">|   |   |   |-- arch_{archid} *</span>
<span class="sd">----------------</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">exists</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span> <span class="n">splitext</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="n">cPickle</span> <span class="k">as</span> <span class="n">pickle</span>  <span class="c1"># NOQA</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">sklearn</span>
<span class="kn">from</span> <span class="nn">wbia_cnn</span> <span class="kn">import</span> <span class="n">net_strs</span>
<span class="kn">from</span> <span class="nn">wbia_cnn</span> <span class="kn">import</span> <span class="n">draw_net</span>
<span class="kn">from</span> <span class="nn">wbia_cnn.models</span> <span class="kn">import</span> <span class="n">_model_legacy</span>

<span class="nb">print</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">inject2</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="n">VERBOSE_CNN</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_module_verbosity_flags</span><span class="p">(</span><span class="s1">&#39;cnn&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span>

<span class="c1"># Delayed imports</span>
<span class="n">lasagne</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">T</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">theano</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="delayed_import"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.delayed_import">[docs]</a><span class="k">def</span> <span class="nf">delayed_import</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">lasagne</span>
    <span class="k">global</span> <span class="n">theano</span>
    <span class="k">global</span> <span class="n">T</span>
    <span class="kn">from</span> <span class="nn">Lasagne</span> <span class="kn">import</span> <span class="n">lasagne</span>
    <span class="kn">import</span> <span class="nn">theano</span>
    <span class="kn">from</span> <span class="nn">theano</span> <span class="kn">import</span> <span class="n">tensor</span> <span class="k">as</span> <span class="n">T</span>  <span class="c1"># NOQA</span></div>


<span class="c1"># def testdata_model_with_history():</span>
<span class="c1">#     model = BaseModel()</span>
<span class="c1">#     # make a dummy history</span>
<span class="c1">#     X_train, y_train = [1, 2, 3], [0, 0, 1]</span>
<span class="c1">#     rng = np.random.RandomState(0)</span>

<span class="c1">#     def dummy_epoch_dict(num):</span>
<span class="c1">#         epoch_info = {</span>
<span class="c1">#             &#39;epoch&#39;: num,</span>
<span class="c1">#             &#39;loss&#39;: 1 / np.exp(num / 10) + rng.rand() / 100,</span>
<span class="c1">#             &#39;train_loss&#39;: 1 / np.exp(num / 10) + rng.rand() / 100,</span>
<span class="c1">#             &#39;train_loss_regularized&#39;: (</span>
<span class="c1">#                 1 / np.exp(num / 10) + np.exp(rng.rand() * num) + rng.rand() / 100</span>
<span class="c1">#             ),</span>
<span class="c1">#             &#39;valid_loss&#39;: 1 / np.exp(num / 10) - rng.rand() / 100,</span>
<span class="c1">#             &#39;param_update_mags&#39;: {</span>
<span class="c1">#                 &#39;C0&#39;: (rng.normal() ** 2, rng.rand()),</span>
<span class="c1">#                 &#39;F1&#39;: (rng.normal() ** 2, rng.rand()),</span>
<span class="c1">#             },</span>
<span class="c1">#         }</span>
<span class="c1">#         return epoch_info</span>

<span class="c1">#     count = 0</span>
<span class="c1">#     for era_length in [4, 4, 4]:</span>
<span class="c1">#         alias_key = &#39;dummy_alias_key&#39;</span>
<span class="c1">#         model.start_new_era(X_train, y_train, X_train, y_train, alias_key)</span>
<span class="c1">#         for count in range(count, count + era_length):</span>
<span class="c1">#             model.record_epoch(dummy_epoch_dict(count))</span>
<span class="c1">#     # model.record_epoch({&#39;epoch&#39;: 1, &#39;valid_loss&#39;: .8, &#39;train_loss&#39;: .9})</span>
<span class="c1">#     # model.record_epoch({&#39;epoch&#39;: 2, &#39;valid_loss&#39;: .5, &#39;train_loss&#39;: .7})</span>
<span class="c1">#     # model.record_epoch({&#39;epoch&#39;: 3, &#39;valid_loss&#39;: .3, &#39;train_loss&#39;: .6})</span>
<span class="c1">#     # model.record_epoch({&#39;epoch&#39;: 4, &#39;valid_loss&#39;: .2, &#39;train_loss&#39;: .3})</span>
<span class="c1">#     # model.record_epoch({&#39;epoch&#39;: 5, &#39;valid_loss&#39;: .1, &#39;train_loss&#39;: .2})</span>
<span class="c1">#     return model</span>


<span class="k">if</span> <span class="s1">&#39;theano&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
    <span class="n">delayed_import</span><span class="p">()</span>


<div class="viewcode-block" id="History"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.History">[docs]</a><span class="nd">@ut</span><span class="o">.</span><span class="n">reloadable_class</span>
<span class="k">class</span> <span class="nc">History</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">NiceRepr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manages bookkeeping for training history</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="n">history</span><span class="p">):</span>
        <span class="c1"># an era is a group of epochs</span>
        <span class="n">history</span><span class="o">.</span><span class="n">era_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">history</span><span class="o">.</span><span class="n">epoch_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Marks the start of the era</span>
        <span class="n">history</span><span class="o">.</span><span class="n">_start_epoch</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="n">history</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">history</span><span class="o">.</span><span class="n">total_epochs</span>

    <span class="k">def</span> <span class="nf">__nice__</span><span class="p">(</span><span class="n">history</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">history</span><span class="o">.</span><span class="n">get_history_nice</span><span class="p">()</span>

    <span class="c1"># def __iter__(history):</span>
    <span class="c1">#    for epochs in history.grouped_epochs():</span>
    <span class="c1">#        yield epochs</span>

<div class="viewcode-block" id="History.from_oldstyle"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.History.from_oldstyle">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_oldstyle</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">era_history</span><span class="p">):</span>
        <span class="n">history</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">era_num</span><span class="p">,</span> <span class="n">era</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">era_history</span><span class="p">):</span>
            <span class="n">epoch_info_list</span> <span class="o">=</span> <span class="n">era</span><span class="p">[</span><span class="s1">&#39;epoch_info_list&#39;</span><span class="p">]</span>
            <span class="n">era</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">delete_dict_keys</span><span class="p">(</span><span class="n">era</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="p">[</span><span class="s1">&#39;epoch_info_list&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">])</span>
            <span class="c1"># Append new information</span>
            <span class="n">era</span><span class="p">[</span><span class="s1">&#39;era_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">era_num</span>
            <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">epoch_info_list</span><span class="p">:</span>
                <span class="n">epoch</span> <span class="o">=</span> <span class="n">epoch</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">epoch</span><span class="p">[</span><span class="s1">&#39;era_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">era_num</span>
                <span class="k">if</span> <span class="s1">&#39;epoch&#39;</span> <span class="ow">in</span> <span class="n">epoch</span><span class="p">:</span>
                    <span class="n">epoch</span><span class="p">[</span><span class="s1">&#39;epoch_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epoch</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">epoch</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">]</span>
                <span class="n">history</span><span class="o">.</span><span class="n">epoch_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
            <span class="n">history</span><span class="o">.</span><span class="n">era_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">era</span><span class="p">)</span>
        <span class="n">history</span><span class="o">.</span><span class="n">_start_epoch</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">epoch_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">history</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">total_epochs</span><span class="p">(</span><span class="n">history</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">epoch_list</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">total_eras</span><span class="p">(</span><span class="n">history</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">era_list</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hist_id</span><span class="p">(</span><span class="n">history</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia_cnn.models.abstract_models --test-History.hist_id:0</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn.models.abstract_models import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; model = testdata_model_with_history()</span>
<span class="sd">            &gt;&gt;&gt; history = model.history</span>
<span class="sd">            &gt;&gt;&gt; result = str(model.history.hist_id)</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">            epoch0002_era012_qewrbbgy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hashid</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">get_history_hashid</span><span class="p">()</span>
        <span class="n">nice</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">get_history_nice</span><span class="p">()</span>
        <span class="n">history_id</span> <span class="o">=</span> <span class="n">nice</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">hashid</span>
        <span class="k">return</span> <span class="n">history_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current_era_size</span><span class="p">(</span><span class="n">history</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">history</span><span class="o">.</span><span class="n">total_epochs</span> <span class="o">-</span> <span class="n">history</span><span class="o">.</span><span class="n">_start_epoch</span>

<div class="viewcode-block" id="History.get_history_hashid"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.History.get_history_hashid">[docs]</a>    <span class="k">def</span> <span class="nf">get_history_hashid</span><span class="p">(</span><span class="n">history</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds a hashid that uniquely identifies the architecture and the</span>
<span class="sd">        training procedure this model has gone through to produce the current</span>
<span class="sd">        architecture weights.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">era_hash_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">hashstr27</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">era</span><span class="p">))</span> <span class="k">for</span> <span class="n">era</span> <span class="ow">in</span> <span class="n">history</span><span class="o">.</span><span class="n">era_list</span><span class="p">]</span>
        <span class="c1"># epoch_hash_list = [ut.hashstr27(ut.repr2(epoch)) for epoch in history.epoch_list]</span>
        <span class="c1"># epoch_hash_str = &#39;&#39;.join(epoch_hash_list)</span>
        <span class="n">era_hash_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">era_hash_list</span><span class="p">)</span>
        <span class="n">era_hash_str</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">total_epochs</span><span class="p">)</span>
        <span class="n">history_hashid</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">hashstr27</span><span class="p">(</span><span class="n">era_hash_str</span><span class="p">,</span> <span class="n">hashlen</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">history_hashid</span></div>

<div class="viewcode-block" id="History.get_history_nice"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.History.get_history_nice">[docs]</a>    <span class="k">def</span> <span class="nf">get_history_nice</span><span class="p">(</span><span class="n">history</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">history</span><span class="o">.</span><span class="n">total_epochs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nice</span> <span class="o">=</span> <span class="s1">&#39;NoHist&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nice</span> <span class="o">=</span> <span class="s1">&#39;epoch</span><span class="si">%04d</span><span class="s1">_era</span><span class="si">%03d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">total_eras</span><span class="p">,</span> <span class="n">history</span><span class="o">.</span><span class="n">total_epochs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nice</span></div>

<div class="viewcode-block" id="History.grouped_epochs"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.History.grouped_epochs">[docs]</a>    <span class="k">def</span> <span class="nf">grouped_epochs</span><span class="p">(</span><span class="n">history</span><span class="p">):</span>
        <span class="n">era_num</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">epoch_list</span><span class="p">,</span> <span class="s1">&#39;era_num&#39;</span><span class="p">)</span>
        <span class="n">unique</span><span class="p">,</span> <span class="n">groupxs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_indices</span><span class="p">(</span><span class="n">era_num</span><span class="p">)</span>
        <span class="n">grouped_epochs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">epoch_list</span><span class="p">,</span> <span class="n">groupxs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">grouped_epochs</span></div>

<div class="viewcode-block" id="History.grouped_epochsT"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.History.grouped_epochsT">[docs]</a>    <span class="k">def</span> <span class="nf">grouped_epochsT</span><span class="p">(</span><span class="n">history</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">epochs</span> <span class="ow">in</span> <span class="n">history</span><span class="o">.</span><span class="n">grouped_epochs</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_stack2</span><span class="p">(</span><span class="n">epochs</span><span class="p">)</span></div>

<div class="viewcode-block" id="History.record_epoch"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.History.record_epoch">[docs]</a>    <span class="k">def</span> <span class="nf">record_epoch</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="n">epoch_info</span><span class="p">):</span>
        <span class="n">epoch_info</span><span class="p">[</span><span class="s1">&#39;epoch_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">epoch_list</span><span class="p">)</span>
        <span class="n">history</span><span class="o">.</span><span class="n">epoch_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_info</span><span class="p">)</span></div>

<div class="viewcode-block" id="History._new_era"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.History._new_era">[docs]</a>    <span class="k">def</span> <span class="nf">_new_era</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">X_learn</span><span class="p">,</span> <span class="n">y_learn</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Used to denote a change in hyperparameters during training.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">y_hashid</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">hashstr_arr</span><span class="p">(</span><span class="n">y_learn</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">alphabet</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">ALPHABET_27</span><span class="p">)</span>

        <span class="n">learn_hashid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">arch_id</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">y_hashid</span>
        <span class="k">if</span> <span class="n">history</span><span class="o">.</span><span class="n">total_epochs</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">history</span><span class="o">.</span><span class="n">current_era_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Not starting new era (previous era has no epochs)&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_new_era</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;learn_hashid&#39;</span><span class="p">:</span> <span class="n">learn_hashid</span><span class="p">,</span>
                <span class="s1">&#39;arch_hashid&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">get_arch_hashid</span><span class="p">(),</span>
                <span class="s1">&#39;arch_id&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">arch_id</span><span class="p">,</span>
                <span class="s1">&#39;num_learn&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_learn</span><span class="p">),</span>
                <span class="s1">&#39;num_valid&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_valid</span><span class="p">),</span>
                <span class="s1">&#39;learn_state&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">learn_state</span><span class="o">.</span><span class="n">asdict</span><span class="p">(),</span>
            <span class="p">}</span>
            <span class="n">num_eras</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">total_eras</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;starting new era </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_eras</span><span class="p">,))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">current_era</span> <span class="o">=</span> <span class="n">_new_era</span>
            <span class="n">history</span><span class="o">.</span><span class="n">era_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_new_era</span><span class="p">)</span>
            <span class="n">history</span><span class="o">.</span><span class="n">_start_epoch</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">total_epochs</span></div>

<div class="viewcode-block" id="History._record_epoch"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.History._record_epoch">[docs]</a>    <span class="k">def</span> <span class="nf">_record_epoch</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="n">epoch_info</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Records an epoch in an era.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># each key/val in epoch_info dict corresponds to a key/val_list in an</span>
        <span class="c1"># era dict.</span>
        <span class="c1"># history.current_era[&#39;size&#39;] += 1</span>
        <span class="c1"># history.current_era[&#39;epoch_info_list&#39;].append(epoch_info)</span>
        <span class="n">epoch_info</span><span class="p">[</span><span class="s1">&#39;era_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">total_eras</span>
        <span class="n">history</span><span class="o">.</span><span class="n">epoch_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_info</span><span class="p">)</span></div>

<div class="viewcode-block" id="History.rewind_to"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.History.rewind_to">[docs]</a>    <span class="k">def</span> <span class="nf">rewind_to</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="n">epoch_num</span><span class="p">):</span>
        <span class="n">target_epoch</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">epoch_list</span><span class="p">[</span><span class="n">epoch_num</span><span class="p">]</span>
        <span class="n">era_num</span> <span class="o">=</span> <span class="n">target_epoch</span><span class="p">[</span><span class="s1">&#39;era_num&#39;</span><span class="p">]</span>
        <span class="n">history</span><span class="o">.</span><span class="n">epoch_list</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">epoch_list</span><span class="p">[:</span> <span class="n">epoch_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">history</span><span class="o">.</span><span class="n">era_list</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">era_list</span><span class="p">[:</span> <span class="n">era_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">history</span><span class="o">.</span><span class="n">_start_epoch</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">total_epochs</span></div>

<div class="viewcode-block" id="History.to_json"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.History.to_json">[docs]</a>    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="n">history</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ut</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="LearnState"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.LearnState">[docs]</a><span class="nd">@ut</span><span class="o">.</span><span class="n">reloadable_class</span>
<span class="k">class</span> <span class="nc">LearnState</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">DictLike</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Keeps track of parameters that can be changed during theano execution</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">learning_rate</span><span class="p">,</span> <span class="n">momentum</span><span class="p">,</span> <span class="n">weight_decay</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;momentum&#39;</span><span class="p">,</span>
            <span class="s1">&#39;weight_decay&#39;</span><span class="p">,</span>
            <span class="s1">&#39;learning_rate&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shared_state</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_isinit</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Set special properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">momentum</span> <span class="o">=</span> <span class="n">momentum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight_decay</span> <span class="o">=</span> <span class="n">weight_decay</span>

    <span class="c1"># --- special properties ---</span>
    <span class="n">momentum</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="n">fget</span><span class="o">=</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">getitem</span><span class="p">(</span><span class="s1">&#39;momentum&#39;</span><span class="p">),</span>
        <span class="n">fset</span><span class="o">=</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">setitem</span><span class="p">(</span><span class="s1">&#39;momentum&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">learning_rate</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="n">fget</span><span class="o">=</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">getitem</span><span class="p">(</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">),</span>
        <span class="n">fset</span><span class="o">=</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">setitem</span><span class="p">(</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">weight_decay</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="n">fget</span><span class="o">=</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">getitem</span><span class="p">(</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">),</span>
        <span class="n">fset</span><span class="o">=</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">setitem</span><span class="p">(</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shared</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isinit</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shared_state</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;Learning has not been initialized&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="LearnState.init"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.LearnState.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isinit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_isinit</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># Reset variables with shared theano state</span>
            <span class="n">_preinit_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shared_state</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_shared_state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_preinit_state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>

<div class="viewcode-block" id="LearnState.keys"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.LearnState.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span></div>

<div class="viewcode-block" id="LearnState.getitem"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.LearnState.getitem">[docs]</a>    <span class="k">def</span> <span class="nf">getitem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">_shared</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shared_state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isinit</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">_shared</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">_shared</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">_shared</span>
        <span class="k">return</span> <span class="n">value</span></div>

<div class="viewcode-block" id="LearnState.setitem"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.LearnState.setitem">[docs]</a>    <span class="k">def</span> <span class="nf">setitem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isinit</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">theano</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[model] setting </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%.9r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
            <span class="n">_shared</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shared_state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">_shared</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot set an initialized shared variable to None.&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">_shared</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_shared_state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">cast</span><span class="p">[</span><span class="s1">&#39;float32&#39;</span><span class="p">](</span><span class="n">value</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="n">key</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">_shared</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_shared</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cast</span><span class="p">[</span><span class="s1">&#39;float32&#39;</span><span class="p">](</span><span class="n">value</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shared_state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div></div>


<div class="viewcode-block" id="_ModelFitter"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelFitter">[docs]</a><span class="nd">@ut</span><span class="o">.</span><span class="n">reloadable_class</span>
<span class="k">class</span> <span class="nc">_ModelFitter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia_cnn _ModelFitter.fit:0</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="_ModelFitter._init_fit_vars"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelFitter._init_fit_vars">[docs]</a>    <span class="k">def</span> <span class="nf">_init_fit_vars</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_rng</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_rng</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">History</span><span class="p">()</span>
        <span class="c1"># Training state</span>
        <span class="n">model</span><span class="o">.</span><span class="n">requested_headers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;learn_loss&#39;</span><span class="p">,</span> <span class="s1">&#39;valid_loss&#39;</span><span class="p">,</span> <span class="s1">&#39;learnval_rat&#39;</span><span class="p">]</span>
        <span class="n">model</span><span class="o">.</span><span class="n">data_params</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Stores current result</span>
        <span class="n">model</span><span class="o">.</span><span class="n">best_results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;epoch_num&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;learn_loss&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
            <span class="s1">&#39;valid_loss&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
            <span class="s1">&#39;weights&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># TODO: some sort of behavior config Things that dont influence</span>
        <span class="c1"># training, but do impact performance / memory usage.</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_behavior</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;buffered&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="c1"># Static configuration indicating training preferences</span>
        <span class="c1"># (these will not influence the model learning)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">monitor_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;monitor&#39;</span><span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--monitor&#39;</span><span class="p">),</span>
            <span class="s1">&#39;monitor_updates&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;checkpoint_freq&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
            <span class="s1">&#39;case_dump_freq&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
            <span class="s1">&#39;weight_dump_freq&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s1">&#39;showprog&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">update_existing</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">monitor_config</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">delete_dict_keys</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">monitor_config</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="c1"># Static configuration indicating hyper-parameters</span>
        <span class="c1"># (these will influence how the model learns)</span>
        <span class="c1"># Some of these values (ie learning state) may be dynamic durring</span>
        <span class="c1"># training. The dynamic version should be used in this context. This</span>
        <span class="c1"># dictionary is always static in a fit session and only indicates the</span>
        <span class="c1"># initial state of these variables.</span>
        <span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;label_encode_on&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;whiten_on&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;augment_on&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;augment_on_validate&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;augment_weights&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;augment_delay&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="c1"># &#39;augment_delay&#39;: 2,</span>
            <span class="s1">&#39;era_size&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>  <span class="c1"># epochs per era</span>
            <span class="s1">&#39;era_clean&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;max_epochs&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;rate_schedule&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
            <span class="s1">&#39;stopping_patience&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
            <span class="c1"># &#39;class_weight&#39;: None,</span>
            <span class="s1">&#39;class_weight&#39;</span><span class="p">:</span> <span class="s1">&#39;balanced&#39;</span><span class="p">,</span>
            <span class="s1">&#39;random_seed&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.005</span><span class="p">,</span>
            <span class="s1">&#39;momentum&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
            <span class="s1">&#39;weight_decay&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">update_existing</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">delete_dict_keys</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="c1"># Dynamic configuration that may change with time</span>
        <span class="n">model</span><span class="o">.</span><span class="n">learn_state</span> <span class="o">=</span> <span class="n">LearnState</span><span class="p">(</span>
            <span class="n">learning_rate</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">],</span>
            <span class="n">momentum</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">],</span>
            <span class="n">weight_decay</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="c1"># This will by a dynamic dict that will span the life of a training</span>
        <span class="c1"># session</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_fit_session</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="_ModelFitter._default_input_weights"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelFitter._default_input_weights">[docs]</a>    <span class="k">def</span> <span class="nf">_default_input_weights</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Hack, assuming a classification task</span>
            <span class="k">if</span> <span class="s1">&#39;class_to_weight&#39;</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">data_params</span><span class="p">:</span>
                <span class="n">class_to_weight</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;class_to_weight&#39;</span><span class="p">]</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">class_to_weight</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># print(&#39;no class weights&#39;)</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">w</span></div>

<div class="viewcode-block" id="_ModelFitter.fit"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelFitter.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">X_train</span><span class="p">,</span>
        <span class="n">y_train</span><span class="p">,</span>
        <span class="n">X_valid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">y_valid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">valid_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">X_test</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">y_test</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Trains the network with backprop.</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia_cnn _ModelFitter.fit --name=bnorm --vd --monitor</span>
<span class="sd">            python -m wbia_cnn _ModelFitter.fit --name=dropout</span>
<span class="sd">            python -m wbia_cnn _ModelFitter.fit --name=incep</span>

<span class="sd">        Example1:</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn.models import mnist</span>
<span class="sd">            &gt;&gt;&gt; model, dataset = mnist.testdata_mnist(defaultname=&#39;bnorm&#39;, dropout=.5)</span>
<span class="sd">            &gt;&gt;&gt; model.init_arch()</span>
<span class="sd">            &gt;&gt;&gt; model.print_layer_info()</span>
<span class="sd">            &gt;&gt;&gt; model.print_model_info_str()</span>
<span class="sd">            &gt;&gt;&gt; X_train, y_train = dataset.subset(&#39;train&#39;)</span>
<span class="sd">            &gt;&gt;&gt; model.fit(X_train, y_train)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">wbia_cnn</span> <span class="kn">import</span> <span class="n">utils</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[train] --- TRAINING LOOP ---&#39;</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">update_existing</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">delete_dict_keys</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">update_existing</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">monitor_config</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">delete_dict_keys</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">monitor_config</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">update_existing</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_behavior</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">delete_dict_keys</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_behavior</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;unhandled kwargs=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">,)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_validate_input</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[WARNING] Input validation failed...&#39;</span><span class="p">)</span>

        <span class="n">X_learn</span><span class="p">,</span> <span class="n">y_learn</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_ensure_learnval_split</span><span class="p">(</span>
            <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">,</span> <span class="n">valid_idx</span>
        <span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">ensure_data_params</span><span class="p">(</span><span class="n">X_learn</span><span class="p">,</span> <span class="n">y_learn</span><span class="p">)</span>

        <span class="n">has_encoder</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">learn_hist</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">y_learn</span><span class="p">)</span> <span class="k">if</span> <span class="n">has_encoder</span> <span class="k">else</span> <span class="n">y_learn</span>
        <span class="n">valid_hist</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">y_valid</span><span class="p">)</span> <span class="k">if</span> <span class="n">has_encoder</span> <span class="k">else</span> <span class="n">y_valid</span>
        <span class="k">if</span> <span class="n">learn_hist</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Learn y histogram: &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">learn_hist</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">valid_hist</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Valid y histogram: &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">valid_hist</span><span class="p">)))</span>

        <span class="c1"># FIXME: make class weights more ellegant and customizable</span>
        <span class="n">w_learn</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_default_input_weights</span><span class="p">(</span><span class="n">X_learn</span><span class="p">,</span> <span class="n">y_learn</span><span class="p">)</span>
        <span class="n">w_valid</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_default_input_weights</span><span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">_new_fit_session</span><span class="p">()</span>

        <span class="n">epoch</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">best_results</span><span class="p">[</span><span class="s1">&#39;epoch_num&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">epoch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">epoch</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initializng training at epoch=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">epoch</span><span class="p">,))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Resuming training at epoch=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">epoch</span><span class="p">,))</span>
        <span class="c1"># Begin training the neural network</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;model.monitor_config = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">monitor_config</span><span class="p">),))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;model.batch_size = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;model.hyperparams = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">),))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;learn_state = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">learn_state</span><span class="o">.</span><span class="n">asdict</span><span class="p">()))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;model.arch_id = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">arch_id</span><span class="p">,))</span>

        <span class="c1"># create theano symbolic expressions that define the network</span>
        <span class="n">theano_backprop</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">build_backprop_func</span><span class="p">()</span>
        <span class="n">theano_forward</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">build_forward_func</span><span class="p">()</span>

        <span class="c1"># number of non-best iterations after, that triggers a best save</span>
        <span class="c1"># This prevents strings of best-saves one after another</span>
        <span class="n">countdown_defaults</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;checkpoint&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="s1">&#39;era_size&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;stop&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="s1">&#39;stopping_patience&#39;</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="n">countdowns</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">countdown_defaults</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

        <span class="k">def</span> <span class="nf">check_countdown</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">countdowns</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">countdowns</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">countdowns</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">countdowns</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">countdown_defaults</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="k">return</span> <span class="kc">True</span>

        <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">_new_era</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="n">printcol_info</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_printcolinfo</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">requested_headers</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">print_header_columns</span><span class="p">(</span><span class="n">printcol_info</span><span class="p">)</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># ---------------------------------------</span>
        <span class="c1"># EPOCH 0: Execute backwards and forward passes</span>
        <span class="n">tt</span><span class="o">.</span><span class="n">tic</span><span class="p">()</span>
        <span class="n">learn_info</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_epoch_validate_learn</span><span class="p">(</span>
            <span class="n">theano_forward</span><span class="p">,</span> <span class="n">X_learn</span><span class="p">,</span> <span class="n">y_learn</span><span class="p">,</span> <span class="n">w_learn</span>
        <span class="p">)</span>
        <span class="n">valid_info</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_epoch_validate</span><span class="p">(</span><span class="n">theano_forward</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">,</span> <span class="n">w_valid</span><span class="p">)</span>

        <span class="c1"># ---------------------------------------</span>
        <span class="c1"># EPOCH 0: Summarize the epoch</span>
        <span class="n">epoch_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;epoch_num&#39;</span><span class="p">:</span> <span class="n">epoch</span><span class="p">}</span>
        <span class="n">epoch_info</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">learn_info</span><span class="p">)</span>
        <span class="n">epoch_info</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">valid_info</span><span class="p">)</span>
        <span class="n">epoch_info</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">toc</span><span class="p">()</span>
        <span class="n">epoch_info</span><span class="p">[</span><span class="s1">&#39;learn_state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">learn_state</span><span class="o">.</span><span class="n">asdict</span><span class="p">()</span>
        <span class="n">epoch_info</span><span class="p">[</span><span class="s1">&#39;learnval_rat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epoch_info</span><span class="p">[</span><span class="s1">&#39;learn_loss&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">epoch_info</span><span class="p">[</span><span class="s1">&#39;valid_loss&#39;</span><span class="p">]</span>

        <span class="c1"># ---------------------------------------</span>
        <span class="c1"># EPOCH 0: Check how we are learning</span>
        <span class="c1"># Cache best results</span>
        <span class="n">model</span><span class="o">.</span><span class="n">best_results</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_all_param_values</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">best_results</span><span class="p">[</span><span class="s1">&#39;epoch_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epoch_info</span><span class="p">[</span><span class="s1">&#39;epoch_num&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;valid_precision&#39;</span> <span class="ow">in</span> <span class="n">epoch_info</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">best_results</span><span class="p">[</span><span class="s1">&#39;valid_precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epoch_info</span><span class="p">[</span><span class="s1">&#39;valid_precision&#39;</span><span class="p">]</span>
            <span class="n">model</span><span class="o">.</span><span class="n">best_results</span><span class="p">[</span><span class="s1">&#39;valid_recall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epoch_info</span><span class="p">[</span><span class="s1">&#39;valid_recall&#39;</span><span class="p">]</span>
            <span class="n">model</span><span class="o">.</span><span class="n">best_results</span><span class="p">[</span><span class="s1">&#39;valid_fscore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epoch_info</span><span class="p">[</span><span class="s1">&#39;valid_fscore&#39;</span><span class="p">]</span>
            <span class="n">model</span><span class="o">.</span><span class="n">best_results</span><span class="p">[</span><span class="s1">&#39;valid_support&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epoch_info</span><span class="p">[</span><span class="s1">&#39;valid_support&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">requested_headers</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">best_results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">epoch_info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># ---------------------------------------</span>
        <span class="c1"># EPOCH 0: Record this epoch in history and print info</span>
        <span class="c1"># model.history._record_epoch(epoch_info)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">print_epoch_info</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">printcol_info</span><span class="p">,</span> <span class="n">epoch_info</span><span class="p">)</span>
        <span class="n">epoch</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># ---------------------------------------</span>
                <span class="c1"># Execute backwards and forward passes</span>
                <span class="n">tt</span><span class="o">.</span><span class="n">tic</span><span class="p">()</span>
                <span class="n">learn_info</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_epoch_learn</span><span class="p">(</span>
                    <span class="n">theano_backprop</span><span class="p">,</span> <span class="n">X_learn</span><span class="p">,</span> <span class="n">y_learn</span><span class="p">,</span> <span class="n">w_learn</span><span class="p">,</span> <span class="n">epoch</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">learn_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;diverged&#39;</span><span class="p">):</span>
                    <span class="k">break</span>
                <span class="n">valid_info</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_epoch_validate</span><span class="p">(</span>
                    <span class="n">theano_forward</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">,</span> <span class="n">w_valid</span>
                <span class="p">)</span>

                <span class="c1"># ---------------------------------------</span>
                <span class="c1"># Summarize the epoch</span>
                <span class="n">epoch_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;epoch_num&#39;</span><span class="p">:</span> <span class="n">epoch</span><span class="p">}</span>
                <span class="n">epoch_info</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">learn_info</span><span class="p">)</span>
                <span class="n">epoch_info</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">valid_info</span><span class="p">)</span>
                <span class="n">epoch_info</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">toc</span><span class="p">()</span>
                <span class="n">epoch_info</span><span class="p">[</span><span class="s1">&#39;learn_state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">learn_state</span><span class="o">.</span><span class="n">asdict</span><span class="p">()</span>
                <span class="n">epoch_info</span><span class="p">[</span><span class="s1">&#39;learnval_rat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">epoch_info</span><span class="p">[</span><span class="s1">&#39;learn_loss&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">epoch_info</span><span class="p">[</span><span class="s1">&#39;valid_loss&#39;</span><span class="p">]</span>
                <span class="p">)</span>

                <span class="c1"># ---------------------------------------</span>
                <span class="c1"># Record this epoch in history</span>
                <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">_record_epoch</span><span class="p">(</span><span class="n">epoch_info</span><span class="p">)</span>

                <span class="c1"># ---------------------------------------</span>
                <span class="c1"># Check how we are learning</span>
                <span class="k">if</span> <span class="n">epoch_info</span><span class="p">[</span><span class="s1">&#39;valid_loss&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">model</span><span class="o">.</span><span class="n">best_results</span><span class="p">[</span><span class="s1">&#39;valid_loss&#39;</span><span class="p">]:</span>
                    <span class="c1"># Found a better model. Reset countdowns.</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">countdowns</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">countdowns</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">countdown_defaults</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="c1"># Cache best results</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">best_results</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_all_param_values</span><span class="p">()</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">best_results</span><span class="p">[</span><span class="s1">&#39;epoch_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epoch_info</span><span class="p">[</span><span class="s1">&#39;epoch_num&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s1">&#39;valid_precision&#39;</span> <span class="ow">in</span> <span class="n">epoch_info</span><span class="p">:</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">best_results</span><span class="p">[</span><span class="s1">&#39;valid_precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epoch_info</span><span class="p">[</span>
                            <span class="s1">&#39;valid_precision&#39;</span>
                        <span class="p">]</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">best_results</span><span class="p">[</span><span class="s1">&#39;valid_recall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epoch_info</span><span class="p">[</span><span class="s1">&#39;valid_recall&#39;</span><span class="p">]</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">best_results</span><span class="p">[</span><span class="s1">&#39;valid_fscore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epoch_info</span><span class="p">[</span><span class="s1">&#39;valid_fscore&#39;</span><span class="p">]</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">best_results</span><span class="p">[</span><span class="s1">&#39;valid_support&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epoch_info</span><span class="p">[</span><span class="s1">&#39;valid_support&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s1">&#39;learn_precision&#39;</span> <span class="ow">in</span> <span class="n">epoch_info</span><span class="p">:</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">best_results</span><span class="p">[</span><span class="s1">&#39;learn_precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epoch_info</span><span class="p">[</span>
                            <span class="s1">&#39;learn_precision&#39;</span>
                        <span class="p">]</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">best_results</span><span class="p">[</span><span class="s1">&#39;learn_recall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epoch_info</span><span class="p">[</span><span class="s1">&#39;learn_recall&#39;</span><span class="p">]</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">best_results</span><span class="p">[</span><span class="s1">&#39;learn_fscore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epoch_info</span><span class="p">[</span><span class="s1">&#39;learn_fscore&#39;</span><span class="p">]</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">best_results</span><span class="p">[</span><span class="s1">&#39;learn_support&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epoch_info</span><span class="p">[</span><span class="s1">&#39;learn_support&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">requested_headers</span><span class="p">:</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">best_results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">epoch_info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

                <span class="c1"># Check frequencies and countdowns</span>
                <span class="n">checkpoint_flag</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">checkfreq</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">monitor_config</span><span class="p">[</span><span class="s1">&#39;checkpoint_freq&#39;</span><span class="p">],</span> <span class="n">epoch</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">check_countdown</span><span class="p">(</span><span class="s1">&#39;checkpoint&#39;</span><span class="p">):</span>
                    <span class="n">countdowns</span><span class="p">[</span><span class="s1">&#39;checkpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">checkpoint_flag</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># ---------------------------------------</span>
                <span class="c1"># Output Diagnostics</span>

                <span class="c1"># Print the epoch</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">print_epoch_info</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">printcol_info</span><span class="p">,</span> <span class="n">epoch_info</span><span class="p">)</span>

                <span class="c1"># Output any diagnostics</span>
                <span class="k">if</span> <span class="n">checkpoint_flag</span><span class="p">:</span>
                    <span class="c1"># FIXME: just move it to the second location</span>
                    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">monitor_config</span><span class="p">[</span><span class="s1">&#39;monitor&#39;</span><span class="p">]:</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">_dump_best_monitor</span><span class="p">()</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">checkpoint_save_model_info</span><span class="p">()</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">checkpoint_save_model_state</span><span class="p">()</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">save_model_info</span><span class="p">()</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">save_model_state</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">monitor_config</span><span class="p">[</span><span class="s1">&#39;monitor&#39;</span><span class="p">]:</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">_dump_epoch_monitor</span><span class="p">()</span>
                    <span class="c1"># if epoch &gt; 10:</span>
                    <span class="c1"># TODO: can dump case info every epoch</span>
                    <span class="c1"># But we want to dump the images less often</span>
                    <span class="c1"># Make function to just grab the failure case info</span>
                    <span class="c1"># and another function to visualize it.</span>

                <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">monitor_config</span><span class="p">[</span><span class="s1">&#39;monitor&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">checkfreq</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">monitor_config</span><span class="p">[</span><span class="s1">&#39;weight_dump_freq&#39;</span><span class="p">],</span> <span class="n">epoch</span><span class="p">):</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">_dump_weight_monitor</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">checkfreq</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">monitor_config</span><span class="p">[</span><span class="s1">&#39;case_dump_freq&#39;</span><span class="p">],</span> <span class="n">epoch</span><span class="p">):</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">_dump_case_monitor</span><span class="p">(</span><span class="n">X_learn</span><span class="p">,</span> <span class="n">y_learn</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">check_countdown</span><span class="p">(</span><span class="s1">&#39;stop&#39;</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Early stopping&#39;</span><span class="p">)</span>
                    <span class="k">break</span>

                <span class="c1"># Check if the era is done</span>
                <span class="n">max_era_size</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_fit_session</span><span class="p">[</span><span class="s1">&#39;max_era_size&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">current_era_size</span> <span class="o">&gt;=</span> <span class="n">max_era_size</span><span class="p">:</span>
                    <span class="c1"># Decay learning rate</span>
                    <span class="n">era</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">total_eras</span>
                    <span class="n">rate_schedule</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="s1">&#39;rate_schedule&#39;</span><span class="p">]</span>
                    <span class="n">rate_schedule</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_iterable</span><span class="p">(</span><span class="n">rate_schedule</span><span class="p">)</span>
                    <span class="n">frac</span> <span class="o">=</span> <span class="n">rate_schedule</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">era</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rate_schedule</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">learn_state</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">learn_state</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="n">frac</span>
                    <span class="p">)</span>
                    <span class="c1"># Increase number of epochs in the next era</span>
                    <span class="n">max_era_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">max_era_size</span> <span class="o">/</span> <span class="p">(</span><span class="n">frac</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">_fit_session</span><span class="p">[</span><span class="s1">&#39;max_era_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_era_size</span>
                    <span class="c1"># Start a new era</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">_new_era</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;era_clean&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                        <span class="n">y_learn</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_epoch_clean</span><span class="p">(</span>
                            <span class="n">theano_forward</span><span class="p">,</span> <span class="n">X_learn</span><span class="p">,</span> <span class="n">y_learn</span><span class="p">,</span> <span class="n">w_learn</span>
                        <span class="p">)</span>
                        <span class="n">y_valid</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_epoch_clean</span><span class="p">(</span>
                            <span class="n">theano_forward</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">,</span> <span class="n">w_valid</span>
                        <span class="p">)</span>

                    <span class="n">utils</span><span class="o">.</span><span class="n">print_header_columns</span><span class="p">(</span><span class="n">printcol_info</span><span class="p">)</span>

                <span class="c1"># Break on max epochs</span>
                <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="s1">&#39;max_epochs&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">epoch</span> <span class="o">&gt;=</span> <span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="s1">&#39;max_epochs&#39;</span><span class="p">]:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[train] maximum number of epochs reached</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="c1"># Increment the epoch</span>
                <span class="n">epoch</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[train] Caught CRTL+C&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;model.arch_id = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">arch_id</span><span class="p">,))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;learn_state = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">learn_state</span><span class="o">.</span><span class="n">asdict</span><span class="p">()))</span>
                <span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">input</span>

                <span class="n">actions</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">(</span><span class="s1">&#39;resume&#39;</span><span class="p">,</span> <span class="p">([</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="s1">&#39;resume training&#39;</span><span class="p">)),</span>
                        <span class="p">(</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="p">([</span><span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;view&#39;</span><span class="p">],</span> <span class="s1">&#39;view session directory&#39;</span><span class="p">)),</span>
                        <span class="p">(</span><span class="s1">&#39;ipy&#39;</span><span class="p">,</span> <span class="p">([</span><span class="s1">&#39;ipy&#39;</span><span class="p">,</span> <span class="s1">&#39;ipython&#39;</span><span class="p">,</span> <span class="s1">&#39;cmd&#39;</span><span class="p">],</span> <span class="s1">&#39;embed into IPython&#39;</span><span class="p">)),</span>
                        <span class="p">(</span><span class="s1">&#39;print&#39;</span><span class="p">,</span> <span class="p">([</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;print&#39;</span><span class="p">],</span> <span class="s1">&#39;print model state&#39;</span><span class="p">)),</span>
                        <span class="p">(</span><span class="s1">&#39;shock&#39;</span><span class="p">,</span> <span class="p">([</span><span class="s1">&#39;shock&#39;</span><span class="p">],</span> <span class="s1">&#39;shock the network&#39;</span><span class="p">)),</span>
                        <span class="p">(</span><span class="s1">&#39;save&#39;</span><span class="p">,</span> <span class="p">([</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;save&#39;</span><span class="p">],</span> <span class="s1">&#39;save best weights&#39;</span><span class="p">)),</span>
                        <span class="p">(</span><span class="s1">&#39;quit&#39;</span><span class="p">,</span> <span class="p">([</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="s1">&#39;quit&#39;</span><span class="p">],</span> <span class="s1">&#39;quit&#39;</span><span class="p">)),</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="c1"># prompt</span>
                    <span class="n">msg_list</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="s1">&#39;enter </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">conj_phrase</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="s1">&#39;or&#39;</span><span class="p">),</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">actions</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="p">]</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">indentjoin</span><span class="p">(</span><span class="n">msg_list</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> | * &#39;</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39; +-----------&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> L-----------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">])</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="c1">#</span>
                    <span class="n">ans</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="p">())</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                    <span class="c1"># We have a resolution</span>
                    <span class="k">if</span> <span class="n">ans</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">[</span><span class="s1">&#39;quit&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;quit training...&#39;</span><span class="p">)</span>
                        <span class="k">return</span>
                    <span class="k">elif</span> <span class="n">ans</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">[</span><span class="s1">&#39;resume&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="n">ans</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">[</span><span class="s1">&#39;ipy&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">ut</span><span class="o">.</span><span class="n">embed</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">ans</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">[</span><span class="s1">&#39;save&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="c1"># Save the weights of the network</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">checkpoint_save_model_info</span><span class="p">()</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">checkpoint_save_model_state</span><span class="p">()</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">save_model_info</span><span class="p">()</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">save_model_state</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">ans</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">[</span><span class="s1">&#39;print&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">print_state_str</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">ans</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">[</span><span class="s1">&#39;shock&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">utils</span><span class="o">.</span><span class="n">shock_network</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">output_layer</span><span class="p">)</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">learn_state</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">model</span><span class="o">.</span><span class="n">learn_state</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="mi">2</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">ans</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">[</span><span class="s1">&#39;view&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">session_dpath</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_fit_session</span><span class="p">[</span><span class="s1">&#39;session_dpath&#39;</span><span class="p">]</span>
                        <span class="n">ut</span><span class="o">.</span><span class="n">view_directory</span><span class="p">(</span><span class="n">session_dpath</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="c1"># Handled the resolution</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;resuming training...&#39;</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;Error Occurred Embedding to enable debugging&#39;</span><span class="p">,</span> <span class="n">tb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">errorstate</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;is_fixed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
                <span class="c1"># is_fixed = False</span>
                <span class="kn">import</span> <span class="nn">utool</span>

                <span class="n">utool</span><span class="o">.</span><span class="n">embed</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">errorstate</span><span class="p">[</span><span class="s1">&#39;is_fixed&#39;</span><span class="p">]:</span>
                    <span class="k">raise</span>
        <span class="c1"># Save the best network</span>
        <span class="n">model</span><span class="o">.</span><span class="n">checkpoint_save_model_state</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">save_model_state</span><span class="p">()</span>

        <span class="c1"># Set model to best weights</span>
        <span class="n">model</span><span class="o">.</span><span class="n">set_all_param_values</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">best_results</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">])</span>

        <span class="c1"># # Remove history after overfitting starts</span>
        <span class="c1"># if &#39;epoch_num&#39; not in model.best_results:</span>
        <span class="c1">#     model.best_results[&#39;epoch_num&#39;] = model.best_results[&#39;epoch&#39;]</span>
        <span class="c1"># epoch_num = model.best_results[&#39;epoch_num&#39;]</span>
        <span class="c1"># model.history.rewind_to(epoch_num)</span>

        <span class="k">if</span> <span class="n">X_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">y_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># TODO: dump test output in a standard way</span>
            <span class="n">w_test</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_default_input_weights</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
            <span class="n">theano_forward</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">build_forward_func</span><span class="p">()</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_epoch_validate</span><span class="p">(</span><span class="n">theano_forward</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">w_test</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;train info = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">info</span><span class="p">,))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">dump_cases</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">dpath</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">arch_dpath</span><span class="p">)</span></div>
            <span class="c1"># model._run_test(X_test, y_test)</span>

    <span class="c1"># def _run_test(model, X_test, y_test):</span>
    <span class="c1">#    # Perform a test on the fitted model</span>
    <span class="c1">#    test_outptuts = model._predict(X_test)</span>
    <span class="c1">#    y_pred = test_outptuts[&#39;predictions&#39;]</span>
    <span class="c1">#    print(model.name)</span>
    <span class="c1">#    report = sklearn.metrics.classification_report(</span>
    <span class="c1">#        y_true=y_test, y_pred=y_pred,</span>
    <span class="c1">#    )</span>
    <span class="c1">#    print(report)</span>
    <span class="c1">#    pass</span>

<div class="viewcode-block" id="_ModelFitter._ensure_learnval_split"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelFitter._ensure_learnval_split">[docs]</a>    <span class="k">def</span> <span class="nf">_ensure_learnval_split</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_valid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y_valid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">valid_idx</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">X_valid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">valid_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Cant specify both valid_idx and X_valid&#39;</span>
            <span class="c1"># When X_valid is given assume X_train is actually X_learn</span>
            <span class="n">X_learn</span> <span class="o">=</span> <span class="n">X_train</span>
            <span class="n">y_learn</span> <span class="o">=</span> <span class="n">y_train</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">valid_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Split training set into a learning / validation set</span>
                <span class="kn">from</span> <span class="nn">wbia_cnn.dataset</span> <span class="kn">import</span> <span class="n">stratified_shuffle_split</span>

                <span class="n">train_idx</span><span class="p">,</span> <span class="n">valid_idx</span> <span class="o">=</span> <span class="n">stratified_shuffle_split</span><span class="p">(</span>
                    <span class="n">y_train</span><span class="p">,</span> <span class="n">fractions</span><span class="o">=</span><span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span> <span class="n">rng</span><span class="o">=</span><span class="mi">432321</span>
                <span class="p">)</span>
                <span class="c1"># import sklearn.cross_validation</span>
                <span class="c1"># xvalkw = dict(n_folds=2, shuffle=True, random_state=43432)</span>
                <span class="c1"># skf = sklearn.cross_validation.StratifiedKFold(y_train, **xvalkw)</span>
                <span class="c1"># train_idx, valid_idx = list(skf)[0]</span>
            <span class="k">elif</span> <span class="n">valid_idx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">X_valid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">train_idx</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">index_complement</span><span class="p">(</span><span class="n">valid_idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;impossible state&#39;</span>
            <span class="c1"># Set to learn network weights</span>
            <span class="n">X_learn</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">train_idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">y_learn</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">train_idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># Set to crossvalidate hyperparamters</span>
            <span class="n">X_valid</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">valid_idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">y_valid</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">valid_idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># print(&#39;\n[train] --- MODEL INFO ---&#39;)</span>
        <span class="c1"># model.print_arch_str()</span>
        <span class="c1"># model.print_layer_info()</span>
        <span class="k">return</span> <span class="n">X_learn</span><span class="p">,</span> <span class="n">y_learn</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span></div>

<div class="viewcode-block" id="_ModelFitter.ensure_data_params"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelFitter.ensure_data_params">[docs]</a>    <span class="k">def</span> <span class="nf">ensure_data_params</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_learn</span><span class="p">,</span> <span class="n">y_learn</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">data_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">data_params</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># TODO: move to dataset. This is independant of the model.</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="s1">&#39;whiten_on&#39;</span><span class="p">]:</span>
            <span class="c1"># Center the data by subtracting the mean</span>
            <span class="k">if</span> <span class="s1">&#39;center_mean&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">data_params</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;computing center mean/std. (hacks std=1)&#39;</span><span class="p">)</span>
                <span class="n">X_</span> <span class="o">=</span> <span class="n">X_learn</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">is_int</span><span class="p">(</span><span class="n">X_learn</span><span class="p">):</span>
                        <span class="n">ut</span><span class="o">.</span><span class="n">assert_inbounds</span><span class="p">(</span><span class="n">X_learn</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">eq</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
                        <span class="n">X_</span> <span class="o">=</span> <span class="n">X_</span> <span class="o">/</span> <span class="mi">255</span>
                    <span class="n">ut</span><span class="o">.</span><span class="n">assert_inbounds</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">eq</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[WARNING] Input bounds check failed...&#39;</span><span class="p">)</span>
                <span class="c1"># Ensure that the mean is computed on 0-1 normalized data</span>
                <span class="n">model</span><span class="o">.</span><span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;center_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;center_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="c1"># Hack to preconvert mean / std to 0-1 for old models</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_fix_center_mean_std</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">delete_dict_keys</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">data_params</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;center_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;center_std&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="s1">&#39;class_weight&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;balanced&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Balancing class weights&#39;</span><span class="p">)</span>
            <span class="kn">import</span> <span class="nn">sklearn.utils</span>

            <span class="n">unique_classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_learn</span><span class="p">)))</span>
            <span class="n">class_to_weight</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">compute_class_weight</span><span class="p">(</span>
                <span class="s1">&#39;balanced&#39;</span><span class="p">,</span> <span class="n">unique_classes</span><span class="p">,</span> <span class="n">y_learn</span>
            <span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;class_to_weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">class_to_weight</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">delete_dict_keys</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">data_params</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;class_to_weight&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="s1">&#39;label_encode_on&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;init_encoder&#39;</span><span class="p">):</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">init_encoder</span><span class="p">(</span><span class="n">y_learn</span><span class="p">)</span></div>

<div class="viewcode-block" id="_ModelFitter._rename_old_sessions"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelFitter._rename_old_sessions">[docs]</a>    <span class="k">def</span> <span class="nf">_rename_old_sessions</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">re</span>

        <span class="n">dpath_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">saved_session_dpath</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">with_files</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dpath</span> <span class="ow">in</span> <span class="n">dpath_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="kc">True</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;^.*_nEpochs_[0-9]*$&#39;</span><span class="p">,</span> <span class="n">dpath</span><span class="p">):</span>
                <span class="n">report_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="s1">&#39;era_history.json&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">report_fpath</span><span class="p">):</span>
                    <span class="n">report_dict</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">report_fpath</span><span class="p">)</span>
                    <span class="c1"># TODO: try to read from history report</span>
                    <span class="n">nEpochs</span> <span class="o">=</span> <span class="n">report_dict</span><span class="p">[</span><span class="s1">&#39;nEpochs&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nEpochs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="s1">&#39;history&#39;</span><span class="p">),</span> <span class="s1">&#39;loss_*&#39;</span><span class="p">))</span>
                <span class="c1"># Add suffix to session to indicate what happened?</span>
                <span class="c1"># Maybe this should be done via symlink?</span>
                <span class="n">dpath_new</span> <span class="o">=</span> <span class="n">dpath</span> <span class="o">+</span> <span class="s1">&#39;_nEpochs_</span><span class="si">%04d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nEpochs</span><span class="p">,)</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="n">dpath_new</span><span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">saved_session_dpath</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="_ModelFitter._new_fit_session"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelFitter._new_fit_session">[docs]</a>    <span class="k">def</span> <span class="nf">_new_fit_session</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts a model training session</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Starting new fit session&#39;</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_fit_session</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;start_time&#39;</span><span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_timestamp</span><span class="p">(),</span>
            <span class="s1">&#39;max_era_size&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="s1">&#39;era_size&#39;</span><span class="p">],</span>
            <span class="s1">&#39;era_epoch_num&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="c1"># TODO: ensure this somewhere else?</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_rng</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_rng</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="s1">&#39;random_seed&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">monitor_config</span><span class="p">[</span><span class="s1">&#39;monitor&#39;</span><span class="p">]:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">arch_dpath</span><span class="p">)</span>

            <span class="c1"># Rename old sessions to distinguish this one</span>
            <span class="c1"># TODO: put a lock file on any existing sessions</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_rename_old_sessions</span><span class="p">()</span>

            <span class="c1"># Create a directory for this training session with a timestamp</span>
            <span class="n">session_dname</span> <span class="o">=</span> <span class="s1">&#39;fit_session_&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">_fit_session</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span>
            <span class="n">session_dpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">saved_session_dpath</span><span class="p">,</span> <span class="n">session_dname</span><span class="p">)</span>
            <span class="n">session_dpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_nonconflicting_path</span><span class="p">(</span>
                <span class="n">session_dpath</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_conflict</span><span class="si">%d</span><span class="s1">&#39;</span>
            <span class="p">)</span>

            <span class="n">prog_dirs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;dream&#39;</span><span class="p">:</span> <span class="n">join</span><span class="p">(</span><span class="n">session_dpath</span><span class="p">,</span> <span class="s1">&#39;dream&#39;</span><span class="p">),</span>
                <span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="n">join</span><span class="p">(</span><span class="n">session_dpath</span><span class="p">,</span> <span class="s1">&#39;history&#39;</span><span class="p">),</span>
                <span class="s1">&#39;weights&#39;</span><span class="p">:</span> <span class="n">join</span><span class="p">(</span><span class="n">session_dpath</span><span class="p">,</span> <span class="s1">&#39;weights&#39;</span><span class="p">),</span>
            <span class="p">}</span>

            <span class="n">model</span><span class="o">.</span><span class="n">_fit_session</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="o">**</span><span class="p">{</span>
                    <span class="s1">&#39;prog_dirs&#39;</span><span class="p">:</span> <span class="n">prog_dirs</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

            <span class="c1"># for dpath in prog_dirs.values():</span>
            <span class="c1">#    ut.ensuredir(dpath)</span>

            <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">session_dpath</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_fit_session</span><span class="p">[</span><span class="s1">&#39;session_dpath&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session_dpath</span>

            <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--vd&#39;</span><span class="p">):</span>
                <span class="c1"># Open session in file explorer</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">view_directory</span><span class="p">(</span><span class="n">session_dpath</span><span class="p">)</span>

            <span class="c1"># Make a symlink to the latest session</span>
            <span class="n">session_link</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">arch_dpath</span><span class="p">,</span> <span class="s1">&#39;latest_session&#39;</span><span class="p">)</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">session_dpath</span><span class="p">,</span> <span class="n">session_link</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Write backprop arch info to arch root</span>
            <span class="n">back_archinfo_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">session_dpath</span><span class="p">,</span> <span class="s1">&#39;arch_info_fit.json&#39;</span><span class="p">)</span>
            <span class="n">back_archinfo_json</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_arch_json</span><span class="p">(</span><span class="n">with_noise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">back_archinfo_fpath</span><span class="p">,</span> <span class="n">back_archinfo_json</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Write feed-forward arch info to arch root</span>
            <span class="n">pred_archinfo_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">session_dpath</span><span class="p">,</span> <span class="s1">&#39;arch_info_predict.json&#39;</span><span class="p">)</span>
            <span class="n">pred_archinfo_json</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_arch_json</span><span class="p">(</span><span class="n">with_noise</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">pred_archinfo_fpath</span><span class="p">,</span> <span class="n">pred_archinfo_json</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># Write arch graph to root</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">back_archimg_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">session_dpath</span><span class="p">,</span> <span class="s1">&#39;arch_graph_fit.jpg&#39;</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">imwrite_arch</span><span class="p">(</span><span class="n">fpath</span><span class="o">=</span><span class="n">back_archimg_fpath</span><span class="p">,</span> <span class="n">fullinfo</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">_overwrite_latest_image</span><span class="p">(</span><span class="n">back_archimg_fpath</span><span class="p">,</span> <span class="s1">&#39;arch_graph&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Write initial states of the weights</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">prog_dirs</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">])</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">show_weights_image</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span>
                    <span class="n">prog_dirs</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">],</span> <span class="s1">&#39;weights_&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">hist_id</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
                <span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">_overwrite_latest_image</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;weights&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="_ModelFitter._overwrite_latest_image"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelFitter._overwrite_latest_image">[docs]</a>    <span class="k">def</span> <span class="nf">_overwrite_latest_image</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fpath</span><span class="p">,</span> <span class="n">new_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        copies the new image to a path to be overwritten so new updates are</span>
<span class="sd">        shown</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">shutil</span>

        <span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">splitext</span><span class="p">(</span><span class="n">fpath</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">session_dpath</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_fit_session</span><span class="p">[</span><span class="s1">&#39;session_dpath&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">session_dpath</span> <span class="o">!=</span> <span class="n">dirname</span><span class="p">(</span><span class="n">fpath</span><span class="p">):</span>
            <span class="c1"># Copy latest image to the session dir if it isn&#39;t there</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="n">session_dpath</span><span class="p">,</span> <span class="s1">&#39;latest_&#39;</span> <span class="o">+</span> <span class="n">new_name</span> <span class="o">+</span> <span class="n">ext</span><span class="p">))</span>
        <span class="c1"># Copy latest image to the main arch dir</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">arch_dpath</span><span class="p">,</span> <span class="s1">&#39;latest_&#39;</span> <span class="o">+</span> <span class="n">new_name</span> <span class="o">+</span> <span class="n">ext</span><span class="p">))</span></div>

<div class="viewcode-block" id="_ModelFitter._dump_case_monitor"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelFitter._dump_case_monitor">[docs]</a>    <span class="k">def</span> <span class="nf">_dump_case_monitor</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_learn</span><span class="p">,</span> <span class="n">y_learn</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">):</span>
        <span class="n">prog_dirs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_fit_session</span><span class="p">[</span><span class="s1">&#39;prog_dirs&#39;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">dump_cases</span><span class="p">(</span><span class="n">X_learn</span><span class="p">,</span> <span class="n">y_learn</span><span class="p">,</span> <span class="s1">&#39;learn&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: DUMP CASES HAS FAILED&#39;</span><span class="p">)</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">dump_cases</span><span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: DUMP CASES HAS FAILED&#39;</span><span class="p">)</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Save class dreams</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">prog_dirs</span><span class="p">[</span><span class="s1">&#39;dream&#39;</span><span class="p">])</span>
                <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span>
                    <span class="n">prog_dirs</span><span class="p">[</span><span class="s1">&#39;dream&#39;</span><span class="p">],</span> <span class="s1">&#39;class_dream_&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">hist_id</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
                <span class="p">)</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">show_class_dream</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">_overwrite_latest_image</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;class_dream&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;failed to dump dream&#39;</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="_ModelFitter._dump_weight_monitor"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelFitter._dump_weight_monitor">[docs]</a>    <span class="k">def</span> <span class="nf">_dump_weight_monitor</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="n">prog_dirs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_fit_session</span><span class="p">[</span><span class="s1">&#39;prog_dirs&#39;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Save weights images</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">prog_dirs</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">])</span>
            <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span>
                <span class="n">prog_dirs</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">],</span> <span class="s1">&#39;weights_&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">hist_id</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
            <span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">show_weights_image</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_overwrite_latest_image</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;weights&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;failed to dump weights&#39;</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="_ModelFitter.get_report_json"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelFitter.get_report_json">[docs]</a>    <span class="k">def</span> <span class="nf">get_report_json</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="n">report_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">report_dict</span><span class="p">[</span><span class="s1">&#39;best&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">delete_keys</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">best_results</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">report_dict</span><span class="p">[</span><span class="s1">&#39;best&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">report_dict</span><span class="p">[</span><span class="s1">&#39;best&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">],</span> <span class="s1">&#39;tolist&#39;</span><span class="p">):</span>
                <span class="n">report_dict</span><span class="p">[</span><span class="s1">&#39;best&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">report_dict</span><span class="p">[</span><span class="s1">&#39;best&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">report_dict</span><span class="p">[</span><span class="s1">&#39;num_learn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">era_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;num_learn&#39;</span><span class="p">]</span>
            <span class="n">report_dict</span><span class="p">[</span><span class="s1">&#39;num_valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">era_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;num_valid&#39;</span><span class="p">]</span>
        <span class="n">report_dict</span><span class="p">[</span><span class="s1">&#39;hyperparams&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span>
        <span class="n">report_dict</span><span class="p">[</span><span class="s1">&#39;arch_hashid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_arch_hashid</span><span class="p">()</span>
        <span class="n">report_dict</span><span class="p">[</span><span class="s1">&#39;model_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span>
        <span class="n">report_json</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr2_json</span><span class="p">(</span><span class="n">report_dict</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">report_json</span></div>

<div class="viewcode-block" id="_ModelFitter._dump_best_monitor"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelFitter._dump_best_monitor">[docs]</a>    <span class="k">def</span> <span class="nf">_dump_best_monitor</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="n">session_dpath</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_fit_session</span><span class="p">[</span><span class="s1">&#39;session_dpath&#39;</span><span class="p">]</span>
        <span class="c1"># Save text best info</span>
        <span class="n">report_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">session_dpath</span><span class="p">,</span> <span class="s1">&#39;best_report.json&#39;</span><span class="p">)</span>
        <span class="n">report_json</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_report_json</span><span class="p">()</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">write_to</span><span class="p">(</span><span class="n">report_fpath</span><span class="p">,</span> <span class="n">report_json</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="_ModelFitter._dump_epoch_monitor"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelFitter._dump_epoch_monitor">[docs]</a>    <span class="k">def</span> <span class="nf">_dump_epoch_monitor</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="n">prog_dirs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_fit_session</span><span class="p">[</span><span class="s1">&#39;prog_dirs&#39;</span><span class="p">]</span>
        <span class="n">session_dpath</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_fit_session</span><span class="p">[</span><span class="s1">&#39;session_dpath&#39;</span><span class="p">]</span>

        <span class="c1"># Save text history info</span>
        <span class="n">text_fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">session_dpath</span><span class="p">,</span> <span class="s1">&#39;era_history.txt&#39;</span><span class="p">)</span>
        <span class="n">history_text</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">write_to</span><span class="p">(</span><span class="n">text_fpath</span><span class="p">,</span> <span class="n">history_text</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Save loss graphs</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">prog_dirs</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
            <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">prog_dirs</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">],</span> <span class="s1">&#39;loss_&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">hist_id</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">show_loss_history</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_overwrite_latest_image</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;loss&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;failed to dump loss&#39;</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">prog_dirs</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
            <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">prog_dirs</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">],</span> <span class="s1">&#39;pr_&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">hist_id</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">show_pr_history</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_overwrite_latest_image</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;pr&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;failed to dump pr&#39;</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="c1"># Save weight updates</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">prog_dirs</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
            <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span>
                <span class="n">prog_dirs</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">],</span> <span class="s1">&#39;update_mag_&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">hist_id</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
            <span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">show_update_mag_history</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_overwrite_latest_image</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;update_mag&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;failed to dump update mags &#39;</span><span class="p">,</span> <span class="n">iswarning</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="_ModelFitter._epoch_learn"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelFitter._epoch_learn">[docs]</a>    <span class="k">def</span> <span class="nf">_epoch_learn</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">theano_backprop</span><span class="p">,</span> <span class="n">X_learn</span><span class="p">,</span> <span class="n">y_learn</span><span class="p">,</span> <span class="n">w_learn</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Backwards propogate -- Run learning set through the backwards pass</span>

<span class="sd">        Ignore:</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn.models.abstract_models import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn.models import mnist</span>
<span class="sd">            &gt;&gt;&gt; import theano</span>
<span class="sd">            &gt;&gt;&gt; model, dataset = mnist.testdata_mnist(dropout=.5)</span>
<span class="sd">            &gt;&gt;&gt; model.monitor_config[&#39;monitor&#39;] = False</span>
<span class="sd">            &gt;&gt;&gt; model.monitor_config[&#39;showprog&#39;] = True</span>
<span class="sd">            &gt;&gt;&gt; model._behavior[&#39;buffered&#39;] = False</span>
<span class="sd">            &gt;&gt;&gt; model.init_arch()</span>
<span class="sd">            &gt;&gt;&gt; model.learn_state.init()</span>
<span class="sd">            &gt;&gt;&gt; batch_size = 16</span>
<span class="sd">            &gt;&gt;&gt; X_learn, y_learn = dataset.subset(&#39;test&#39;)</span>
<span class="sd">            &gt;&gt;&gt; model.ensure_data_params(X_learn, y_learn)</span>
<span class="sd">            &gt;&gt;&gt; class_to_weight = model.data_params[&#39;class_to_weight&#39;]</span>
<span class="sd">            &gt;&gt;&gt; class_to_weight.take(y_learn)</span>
<span class="sd">            &gt;&gt;&gt; w_learn = class_to_weight.take(y_learn).astype(np.float32)</span>
<span class="sd">            &gt;&gt;&gt; model._new_fit_session()</span>
<span class="sd">            &gt;&gt;&gt; theano_backprop = model.build_backprop_func()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">buffered</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_behavior</span><span class="p">[</span><span class="s1">&#39;buffered&#39;</span><span class="p">]</span>
        <span class="n">augment_on</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;augment_on&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">epoch</span> <span class="o">&lt;=</span> <span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="s1">&#39;augment_delay&#39;</span><span class="p">]:</span>
            <span class="c1"># Dont augment in the first few epochs so the model can start to</span>
            <span class="c1"># get somewhere. This will hopefully help training initialize</span>
            <span class="c1"># faster.</span>
            <span class="n">augment_on</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">learn_outputs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">process_batch</span><span class="p">(</span>
            <span class="n">theano_backprop</span><span class="p">,</span>
            <span class="n">X_learn</span><span class="p">,</span>
            <span class="n">y_learn</span><span class="p">,</span>
            <span class="n">w_learn</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">augment_on</span><span class="o">=</span><span class="n">augment_on</span><span class="p">,</span>
            <span class="n">buffered</span><span class="o">=</span><span class="n">buffered</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># average loss over all learning batches</span>
        <span class="n">learn_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">learn_info</span><span class="p">[</span><span class="s1">&#39;learn_loss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">learn_outputs</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">learn_info</span><span class="p">[</span><span class="s1">&#39;learn_loss_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">learn_outputs</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;loss_reg&#39;</span> <span class="ow">in</span> <span class="n">learn_outputs</span><span class="p">:</span>
            <span class="c1"># Regularization information</span>
            <span class="n">learn_info</span><span class="p">[</span><span class="s1">&#39;learn_loss_reg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">learn_outputs</span><span class="p">[</span><span class="s1">&#39;loss_reg&#39;</span><span class="p">]</span>
            <span class="n">reg_amount</span> <span class="o">=</span> <span class="n">learn_outputs</span><span class="p">[</span><span class="s1">&#39;loss_reg&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">learn_outputs</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span>
            <span class="n">reg_ratio</span> <span class="o">=</span> <span class="n">reg_amount</span> <span class="o">/</span> <span class="n">learn_outputs</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span>
            <span class="n">reg_percent</span> <span class="o">=</span> <span class="n">reg_amount</span> <span class="o">/</span> <span class="n">learn_outputs</span><span class="p">[</span><span class="s1">&#39;loss_reg&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s1">&#39;accuracy&#39;</span> <span class="ow">in</span> <span class="n">learn_outputs</span><span class="p">:</span>
                <span class="n">learn_info</span><span class="p">[</span><span class="s1">&#39;learn_acc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">learn_outputs</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">learn_info</span><span class="p">[</span><span class="s1">&#39;learn_acc_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">learn_outputs</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;predictions&#39;</span> <span class="ow">in</span> <span class="n">learn_outputs</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">p</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">precision_recall_fscore_support</span><span class="p">(</span>
                        <span class="n">y_true</span><span class="o">=</span><span class="n">learn_outputs</span><span class="p">[</span><span class="s1">&#39;auglbl_list&#39;</span><span class="p">],</span>
                        <span class="n">y_pred</span><span class="o">=</span><span class="n">learn_outputs</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">],</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">p</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
                <span class="c1"># report = sklearn.metrics.classification_report(</span>
                <span class="c1">#    y_true=learn_outputs[&#39;auglbl_list&#39;], y_pred=learn_outputs[&#39;predictions&#39;]</span>
                <span class="c1"># )</span>
                <span class="n">learn_info</span><span class="p">[</span><span class="s1">&#39;learn_precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
                <span class="n">learn_info</span><span class="p">[</span><span class="s1">&#39;learn_recall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
                <span class="n">learn_info</span><span class="p">[</span><span class="s1">&#39;learn_fscore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span>
                <span class="n">learn_info</span><span class="p">[</span><span class="s1">&#39;learn_support&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>

            <span class="n">learn_info</span><span class="p">[</span><span class="s1">&#39;reg_percent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg_percent</span>
            <span class="n">learn_info</span><span class="p">[</span><span class="s1">&#39;reg_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg_ratio</span>

        <span class="n">param_update_mags</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">learn_outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;param_update_magnitude_&#39;</span><span class="p">):</span>
                <span class="n">key_</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;param_update_magnitude_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">param_update_mags</span><span class="p">[</span><span class="n">key_</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">val</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">param_update_mags</span><span class="p">:</span>
            <span class="n">learn_info</span><span class="p">[</span><span class="s1">&#39;param_update_mags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_update_mags</span>

        <span class="c1"># If the training loss is nan, the training has diverged</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">learn_info</span><span class="p">[</span><span class="s1">&#39;learn_loss&#39;</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[train] train loss is Nan. training diverged</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;learn_outputs = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">learn_outputs</span><span class="p">,))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[train] train loss is Nan. training diverged</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            from wbia_cnn import draw_net</span>
<span class="sd">            draw_net.imwrite_theano_symbolic_graph(theano_backprop)</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># imwrite_theano_symbolic_graph(thean_expr):</span>
            <span class="n">learn_info</span><span class="p">[</span><span class="s1">&#39;diverged&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">learn_info</span></div>

<div class="viewcode-block" id="_ModelFitter._epoch_validate_learn"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelFitter._epoch_validate_learn">[docs]</a>    <span class="k">def</span> <span class="nf">_epoch_validate_learn</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">theano_forward</span><span class="p">,</span> <span class="n">X_learn</span><span class="p">,</span> <span class="n">y_learn</span><span class="p">,</span> <span class="n">w_learn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forwards propagate -- Run validation set through the forwards pass</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">augment_on</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;augment_on_validate&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">learn_outputs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">process_batch</span><span class="p">(</span>
            <span class="n">theano_forward</span><span class="p">,</span> <span class="n">X_learn</span><span class="p">,</span> <span class="n">y_learn</span><span class="p">,</span> <span class="n">w_learn</span><span class="p">,</span> <span class="n">augment_on</span><span class="o">=</span><span class="n">augment_on</span>
        <span class="p">)</span>
        <span class="c1"># average loss over all learning batches</span>
        <span class="n">learn_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">learn_info</span><span class="p">[</span><span class="s1">&#39;learn_loss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">learn_outputs</span><span class="p">[</span><span class="s1">&#39;loss_determ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">learn_info</span><span class="p">[</span><span class="s1">&#39;learn_loss_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">learn_outputs</span><span class="p">[</span><span class="s1">&#39;loss_determ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;loss_reg&#39;</span> <span class="ow">in</span> <span class="n">learn_outputs</span><span class="p">:</span>
            <span class="c1"># Regularization information</span>
            <span class="n">learn_info</span><span class="p">[</span><span class="s1">&#39;learn_loss_reg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">learn_outputs</span><span class="p">[</span><span class="s1">&#39;loss_reg&#39;</span><span class="p">]</span>
            <span class="n">reg_amount</span> <span class="o">=</span> <span class="n">learn_outputs</span><span class="p">[</span><span class="s1">&#39;loss_reg&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">learn_outputs</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span>
            <span class="n">reg_ratio</span> <span class="o">=</span> <span class="n">reg_amount</span> <span class="o">/</span> <span class="n">learn_outputs</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span>
            <span class="n">reg_percent</span> <span class="o">=</span> <span class="n">reg_amount</span> <span class="o">/</span> <span class="n">learn_outputs</span><span class="p">[</span><span class="s1">&#39;loss_reg&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s1">&#39;accuracy&#39;</span> <span class="ow">in</span> <span class="n">learn_outputs</span><span class="p">:</span>
                <span class="n">learn_info</span><span class="p">[</span><span class="s1">&#39;learn_acc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">learn_outputs</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">learn_info</span><span class="p">[</span><span class="s1">&#39;learn_acc_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">learn_outputs</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;predictions&#39;</span> <span class="ow">in</span> <span class="n">learn_outputs</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">p</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">precision_recall_fscore_support</span><span class="p">(</span>
                        <span class="n">y_true</span><span class="o">=</span><span class="n">learn_outputs</span><span class="p">[</span><span class="s1">&#39;auglbl_list&#39;</span><span class="p">],</span>
                        <span class="n">y_pred</span><span class="o">=</span><span class="n">learn_outputs</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">],</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">p</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
                <span class="c1"># report = sklearn.metrics.classification_report(</span>
                <span class="c1">#    y_true=learn_outputs[&#39;auglbl_list&#39;], y_pred=learn_outputs[&#39;predictions&#39;]</span>
                <span class="c1"># )</span>
                <span class="n">learn_info</span><span class="p">[</span><span class="s1">&#39;learn_precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
                <span class="n">learn_info</span><span class="p">[</span><span class="s1">&#39;learn_recall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
                <span class="n">learn_info</span><span class="p">[</span><span class="s1">&#39;learn_fscore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span>
                <span class="n">learn_info</span><span class="p">[</span><span class="s1">&#39;learn_support&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>

            <span class="n">learn_info</span><span class="p">[</span><span class="s1">&#39;reg_percent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg_percent</span>
            <span class="n">learn_info</span><span class="p">[</span><span class="s1">&#39;reg_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg_ratio</span>

        <span class="n">param_update_mags</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">learn_outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;param_update_magnitude_&#39;</span><span class="p">):</span>
                <span class="n">key_</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;param_update_magnitude_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">param_update_mags</span><span class="p">[</span><span class="n">key_</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">val</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">param_update_mags</span><span class="p">:</span>
            <span class="n">learn_info</span><span class="p">[</span><span class="s1">&#39;param_update_mags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_update_mags</span>
        <span class="k">return</span> <span class="n">learn_info</span></div>

<div class="viewcode-block" id="_ModelFitter._epoch_validate"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelFitter._epoch_validate">[docs]</a>    <span class="k">def</span> <span class="nf">_epoch_validate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">theano_forward</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">,</span> <span class="n">w_valid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forwards propagate -- Run validation set through the forwards pass</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">augment_on</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;augment_on_validate&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">valid_outputs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">process_batch</span><span class="p">(</span>
            <span class="n">theano_forward</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">,</span> <span class="n">w_valid</span><span class="p">,</span> <span class="n">augment_on</span><span class="o">=</span><span class="n">augment_on</span>
        <span class="p">)</span>
        <span class="n">valid_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">valid_info</span><span class="p">[</span><span class="s1">&#39;valid_loss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_outputs</span><span class="p">[</span><span class="s1">&#39;loss_determ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">valid_info</span><span class="p">[</span><span class="s1">&#39;valid_loss_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_outputs</span><span class="p">[</span><span class="s1">&#39;loss_determ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;valid_acc&#39;</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">requested_headers</span><span class="p">:</span>
            <span class="n">valid_info</span><span class="p">[</span><span class="s1">&#39;valid_acc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_outputs</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">valid_info</span><span class="p">[</span><span class="s1">&#39;valid_acc_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_outputs</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;predictions&#39;</span> <span class="ow">in</span> <span class="n">valid_outputs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">precision_recall_fscore_support</span><span class="p">(</span>
                    <span class="n">y_true</span><span class="o">=</span><span class="n">valid_outputs</span><span class="p">[</span><span class="s1">&#39;auglbl_list&#39;</span><span class="p">],</span>
                    <span class="n">y_pred</span><span class="o">=</span><span class="n">valid_outputs</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">p</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
            <span class="n">valid_info</span><span class="p">[</span><span class="s1">&#39;valid_precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
            <span class="n">valid_info</span><span class="p">[</span><span class="s1">&#39;valid_recall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
            <span class="n">valid_info</span><span class="p">[</span><span class="s1">&#39;valid_fscore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span>
            <span class="n">valid_info</span><span class="p">[</span><span class="s1">&#39;valid_support&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
        <span class="k">return</span> <span class="n">valid_info</span></div>

<div class="viewcode-block" id="_ModelFitter._epoch_clean"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelFitter._epoch_clean">[docs]</a>    <span class="k">def</span> <span class="nf">_epoch_clean</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">theano_forward</span><span class="p">,</span> <span class="n">X_general</span><span class="p">,</span> <span class="n">y_general</span><span class="p">,</span> <span class="n">w_general</span><span class="p">,</span> <span class="n">conf_thresh</span><span class="o">=</span><span class="mf">0.95</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forwards propogate -- Run set through the forwards pass and clean</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">augment_on</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;augment_on_validate&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">valid_outputs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">process_batch</span><span class="p">(</span>
            <span class="n">theano_forward</span><span class="p">,</span> <span class="n">X_general</span><span class="p">,</span> <span class="n">y_general</span><span class="p">,</span> <span class="n">w_general</span><span class="p">,</span> <span class="n">augment_on</span><span class="o">=</span><span class="n">augment_on</span>
        <span class="p">)</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">valid_outputs</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
        <span class="n">confidences</span> <span class="o">=</span> <span class="n">valid_outputs</span><span class="p">[</span><span class="s1">&#39;confidences&#39;</span><span class="p">]</span>
        <span class="n">y_cleaned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">pred</span> <span class="k">if</span> <span class="n">y</span> <span class="o">!=</span> <span class="n">pred</span> <span class="ow">and</span> <span class="n">conf</span> <span class="o">&gt;</span> <span class="n">conf_thresh</span> <span class="k">else</span> <span class="n">y</span>
                <span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">conf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">y_general</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">confidences</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">num_cleaned</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">y_general</span> <span class="o">!=</span> <span class="n">y_cleaned</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cleaned </span><span class="si">%d</span><span class="s1"> instances&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_cleaned</span><span class="p">,))</span>
        <span class="k">return</span> <span class="n">y_cleaned</span></div>

<div class="viewcode-block" id="_ModelFitter.dump_cases"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelFitter.dump_cases">[docs]</a>    <span class="k">def</span> <span class="nf">dump_cases</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">subset_id</span><span class="o">=</span><span class="s1">&#39;unknown&#39;</span><span class="p">,</span> <span class="n">dpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For each class find:</span>
<span class="sd">            * the most-hard  failures</span>
<span class="sd">            * the mid-level failures</span>
<span class="sd">            * the critical cases (least-hard failures / most-hard successes)</span>
<span class="sd">            * the mid-level successes</span>
<span class="sd">            * the least-hard successs</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dumping </span><span class="si">%s</span><span class="s1"> cases&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">subset_id</span><span class="p">,))</span>
        <span class="c1"># pd.set_option(&quot;display.max_rows&quot;, 20)</span>
        <span class="c1"># pd.set_option(&quot;display.precision&quot;, 2)</span>
        <span class="c1"># pd.set_option(&#39;expand_frame_repr&#39;, False)</span>
        <span class="c1"># pd.set_option(&#39;display.float_format&#39;, lambda x: &#39;%.2f&#39; % x)</span>

        <span class="k">if</span> <span class="n">dpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dpath</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_fit_session</span><span class="p">[</span><span class="s1">&#39;session_dpath&#39;</span><span class="p">]</span>
        <span class="n">case_dpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">((</span><span class="n">dpath</span><span class="p">,</span> <span class="s1">&#39;cases&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">hist_id</span><span class="p">,</span> <span class="n">subset_id</span><span class="p">))</span>

        <span class="n">y_true</span> <span class="o">=</span> <span class="n">y</span>
        <span class="n">netout</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">y_conf</span> <span class="o">=</span> <span class="n">netout</span><span class="p">[</span><span class="s1">&#39;network_output_determ&#39;</span><span class="p">]</span>
        <span class="n">data_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_conf</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">class_idxs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
            <span class="n">class_lbls</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">classes_</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">class_idxs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">output_dims</span><span class="p">))</span>
            <span class="n">class_lbls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">output_dims</span><span class="p">))</span>
        <span class="n">target_classes</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">class_lbls</span><span class="p">,</span> <span class="n">class_idxs</span><span class="p">)</span>

        <span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data_idx</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;data_idx&#39;</span><span class="p">)</span>
        <span class="n">decision</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">y_conf</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">target_classes</span><span class="p">)</span>

        <span class="n">easiness</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">ziptake</span><span class="p">(</span><span class="n">decision</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">y_true</span><span class="p">))</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pred&#39;</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;easiness&#39;</span><span class="p">]</span>
        <span class="n">column_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">easiness</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">column_data</span><span class="p">))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;failed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pred&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">target_partition</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
            <span class="n">df_chunk</span> <span class="o">=</span> <span class="n">df</span> <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">target</span><span class="p">]</span>
            <span class="n">df_chunk</span> <span class="o">=</span> <span class="n">df_chunk</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">df_chunk</span><span class="p">[</span><span class="s1">&#39;easiness&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">df_chunk</span>

        <span class="k">def</span> <span class="nf">snapped_slice</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="n">frac</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="n">frac</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">stop</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">:</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">stop</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">start</span>
            <span class="n">stop</span> <span class="o">+=</span> <span class="n">buf</span>
            <span class="n">start</span> <span class="o">+=</span> <span class="n">buf</span>
            <span class="k">assert</span> <span class="n">stop</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">,</span> <span class="s1">&#39;out of bounds&#39;</span>
            <span class="n">sl</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">sl</span>

        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">class_idxs</span><span class="p">:</span>
            <span class="n">class_case_dpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">((</span><span class="n">case_dpath</span><span class="p">,</span> <span class="s1">&#39;class_</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">y</span><span class="p">,)))</span>
            <span class="n">df_chunk</span> <span class="o">=</span> <span class="n">target_partition</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="c1"># Find the first failure</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">df_chunk</span><span class="p">[</span><span class="s1">&#39;failed&#39;</span><span class="p">]):</span>
                <span class="n">critical_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_chunk</span><span class="p">[</span><span class="s1">&#39;failed&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">critical_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">critical_frac</span> <span class="o">=</span> <span class="n">critical_index</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_chunk</span><span class="p">)</span>
            <span class="n">midlevel_easy</span> <span class="o">=</span> <span class="n">critical_frac</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">midlevel_hard</span> <span class="o">=</span> <span class="n">critical_frac</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">critical_frac</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="c1"># 0 is easy, 1 is hard</span>
            <span class="n">fracs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">midlevel_easy</span><span class="p">,</span> <span class="n">critical_frac</span><span class="p">,</span> <span class="n">midlevel_hard</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_chunk</span><span class="p">)</span>
            <span class="n">slices</span> <span class="o">=</span> <span class="p">[</span><span class="n">snapped_slice</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">frac</span> <span class="ow">in</span> <span class="n">fracs</span><span class="p">]</span>

            <span class="n">hard_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
                    <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">*</span><span class="n">sl</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_chunk</span><span class="p">))))</span> <span class="k">for</span> <span class="n">sl</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">hard_frac</span> <span class="o">=</span> <span class="n">hard_idx</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_chunk</span><span class="p">)</span>
            <span class="n">selected</span> <span class="o">=</span> <span class="n">df_chunk</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">hard_idx</span><span class="p">]</span>

            <span class="n">selected</span><span class="p">[</span><span class="s1">&#39;hard_idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hard_idx</span>
            <span class="n">selected</span><span class="p">[</span><span class="s1">&#39;hard_frac&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hard_frac</span>

            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">selected</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">type_</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;failed&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;success&#39;</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;hardidx_</span><span class="si">%04d</span><span class="s1">_hardfrac_</span><span class="si">%.2f</span><span class="s1">_pred_</span><span class="si">%d</span><span class="s1">_case_</span><span class="si">%s</span><span class="s1">.jpg&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">row</span><span class="p">[</span><span class="s1">&#39;hard_idx&#39;</span><span class="p">],</span>
                    <span class="n">row</span><span class="p">[</span><span class="s1">&#39;hard_frac&#39;</span><span class="p">],</span>
                    <span class="n">row</span><span class="p">[</span><span class="s1">&#39;pred&#39;</span><span class="p">],</span>
                    <span class="n">type_</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">class_case_dpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
                <span class="n">vt</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="_BatchUtility"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._BatchUtility">[docs]</a><span class="nd">@ut</span><span class="o">.</span><span class="n">reloadable_class</span>
<span class="k">class</span> <span class="nc">_BatchUtility</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="_BatchUtility.expand_data_indicies"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._BatchUtility.expand_data_indicies">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">expand_data_indicies</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">label_idx</span><span class="p">,</span> <span class="n">data_per_label</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        when data_per_label &gt; 1, gives the corresponding data indicies for the</span>
<span class="sd">        data indicies</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">expanded_idx</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">label_idx</span> <span class="o">*</span> <span class="n">data_per_label</span> <span class="o">+</span> <span class="n">count</span> <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data_per_label</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">data_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">expanded_idx</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">data_idx</span></div>

<div class="viewcode-block" id="_BatchUtility.shuffle_input"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._BatchUtility.shuffle_input">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">shuffle_input</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">data_per_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_rng</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span>
        <span class="n">num_labels</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">data_per_label</span>
        <span class="n">label_idx</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">random_indexes</span><span class="p">(</span><span class="n">num_labels</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
        <span class="n">data_idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">expand_data_indicies</span><span class="p">(</span><span class="n">label_idx</span><span class="p">,</span> <span class="n">data_per_label</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">data_idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">label_idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">label_idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span></div>

<div class="viewcode-block" id="_BatchUtility.slice_batch"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._BatchUtility.slice_batch">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">slice_batch</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">batch_index</span><span class="p">,</span> <span class="n">data_per_label</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">wraparound</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="n">start_x</span> <span class="o">=</span> <span class="n">batch_index</span> <span class="o">*</span> <span class="n">batch_size</span>
        <span class="n">end_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_size</span>
        <span class="c1"># Take full batch of images and take the fraction of labels if</span>
        <span class="c1"># data_per_label &gt; 1</span>
        <span class="n">x_sl</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start_x</span><span class="p">,</span> <span class="n">end_x</span><span class="p">)</span>
        <span class="n">y_sl</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start_x</span> <span class="o">//</span> <span class="n">data_per_label</span><span class="p">,</span> <span class="n">end_x</span> <span class="o">//</span> <span class="n">data_per_label</span><span class="p">)</span>
        <span class="n">Xb</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">x_sl</span><span class="p">]</span>
        <span class="n">yb</span> <span class="o">=</span> <span class="n">y</span> <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">y</span><span class="p">[</span><span class="n">y_sl</span><span class="p">]</span>
        <span class="n">wb</span> <span class="o">=</span> <span class="n">w</span> <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">w</span><span class="p">[</span><span class="n">y_sl</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">wraparound</span><span class="p">:</span>
            <span class="c1"># Append extra data to ensure the batch size is full</span>
            <span class="k">if</span> <span class="n">Xb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">batch_size</span><span class="p">:</span>
                <span class="n">extra</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="n">Xb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">Xb_wrap</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">extra</span><span class="p">)]</span>
                <span class="n">Xb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">Xb</span><span class="p">,</span> <span class="n">Xb_wrap</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">yb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">yb_wrap</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">extra</span> <span class="o">//</span> <span class="n">data_per_label</span><span class="p">)]</span>
                    <span class="n">yb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">yb</span><span class="p">,</span> <span class="n">yb_wrap</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">wb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">wb_wrap</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">extra</span> <span class="o">//</span> <span class="n">data_per_label</span><span class="p">)]</span>
                    <span class="n">wb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">wb</span><span class="p">,</span> <span class="n">wb_wrap</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Xb</span><span class="p">,</span> <span class="n">yb</span><span class="p">,</span> <span class="n">wb</span></div>

<div class="viewcode-block" id="_BatchUtility._pad_labels"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._BatchUtility._pad_labels">[docs]</a>    <span class="k">def</span> <span class="nf">_pad_labels</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">yb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        # TODO: FIX data_per_label_input ISSUES</span>
<span class="sd">        # most models will do the padding implicitly</span>
<span class="sd">        # in the layer architecture</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pad_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">yb</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">data_per_label_input</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">yb_buffer</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">pad_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">yb</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">yb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">yb</span><span class="p">,</span> <span class="n">yb_buffer</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">yb</span></div>

<div class="viewcode-block" id="_BatchUtility._stack_outputs"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._BatchUtility._stack_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">_stack_outputs</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">theano_fn</span><span class="p">,</span> <span class="n">output_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Combines outputs across batches and returns them in a dictionary keyed</span>
<span class="sd">        by the theano variable output name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

        <span class="n">output_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">outexpr</span><span class="o">.</span><span class="n">variable</span> <span class="k">for</span> <span class="n">outexpr</span> <span class="ow">in</span> <span class="n">theano_fn</span><span class="o">.</span><span class="n">outputs</span><span class="p">]</span>
        <span class="n">output_names</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">output_vars</span><span class="p">]</span>
        <span class="n">unstacked_output_gen</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">bop</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="k">for</span> <span class="n">bop</span> <span class="ow">in</span> <span class="n">output_list</span><span class="p">]</span> <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output_names</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">stacked_output_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">vt</span><span class="o">.</span><span class="n">safe_cat</span><span class="p">(</span><span class="n">_output_unstacked</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_output_unstacked</span> <span class="ow">in</span> <span class="n">unstacked_output_gen</span>
        <span class="p">]</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">output_names</span><span class="p">,</span> <span class="n">stacked_output_list</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">outputs</span></div>

<div class="viewcode-block" id="_BatchUtility._unwrap_outputs"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._BatchUtility._unwrap_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">_unwrap_outputs</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="c1"># batch iteration may wrap-around returned data.</span>
        <span class="c1"># slice off the padding</span>
        <span class="n">num_inputs</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">model</span><span class="o">.</span><span class="n">data_per_label_input</span>
        <span class="n">num_outputs</span> <span class="o">=</span> <span class="n">num_inputs</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">data_per_label_output</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">outputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_outputs</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">outputs</span></div></div>


<div class="viewcode-block" id="_ModelBatch"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelBatch">[docs]</a><span class="nd">@ut</span><span class="o">.</span><span class="n">reloadable_class</span>
<span class="k">class</span> <span class="nc">_ModelBatch</span><span class="p">(</span><span class="n">_BatchUtility</span><span class="p">):</span>
<div class="viewcode-block" id="_ModelBatch._init_batch_vars"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelBatch._init_batch_vars">[docs]</a>    <span class="k">def</span> <span class="nf">_init_batch_vars</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">pad_labels</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">model</span><span class="o">.</span><span class="n">X_is_cv2_native</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="_ModelBatch.process_batch"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelBatch.process_batch">[docs]</a>    <span class="k">def</span> <span class="nf">process_batch</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">theano_fn</span><span class="p">,</span>
        <span class="n">X</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">w</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">buffered</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">unwrap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">augment_on</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Execute a theano function on batches of X and y &quot;&quot;&quot;</span>
        <span class="c1"># Break data into generated batches</span>
        <span class="c1"># TODO: sliced batches when there is no shuffling</span>
        <span class="c1"># Create an iterator to generate batches of data</span>
        <span class="n">batch_iter</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">batch_iterator</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span> <span class="n">augment_on</span><span class="o">=</span><span class="n">augment_on</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">buffered</span><span class="p">:</span>
            <span class="n">batch_iter</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">buffered_generator</span><span class="p">(</span><span class="n">batch_iter</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">monitor_config</span><span class="p">[</span><span class="s1">&#39;showprog&#39;</span><span class="p">]:</span>
            <span class="n">num_batches</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">model</span><span class="o">.</span><span class="n">batch_size</span>
            <span class="n">batch_iter</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgIter</span><span class="p">(</span>
                <span class="n">batch_iter</span><span class="p">,</span>
                <span class="n">nTotal</span><span class="o">=</span><span class="n">num_batches</span><span class="p">,</span>
                <span class="n">lbl</span><span class="o">=</span><span class="n">theano_fn</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">freq</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">bs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">adjust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Execute the function with either known or unknown y-targets</span>
        <span class="n">output_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">aug_yb_list</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">Xb</span><span class="p">,</span> <span class="n">yb</span><span class="p">,</span> <span class="n">wb</span> <span class="ow">in</span> <span class="n">batch_iter</span><span class="p">:</span>
                <span class="n">batch_label</span> <span class="o">=</span> <span class="n">theano_fn</span><span class="p">(</span><span class="n">Xb</span><span class="p">)</span>
                <span class="n">output_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_label</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aug_yb_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">Xb</span><span class="p">,</span> <span class="n">yb</span><span class="p">,</span> <span class="n">wb</span> <span class="ow">in</span> <span class="n">batch_iter</span><span class="p">:</span>
                <span class="n">batch_label</span> <span class="o">=</span> <span class="n">theano_fn</span><span class="p">(</span><span class="n">Xb</span><span class="p">,</span> <span class="n">yb</span><span class="p">,</span> <span class="n">wb</span><span class="p">)</span>
                <span class="n">output_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_label</span><span class="p">)</span>
                <span class="n">aug_yb_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yb</span><span class="p">)</span>

        <span class="c1"># Combine results of batches into one big result</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_stack_outputs</span><span class="p">(</span><span class="n">theano_fn</span><span class="p">,</span> <span class="n">output_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Hack in special outputs</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">AbstractVectorVectorModel</span><span class="p">):</span>
                <span class="n">auglbl_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">aug_yb_list</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">AbstractVectorModel</span><span class="p">):</span>
                <span class="n">auglbl_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">aug_yb_list</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">auglbl_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">aug_yb_list</span><span class="p">)</span>
            <span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;auglbl_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auglbl_list</span>
        <span class="k">if</span> <span class="n">unwrap</span><span class="p">:</span>
            <span class="c1"># slice of batch induced padding</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_unwrap_outputs</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outputs</span></div>

<div class="viewcode-block" id="_ModelBatch.batch_iterator"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelBatch.batch_iterator">[docs]</a>    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">batch_iterator</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">augment_on</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn.models.abstract_models import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn import models</span>
<span class="sd">            &gt;&gt;&gt; model = models.DummyModel(batch_size=16)</span>
<span class="sd">            &gt;&gt;&gt; X, y = model.make_random_testdata(num=37, cv2_format=True)</span>
<span class="sd">            &gt;&gt;&gt; model.ensure_data_params(X, y)</span>
<span class="sd">            &gt;&gt;&gt; result_list = [(Xb, Yb) for Xb, Yb in model.batch_iterator(X, y)]</span>
<span class="sd">            &gt;&gt;&gt; Xb, yb = result_list[0]</span>
<span class="sd">            &gt;&gt;&gt; assert np.all(X[0, :, :, 0] == Xb[0, 0, :, :])</span>
<span class="sd">            &gt;&gt;&gt; result = ut.depth_profile(result_list, compress_consecutive=True)</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">            (7, [(16, 1, 4, 4), 16])</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn.models.abstract_models import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn import models</span>
<span class="sd">            &gt;&gt;&gt; model = models.DummyModel(batch_size=16)</span>
<span class="sd">            &gt;&gt;&gt; X, y = model.make_random_testdata(num=37, cv2_format=False, asint=True)</span>
<span class="sd">            &gt;&gt;&gt; model.X_is_cv2_native = False</span>
<span class="sd">            &gt;&gt;&gt; model.ensure_data_params(X, y)</span>
<span class="sd">            &gt;&gt;&gt; result_list = [(Xb, Yb) for Xb, Yb in model.batch_iterator(X, y)]</span>
<span class="sd">            &gt;&gt;&gt; Xb, yb = result_list[0]</span>
<span class="sd">            &gt;&gt;&gt; assert np.all(np.isclose(X[0] / 255, Xb[0]))</span>
<span class="sd">            &gt;&gt;&gt; result = depth</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># need to be careful with batchsizes if directly specified to theano</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">batch_size</span>
        <span class="n">data_per_label</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">data_per_label_input</span>
        <span class="n">wraparound</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_validate_labels</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>

        <span class="n">num_batches</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span>

        <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
            <span class="n">rng</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_rng</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">shuffle_input</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">data_per_label</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>

        <span class="n">is_int</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">is_int</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">is_cv2</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">X_is_cv2_native</span>
        <span class="n">whiten_on</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="s1">&#39;whiten_on&#39;</span><span class="p">]</span>

        <span class="c1"># Slice and preprocess data in batch</span>
        <span class="k">for</span> <span class="n">batch_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_batches</span><span class="p">):</span>
            <span class="c1"># Take a slice from the data</span>
            <span class="n">Xb_</span><span class="p">,</span> <span class="n">yb_</span><span class="p">,</span> <span class="n">wb_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">slice_batch</span><span class="p">(</span>
                <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">batch_index</span><span class="p">,</span> <span class="n">data_per_label</span><span class="p">,</span> <span class="n">wraparound</span>
            <span class="p">)</span>
            <span class="c1"># Prepare data for the GPU</span>
            <span class="n">Xb</span><span class="p">,</span> <span class="n">yb</span><span class="p">,</span> <span class="n">wb</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_prepare_batch</span><span class="p">(</span>
                <span class="n">Xb_</span><span class="p">,</span>
                <span class="n">yb_</span><span class="p">,</span>
                <span class="n">wb_</span><span class="p">,</span>
                <span class="n">is_int</span><span class="o">=</span><span class="n">is_int</span><span class="p">,</span>
                <span class="n">is_cv2</span><span class="o">=</span><span class="n">is_cv2</span><span class="p">,</span>
                <span class="n">augment_on</span><span class="o">=</span><span class="n">augment_on</span><span class="p">,</span>
                <span class="n">whiten_on</span><span class="o">=</span><span class="n">whiten_on</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">yield</span> <span class="n">Xb</span><span class="p">,</span> <span class="n">yb</span><span class="p">,</span> <span class="n">wb</span></div>

<div class="viewcode-block" id="_ModelBatch._prepare_batch"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelBatch._prepare_batch">[docs]</a>    <span class="k">def</span> <span class="nf">_prepare_batch</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">Xb_</span><span class="p">,</span> <span class="n">yb_</span><span class="p">,</span> <span class="n">wb_</span><span class="p">,</span> <span class="n">is_int</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_cv2</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">augment_on</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">whiten_on</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">augment_on</span><span class="p">:</span>
            <span class="n">has_encoder</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">yb_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">yb_</span><span class="p">)</span> <span class="k">if</span> <span class="n">has_encoder</span> <span class="k">else</span> <span class="n">yb_</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="s1">&#39;augment_weights&#39;</span><span class="p">]:</span>
                <span class="n">Xb_</span><span class="p">,</span> <span class="n">yb_</span><span class="p">,</span> <span class="n">wb_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">augment</span><span class="p">(</span><span class="n">Xb_</span><span class="p">,</span> <span class="n">yb_</span><span class="p">,</span> <span class="n">wb_</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Xb_</span><span class="p">,</span> <span class="n">yb_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">augment</span><span class="p">(</span><span class="n">Xb_</span><span class="p">,</span> <span class="n">yb_</span><span class="p">)</span>
            <span class="n">yb_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">yb_</span><span class="p">)</span> <span class="k">if</span> <span class="n">has_encoder</span> <span class="k">else</span> <span class="n">yb_</span>
        <span class="n">Xb</span> <span class="o">=</span> <span class="n">Xb_</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">yb</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">yb_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">yb_</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">wb</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">wb_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">wb_</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_int</span><span class="p">:</span>
            <span class="c1"># Rescale the batch data to the range 0 to 1</span>
            <span class="n">Xb</span> <span class="o">=</span> <span class="n">Xb</span> <span class="o">/</span> <span class="mf">255.0</span>
        <span class="k">if</span> <span class="n">whiten_on</span><span class="p">:</span>
            <span class="n">mean</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;center_mean&#39;</span><span class="p">]</span>
            <span class="n">std</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;center_std&#39;</span><span class="p">]</span>
            <span class="c1"># assert np.all(mean &lt;= 1.0)</span>
            <span class="c1"># assert np.all(std &lt;= 1.0)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">Xb</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">Xb</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">Xb</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">Xb</span><span class="p">)</span>
            <span class="c1"># Xb = (Xb - mean) / (std)</span>
        <span class="k">if</span> <span class="n">is_cv2</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">Xb</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># Convert from cv2 to lasagne format</span>
            <span class="n">Xb</span> <span class="o">=</span> <span class="n">Xb</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">yb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># if encoder is not None:</span>
            <span class="c1">#     # Apply an encoding if applicable</span>
            <span class="c1">#     yb = encoder.transform(yb).astype(np.int32)</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">data_per_label_input</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">model</span><span class="o">.</span><span class="n">pad_labels</span><span class="p">:</span>
                <span class="c1"># Pad data for siamese networks</span>
                <span class="n">yb</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_pad_labels</span><span class="p">(</span><span class="n">yb</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Xb</span><span class="p">,</span> <span class="n">yb</span><span class="p">,</span> <span class="n">wb</span></div>

<div class="viewcode-block" id="_ModelBatch.prepare_data"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelBatch.prepare_data">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_data</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; convenience function for external use &quot;&quot;&quot;</span>
        <span class="n">is_int</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">is_int</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">is_cv2</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">X_is_cv2_native</span>
        <span class="n">whiten_on</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="s1">&#39;whiten_on&#39;</span><span class="p">]</span>
        <span class="n">Xb</span><span class="p">,</span> <span class="n">yb</span><span class="p">,</span> <span class="n">wb</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_prepare_batch</span><span class="p">(</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">is_int</span><span class="o">=</span><span class="n">is_int</span><span class="p">,</span> <span class="n">is_cv2</span><span class="o">=</span><span class="n">is_cv2</span><span class="p">,</span> <span class="n">whiten_on</span><span class="o">=</span><span class="n">whiten_on</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Xb</span>
        <span class="k">elif</span> <span class="n">w</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Xb</span><span class="p">,</span> <span class="n">yb</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Xb</span><span class="p">,</span> <span class="n">yb</span><span class="p">,</span> <span class="n">wb</span></div></div>


<div class="viewcode-block" id="_ModelPredicter"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelPredicter">[docs]</a><span class="k">class</span> <span class="nc">_ModelPredicter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="_ModelPredicter._predict"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelPredicter._predict">[docs]</a>    <span class="k">def</span> <span class="nf">_predict</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns all prediction outputs of the network in a dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[train] --- MODEL INFO ---&#39;</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">print_arch_str</span><span class="p">()</span>
            <span class="n">model</span><span class="o">.</span><span class="n">print_layer_info</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[test] predict with batch size </span><span class="si">%0.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">batch_size</span><span class="p">))</span>
        <span class="c1"># create theano symbolic expressions that define the network</span>
        <span class="n">theano_predict</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">build_predict_func</span><span class="p">()</span>
        <span class="c1"># Begin testing with the neural network</span>
        <span class="n">test_outputs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">process_batch</span><span class="p">(</span><span class="n">theano_predict</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">unwrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">test_outputs</span></div>

<div class="viewcode-block" id="_ModelPredicter.predict_proba"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelPredicter.predict_proba">[docs]</a>    <span class="k">def</span> <span class="nf">predict_proba</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">):</span>
        <span class="n">test_outputs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
        <span class="n">y_proba</span> <span class="o">=</span> <span class="n">test_outputs</span><span class="p">[</span><span class="s1">&#39;network_output_determ&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">y_proba</span></div>

<div class="viewcode-block" id="_ModelPredicter.predict_proba_Xb"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelPredicter.predict_proba_Xb">[docs]</a>    <span class="k">def</span> <span class="nf">predict_proba_Xb</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">Xb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Accepts prepared inputs &quot;&quot;&quot;</span>
        <span class="n">theano_predict</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">build_predict_func</span><span class="p">()</span>
        <span class="n">batch_label</span> <span class="o">=</span> <span class="n">theano_predict</span><span class="p">(</span><span class="n">Xb</span><span class="p">)</span>
        <span class="n">output_names</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">outexpr</span><span class="o">.</span><span class="n">variable</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">outexpr</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">outexpr</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">name</span>
            <span class="k">for</span> <span class="n">outexpr</span> <span class="ow">in</span> <span class="n">theano_predict</span><span class="o">.</span><span class="n">outputs</span>
        <span class="p">]</span>
        <span class="n">test_outputs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">output_names</span><span class="p">,</span> <span class="n">batch_label</span><span class="p">))</span>
        <span class="n">y_proba</span> <span class="o">=</span> <span class="n">test_outputs</span><span class="p">[</span><span class="s1">&#39;network_output_determ&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">y_proba</span></div>

<div class="viewcode-block" id="_ModelPredicter.predict"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelPredicter.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_test</span><span class="p">):</span>
        <span class="n">test_outputs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
        <span class="n">y_predict</span> <span class="o">=</span> <span class="n">test_outputs</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">y_predict</span></div></div>


<div class="viewcode-block" id="_ModelBackend"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelBackend">[docs]</a><span class="k">class</span> <span class="nc">_ModelBackend</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Functions that build and compile theano exepressions</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="_ModelBackend._init_compile_vars"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelBackend._init_compile_vars">[docs]</a>    <span class="k">def</span> <span class="nf">_init_compile_vars</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_theano_exprs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ddict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_theano_backprop</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_theano_forward</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_theano_predict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_theano_mode</span> <span class="o">=</span> <span class="kc">None</span></div>
        <span class="c1"># theano.compile.FAST_COMPILE</span>
        <span class="c1"># theano.compile.FAST_RUN</span>

<div class="viewcode-block" id="_ModelBackend.build"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelBackend.build">[docs]</a>    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[model] --- BUILDING SYMBOLIC THEANO FUNCTIONS ---&#39;</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">build_backprop_func</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">build_forward_func</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">build_predict_func</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[model] --- FINISHED BUILD ---&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="_ModelBackend.build_predict_func"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelBackend.build_predict_func">[docs]</a>    <span class="k">def</span> <span class="nf">build_predict_func</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Computes predictions given unlabeled data &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_theano_predict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[model.build] request_predict&#39;</span><span class="p">)</span>
            <span class="n">netout_exprs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_get_network_output</span><span class="p">()</span>
            <span class="n">network_output_determ</span> <span class="o">=</span> <span class="n">netout_exprs</span><span class="p">[</span><span class="s1">&#39;network_output_determ&#39;</span><span class="p">]</span>
            <span class="n">unlabeled_outputs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_get_unlabeled_outputs</span><span class="p">()</span>

            <span class="n">fn_inputs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_theano_fn_inputs</span>
            <span class="n">X_batch</span><span class="p">,</span> <span class="n">X_given</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fn_inputs</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;X_batch&#39;</span><span class="p">,</span> <span class="s1">&#39;X_given&#39;</span><span class="p">])</span>

            <span class="n">theano_predict</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">function</span><span class="p">(</span>
                <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">theano</span><span class="o">.</span><span class="n">In</span><span class="p">(</span><span class="n">X_batch</span><span class="p">)],</span>
                <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">network_output_determ</span><span class="p">]</span> <span class="o">+</span> <span class="n">unlabeled_outputs</span><span class="p">,</span>
                <span class="n">givens</span><span class="o">=</span><span class="p">{</span><span class="n">X_given</span><span class="p">:</span> <span class="n">X_batch</span><span class="p">},</span>
                <span class="n">updates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">_theano_mode</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;:predict&#39;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_theano_predict</span> <span class="o">=</span> <span class="n">theano_predict</span>
        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">_theano_predict</span></div>

<div class="viewcode-block" id="_ModelBackend.build_forward_func"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelBackend.build_forward_func">[docs]</a>    <span class="k">def</span> <span class="nf">build_forward_func</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes loss, but does not learn.</span>
<span class="sd">        Returns diagnostic information.</span>

<span class="sd">        Ignore:</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn.models.abstract_models import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn.models import mnist</span>
<span class="sd">            &gt;&gt;&gt; import theano</span>
<span class="sd">            &gt;&gt;&gt; model, dataset = mnist.testdata_mnist(dropout=.5)</span>
<span class="sd">            &gt;&gt;&gt; model.init_arch()</span>
<span class="sd">            &gt;&gt;&gt; batch_size = 16</span>
<span class="sd">            &gt;&gt;&gt; model.learn_state.init()</span>
<span class="sd">            &gt;&gt;&gt; Xb, yb, wb = model._testdata_batch(dataset, batch_size)</span>
<span class="sd">            &gt;&gt;&gt; loss = model._theano_exprs[&#39;loss&#39;] = None</span>
<span class="sd">            &gt;&gt;&gt; loss_item = model._theano_loss_exprs[&#39;loss_item&#39;]</span>
<span class="sd">            &gt;&gt;&gt; X_in = theano.In(model._theano_fn_inputs[&#39;X_batch&#39;])</span>
<span class="sd">            &gt;&gt;&gt; y_in = theano.In(model._theano_fn_inputs[&#39;y_batch&#39;])</span>
<span class="sd">            &gt;&gt;&gt; w_in = theano.In(model._theano_fn_inputs[&#39;w_batch&#39;])</span>
<span class="sd">            &gt;&gt;&gt; loss_batch = loss_item.eval({X_in: Xb, y_in: yb})</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_theano_forward</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[model.build] request_forward&#39;</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">learn_state</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
            <span class="n">fn_inputs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_theano_fn_inputs</span>
            <span class="n">X_batch</span><span class="p">,</span> <span class="n">X_given</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fn_inputs</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;X_batch&#39;</span><span class="p">,</span> <span class="s1">&#39;X_given&#39;</span><span class="p">])</span>
            <span class="n">y_batch</span><span class="p">,</span> <span class="n">y_given</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fn_inputs</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;y_batch&#39;</span><span class="p">,</span> <span class="s1">&#39;y_given&#39;</span><span class="p">])</span>
            <span class="n">w_batch</span><span class="p">,</span> <span class="n">w_given</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fn_inputs</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;w_batch&#39;</span><span class="p">,</span> <span class="s1">&#39;w_given&#39;</span><span class="p">])</span>

            <span class="n">labeled_outputs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_get_labeled_outputs</span><span class="p">()</span>
            <span class="n">unlabeled_outputs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_get_unlabeled_outputs</span><span class="p">()</span>

            <span class="n">loss_exprs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_theano_loss_exprs</span>
            <span class="n">loss_determ</span> <span class="o">=</span> <span class="n">loss_exprs</span><span class="p">[</span><span class="s1">&#39;loss_determ&#39;</span><span class="p">]</span>
            <span class="c1"># loss_std_determ = loss_exprs[&#39;loss_std_determ&#39;]</span>
            <span class="n">forward_losses</span> <span class="o">=</span> <span class="p">[</span><span class="n">loss_determ</span><span class="p">]</span>

            <span class="n">In</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">In</span>
            <span class="n">theano_forward</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">function</span><span class="p">(</span>
                <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">In</span><span class="p">(</span><span class="n">X_batch</span><span class="p">),</span> <span class="n">In</span><span class="p">(</span><span class="n">y_batch</span><span class="p">),</span> <span class="n">In</span><span class="p">(</span><span class="n">w_batch</span><span class="p">)],</span>
                <span class="n">outputs</span><span class="o">=</span><span class="n">forward_losses</span> <span class="o">+</span> <span class="n">labeled_outputs</span> <span class="o">+</span> <span class="n">unlabeled_outputs</span><span class="p">,</span>
                <span class="n">givens</span><span class="o">=</span><span class="p">{</span><span class="n">X_given</span><span class="p">:</span> <span class="n">X_batch</span><span class="p">,</span> <span class="n">y_given</span><span class="p">:</span> <span class="n">y_batch</span><span class="p">,</span> <span class="n">w_given</span><span class="p">:</span> <span class="n">w_batch</span><span class="p">},</span>
                <span class="n">updates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">_theano_mode</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;:feedforward&#39;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_theano_forward</span> <span class="o">=</span> <span class="n">theano_forward</span>
        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">_theano_forward</span></div>

<div class="viewcode-block" id="_ModelBackend.build_backprop_func"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelBackend.build_backprop_func">[docs]</a>    <span class="k">def</span> <span class="nf">build_backprop_func</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes loss and updates model parameters.</span>
<span class="sd">        Returns diagnostic information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_theano_backprop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[model.build] request_backprop&#39;</span><span class="p">)</span>
            <span class="c1"># Must have an initialized learning state</span>
            <span class="n">model</span><span class="o">.</span><span class="n">learn_state</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

            <span class="n">fn_inputs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_theano_fn_inputs</span>
            <span class="n">X_batch</span><span class="p">,</span> <span class="n">X_given</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fn_inputs</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;X_batch&#39;</span><span class="p">,</span> <span class="s1">&#39;X_given&#39;</span><span class="p">])</span>
            <span class="n">y_batch</span><span class="p">,</span> <span class="n">y_given</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fn_inputs</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;y_batch&#39;</span><span class="p">,</span> <span class="s1">&#39;y_given&#39;</span><span class="p">])</span>
            <span class="n">w_batch</span><span class="p">,</span> <span class="n">w_given</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fn_inputs</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;w_batch&#39;</span><span class="p">,</span> <span class="s1">&#39;w_given&#39;</span><span class="p">])</span>

            <span class="n">labeled_outputs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_get_labeled_outputs</span><span class="p">()</span>

            <span class="c1"># Build backprop losses</span>
            <span class="n">loss_exprs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_theano_loss_exprs</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_exprs</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span>
            <span class="c1"># loss_std = loss_exprs[&#39;loss_std&#39;]</span>
            <span class="n">loss_reg</span> <span class="o">=</span> <span class="n">loss_exprs</span><span class="p">[</span><span class="s1">&#39;loss_reg&#39;</span><span class="p">]</span>

            <span class="n">backprop_loss_</span> <span class="o">=</span> <span class="n">loss_reg</span>
            <span class="n">backprop_losses</span> <span class="o">=</span> <span class="p">[</span><span class="n">loss_reg</span><span class="p">,</span> <span class="n">loss</span><span class="p">]</span>

            <span class="c1"># Updates network parameters based on the training loss</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_all_params</span><span class="p">(</span><span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">updates</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_make_updates</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">backprop_loss_</span><span class="p">)</span>
            <span class="n">monitor_outputs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_make_monitor_outputs</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">updates</span><span class="p">)</span>

            <span class="n">In</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">In</span>
            <span class="n">theano_backprop</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">function</span><span class="p">(</span>
                <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">In</span><span class="p">(</span><span class="n">X_batch</span><span class="p">),</span> <span class="n">In</span><span class="p">(</span><span class="n">y_batch</span><span class="p">),</span> <span class="n">In</span><span class="p">(</span><span class="n">w_batch</span><span class="p">)],</span>
                <span class="n">outputs</span><span class="o">=</span><span class="p">(</span><span class="n">backprop_losses</span> <span class="o">+</span> <span class="n">labeled_outputs</span> <span class="o">+</span> <span class="n">monitor_outputs</span><span class="p">),</span>
                <span class="n">givens</span><span class="o">=</span><span class="p">{</span><span class="n">X_given</span><span class="p">:</span> <span class="n">X_batch</span><span class="p">,</span> <span class="n">y_given</span><span class="p">:</span> <span class="n">y_batch</span><span class="p">,</span> <span class="n">w_given</span><span class="p">:</span> <span class="n">w_batch</span><span class="p">},</span>
                <span class="n">updates</span><span class="o">=</span><span class="n">updates</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">_theano_mode</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;:backprop&#39;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_theano_backprop</span> <span class="o">=</span> <span class="n">theano_backprop</span>
        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">_theano_backprop</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_theano_fn_inputs</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_theano_exprs</span><span class="p">[</span><span class="s1">&#39;fn_inputs&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">AbstractVectorVectorModel</span><span class="p">):</span>
                <span class="n">x_type</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">matrix</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x_type</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">tensor4</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">AbstractVectorVectorModel</span><span class="p">):</span>
                <span class="n">y_type</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">ivector</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">AbstractVectorModel</span><span class="p">):</span>
                <span class="n">y_type</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">imatrix</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y_type</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">ivector</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">AbstractVectorVectorModel</span><span class="p">):</span>
                <span class="n">w_type</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">vector</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">AbstractVectorModel</span><span class="p">):</span>
                <span class="n">w_type</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">matrix</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">w_type</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">vector</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[model] Using y_type = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">y_type</span><span class="p">,))</span>

            <span class="n">fn_inputs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="c1"># Data</span>
                <span class="s1">&#39;X_given&#39;</span><span class="p">:</span> <span class="n">x_type</span><span class="p">(</span><span class="s1">&#39;X_given&#39;</span><span class="p">),</span>
                <span class="s1">&#39;X_batch&#39;</span><span class="p">:</span> <span class="n">x_type</span><span class="p">(</span><span class="s1">&#39;X_batch&#39;</span><span class="p">),</span>
                <span class="c1"># Labels</span>
                <span class="s1">&#39;y_given&#39;</span><span class="p">:</span> <span class="n">y_type</span><span class="p">(</span><span class="s1">&#39;y_given&#39;</span><span class="p">),</span>
                <span class="s1">&#39;y_batch&#39;</span><span class="p">:</span> <span class="n">y_type</span><span class="p">(</span><span class="s1">&#39;y_batch&#39;</span><span class="p">),</span>
                <span class="c1"># Importance</span>
                <span class="s1">&#39;w_given&#39;</span><span class="p">:</span> <span class="n">w_type</span><span class="p">(</span><span class="s1">&#39;w_given&#39;</span><span class="p">),</span>
                <span class="s1">&#39;w_batch&#39;</span><span class="p">:</span> <span class="n">w_type</span><span class="p">(</span><span class="s1">&#39;w_batch&#39;</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_theano_exprs</span><span class="p">[</span><span class="s1">&#39;fn_inputs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn_inputs</span>
        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">_theano_exprs</span><span class="p">[</span><span class="s1">&#39;fn_inputs&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="_ModelBackend._testdata_batch"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelBackend._testdata_batch">[docs]</a>    <span class="k">def</span> <span class="nf">_testdata_batch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">ensure_data_params</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
        <span class="n">class_to_weight</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;class_to_weight&#39;</span><span class="p">]</span>
        <span class="n">class_to_weight</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">class_to_weight</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">data_per_label</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">data_per_label_input</span>
        <span class="n">Xb_</span><span class="p">,</span> <span class="n">yb_</span><span class="p">,</span> <span class="n">wb_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">slice_batch</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">data_per_label</span>
        <span class="p">)</span>
        <span class="n">Xb</span><span class="p">,</span> <span class="n">yb</span><span class="p">,</span> <span class="n">wb</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">prepare_data</span><span class="p">(</span><span class="n">Xb_</span><span class="p">,</span> <span class="n">yb_</span><span class="p">,</span> <span class="n">wb_</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Xb</span><span class="p">,</span> <span class="n">yb</span><span class="p">,</span> <span class="n">wb</span>
        <span class="k">pass</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_theano_loss_exprs</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Requires that a custom loss function is defined in the inherited class</span>

<span class="sd">        Ignore:</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn.models.abstract_models import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn.models import mnist</span>
<span class="sd">            &gt;&gt;&gt; import theano</span>
<span class="sd">            &gt;&gt;&gt; model, dataset = mnist.testdata_mnist(dropout=.5)</span>
<span class="sd">            &gt;&gt;&gt; model._init_compile_vars({})  # reset state</span>
<span class="sd">            &gt;&gt;&gt; model.init_arch()</span>
<span class="sd">            &gt;&gt;&gt; data, labels = dataset.subset(&#39;test&#39;)</span>
<span class="sd">            &gt;&gt;&gt; loss = model._theano_loss_exprs[&#39;loss&#39;]</span>
<span class="sd">            &gt;&gt;&gt; loss_item = model._theano_loss_exprs[&#39;loss_item&#39;]</span>
<span class="sd">            &gt;&gt;&gt; X_in = theano.In(model._theano_fn_inputs[&#39;X_batch&#39;])</span>
<span class="sd">            &gt;&gt;&gt; y_in = theano.In(model._theano_fn_inputs[&#39;y_batch&#39;])</span>
<span class="sd">            &gt;&gt;&gt; w_in = theano.In(model._theano_fn_inputs[&#39;w_batch&#39;])</span>
<span class="sd">            &gt;&gt;&gt; # Eval</span>
<span class="sd">            &gt;&gt;&gt; input1 = {X_in: Xb, y_in: yb, w_in: wb}</span>
<span class="sd">            &gt;&gt;&gt; input2 = {X_in: Xb, y_in: yb}</span>
<span class="sd">            &gt;&gt;&gt; _loss = loss.eval(input1)</span>
<span class="sd">            &gt;&gt;&gt; _loss_item = loss_item.eval(input2)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_theano_exprs</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                <span class="n">y_batch</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_theano_fn_inputs</span><span class="p">[</span><span class="s1">&#39;y_batch&#39;</span><span class="p">]</span>
                <span class="n">w_batch</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_theano_fn_inputs</span><span class="p">[</span><span class="s1">&#39;w_batch&#39;</span><span class="p">]</span>

                <span class="n">netout_exprs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_get_network_output</span><span class="p">()</span>
                <span class="n">netout_learn</span> <span class="o">=</span> <span class="n">netout_exprs</span><span class="p">[</span><span class="s1">&#39;network_output_learn&#39;</span><span class="p">]</span>
                <span class="n">netout_determ</span> <span class="o">=</span> <span class="n">netout_exprs</span><span class="p">[</span><span class="s1">&#39;network_output_determ&#39;</span><span class="p">]</span>

                <span class="c1"># In both learn and validate setting get:</span>
                <span class="c1"># Loss of each iterm in the batch</span>
                <span class="c1"># Standard deviation of the loss in the batch</span>
                <span class="c1"># Weighted mean of the loss in the batch</span>

                <span class="c1"># Loss of each example/item</span>
                <span class="c1"># Record loss standard deviation over batch for diagnostics</span>

                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Building symbolic loss function&#39;</span><span class="p">)</span>
                <span class="n">loss_item</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">loss_function</span><span class="p">(</span><span class="n">netout_learn</span><span class="p">,</span> <span class="n">y_batch</span><span class="p">)</span>
                <span class="n">loss_item</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;loss_item&#39;</span>
                <span class="c1"># loss_std = loss_item.std()</span>
                <span class="c1"># loss_std.name = &#39;loss_std&#39;</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">lasagne</span><span class="o">.</span><span class="n">objectives</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
                    <span class="n">loss_item</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_batch</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span>
                <span class="p">)</span>
                <span class="n">loss</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;loss&#39;</span>

                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Building symbolic loss function (determenistic)&#39;</span><span class="p">)</span>
                <span class="n">loss_item_determ</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">loss_function</span><span class="p">(</span><span class="n">netout_determ</span><span class="p">,</span> <span class="n">y_batch</span><span class="p">)</span>
                <span class="n">loss_item_determ</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;loss_item_determ&#39;</span>
                <span class="c1"># loss_std_determ = loss_item_determ.std()</span>
                <span class="c1"># loss_std_determ.name = &#39;loss_std_determ&#39;</span>
                <span class="n">loss_determ</span> <span class="o">=</span> <span class="n">lasagne</span><span class="o">.</span><span class="n">objectives</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
                    <span class="n">loss_item_determ</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w_batch</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span>
                <span class="p">)</span>
                <span class="n">loss_determ</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;loss_determ&#39;</span>

                <span class="c1"># Regularize the learning loss function</span>

                <span class="c1"># TODO: L2 should one of many regularization options (Lp, L1)</span>
                <span class="n">L2</span> <span class="o">=</span> <span class="n">lasagne</span><span class="o">.</span><span class="n">regularization</span><span class="o">.</span><span class="n">regularize_network_params</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">output_layer</span><span class="p">,</span> <span class="n">lasagne</span><span class="o">.</span><span class="n">regularization</span><span class="o">.</span><span class="n">l2</span>
                <span class="p">)</span>
                <span class="n">L2</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;reg_L2_param_mag&#39;</span>

                <span class="n">weight_decay</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">learn_state</span><span class="o">.</span><span class="n">shared</span><span class="p">[</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">]</span>
                <span class="n">reg_L2_decay</span> <span class="o">=</span> <span class="n">weight_decay</span> <span class="o">*</span> <span class="n">L2</span>
                <span class="n">reg_L2_decay</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;reg_L2_decay&#39;</span>
                <span class="n">loss_reg</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">+</span> <span class="n">reg_L2_decay</span>
                <span class="n">loss_reg</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;loss_reg&#39;</span>

                <span class="n">loss_exprs</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;loss_reg&#39;</span><span class="p">:</span> <span class="n">loss_reg</span><span class="p">,</span>
                    <span class="s1">&#39;loss_determ&#39;</span><span class="p">:</span> <span class="n">loss_determ</span><span class="p">,</span>
                    <span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="n">loss</span><span class="p">,</span>
                    <span class="c1"># &#39;loss_std&#39;: loss_std,</span>
                    <span class="c1"># &#39;loss_std_determ&#39;: loss_std_determ,</span>
                    <span class="s1">&#39;loss_item&#39;</span><span class="p">:</span> <span class="n">loss_item</span><span class="p">,</span>
                    <span class="s1">&#39;loss_item_determ&#39;</span><span class="p">:</span> <span class="n">loss_item</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_theano_exprs</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss_exprs</span>
        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">_theano_exprs</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="_ModelBackend._make_updates"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelBackend._make_updates">[docs]</a>    <span class="k">def</span> <span class="nf">_make_updates</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">backprop_loss_</span><span class="p">):</span>
        <span class="n">grads</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">backprop_loss_</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">add_names</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">shared_learning_rate</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">learn_state</span><span class="o">.</span><span class="n">shared</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">]</span>
        <span class="n">momentum</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">learn_state</span><span class="o">.</span><span class="n">shared</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">]</span>

        <span class="n">updates</span> <span class="o">=</span> <span class="n">lasagne</span><span class="o">.</span><span class="n">updates</span><span class="o">.</span><span class="n">nesterov_momentum</span><span class="p">(</span>
            <span class="n">loss_or_grads</span><span class="o">=</span><span class="n">grads</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
            <span class="n">learning_rate</span><span class="o">=</span><span class="n">shared_learning_rate</span><span class="p">,</span>
            <span class="n">momentum</span><span class="o">=</span><span class="n">momentum</span>
            <span class="c1"># add_names=True  # TODO; commit to lasagne</span>
        <span class="p">)</span>

        <span class="c1"># workaround for pylearn2 bug documented in</span>
        <span class="c1"># https://github.com/Lasagne/Lasagne/issues/728</span>
        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">update</span> <span class="ow">in</span> <span class="n">updates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">broadcastable</span> <span class="o">!=</span> <span class="n">update</span><span class="o">.</span><span class="n">broadcastable</span><span class="p">:</span>
                <span class="n">updates</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">patternbroadcast</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">broadcastable</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">updates</span></div>

<div class="viewcode-block" id="_ModelBackend._get_network_output"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelBackend._get_network_output">[docs]</a>    <span class="k">def</span> <span class="nf">_get_network_output</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        gets the activations of the output neurons</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_theano_exprs</span><span class="p">[</span><span class="s1">&#39;netout&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">X_batch</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_theano_fn_inputs</span><span class="p">[</span><span class="s1">&#39;X_batch&#39;</span><span class="p">]</span>

            <span class="n">network_output_learn</span> <span class="o">=</span> <span class="n">lasagne</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">get_output</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">output_layer</span><span class="p">,</span> <span class="n">X_batch</span><span class="p">)</span>
            <span class="n">network_output_learn</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;network_output_learn&#39;</span>

            <span class="n">network_output_determ</span> <span class="o">=</span> <span class="n">lasagne</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">get_output</span><span class="p">(</span>
                <span class="n">model</span><span class="o">.</span><span class="n">output_layer</span><span class="p">,</span> <span class="n">X_batch</span><span class="p">,</span> <span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">network_output_determ</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;network_output_determ&#39;</span>

            <span class="n">netout_exprs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;network_output_learn&#39;</span><span class="p">:</span> <span class="n">network_output_learn</span><span class="p">,</span>
                <span class="s1">&#39;network_output_determ&#39;</span><span class="p">:</span> <span class="n">network_output_determ</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_theano_exprs</span><span class="p">[</span><span class="s1">&#39;netout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">netout_exprs</span>
        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">_theano_exprs</span><span class="p">[</span><span class="s1">&#39;netout&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="_ModelBackend._get_unlabeled_outputs"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelBackend._get_unlabeled_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">_get_unlabeled_outputs</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_theano_exprs</span><span class="p">[</span><span class="s1">&#39;unlabeled_out&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">netout_exprs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_get_network_output</span><span class="p">()</span>
            <span class="n">network_output_determ</span> <span class="o">=</span> <span class="n">netout_exprs</span><span class="p">[</span><span class="s1">&#39;network_output_determ&#39;</span><span class="p">]</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">custom_unlabeled_outputs</span><span class="p">(</span><span class="n">network_output_determ</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_theano_exprs</span><span class="p">[</span><span class="s1">&#39;unlabeled_out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span>
        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">_theano_exprs</span><span class="p">[</span><span class="s1">&#39;unlabeled_out&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="_ModelBackend._get_labeled_outputs"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelBackend._get_labeled_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">_get_labeled_outputs</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_theano_exprs</span><span class="p">[</span><span class="s1">&#39;labeled_out&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">netout_exprs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_get_network_output</span><span class="p">()</span>
            <span class="n">network_output_determ</span> <span class="o">=</span> <span class="n">netout_exprs</span><span class="p">[</span><span class="s1">&#39;network_output_determ&#39;</span><span class="p">]</span>
            <span class="n">y_batch</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_theano_fn_inputs</span><span class="p">[</span><span class="s1">&#39;y_batch&#39;</span><span class="p">]</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_theano_exprs</span><span class="p">[</span><span class="s1">&#39;labeled_out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">custom_labeled_outputs</span><span class="p">(</span>
                <span class="n">network_output_determ</span><span class="p">,</span> <span class="n">y_batch</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">_theano_exprs</span><span class="p">[</span><span class="s1">&#39;labeled_out&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="_ModelBackend._make_monitor_outputs"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelBackend._make_monitor_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">_make_monitor_outputs</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">updates</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds parameters to monitor the magnitude of updates durning learning</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Build outputs to babysit training</span>
        <span class="n">monitor_outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">monitor_config</span><span class="p">[</span><span class="s1">&#39;monitor_updates&#39;</span><span class="p">]:</span>  <span class="c1"># and False:</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
                <span class="c1"># The vector each param was udpated with</span>
                <span class="c1"># (one vector per channel)</span>
                <span class="n">param_update_vec</span> <span class="o">=</span> <span class="n">updates</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">-</span> <span class="n">param</span>
                <span class="n">param_update_vec</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;param_update_vector_&#39;</span> <span class="o">+</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span>
                <span class="n">flat_shape</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">param_update_vec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">T</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">param_update_vec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span>
                <span class="p">)</span>
                <span class="n">flat_param_update_vec</span> <span class="o">=</span> <span class="n">param_update_vec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">flat_shape</span><span class="p">)</span>
                <span class="n">param_update_mag</span> <span class="o">=</span> <span class="p">(</span><span class="n">flat_param_update_vec</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">param_update_mag</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;param_update_magnitude_&#39;</span> <span class="o">+</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span>
                <span class="n">monitor_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param_update_mag</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">monitor_outputs</span></div>

<div class="viewcode-block" id="_ModelBackend.custom_unlabeled_outputs"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelBackend.custom_unlabeled_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">custom_unlabeled_outputs</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">network_output</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        override in inherited subclass to enable custom symbolic expressions</span>
<span class="sd">        based on the network output alone</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;need override&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="_ModelBackend.custom_labeled_outputs"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelBackend.custom_labeled_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">custom_labeled_outputs</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">network_output</span><span class="p">,</span> <span class="n">y_batch</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        override in inherited subclass to enable custom symbolic expressions</span>
<span class="sd">        based on the network output and the labels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;need override&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span></div></div>


<div class="viewcode-block" id="_ModelVisualization"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelVisualization">[docs]</a><span class="nd">@ut</span><span class="o">.</span><span class="n">reloadable_class</span>
<span class="k">class</span> <span class="nc">_ModelVisualization</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia_cnn.models.abstract_models _ModelVisualization</span>
<span class="sd">        python -m wbia_cnn.models.abstract_models _ModelVisualization --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn.models.abstract_models import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn.models import dummy</span>
<span class="sd">        &gt;&gt;&gt; model = dummy.DummyModel(batch_size=16, autoinit=False)</span>
<span class="sd">        &gt;&gt;&gt; #model._theano_mode = theano.compile.Mode(linker=&#39;py&#39;, optimizer=&#39;fast_compile&#39;)</span>
<span class="sd">        &gt;&gt;&gt; #model._theano_mode = theano.compile.Mode(linker=&#39;py&#39;, optimizer=&#39;fast_compile&#39;)</span>
<span class="sd">        &gt;&gt;&gt; model_theano_mode = theano.compile.FAST_COMPILE</span>
<span class="sd">        &gt;&gt;&gt; model.init_arch()</span>
<span class="sd">        &gt;&gt;&gt; X, y = model.make_random_testdata(num=27, cv2_format=True, asint=False)</span>
<span class="sd">        &gt;&gt;&gt; model.fit(X, y, max_epochs=10, era_size=3, buffered=False)</span>
<span class="sd">        &gt;&gt;&gt; fnum = None</span>
<span class="sd">        &gt;&gt;&gt; import plottool as pt</span>
<span class="sd">        &gt;&gt;&gt; pt.qt4ensure()</span>
<span class="sd">        &gt;&gt;&gt; fnum = 1</span>
<span class="sd">        &gt;&gt;&gt; model.show_loss_history(fnum)</span>
<span class="sd">        &gt;&gt;&gt; #model.show_era_report(fnum)</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="_ModelVisualization.show_arch"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelVisualization.show_arch">[docs]</a>    <span class="k">def</span> <span class="nf">show_arch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fullinfo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">plottool</span> <span class="k">as</span> <span class="nn">pt</span>

        <span class="n">layers</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_all_layers</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">draw_net</span><span class="o">.</span><span class="n">show_arch_nx_graph</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">fullinfo</span><span class="o">=</span><span class="n">fullinfo</span><span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">set_figtitle</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">arch_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="_ModelVisualization.show_class_dream"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelVisualization.show_class_dream">[docs]</a>    <span class="k">def</span> <span class="nf">show_class_dream</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia_cnn.models.abstract_models show_class_dream --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; # Assumes mnist is trained</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn.draw_net import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn.models import mnist</span>
<span class="sd">            &gt;&gt;&gt; model, dataset = mnist.testdata_mnist(dropout=.5)</span>
<span class="sd">            &gt;&gt;&gt; model.init_arch()</span>
<span class="sd">            &gt;&gt;&gt; model.load_model_state()</span>
<span class="sd">            &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">            &gt;&gt;&gt; import plottool as pt</span>
<span class="sd">            &gt;&gt;&gt; #pt.qt4ensure()</span>
<span class="sd">            &gt;&gt;&gt; model.show_class_dream()</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">plottool</span> <span class="k">as</span> <span class="nn">pt</span>

        <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="s1">&#39;randn&#39;</span><span class="p">,</span> <span class="n">niters</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">update_rate</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
        <span class="n">kw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">target_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">output_dims</span><span class="p">))</span>
        <span class="n">dream</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;_dream&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dream</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dream</span> <span class="o">=</span> <span class="n">draw_net</span><span class="o">.</span><span class="n">Dream</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_dream</span> <span class="o">=</span> <span class="n">dream</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">dream</span><span class="o">.</span><span class="n">make_class_images</span><span class="p">(</span><span class="n">target_labels</span><span class="p">)</span>
        <span class="n">pnum_</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">make_pnum_nextgen</span><span class="p">(</span><span class="n">nSubplots</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">target_labels</span><span class="p">))</span>
        <span class="n">fnum</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">ensure_fnum</span><span class="p">(</span><span class="n">fnum</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">target_label</span><span class="p">,</span> <span class="n">img</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">target_labels</span><span class="p">,</span> <span class="n">images</span><span class="p">):</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum_</span><span class="p">(),</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;target=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">target_label</span><span class="p">,))</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="_ModelVisualization.dump_class_dream"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelVisualization.dump_class_dream">[docs]</a>    <span class="k">def</span> <span class="nf">dump_class_dream</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fpath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        initial =</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dpath</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_fit_session</span><span class="p">[</span><span class="s1">&#39;session_dpath&#39;</span><span class="p">]</span>
        <span class="n">dpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="s1">&#39;dreamvid&#39;</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">search_stack_for_localvar</span><span class="p">(</span><span class="s1">&#39;dataset&#39;</span><span class="p">)</span>
        <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span><span class="s1">&#39;valid&#39;</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">theano</span>
        <span class="kn">from</span> <span class="nn">theano</span> <span class="kn">import</span> <span class="n">tensor</span> <span class="k">as</span> <span class="n">T</span>  <span class="c1"># NOQA</span>
        <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

        <span class="n">num</span> <span class="o">=</span> <span class="mi">64</span>
        <span class="n">Xb</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">prepare_data</span><span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">num</span><span class="p">])</span>
        <span class="n">yb</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">num</span><span class="p">]</span>
        <span class="n">shared_images</span> <span class="o">=</span> <span class="n">theano</span><span class="o">.</span><span class="n">shared</span><span class="p">(</span><span class="n">Xb</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="n">dream</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_dream</span>
        <span class="n">step_fn</span> <span class="o">=</span> <span class="n">dream</span><span class="o">.</span><span class="n">_make_objective</span><span class="p">(</span><span class="n">shared_images</span><span class="p">,</span> <span class="n">yb</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">dream</span><span class="o">.</span><span class="n">_postprocess_class_image</span><span class="p">(</span><span class="n">shared_images</span><span class="p">,</span> <span class="n">yb</span><span class="p">,</span> <span class="n">was_scalar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">dream</span><span class="o">.</span><span class="n">_postprocess_class_image</span><span class="p">(</span><span class="n">shared_images</span><span class="p">,</span> <span class="n">yb</span><span class="p">,</span> <span class="n">was_scalar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">vt</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="s1">&#39;out</span><span class="si">%d</span><span class="s1">.jpg&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,)),</span> <span class="n">out</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgIter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)):</span>
                <span class="n">step_fn</span><span class="p">()</span></div>

<div class="viewcode-block" id="_ModelVisualization.show_weights_image"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelVisualization.show_weights_image">[docs]</a>    <span class="k">def</span> <span class="nf">show_weights_image</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">plottool</span> <span class="k">as</span> <span class="nn">pt</span>

        <span class="n">network_layers</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_all_layers</span><span class="p">()</span>
        <span class="n">cnn_layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">layer_</span> <span class="k">for</span> <span class="n">layer_</span> <span class="ow">in</span> <span class="n">network_layers</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">layer_</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">)]</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">cnn_layers</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">all_weights</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="n">layername</span> <span class="o">=</span> <span class="n">net_strs</span><span class="o">.</span><span class="n">make_layer_str</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">draw_net</span><span class="o">.</span><span class="n">show_convolutional_weights</span><span class="p">(</span><span class="n">all_weights</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">figtitle</span> <span class="o">=</span> <span class="n">layername</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">arch_id</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">hist_id</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">set_figtitle</span><span class="p">(</span>
            <span class="n">figtitle</span><span class="p">,</span>
            <span class="n">subtitle</span><span class="o">=</span><span class="s1">&#39;shape=</span><span class="si">%r</span><span class="s1">, sum=</span><span class="si">%.4f</span><span class="s1">, l2=</span><span class="si">%.4f</span><span class="s1">&#39;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">all_weights</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">all_weights</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="p">(</span><span class="n">all_weights</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="_ModelVisualization.show_update_mag_history"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelVisualization.show_update_mag_history">[docs]</a>    <span class="k">def</span> <span class="nf">show_update_mag_history</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia_cnn --tf _ModelVisualization.show_update_mag_history --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn.models.abstract_models import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; model = testdata_model_with_history()</span>
<span class="sd">            &gt;&gt;&gt; fnum = None</span>
<span class="sd">            &gt;&gt;&gt; model.show_update_mag_history(fnum)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">plottool</span> <span class="k">as</span> <span class="nn">pt</span>

        <span class="n">fnum</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">ensure_fnum</span><span class="p">(</span><span class="n">fnum</span><span class="p">)</span>

        <span class="n">layer_info</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_all_layer_info</span><span class="p">()</span>
        <span class="n">param_groups</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;param_infos&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;trainable&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">layer_info</span>
        <span class="p">]</span>
        <span class="n">param_groups</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">param_groups</span><span class="p">,</span> <span class="n">param_groups</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">doclf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">docla</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># next_pnum = pt.make_pnum_nextgen(nSubplots=1 + len(param_groups))</span>
        <span class="n">next_pnum</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">make_pnum_nextgen</span><span class="p">(</span><span class="n">nSubplots</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># if len(model.era_history) &gt; 0:</span>
        <span class="c1">#    for param_keys in param_groups:</span>
        <span class="c1">#        model.show_weight_updates(param_keys=param_keys, fnum=fnum, pnum=next_pnum())</span>
        <span class="c1"># Show learning rate</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rate&#39;</span><span class="p">:</span> <span class="s1">&#39;learning rate&#39;</span><span class="p">}</span>
        <span class="n">ydatas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">epochsT</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">grouped_epochsT</span><span class="p">():</span>
            <span class="n">learn_rate_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">epochsT</span><span class="p">[</span><span class="s1">&#39;learn_state&#39;</span><span class="p">],</span> <span class="s1">&#39;learning_rate&#39;</span><span class="p">)</span>
            <span class="n">ydatas</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;rate&#39;</span><span class="p">:</span> <span class="n">learn_rate_list</span><span class="p">})</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_show_era_measure</span><span class="p">(</span>
            <span class="n">ydatas</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;learning rate&#39;</span><span class="p">,</span>
            <span class="n">yscale</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
            <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span>
            <span class="n">pnum</span><span class="o">=</span><span class="n">next_pnum</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="c1"># model.show_weight_updates(fnum=fnum, pnum=next_pnum())</span>
        <span class="c1"># TODO: add confusion</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">set_figtitle</span><span class="p">(</span>
            <span class="s1">&#39;Weight Update History: &#39;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">hist_id</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">arch_id</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="_ModelVisualization.show_pr_history"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelVisualization.show_pr_history">[docs]</a>    <span class="k">def</span> <span class="nf">show_pr_history</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia_cnn --tf _ModelVisualization.show_pr_history --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn.models.abstract_models import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; model = testdata_model_with_history()</span>
<span class="sd">            &gt;&gt;&gt; fnum = None</span>
<span class="sd">            &gt;&gt;&gt; model.show_pr_history(fnum)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">plottool</span> <span class="k">as</span> <span class="nn">pt</span>

        <span class="n">fnum</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">ensure_fnum</span><span class="p">(</span><span class="n">fnum</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">doclf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">docla</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">next_pnum</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">make_pnum_nextgen</span><span class="p">(</span><span class="n">nRows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nCols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_show_era_class_pr</span><span class="p">(</span>
                <span class="p">[</span><span class="s1">&#39;learn&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">next_pnum</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_show_era_class_pr</span><span class="p">([</span><span class="s1">&#39;learn&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">next_pnum</span><span class="p">())</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_show_era_class_pr</span><span class="p">(</span>
                <span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">],</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">next_pnum</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_show_era_class_pr</span><span class="p">([</span><span class="s1">&#39;valid&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;recall&#39;</span><span class="p">],</span> <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">next_pnum</span><span class="p">())</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">set_figtitle</span><span class="p">(</span><span class="s1">&#39;Era PR History: &#39;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">hist_id</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">arch_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="_ModelVisualization.show_loss_history"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelVisualization.show_loss_history">[docs]</a>    <span class="k">def</span> <span class="nf">show_loss_history</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            fnum (int):  figure number(default = None)</span>

<span class="sd">        Returns:</span>
<span class="sd">            mpl.Figure: fig</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia_cnn _ModelVisualization.show_loss_history --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn.models.abstract_models import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; model = testdata_model_with_history()</span>
<span class="sd">            &gt;&gt;&gt; fnum = None</span>
<span class="sd">            &gt;&gt;&gt; model.show_loss_history(fnum)</span>
<span class="sd">            &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">plottool</span> <span class="k">as</span> <span class="nn">pt</span>

        <span class="n">fnum</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">ensure_fnum</span><span class="p">(</span><span class="n">fnum</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">doclf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">docla</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">next_pnum</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">make_pnum_nextgen</span><span class="p">(</span><span class="n">nRows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nCols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_show_era_loss</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">next_pnum</span><span class="p">(),</span> <span class="n">yscale</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_show_era_loss</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">next_pnum</span><span class="p">(),</span> <span class="n">yscale</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_show_era_acc</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">next_pnum</span><span class="p">(),</span> <span class="n">yscale</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_show_era_lossratio</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">next_pnum</span><span class="p">())</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">set_figtitle</span><span class="p">(</span>
            <span class="s1">&#39;Era Loss History: &#39;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">hist_id</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">arch_id</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="_ModelVisualization._show_era_lossratio"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelVisualization._show_era_lossratio">[docs]</a>    <span class="k">def</span> <span class="nf">_show_era_lossratio</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ratio&#39;</span><span class="p">:</span> <span class="s1">&#39;learn/valid&#39;</span><span class="p">}</span>

        <span class="n">ydatas</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;ratio&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span>
                    <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="s1">&#39;learn_loss&#39;</span><span class="p">),</span>
                    <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="s1">&#39;valid_loss&#39;</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">epochs</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">grouped_epochs</span><span class="p">()</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">_show_era_measure</span><span class="p">(</span>
            <span class="n">ydatas</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;learn/valid&#39;</span><span class="p">,</span> <span class="n">yscale</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="_ModelVisualization._show_era_class_pr"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelVisualization._show_era_class_pr">[docs]</a>    <span class="k">def</span> <span class="nf">_show_era_class_pr</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="s1">&#39;learn&#39;</span><span class="p">],</span> <span class="n">measures</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="s1">&#39;recall&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="kn">import</span> <span class="nn">plottool</span> <span class="k">as</span> <span class="nn">pt</span>

        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># TODO: keep in data_params?</span>
            <span class="n">class_idxs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
            <span class="n">class_lbls</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">classes_</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">class_idxs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">output_dims</span><span class="p">))</span>
            <span class="n">class_lbls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">output_dims</span><span class="p">))</span>

        <span class="n">type_styles</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;learn&#39;</span><span class="p">:</span> <span class="s1">&#39;-x&#39;</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="s1">&#39;-o&#39;</span><span class="p">}</span>
        <span class="n">styles</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">(</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">[</span>
                        <span class="p">(</span>
                            <span class="p">(</span>
                                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%d</span><span class="s1">&#39;</span>
                                <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">t</span><span class="p">,</span>
                                    <span class="n">m</span><span class="p">,</span>
                                    <span class="n">y</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="p">),</span>
                            <span class="n">type_styles</span><span class="p">[</span><span class="n">t</span><span class="p">],</span>
                        <span class="p">)</span>
                        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span>
                        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">measures</span>
                    <span class="p">]</span>
                    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">class_idxs</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">class_colors</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">distinct_colors</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">class_idxs</span><span class="p">))</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">(</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">[</span>
                        <span class="p">(</span>
                            <span class="p">(</span>
                                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%d</span><span class="s1">&#39;</span>
                                <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">t</span><span class="p">,</span>
                                    <span class="n">m</span><span class="p">,</span>
                                    <span class="n">y</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="p">),</span>
                            <span class="n">color</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span>
                        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">measures</span>
                    <span class="p">]</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">class_idxs</span><span class="p">,</span> <span class="n">class_colors</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">(</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">[</span>
                            <span class="p">(</span>
                                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%d</span><span class="s1">&#39;</span>
                                <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">t</span><span class="p">,</span>
                                    <span class="n">m</span><span class="p">,</span>
                                    <span class="n">y</span><span class="p">,</span>
                                <span class="p">),</span>
                                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span>
                                <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">t</span><span class="p">,</span>
                                    <span class="n">m</span><span class="p">,</span>
                                    <span class="n">category</span><span class="p">,</span>
                                <span class="p">),</span>
                            <span class="p">)</span>
                            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span>
                            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">measures</span>
                        <span class="p">]</span>
                        <span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">category</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">class_idxs</span><span class="p">,</span> <span class="n">class_lbls</span><span class="p">)</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">ydatas</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">(</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">[</span>
                            <span class="p">(</span>
                                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%d</span><span class="s1">&#39;</span>
                                <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">t</span><span class="p">,</span>
                                    <span class="n">m</span><span class="p">,</span>
                                    <span class="n">y</span><span class="p">,</span>
                                <span class="p">),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">m</span><span class="p">)))[:,</span> <span class="n">y</span><span class="p">],</span>
                            <span class="p">)</span>
                            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span>
                            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">measures</span>
                        <span class="p">]</span>
                        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">class_idxs</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">epochs</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">grouped_epochs</span><span class="p">()</span>
        <span class="p">]</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_show_era_measure</span><span class="p">(</span>
            <span class="n">ydatas</span><span class="p">,</span>
            <span class="n">styles</span><span class="o">=</span><span class="n">styles</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
            <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">measures</span><span class="p">),</span>
            <span class="n">yscale</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="_ModelVisualization._show_era_acc"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelVisualization._show_era_acc">[docs]</a>    <span class="k">def</span> <span class="nf">_show_era_acc</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># styles = {&#39;valid&#39;: &#39;-o&#39;}</span>
        <span class="n">styles</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;learn&#39;</span><span class="p">:</span> <span class="s1">&#39;-x&#39;</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="s1">&#39;-o&#39;</span><span class="p">}</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">last_epoch</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">epoch_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">last_era</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">era_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="s1">&#39;valid acc &#39;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">last_era</span><span class="p">[</span><span class="s1">&#39;num_valid&#39;</span><span class="p">])</span>
                <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">last_epoch</span><span class="p">[</span><span class="s1">&#39;learn_acc&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
                <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span>
                <span class="s1">&#39;learn&#39;</span><span class="p">:</span> <span class="s1">&#39;learn acc &#39;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">last_era</span><span class="p">[</span><span class="s1">&#39;num_learn&#39;</span><span class="p">])</span>
                <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr4</span><span class="p">(</span><span class="n">last_epoch</span><span class="p">[</span><span class="s1">&#39;valid_acc&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
                <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="n">ydatas</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="s1">&#39;valid_acc&#39;</span><span class="p">),</span>
                <span class="s1">&#39;learn&#39;</span><span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="s1">&#39;learn_acc&#39;</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">epochs</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">grouped_epochs</span><span class="p">()</span>
        <span class="p">]</span>

        <span class="n">yspreads</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="s1">&#39;valid_acc_std&#39;</span><span class="p">),</span>
                <span class="s1">&#39;learn&#39;</span><span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="s1">&#39;learn_acc_std&#39;</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">epochs</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">grouped_epochs</span><span class="p">()</span>
        <span class="p">]</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_show_era_measure</span><span class="p">(</span>
            <span class="n">ydatas</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">styles</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="n">yspreads</span><span class="o">=</span><span class="n">yspreads</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="c1"># import plottool as pt</span>
        <span class="c1"># ax = pt.gca()</span>
        <span class="c1"># ymin, ymax = ax.get_ylim()</span>
        <span class="c1"># pt.gca().set_ylim((ymin, 100))</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="_ModelVisualization._show_era_loss"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelVisualization._show_era_loss">[docs]</a>    <span class="k">def</span> <span class="nf">_show_era_loss</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">styles</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;learn&#39;</span><span class="p">:</span> <span class="s1">&#39;-x&#39;</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="s1">&#39;-o&#39;</span><span class="p">}</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;learn&#39;</span><span class="p">:</span> <span class="s1">&#39;learn &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">era_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;num_learn&#39;</span><span class="p">]),</span>
                <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="s1">&#39;valid &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">era_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;num_valid&#39;</span><span class="p">]),</span>
            <span class="p">}</span>
        <span class="n">epochsT_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">grouped_epochsT</span><span class="p">())</span>

        <span class="n">ydatas</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;learn&#39;</span><span class="p">:</span> <span class="n">epochsT</span><span class="p">[</span><span class="s1">&#39;learn_loss&#39;</span><span class="p">],</span> <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="n">epochsT</span><span class="p">[</span><span class="s1">&#39;valid_loss&#39;</span><span class="p">]}</span>
            <span class="k">for</span> <span class="n">epochsT</span> <span class="ow">in</span> <span class="n">epochsT_list</span>
        <span class="p">]</span>

        <span class="n">yspreads</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;learn&#39;</span><span class="p">:</span> <span class="n">epochsT</span><span class="p">[</span><span class="s1">&#39;learn_loss_std&#39;</span><span class="p">],</span> <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="n">epochsT</span><span class="p">[</span><span class="s1">&#39;valid_loss_std&#39;</span><span class="p">]}</span>
            <span class="k">for</span> <span class="n">epochsT</span> <span class="ow">in</span> <span class="n">epochsT_list</span>
        <span class="p">]</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_show_era_measure</span><span class="p">(</span>
            <span class="n">ydatas</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">styles</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="n">yspreads</span><span class="o">=</span><span class="n">yspreads</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="_ModelVisualization.show_weight_updates"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelVisualization.show_weight_updates">[docs]</a>    <span class="k">def</span> <span class="nf">show_weight_updates</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">param_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># has_mag_updates = False</span>
        <span class="kn">import</span> <span class="nn">plottool</span> <span class="k">as</span> <span class="nn">pt</span>

        <span class="n">xdatas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ydatas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">yspreads</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">era</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">era_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;param_update_mags&#39;</span> <span class="ow">in</span> <span class="n">era</span><span class="p">[</span><span class="s1">&#39;epoch_info_list&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">param_keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">param_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                        <span class="nb">set</span><span class="p">(</span>
                            <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">dict_</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">dict_</span> <span class="ow">in</span> <span class="n">era</span><span class="p">[</span><span class="s1">&#39;param_update_mags_list&#39;</span><span class="p">]]</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">param_keys</span><span class="p">,</span> <span class="n">param_keys</span><span class="p">))</span>
                <span class="n">colors</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">param_keys</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">distinct_colors</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_keys</span><span class="p">))))</span>

        <span class="c1"># colors = {}</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">epochs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;param_update_mags&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">era</span><span class="p">[</span><span class="s1">&#39;epoch_info_list&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">xdata</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="s1">&#39;epoch_num&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">xdata</span> <span class="o">=</span> <span class="n">xdata</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">xdatas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span>
            <span class="c1"># FIXME</span>
            <span class="n">update_mags_list</span> <span class="o">=</span> <span class="n">era</span><span class="p">[</span><span class="s1">&#39;param_update_mags_list&#39;</span><span class="p">]</span>
            <span class="c1"># Transpose keys and positions</span>
            <span class="c1"># param_keys = list(set(ut.flatten([</span>
            <span class="c1">#    dict_.keys() for dict_ in update_mags_list</span>
            <span class="c1"># ])))</span>
            <span class="n">param_val_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">list_</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="k">for</span> <span class="n">list_</span> <span class="ow">in</span> <span class="n">update_mags_list</span><span class="p">]</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">param_keys</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">param_val_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">list_</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">list_</span> <span class="ow">in</span> <span class="n">param_val_list</span><span class="p">]</span>
            <span class="n">ydata</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">yspread</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">param_keys</span><span class="p">,</span> <span class="n">param_val_list</span><span class="p">):</span>
                <span class="n">ydata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">yspread</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ydatas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ydata</span><span class="p">)</span>
            <span class="n">yspreads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yspread</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">_show_era_measure</span><span class="p">(</span>
            <span class="n">ydatas</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
            <span class="n">xdatas</span><span class="o">=</span><span class="n">xdatas</span><span class="p">,</span>
            <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;update magnitude&#39;</span><span class="p">,</span>
            <span class="n">yspreads</span><span class="o">=</span><span class="n">yspreads</span><span class="p">,</span>
            <span class="n">yscale</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="_ModelVisualization._show_era_measure"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelVisualization._show_era_measure">[docs]</a>    <span class="k">def</span> <span class="nf">_show_era_measure</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">ydatas</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">styles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">xdatas</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;epoch&#39;</span><span class="p">,</span>
        <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">yspreads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fnum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pnum</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">yscale</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="c1"># print(&#39;Show Era Measure ylabel = %r&#39; % (ylabel,))</span>
        <span class="kn">import</span> <span class="nn">plottool</span> <span class="k">as</span> <span class="nn">pt</span>

        <span class="n">num_eras</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">total_eras</span>

        <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">styles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">styles</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ddict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="s1">&#39;-o&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">xdatas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xdatas</span> <span class="o">=</span> <span class="p">[</span><span class="n">epochsT</span><span class="p">[</span><span class="s1">&#39;epoch_num&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">epochsT</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">grouped_epochsT</span><span class="p">()]</span>

        <span class="k">if</span> <span class="n">colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">distinct_colors</span><span class="p">(</span><span class="n">num_eras</span><span class="p">)</span>

        <span class="n">prev_xdata</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">prev_ydata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">prev_yspread</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">fnum</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">ensure_fnum</span><span class="p">(</span><span class="n">fnum</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

        <span class="n">can_plot</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_eras</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xdatas</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">index</span><span class="p">:</span>
                <span class="n">can_plot</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
            <span class="n">xdata</span> <span class="o">=</span> <span class="n">xdatas</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">ydata</span> <span class="o">=</span> <span class="n">ydatas</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">color_</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">colors</span>

            <span class="c1"># Draw lines between eras</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prev_xdata</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ydata</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="n">color_</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">color_</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="n">color_</span>
                    <span class="n">xdata_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">([</span><span class="n">prev_xdata</span><span class="p">,</span> <span class="n">xdata</span><span class="p">[:</span><span class="mi">1</span><span class="p">]])</span>
                    <span class="n">ydata_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">([</span><span class="n">prev_ydata</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">ydata</span><span class="p">[</span><span class="n">key</span><span class="p">][:</span><span class="mi">1</span><span class="p">]])</span>
                    <span class="k">if</span> <span class="n">yspreads</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">std_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">([</span><span class="n">prev_yspread</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">yspreads</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">key</span><span class="p">][:</span><span class="mi">1</span><span class="p">]])</span>
                        <span class="n">std_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">std_</span><span class="p">)</span>
                        <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ydata_</span><span class="p">)</span> <span class="o">+</span> <span class="n">std_</span>
                        <span class="n">ymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ydata_</span><span class="p">)</span> <span class="o">-</span> <span class="n">std_</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">xdata_</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                    <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdata_</span><span class="p">,</span> <span class="n">ydata_</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">yscale</span><span class="o">=</span><span class="n">yscale</span><span class="p">)</span>

            <span class="c1"># Draw lines inside era</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ydata</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">kw</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="c1"># The last epoch gets the label</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="n">num_eras</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">kw</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">labels</span><span class="p">[</span><span class="n">key</span><span class="p">]}</span>
                <span class="n">ydata_</span> <span class="o">=</span> <span class="n">ydata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">color_</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">color_</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="n">color_</span>
                <span class="k">if</span> <span class="n">yspreads</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yspreads</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">key</span><span class="p">])</span>
                    <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ydata_</span><span class="p">)</span> <span class="o">+</span> <span class="n">std</span>
                    <span class="n">ymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ydata_</span><span class="p">)</span> <span class="o">-</span> <span class="n">std</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                    <span class="n">prev_yspread</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">ydata_</span><span class="p">,</span> <span class="n">styles</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">yscale</span><span class="o">=</span><span class="n">yscale</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
                <span class="n">prev_ydata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ydata_</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">prev_xdata</span> <span class="o">=</span> <span class="n">xdata</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c1"># append_phantom_legend_label</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">can_plot</span><span class="p">:</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">dark_background</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="_ModelVisualization.show_regularization_stuff"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelVisualization.show_regularization_stuff">[docs]</a>    <span class="k">def</span> <span class="nf">show_regularization_stuff</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="kn">import</span> <span class="nn">plottool</span> <span class="k">as</span> <span class="nn">pt</span>

        <span class="n">fnum</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">ensure_fnum</span><span class="p">(</span><span class="n">fnum</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">era</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="p">):</span>
            <span class="c1"># epochs = era[&#39;epoch_list&#39;]</span>
            <span class="n">epochs</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take_column</span><span class="p">(</span><span class="n">era</span><span class="p">[</span><span class="s1">&#39;epoch_info_list&#39;</span><span class="p">],</span> <span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;update_mags_list&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">era</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">update_mags_list</span> <span class="o">=</span> <span class="n">era</span><span class="p">[</span><span class="s1">&#39;update_mags_list&#39;</span><span class="p">]</span>
            <span class="c1"># Transpose keys and positions</span>
            <span class="n">param_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">([</span><span class="n">dict_</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">dict_</span> <span class="ow">in</span> <span class="n">update_mags_list</span><span class="p">]))</span>
            <span class="p">)</span>
            <span class="n">param_val_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">list_</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="k">for</span> <span class="n">list_</span> <span class="ow">in</span> <span class="n">update_mags_list</span><span class="p">]</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">param_keys</span>
            <span class="p">]</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">distinct_colors</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_val_list</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">param_keys</span><span class="p">,</span> <span class="n">param_val_list</span><span class="p">,</span> <span class="n">colors</span><span class="p">):</span>
                <span class="n">update_mag_mean</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">update_mag_std</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_list_column</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">pt</span><span class="o">.</span><span class="n">interval_line_plot</span><span class="p">(</span>
                        <span class="n">epochs</span><span class="p">,</span>
                        <span class="n">update_mag_mean</span><span class="p">,</span>
                        <span class="n">update_mag_std</span><span class="p">,</span>
                        <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
                        <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pt</span><span class="o">.</span><span class="n">interval_line_plot</span><span class="p">(</span>
                        <span class="n">epochs</span><span class="p">,</span>
                        <span class="n">update_mag_mean</span><span class="p">,</span>
                        <span class="n">update_mag_std</span><span class="p">,</span>
                        <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
                        <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="n">pt</span><span class="o">.</span><span class="n">dark_background</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="c1"># --- IMAGE WRITE</span>

<div class="viewcode-block" id="_ModelVisualization.render_arch"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelVisualization.render_arch">[docs]</a>    <span class="k">def</span> <span class="nf">render_arch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fullinfo</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">plottool</span> <span class="k">as</span> <span class="nn">pt</span>

        <span class="n">savekw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="mi">180</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">pt</span><span class="o">.</span><span class="n">RenderingContext</span><span class="p">(</span><span class="o">**</span><span class="n">savekw</span><span class="p">)</span> <span class="k">as</span> <span class="n">render</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">show_arch</span><span class="p">(</span><span class="n">fnum</span><span class="o">=</span><span class="n">render</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">fullinfo</span><span class="o">=</span><span class="n">fullinfo</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render</span><span class="o">.</span><span class="n">image</span></div>

<div class="viewcode-block" id="_ModelVisualization.imwrite_arch"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelVisualization.imwrite_arch">[docs]</a>    <span class="k">def</span> <span class="nf">imwrite_arch</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fpath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fullinfo</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            fpath (str):  file path string(default = None)</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia_cnn.models.abstract_models imwrite_arch --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn.models.abstract_models import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn.models.mnist import MNISTModel</span>
<span class="sd">            &gt;&gt;&gt; model = MNISTModel(batch_size=128, data_shape=(24, 24, 1),</span>
<span class="sd">            &gt;&gt;&gt;                    output_dims=10, batch_norm=False, name=&#39;mnist&#39;)</span>
<span class="sd">            &gt;&gt;&gt; model.init_arch()</span>
<span class="sd">            &gt;&gt;&gt; fapth = model.imwrite_arch()</span>
<span class="sd">            &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">            &gt;&gt;&gt; ut.startfile(fapth)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># FIXME</span>
        <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

        <span class="k">if</span> <span class="n">fpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fpath</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">arch_id</span> <span class="o">+</span> <span class="s1">&#39;.jpg&#39;</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">render_arch</span><span class="p">(</span><span class="n">fullinfo</span><span class="o">=</span><span class="n">fullinfo</span><span class="p">)</span>
        <span class="n">vt</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fpath</span></div></div>


<div class="viewcode-block" id="_ModelStrings"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelStrings">[docs]</a><span class="nd">@ut</span><span class="o">.</span><span class="n">reloadable_class</span>
<span class="k">class</span> <span class="nc">_ModelStrings</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>

<div class="viewcode-block" id="_ModelStrings.get_state_str"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelStrings.get_state_str">[docs]</a>    <span class="k">def</span> <span class="nf">get_state_str</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">other_override_reprs</span><span class="o">=</span><span class="p">{}):</span>
        <span class="n">era_history_str</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_str</span><span class="p">(</span>
            <span class="p">[</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_str</span><span class="p">(</span><span class="n">era</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sorted_</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">era</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="p">],</span>
            <span class="n">strvals</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">override_reprs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;best_results&#39;</span><span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">best_results</span><span class="p">),</span>
            <span class="c1"># &#39;best_weights&#39;: ut.truncate_str(str(model.best_weights)),</span>
            <span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">data_params</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="s1">&#39;learn_state&#39;</span><span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">learn_state</span><span class="p">),</span>
            <span class="s1">&#39;era_history&#39;</span><span class="p">:</span> <span class="n">era_history_str</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">override_reprs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">other_override_reprs</span><span class="p">)</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">override_reprs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">is_func_or_method</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                <span class="c1"># rrr support</span>
                <span class="k">continue</span>
            <span class="n">override_reprs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="n">state_str</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_str</span><span class="p">(</span><span class="n">override_reprs</span><span class="p">,</span> <span class="n">sorted_</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">strvals</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state_str</span></div>

<div class="viewcode-block" id="_ModelStrings.make_arch_json"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelStrings.make_arch_json">[docs]</a>    <span class="k">def</span> <span class="nf">make_arch_json</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">with_noise</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia_cnn.models.abstract_models make_arch_json --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn.models.abstract_models import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn.models import mnist</span>
<span class="sd">            &gt;&gt;&gt; model, dataset = mnist.testdata_mnist(defaultname=&#39;resnet&#39;)</span>
<span class="sd">            &gt;&gt;&gt; #model = mnist.MNISTModel(batch_size=128, data_shape=(28, 28, 1),</span>
<span class="sd">            &gt;&gt;&gt; #                         output_dims=10, batch_norm=True)</span>
<span class="sd">            &gt;&gt;&gt; model.init_arch()</span>
<span class="sd">            &gt;&gt;&gt; json_str = model.make_arch_json(with_noise=True)</span>
<span class="sd">            &gt;&gt;&gt; print(json_str)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">layer_list</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_all_layers</span><span class="p">(</span><span class="n">with_noise</span><span class="o">=</span><span class="n">with_noise</span><span class="p">)</span>
        <span class="n">layer_json_list</span> <span class="o">=</span> <span class="n">net_strs</span><span class="o">.</span><span class="n">make_layers_json</span><span class="p">(</span><span class="n">layer_list</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">with_noise</span><span class="p">)</span>
        <span class="n">json_dict</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">()</span>
        <span class="n">json_dict</span><span class="p">[</span><span class="s1">&#39;arch_hashid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_arch_hashid</span><span class="p">()</span>
        <span class="n">json_dict</span><span class="p">[</span><span class="s1">&#39;layers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer_json_list</span>

        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">raw_json</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">json_dict</span><span class="p">,</span> <span class="n">pretty</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">raw_json</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ut</span><span class="o">.</span><span class="n">get_indentation</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">])</span> <span class="o">/</span> <span class="mi">4</span>
            <span class="c1"># Collapse newlines past indent 4</span>
            <span class="n">nl</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">newlines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">prev</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">levels</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">level</span> <span class="o">&gt;=</span> <span class="n">nl</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">prev</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                        <span class="n">newlines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="n">line</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">newlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="n">prev</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="n">prev</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">json_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">newlines</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># prettier json</span>
            <span class="n">json_str</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">repr2_json</span><span class="p">(</span><span class="n">json_dict</span><span class="p">,</span> <span class="n">nl</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">json_str</span></div>

<div class="viewcode-block" id="_ModelStrings.get_arch_str"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelStrings.get_arch_str">[docs]</a>    <span class="k">def</span> <span class="nf">get_arch_str</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">with_noise</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        with_noise is a boolean that specifies if layers that doesnt</span>
<span class="sd">        affect the flow of information in the determenistic setting are to be</span>
<span class="sd">        included. IE get rid of dropout.</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia_cnn.models.abstract_models _ModelStrings.get_arch_str:0</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn.models.abstract_models import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn.models.mnist import MNISTModel</span>
<span class="sd">            &gt;&gt;&gt; model = MNISTModel(batch_size=128, data_shape=(28, 28, 1),</span>
<span class="sd">            &gt;&gt;&gt;                    output_dims=10, batch_norm=True)</span>
<span class="sd">            &gt;&gt;&gt; model.init_arch()</span>
<span class="sd">            &gt;&gt;&gt; result = model.get_arch_str(sep=ut.NEWLINE, with_noise=False)</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">            InputLayer(name=I0,shape=(128, 1, 24, 24))</span>
<span class="sd">            Conv2DDNNLayer(name=C1,num_filters=32,stride=(1, 1),nonlinearity=rectify)</span>
<span class="sd">            MaxPool2DDNNLayer(name=P1,stride=(2, 2))</span>
<span class="sd">            Conv2DDNNLayer(name=C2,num_filters=32,stride=(1, 1),nonlinearity=rectify)</span>
<span class="sd">            MaxPool2DDNNLayer(name=P2,stride=(2, 2))</span>
<span class="sd">            DenseLayer(name=F3,num_units=256,nonlinearity=rectify)</span>
<span class="sd">            DenseLayer(name=O4,num_units=10,nonlinearity=softmax)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">output_layer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
        <span class="n">layer_list</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_all_layers</span><span class="p">(</span><span class="n">with_noise</span><span class="o">=</span><span class="n">with_noise</span><span class="p">)</span>
        <span class="n">layer_str_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">net_strs</span><span class="o">.</span><span class="n">make_layer_str</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">with_name</span><span class="o">=</span><span class="n">with_noise</span><span class="p">)</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layer_list</span>
        <span class="p">]</span>
        <span class="n">architecture_str</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">layer_str_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">architecture_str</span></div>

<div class="viewcode-block" id="_ModelStrings.get_layer_info_str"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelStrings.get_layer_info_str">[docs]</a>    <span class="k">def</span> <span class="nf">get_layer_info_str</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia_cnn.models.abstract_models _ModelStrings.get_layer_info_str:0</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn.models.abstract_models import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn.models.mnist import MNISTModel</span>
<span class="sd">            &gt;&gt;&gt; model = MNISTModel(batch_size=128, data_shape=(24, 24, 1),</span>
<span class="sd">            &gt;&gt;&gt;                    output_dims=10)</span>
<span class="sd">            &gt;&gt;&gt; model.init_arch()</span>
<span class="sd">            &gt;&gt;&gt; result = model.get_layer_info_str()</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">            Network Structure:</span>
<span class="sd">             index  Name  Layer               Outputs      Bytes OutShape           Params</span>
<span class="sd">             0      I0    InputLayer              576    294,912 (128, 1, 24, 24)   []</span>
<span class="sd">             1      C1    Conv2DDNNLayer       12,800  6,556,928 (128, 32, 20, 20)  [C1.W(32,1,5,5, {t,r}), C1.b(32, {t})]</span>
<span class="sd">             2      P1    MaxPool2DDNNLayer     3,200  1,638,400 (128, 32, 10, 10)  []</span>
<span class="sd">             3      C2    Conv2DDNNLayer        1,152    692,352 (128, 32, 6, 6)    [C2.W(32,32,5,5, {t,r}), C2.b(32, {t})]</span>
<span class="sd">             4      P2    MaxPool2DDNNLayer       288    147,456 (128, 32, 3, 3)    []</span>
<span class="sd">             5      D2    DropoutLayer            288    147,456 (128, 32, 3, 3)    []</span>
<span class="sd">             6      F3    DenseLayer              256    427,008 (128, 256)         [F3.W(288,256, {t,r}), F3.b(256, {t})]</span>
<span class="sd">             7      D3    DropoutLayer            256    131,072 (128, 256)         []</span>
<span class="sd">             8      O4    DenseLayer               10     15,400 (128, 10)          [O4.W(256,10, {t,r}), O4.b(10, {t})]</span>
<span class="sd">            ...this model has 103,018 learnable parameters</span>
<span class="sd">            ...this model will use 10,050,984 bytes = 9.59 MB</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">net_strs</span><span class="o">.</span><span class="n">get_layer_info_str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">get_all_layers</span><span class="p">(),</span> <span class="n">model</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span></div>

    <span class="c1"># --- PRINTING</span>

<div class="viewcode-block" id="_ModelStrings.print_state_str"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelStrings.print_state_str">[docs]</a>    <span class="k">def</span> <span class="nf">print_state_str</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">get_state_str</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">))</span></div>

<div class="viewcode-block" id="_ModelStrings.print_layer_info"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelStrings.print_layer_info">[docs]</a>    <span class="k">def</span> <span class="nf">print_layer_info</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="n">net_strs</span><span class="o">.</span><span class="n">print_layer_info</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">get_all_layers</span><span class="p">())</span></div>

<div class="viewcode-block" id="_ModelStrings.print_arch_str"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelStrings.print_arch_str">[docs]</a>    <span class="k">def</span> <span class="nf">print_arch_str</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  &#39;</span><span class="p">):</span>
        <span class="n">architecture_str</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_arch_str</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">architecture_str</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">architecture_str</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">architecture_str</span> <span class="o">=</span> <span class="s1">&#39;UNDEFINED&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Architecture:&#39;</span> <span class="o">+</span> <span class="n">sep</span> <span class="o">+</span> <span class="n">architecture_str</span><span class="p">)</span></div>

<div class="viewcode-block" id="_ModelStrings.print_model_info_str"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelStrings.print_model_info_str">[docs]</a>    <span class="k">def</span> <span class="nf">print_model_info_str</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">---- Arch Str&#39;</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">print_arch_str</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">---- Layer Info&#39;</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">print_layer_info</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">---- Arch HashID&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s1">&#39;arch_hashid=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">get_arch_hashid</span><span class="p">()),</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;----&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="_ModelIDs"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelIDs">[docs]</a><span class="nd">@ut</span><span class="o">.</span><span class="n">reloadable_class</span>
<span class="k">class</span> <span class="nc">_ModelIDs</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="_ModelIDs._init_id_vars"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelIDs._init_id_vars">[docs]</a>    <span class="k">def</span> <span class="nf">_init_id_vars</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>
        <span class="c1"># if model.name is None:</span>
        <span class="c1">#    model.name = ut.get_classname(model.__class__, local=True)</span>

    <span class="k">def</span> <span class="nf">__nice__</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">get_arch_nice</span><span class="p">(),</span> <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">get_history_nice</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">+</span> <span class="n">parts</span>
        <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hash_id</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="n">arch_hashid</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_arch_hashid</span><span class="p">()</span>
        <span class="n">history_hashid</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">get_history_hashid</span><span class="p">()</span>
        <span class="n">hashid</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">hashstr27</span><span class="p">(</span><span class="n">history_hashid</span> <span class="o">+</span> <span class="n">arch_hashid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hashid</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">arch_id</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia_cnn.models.abstract_models _ModelIDs.arch_id:0</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn.models.abstract_models import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn.models.mnist import MNISTModel</span>
<span class="sd">            &gt;&gt;&gt; model = MNISTModel(batch_size=128, data_shape=(24, 24, 1),</span>
<span class="sd">            &gt;&gt;&gt;                    output_dims=10, name=&#39;bnorm&#39;)</span>
<span class="sd">            &gt;&gt;&gt; model.init_arch()</span>
<span class="sd">            &gt;&gt;&gt; result = str(model.arch_id)</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;arch&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">get_arch_nice</span><span class="p">(),</span> <span class="n">model</span><span class="o">.</span><span class="n">get_arch_hashid</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;arch&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">get_arch_nice</span><span class="p">(),</span> <span class="n">model</span><span class="o">.</span><span class="n">get_arch_hashid</span><span class="p">()]</span>
        <span class="n">arch_id</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">arch_id</span>

<div class="viewcode-block" id="_ModelIDs.get_arch_hashid"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelIDs.get_arch_hashid">[docs]</a>    <span class="k">def</span> <span class="nf">get_arch_hashid</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a hash identifying the architecture of the determenistic net.</span>
<span class="sd">        This does not involve any dropout or noise layers, nor does the</span>
<span class="sd">        initialization of the weights matter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">arch_str</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_arch_str</span><span class="p">(</span><span class="n">with_noise</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">arch_hashid</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">hashstr27</span><span class="p">(</span><span class="n">arch_str</span><span class="p">,</span> <span class="n">hashlen</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">arch_hashid</span></div>

<div class="viewcode-block" id="_ModelIDs.get_arch_nice"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelIDs.get_arch_nice">[docs]</a>    <span class="k">def</span> <span class="nf">get_arch_nice</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Makes a string that shows the number of input units, output units,</span>
<span class="sd">        hidden units, parameters, and model depth.</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia_cnn.models.abstract_models get_arch_nice --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn.models.abstract_models import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn.models.mnist import MNISTModel</span>
<span class="sd">            &gt;&gt;&gt; model = MNISTModel(batch_size=128, data_shape=(24, 24, 1),</span>
<span class="sd">            &gt;&gt;&gt;                    output_dims=10)</span>
<span class="sd">            &gt;&gt;&gt; model.init_arch()</span>
<span class="sd">            &gt;&gt;&gt; result = str(model.get_arch_nice())</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">            o10_d4_c107</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">output_layer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;NoArch&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">weighted_layers</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_all_layers</span><span class="p">(</span>
                <span class="n">with_noise</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">with_weightless</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">info_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">net_strs</span><span class="o">.</span><span class="n">get_layer_info</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">weighted_layers</span><span class="p">]</span>
            <span class="c1"># The number of units depends if you look at things via input or output</span>
            <span class="c1"># does a convolutional layer have its outputs or the outputs of the pooling layer?</span>
            <span class="c1"># num_units1 = sum([info[&#39;num_outputs&#39;] for info in info_list])</span>
            <span class="n">nhidden</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;num_inputs&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">info_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]])</span>
            <span class="c1"># num_units2 += net_strs.get_layer_info(model.output_layer)[&#39;num_outputs&#39;]</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">weighted_layers</span><span class="p">)</span>
            <span class="n">nparam</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;num_params&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">info_list</span><span class="p">])</span>
            <span class="n">nin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">data_shape</span><span class="p">)</span>
            <span class="n">nout</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">output_dims</span>
            <span class="n">fmtdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">nin</span><span class="o">=</span><span class="n">nin</span><span class="p">,</span>
                <span class="n">nout</span><span class="o">=</span><span class="n">nout</span><span class="p">,</span>
                <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span>
                <span class="n">nhidden</span><span class="o">=</span><span class="n">nhidden</span><span class="p">,</span>
                <span class="n">nparam</span><span class="o">=</span><span class="n">nparam</span><span class="p">,</span>
                <span class="c1"># logmcomplex=int(np.round(np.log10(nhidden + nparam)))</span>
                <span class="n">mcomplex</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">nhidden</span> <span class="o">+</span> <span class="n">nparam</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)),</span>
            <span class="p">)</span>
            <span class="c1"># nice = &#39;i{nin}_o{nout}_d{depth}_h{nhidden}_p{nparam}&#39;.format(**fmtdict)</span>
            <span class="c1"># Use a complexity measure</span>
            <span class="c1"># nice = &#39;i{nin}_o{nout}_d{depth}_c{mcomplex}&#39;.format(**fmtdict)</span>
            <span class="n">nice</span> <span class="o">=</span> <span class="s1">&#39;o</span><span class="si">{nout}</span><span class="s1">_d</span><span class="si">{depth}</span><span class="s1">_c</span><span class="si">{mcomplex}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fmtdict</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">nice</span></div></div>


<div class="viewcode-block" id="_ModelIO"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelIO">[docs]</a><span class="nd">@ut</span><span class="o">.</span><span class="n">reloadable_class</span>
<span class="k">class</span> <span class="nc">_ModelIO</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="_ModelIO._init_io_vars"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelIO._init_io_vars">[docs]</a>    <span class="k">def</span> <span class="nf">_init_io_vars</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">dataset_dpath</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dataset_dpath&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">training_dpath</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;training_dpath&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_arch_dpath</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;arch_dpath&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="_ModelIO.print_structure"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelIO.print_structure">[docs]</a>    <span class="k">def</span> <span class="nf">print_structure</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m wbia_cnn.models.abstract_models print_structure --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn.ingest_data import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; dataset = grab_mnist_category_dataset()</span>
<span class="sd">            &gt;&gt;&gt; dataset.print_dir_structure()</span>
<span class="sd">            &gt;&gt;&gt; # ----</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn.models.mnist import MNISTModel</span>
<span class="sd">            &gt;&gt;&gt; model = MNISTModel(batch_size=128, data_shape=(24, 24, 1),</span>
<span class="sd">            &gt;&gt;&gt;                    output_dims=10, dataset_dpath=dataset.dataset_dpath)</span>
<span class="sd">            &gt;&gt;&gt; model.print_structure()</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print(model.model_dpath)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">arch_dpath</span><span class="p">)</span>
        <span class="c1"># print(model.best_dpath)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">saved_session_dpath</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">checkpoint_dpath</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">diagnostic_dpath</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">trained_model_dpath</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">trained_arch_dpath</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">trained_model_dpath</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">join</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">training_dpath</span><span class="p">,</span> <span class="s1">&#39;trained_models&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">trained_arch_dpath</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">join</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">trained_model_dpath</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">arch_id</span><span class="p">)</span>

    <span class="c1"># @property</span>
    <span class="c1"># def model_dpath(model):</span>
    <span class="c1">#    return join(model.dataset_dpath, &#39;models&#39;)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">arch_dpath</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="c1"># return join(model.model_dpath, model.arch_id)</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_arch_dpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">join</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">dataset_dpath</span><span class="p">,</span> <span class="s1">&#39;models&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">arch_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">_arch_dpath</span>

    <span class="nd">@arch_dpath</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">arch_dpath</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">arch_dpath</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_arch_dpath</span> <span class="o">=</span> <span class="n">arch_dpath</span>

    <span class="c1"># @property</span>
    <span class="c1"># def best_dpath(model):</span>
    <span class="c1">#    return join(model.arch_dpath, &#39;best&#39;)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">checkpoint_dpath</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">join</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">arch_dpath</span><span class="p">,</span> <span class="s1">&#39;checkpoints&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">saved_session_dpath</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">join</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">arch_dpath</span><span class="p">,</span> <span class="s1">&#39;saved_sessions&#39;</span><span class="p">)</span>

    <span class="c1"># @property</span>
    <span class="c1"># def diagnostic_dpath(model):</span>
    <span class="c1">#    return join(model.arch_dpath, &#39;diagnostics&#39;)</span>

    <span class="c1"># def get_epoch_diagnostic_dpath(model, epoch=None):</span>
    <span class="c1">#    import utool as ut</span>
    <span class="c1">#    diagnostic_dpath = model.diagnostic_dpath</span>
    <span class="c1">#    ut.ensuredir(diagnostic_dpath)</span>
    <span class="c1">#    epoch_dpath = ut.unixjoin(diagnostic_dpath, model.history.hist_id)</span>
    <span class="c1">#    ut.ensuredir(epoch_dpath)</span>
    <span class="c1">#    return epoch_dpath</span>

<div class="viewcode-block" id="_ModelIO.list_saved_checkpoints"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelIO.list_saved_checkpoints">[docs]</a>    <span class="k">def</span> <span class="nf">list_saved_checkpoints</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="n">dpath</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_get_model_dpath</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">checkpoint_dirs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">fullpath</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">checkpoint_dirs</span></div>

<div class="viewcode-block" id="_ModelIO._get_model_dpath"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelIO._get_model_dpath">[docs]</a>    <span class="k">def</span> <span class="nf">_get_model_dpath</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dpath</span><span class="p">,</span> <span class="n">checkpoint_tag</span><span class="p">):</span>
        <span class="n">dpath</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">arch_dpath</span> <span class="k">if</span> <span class="n">dpath</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">dpath</span>
        <span class="k">if</span> <span class="n">checkpoint_tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># checkpoint dir requested</span>
            <span class="n">dpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="s1">&#39;checkpoints&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">checkpoint_tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># specific checkpoint requested</span>
                <span class="n">dpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="n">checkpoint_tag</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dpath</span></div>

<div class="viewcode-block" id="_ModelIO._get_model_file_fpath"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelIO._get_model_file_fpath">[docs]</a>    <span class="k">def</span> <span class="nf">_get_model_file_fpath</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">default_fname</span><span class="p">,</span> <span class="n">fpath</span><span class="p">,</span> <span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">checkpoint_tag</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">default_fname</span> <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">fname</span>
            <span class="n">dpath</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_get_model_dpath</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="n">checkpoint_tag</span><span class="p">)</span>
            <span class="n">fpath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">checkpoint_tag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;fpath overrides all other settings&#39;</span>
            <span class="k">assert</span> <span class="n">dpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;fpath overrides all other settings&#39;</span>
            <span class="k">assert</span> <span class="n">fname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;fpath overrides all other settings&#39;</span>
        <span class="k">return</span> <span class="n">fpath</span></div>

<div class="viewcode-block" id="_ModelIO.resolve_fuzzy_checkpoint_pattern"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelIO.resolve_fuzzy_checkpoint_pattern">[docs]</a>    <span class="k">def</span> <span class="nf">resolve_fuzzy_checkpoint_pattern</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">checkpoint_pattern</span><span class="p">,</span> <span class="n">extern_dpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        tries to find a matching checkpoint so you dont have to type a full</span>
<span class="sd">        hash</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dpath</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_get_model_dpath</span><span class="p">(</span><span class="n">extern_dpath</span><span class="p">,</span> <span class="n">checkpoint_pattern</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">dpath</span><span class="p">):</span>
            <span class="n">checkpoint_tag</span> <span class="o">=</span> <span class="n">checkpoint_pattern</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">checkpoint_dpath</span> <span class="o">=</span> <span class="n">dirname</span><span class="p">(</span><span class="n">dpath</span><span class="p">)</span>
            <span class="n">checkpoint_globpat</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span> <span class="o">+</span> <span class="n">checkpoint_pattern</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span>
            <span class="n">matching_dpaths</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">checkpoint_dpath</span><span class="p">,</span> <span class="n">checkpoint_globpat</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matching_dpaths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s1">&#39;Could not resolve checkpoint_pattern=</span><span class="si">%r</span><span class="s1">. No Matches&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">checkpoint_pattern</span><span class="p">,)</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">matching_dpaths</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s1">&#39;Could not resolve checkpoint_pattern=</span><span class="si">%r</span><span class="s1">. &#39;</span>
                        <span class="s1">&#39;matching_dpaths=</span><span class="si">%r</span><span class="s1">. Too many matches&#39;</span>
                    <span class="p">)</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">checkpoint_pattern</span><span class="p">,</span> <span class="n">matching_dpaths</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">checkpoint_tag</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">matching_dpaths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s1">&#39;Resolved checkpoint pattern to checkpoint_tag=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">checkpoint_tag</span><span class="p">,)</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">checkpoint_tag</span></div>

<div class="viewcode-block" id="_ModelIO.has_saved_state"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelIO.has_saved_state">[docs]</a>    <span class="k">def</span> <span class="nf">has_saved_state</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">checkpoint_tag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if there are any saved model states matching the checkpoing tag.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_model_state_fpath</span><span class="p">(</span><span class="n">checkpoint_tag</span><span class="o">=</span><span class="n">checkpoint_tag</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">checkpoint_tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">assertpath</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ut</span><span class="o">.</span><span class="n">checkpath</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span></div>

<div class="viewcode-block" id="_ModelIO.get_model_state_fpath"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelIO.get_model_state_fpath">[docs]</a>    <span class="k">def</span> <span class="nf">get_model_state_fpath</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">fpath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dpath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">checkpoint_tag</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="n">default_fname</span> <span class="o">=</span> <span class="s1">&#39;model_state_arch_</span><span class="si">%s</span><span class="s1">.pkl&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">get_arch_hashid</span><span class="p">())</span>
        <span class="n">model_state_fpath</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_get_model_file_fpath</span><span class="p">(</span>
            <span class="n">default_fname</span><span class="p">,</span> <span class="n">fpath</span><span class="p">,</span> <span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">checkpoint_tag</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">model_state_fpath</span></div>

<div class="viewcode-block" id="_ModelIO.get_model_info_fpath"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelIO.get_model_info_fpath">[docs]</a>    <span class="k">def</span> <span class="nf">get_model_info_fpath</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">fpath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dpath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">checkpoint_tag</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="n">default_fname</span> <span class="o">=</span> <span class="s1">&#39;model_info_arch_</span><span class="si">%s</span><span class="s1">.pkl&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">get_arch_hashid</span><span class="p">())</span>
        <span class="n">model_state_fpath</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_get_model_file_fpath</span><span class="p">(</span>
            <span class="n">default_fname</span><span class="p">,</span> <span class="n">fpath</span><span class="p">,</span> <span class="n">dpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">checkpoint_tag</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">model_state_fpath</span></div>

<div class="viewcode-block" id="_ModelIO.checkpoint_save_model_state"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelIO.checkpoint_save_model_state">[docs]</a>    <span class="k">def</span> <span class="nf">checkpoint_save_model_state</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_model_state_fpath</span><span class="p">(</span><span class="n">checkpoint_tag</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">hist_id</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">fpath</span><span class="p">))</span>
        <span class="n">model</span><span class="o">.</span><span class="n">save_model_state</span><span class="p">(</span><span class="n">fpath</span><span class="o">=</span><span class="n">fpath</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fpath</span></div>

<div class="viewcode-block" id="_ModelIO.checkpoint_save_model_info"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelIO.checkpoint_save_model_info">[docs]</a>    <span class="k">def</span> <span class="nf">checkpoint_save_model_info</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_model_info_fpath</span><span class="p">(</span><span class="n">checkpoint_tag</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">hist_id</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">dirname</span><span class="p">(</span><span class="n">fpath</span><span class="p">))</span>
        <span class="n">model</span><span class="o">.</span><span class="n">save_model_info</span><span class="p">(</span><span class="n">fpath</span><span class="o">=</span><span class="n">fpath</span><span class="p">)</span></div>

<div class="viewcode-block" id="_ModelIO.save_model_state"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelIO.save_model_state">[docs]</a>    <span class="k">def</span> <span class="nf">save_model_state</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; saves current model state &quot;&quot;&quot;</span>
        <span class="n">current_weights</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_all_param_values</span><span class="p">()</span>
        <span class="n">model_state</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;best_results&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">best_results</span><span class="p">,</span>
            <span class="s1">&#39;data_params&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">data_params</span><span class="p">,</span>
            <span class="s1">&#39;current_weights&#39;</span><span class="p">:</span> <span class="n">current_weights</span><span class="p">,</span>
            <span class="s1">&#39;encoder&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s1">&#39;input_shape&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">input_shape</span><span class="p">,</span>
            <span class="s1">&#39;data_shape&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">data_shape</span><span class="p">,</span>
            <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">data_shape</span><span class="p">,</span>
            <span class="s1">&#39;output_dims&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">output_dims</span><span class="p">,</span>
            <span class="s1">&#39;era_history&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="p">,</span>
            <span class="c1"># &#39;arch_tag&#39;: model.arch_tag,</span>
        <span class="p">}</span>
        <span class="n">model_state_fpath</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_model_state_fpath</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># print(&#39;saving model state to: %s&#39; % (model_state_fpath,))</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">save_cPkl</span><span class="p">(</span><span class="n">model_state_fpath</span><span class="p">,</span> <span class="n">model_state</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;saved model state to </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model_state_fpath</span><span class="p">,))</span>
        <span class="c1"># print(&#39;finished saving&#39;)</span>
        <span class="k">return</span> <span class="n">model_state_fpath</span></div>

<div class="viewcode-block" id="_ModelIO.save_model_info"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelIO.save_model_info">[docs]</a>    <span class="k">def</span> <span class="nf">save_model_info</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; save model information (history and results but no weights) &quot;&quot;&quot;</span>
        <span class="n">model_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;best_results&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">best_results</span><span class="p">,</span>
            <span class="s1">&#39;input_shape&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">input_shape</span><span class="p">,</span>
            <span class="s1">&#39;output_dims&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">output_dims</span><span class="p">,</span>
            <span class="s1">&#39;era_history&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">model_info_fpath</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_model_state_fpath</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># print(&#39;saving model info to: %s&#39; % (model_info_fpath,))</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">save_cPkl</span><span class="p">(</span><span class="n">model_info_fpath</span><span class="p">,</span> <span class="n">model_info</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;saved model info&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="_ModelIO.load_model_state"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelIO.load_model_state">[docs]</a>    <span class="k">def</span> <span class="nf">load_model_state</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        kwargs = {}</span>
<span class="sd">        TODO: resolve load_model_state and load_extern_weights into a single</span>
<span class="sd">            function that is less magic in what it does and more</span>
<span class="sd">            straightforward</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # Assumes mnist is trained</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn.models.abstract_models import  *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; from wbia_cnn.models import mnist</span>
<span class="sd">            &gt;&gt;&gt; model, dataset = mnist.testdata_mnist()</span>
<span class="sd">            &gt;&gt;&gt; model.init_arch()</span>
<span class="sd">            &gt;&gt;&gt; model.load_model_state()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model_state_fpath</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_model_state_fpath</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[model] loading model state from: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model_state_fpath</span><span class="p">,))</span>
        <span class="n">model_state</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">load_cPkl</span><span class="p">(</span><span class="n">model_state_fpath</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="s1">&#39;BaseModel&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;input_shape&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="n">model</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="p">),</span> <span class="s1">&#39;architecture disagreement&#39;</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;output_dims&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">model</span><span class="o">.</span><span class="n">output_dims</span>
            <span class="p">),</span> <span class="s1">&#39;architecture disagreement&#39;</span>
            <span class="k">if</span> <span class="s1">&#39;preproc_kw&#39;</span> <span class="ow">in</span> <span class="n">model_state</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">data_params</span> <span class="o">=</span> <span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;preproc_kw&#39;</span><span class="p">]</span>
                <span class="n">model</span><span class="o">.</span><span class="n">_fix_center_mean_std</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">data_params</span> <span class="o">=</span> <span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;data_params&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># HACK TO LOAD ABSTRACT MODEL FOR DIAGNOSITIC REASONS</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING LOADING ABSTRACT MODEL&#39;</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">best_results</span> <span class="o">=</span> <span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;best_results&#39;</span><span class="p">]</span>
        <span class="n">model</span><span class="o">.</span><span class="n">input_shape</span> <span class="o">=</span> <span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;input_shape&#39;</span><span class="p">]</span>
        <span class="n">model</span><span class="o">.</span><span class="n">output_dims</span> <span class="o">=</span> <span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;output_dims&#39;</span><span class="p">]</span>
        <span class="n">model</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">model_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;era_history&#39;</span> <span class="ow">in</span> <span class="n">model_state</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">History</span><span class="o">.</span><span class="n">from_oldstyle</span><span class="p">(</span><span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;era_history&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;era_history&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">History</span><span class="p">()</span>
            <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;history&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="s1">&#39;BaseModel&#39;</span><span class="p">:</span>
            <span class="c1"># hack for abstract model</span>
            <span class="c1"># model.output_layer is not None</span>
            <span class="n">model</span><span class="o">.</span><span class="n">set_all_param_values</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">best_results</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="_ModelIO.load_extern_weights"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelIO.load_extern_weights">[docs]</a>    <span class="k">def</span> <span class="nf">load_extern_weights</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; load weights from another model &quot;&quot;&quot;</span>
        <span class="n">model_state_fpath</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_model_state_fpath</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[model] loading extern weights from: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model_state_fpath</span><span class="p">,))</span>
        <span class="n">model_state</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">load_cPkl</span><span class="p">(</span><span class="n">model_state_fpath</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">VERBOSE_CNN</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;External Model State:&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_str</span><span class="p">(</span><span class="n">model_state</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="c1"># check compatibility with this architecture</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;input_shape&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="n">model</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="p">),</span> <span class="s1">&#39;architecture disagreement&#39;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;output_dims&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">model</span><span class="o">.</span><span class="n">output_dims</span>
        <span class="p">),</span> <span class="s1">&#39;architecture disagreement&#39;</span>
        <span class="c1"># Just set the weights, no other training state variables</span>
        <span class="n">model</span><span class="o">.</span><span class="n">set_all_param_values</span><span class="p">(</span><span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;best_weights&#39;</span><span class="p">])</span>
        <span class="c1"># also need to make sure the same preprocessing is used</span>
        <span class="c1"># TODO make this a layer?</span>
        <span class="k">if</span> <span class="s1">&#39;preproc_kw&#39;</span> <span class="ow">in</span> <span class="n">model_state</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">data_params</span> <span class="o">=</span> <span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;preproc_kw&#39;</span><span class="p">]</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_fix_center_mean_std</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">data_params</span> <span class="o">=</span> <span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;data_params&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;era_history&#39;</span> <span class="ow">in</span> <span class="n">model_state</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">History</span><span class="o">.</span><span class="n">from_oldstyle</span><span class="p">(</span><span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;era_history&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">History</span><span class="p">()</span>
            <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;history&#39;</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="_ModelUtility"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelUtility">[docs]</a><span class="k">class</span> <span class="nc">_ModelUtility</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="_ModelUtility.set_all_param_values"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelUtility.set_all_param_values">[docs]</a>    <span class="k">def</span> <span class="nf">set_all_param_values</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">weights_list</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">Lasagne</span> <span class="kn">import</span> <span class="n">lasagne</span>

        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="s1">&#39;.*topo.*&#39;</span><span class="p">)</span>
            <span class="n">lasagne</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">set_all_param_values</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">output_layer</span><span class="p">,</span> <span class="n">weights_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="_ModelUtility.get_all_param_values"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelUtility.get_all_param_values">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_param_values</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">Lasagne</span> <span class="kn">import</span> <span class="n">lasagne</span>

        <span class="n">weights_list</span> <span class="o">=</span> <span class="n">lasagne</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">get_all_param_values</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">output_layer</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">weights_list</span></div>

<div class="viewcode-block" id="_ModelUtility.get_all_params"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelUtility.get_all_params">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_params</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">tags</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">Lasagne</span> <span class="kn">import</span> <span class="n">lasagne</span>

        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="s1">&#39;.*topo.*&#39;</span><span class="p">)</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="n">lasagne</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">get_all_params</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">output_layer</span><span class="p">,</span> <span class="o">**</span><span class="n">tags</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">parameters</span></div>

<div class="viewcode-block" id="_ModelUtility.get_all_layer_info"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelUtility.get_all_layer_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_layer_info</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">net_strs</span><span class="o">.</span><span class="n">get_layer_info</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">get_all_layers</span><span class="p">()]</span></div>

<div class="viewcode-block" id="_ModelUtility.get_all_layers"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelUtility.get_all_layers">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_layers</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">with_noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_weightless</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">Lasagne</span> <span class="kn">import</span> <span class="n">lasagne</span>

        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="s1">&#39;.*topo.*&#39;</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="s1">&#39;.*layer.get_all_layers.*&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">model</span><span class="o">.</span><span class="n">output_layer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;need to initialize&#39;</span>
            <span class="n">layer_list_</span> <span class="o">=</span> <span class="n">lasagne</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">get_all_layers</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">output_layer</span><span class="p">)</span>
        <span class="n">layer_list</span> <span class="o">=</span> <span class="n">layer_list_</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">with_noise</span><span class="p">:</span>
            <span class="c1"># Remove dropout / gaussian noise layers</span>
            <span class="n">layer_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">layer</span>
                <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layer_list_</span>
                <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lasagne</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">noise</span><span class="o">.</span><span class="n">__all__</span>
            <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">with_weightless</span><span class="p">:</span>
            <span class="c1"># Remove layers without weights</span>
            <span class="n">layer_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">layer</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layer_list</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">layer_list</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">layers_</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; for compatibility with nolearn visualizations &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">get_all_layers</span><span class="p">()</span>

<div class="viewcode-block" id="_ModelUtility.get_output_layer"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelUtility.get_output_layer">[docs]</a>    <span class="k">def</span> <span class="nf">get_output_layer</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">output_layer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">output_layer</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="_ModelUtility._validate_data"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelUtility._validate_data">[docs]</a>    <span class="k">def</span> <span class="nf">_validate_data</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check to make sure data agrees with model input &quot;&quot;&quot;</span>
        <span class="n">input_layer</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_all_layers</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">expected_item_shape</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">input_layer</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">expected_item_shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">expected_item_shape</span><span class="p">)</span>
        <span class="n">given_item_shape</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">given_item_shape</span> <span class="o">!=</span> <span class="n">expected_item_shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;inconsistent item shape: &#39;</span>
                <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;expected_item_shape = </span><span class="si">%r</span><span class="s1">, &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">expected_item_shape</span><span class="p">,))</span>
                <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;given_item_shape = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">given_item_shape</span><span class="p">,))</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="_ModelUtility._validate_labels"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelUtility._validate_labels">[docs]</a>    <span class="k">def</span> <span class="nf">_validate_labels</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span>
                <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">data_per_label_input</span>
            <span class="p">),</span> <span class="s1">&#39;bad data / label alignment&#39;</span>
        <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span>
                <span class="n">w</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">data_per_label_input</span>
            <span class="p">),</span> <span class="s1">&#39;bad data / label alignment&#39;</span></div>

<div class="viewcode-block" id="_ModelUtility._validate_input"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelUtility._validate_input">[docs]</a>    <span class="k">def</span> <span class="nf">_validate_input</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_validate_data</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_validate_labels</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span></div>

<div class="viewcode-block" id="_ModelUtility.make_random_testdata"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models._ModelUtility.make_random_testdata">[docs]</a>    <span class="k">def</span> <span class="nf">make_random_testdata</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">37</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cv2_format</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">asint</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;made random testdata&#39;</span><span class="p">)</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_rng</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span>
        <span class="n">num_labels</span> <span class="o">=</span> <span class="n">num</span>
        <span class="n">num_data</span> <span class="o">=</span> <span class="n">num</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">data_per_label_input</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">num_data</span><span class="p">,</span> <span class="o">*</span><span class="n">model</span><span class="o">.</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">num_labels</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">output_dims</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="k">if</span> <span class="n">asint</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cv2_format</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span></div></div>


<div class="viewcode-block" id="BaseModel"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.BaseModel">[docs]</a><span class="nd">@ut</span><span class="o">.</span><span class="n">reloadable_class</span>
<span class="k">class</span> <span class="nc">BaseModel</span><span class="p">(</span>
    <span class="n">_model_legacy</span><span class="o">.</span><span class="n">_ModelLegacy</span><span class="p">,</span>
    <span class="n">_ModelVisualization</span><span class="p">,</span>
    <span class="n">_ModelIO</span><span class="p">,</span>
    <span class="n">_ModelStrings</span><span class="p">,</span>
    <span class="n">_ModelIDs</span><span class="p">,</span>
    <span class="n">_ModelBackend</span><span class="p">,</span>
    <span class="n">_ModelFitter</span><span class="p">,</span>
    <span class="n">_ModelPredicter</span><span class="p">,</span>
    <span class="n">_ModelBatch</span><span class="p">,</span>
    <span class="n">_ModelUtility</span><span class="p">,</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">NiceRepr</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract model providing functionality for all other models to derive from</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Guess on Shapes:</span>
<span class="sd">            input_shape (tuple): in Theano format (b, c, h, w)</span>
<span class="sd">            data_shape (tuple):  in  Numpy format (b, h, w, c)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;verbose_compile&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">logging</span>

            <span class="n">compile_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;theano.compile&#39;</span><span class="p">)</span>
            <span class="n">compile_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span>
        <span class="c1"># Should delayed import be moved? (or deleted)</span>
        <span class="n">delayed_import</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_init_io_vars</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_init_id_vars</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_init_shape_vars</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_init_compile_vars</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_init_fit_vars</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_init_batch_vars</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">output_layer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">autoinit</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;autoinit&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Model was given unused keywords=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">autoinit</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">init_arch</span><span class="p">()</span>

<div class="viewcode-block" id="BaseModel._init_shape_vars"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.BaseModel._init_shape_vars">[docs]</a>    <span class="k">def</span> <span class="nf">_init_shape_vars</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="n">input_shape</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;input_shape&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;batch_size&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">data_shape</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;data_shape&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">output_dims</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;output_dims&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">input_shape</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">data_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">report_error</span><span class="p">(</span><span class="s1">&#39;Must specify either input_shape or data_shape&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">input_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">CONST_BATCH</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">CONST_BATCH</span><span class="p">:</span>
                <span class="c1"># Fixed batch size</span>
                <span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">data_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Dynamic batch size</span>
                <span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">data_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">data_shape</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">input_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="n">input_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">report_error</span><span class="p">(</span><span class="s1">&#39;Dont specify batch_size or data_shape with input_shape&#39;</span><span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">output_dims</span> <span class="o">=</span> <span class="n">output_dims</span>
        <span class="n">model</span><span class="o">.</span><span class="n">input_shape</span> <span class="o">=</span> <span class="n">input_shape</span>
        <span class="n">model</span><span class="o">.</span><span class="n">data_shape</span> <span class="o">=</span> <span class="n">data_shape</span>
        <span class="n">model</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="c1"># bad name, says that this network will take</span>
        <span class="c1"># 2*N images in a batch and N labels that map to</span>
        <span class="c1"># two images a piece</span>
        <span class="n">model</span><span class="o">.</span><span class="n">data_per_label_input</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># state of network input</span>
        <span class="n">model</span><span class="o">.</span><span class="n">data_per_label_output</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># state of network output</span></div>

    <span class="c1"># @classmethod</span>
    <span class="c1"># def from_saved_state(cls, fpath):</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    fpath = ut.truepath(&#39;~/Desktop/manually_saved/arch_injur-shark-resnet_o2_d27_c2942_jzuddodd/model_state_arch_jzuddodd.pkl&#39;)</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    arch_dpath = dirname(fpath)</span>
    <span class="c1">#    pass</span>

    <span class="c1"># @classmethod</span>
<div class="viewcode-block" id="BaseModel.init_from_json"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.BaseModel.init_from_json">[docs]</a>    <span class="k">def</span> <span class="nf">init_from_json</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fpath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        fpath = ut.truepath(&#39;~/Desktop/manually_saved/arch_injur-shark-resnet_o2_d27_c2942_jzuddodd/model_state_arch_jzuddodd.pkl&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># from Lasagne import lasagne</span>
        <span class="c1"># arch_dpath = dirname(fpath)</span>
        <span class="kn">from</span> <span class="nn">wbia_cnn</span> <span class="kn">import</span> <span class="n">custom_layers</span>

        <span class="n">arch_json_fpath</span> <span class="o">=</span> <span class="s1">&#39;/home/joncrall/Desktop/manually_saved/arch_injur-shark-lenet_o2_d11_c688_acioqbst/arch_info.json&#39;</span>
        <span class="n">state_fpath</span> <span class="o">=</span> <span class="s1">&#39;/home/joncrall/Desktop/manually_saved/arch_injur-shark-lenet_o2_d11_c688_acioqbst/model_state_arch_acioqbst.pkl&#39;</span>
        <span class="n">output_layer</span> <span class="o">=</span> <span class="n">custom_layers</span><span class="o">.</span><span class="n">load_json_arch_def</span><span class="p">(</span><span class="n">arch_json_fpath</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">output_layer</span> <span class="o">=</span> <span class="n">output_layer</span>

        <span class="n">model</span><span class="o">.</span><span class="n">load_model_state</span><span class="p">(</span><span class="n">fpath</span><span class="o">=</span><span class="n">state_fpath</span><span class="p">)</span></div>

    <span class="c1"># --- OTHER</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">input_batchsize</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">input_channels</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">input_height</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">input_width</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

<div class="viewcode-block" id="BaseModel.reinit_weights"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.BaseModel.reinit_weights">[docs]</a>    <span class="k">def</span> <span class="nf">reinit_weights</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        initailizes weights after the architecture has been defined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">Lasagne</span> <span class="kn">import</span> <span class="n">lasagne</span>

        <span class="k">if</span> <span class="n">W</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">W</span> <span class="o">=</span> <span class="s1">&#39;orthogonal&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">W</span> <span class="o">==</span> <span class="s1">&#39;orthogonal&#39;</span><span class="p">:</span>
                <span class="n">W</span> <span class="o">=</span> <span class="n">lasagne</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">Orthogonal</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reinitializing all weights to </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">W</span><span class="p">,))</span>
        <span class="n">weights_list</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_all_params</span><span class="p">(</span><span class="n">regularizable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># print(weights_list)</span>
        <span class="k">for</span> <span class="n">weights</span> <span class="ow">in</span> <span class="n">weights_list</span><span class="p">:</span>
            <span class="c1"># print(weights)</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">new_values</span> <span class="o">=</span> <span class="n">W</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">weights</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">new_values</span><span class="p">)</span></div>

    <span class="c1"># --- ABSTRACT FUNCTIONS</span>

<div class="viewcode-block" id="BaseModel.init_arch"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.BaseModel.init_arch">[docs]</a>    <span class="k">def</span> <span class="nf">init_arch</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;reimplement&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseModel.augment"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.BaseModel.augment">[docs]</a>    <span class="k">def</span> <span class="nf">augment</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">Xb</span><span class="p">,</span> <span class="n">yb</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;data augmentation not implemented&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseModel.loss_function"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.BaseModel.loss_function">[docs]</a>    <span class="k">def</span> <span class="nf">loss_function</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">network_output</span><span class="p">,</span> <span class="n">truth</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;need to implement a loss function&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="AbstractCategoricalModel"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.AbstractCategoricalModel">[docs]</a><span class="nd">@ut</span><span class="o">.</span><span class="n">reloadable_class</span>
<span class="k">class</span> <span class="nc">AbstractCategoricalModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; base model for catagory classifiers &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># BaseModel.__init__(model, **kwargs)</span>
        <span class="c1"># HACKING</span>
        <span class="c1"># &lt;Prototype code to fix reload errors&gt;</span>
        <span class="c1"># this_class_now = ut.fix_super_reload_error(AbstractCategoricalModel, model)</span>
        <span class="n">this_class_now</span> <span class="o">=</span> <span class="n">AbstractCategoricalModel</span>
        <span class="c1"># super(AbstractCategoricalModel, model).__init__(**kwargs)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">this_class_now</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># &lt;/Prototype code to fix reload errors&gt;</span>

        <span class="n">model</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># categorical models have a concept of accuracy</span>
        <span class="c1"># model.requested_headers += [&#39;valid_acc&#39;, &#39;test_acc&#39;]</span>
        <span class="n">model</span><span class="o">.</span><span class="n">requested_headers</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;valid_acc&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="AbstractCategoricalModel.init_encoder"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.AbstractCategoricalModel.init_encoder">[docs]</a>    <span class="k">def</span> <span class="nf">init_encoder</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[model] encoding labels&#39;</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">preprocessing</span>

        <span class="n">model</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">LabelEncoder</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">output_dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">labels</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[model] model.output_dims = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">output_dims</span><span class="p">,))</span></div>

<div class="viewcode-block" id="AbstractCategoricalModel.loss_function"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.AbstractCategoricalModel.loss_function">[docs]</a>    <span class="k">def</span> <span class="nf">loss_function</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">network_output</span><span class="p">,</span> <span class="n">truth</span><span class="p">):</span>
        <span class="c1"># https://en.wikipedia.org/wiki/Loss_functions_for_classification</span>
        <span class="kn">from</span> <span class="nn">theano</span> <span class="kn">import</span> <span class="n">tensor</span> <span class="k">as</span> <span class="n">T</span>  <span class="c1"># NOQA</span>

        <span class="c1"># categorical cross-entropy between predictions and targets</span>
        <span class="c1"># L_i = -\sum_{j} t_{i,j} \log{p_{i, j}}</span>
        <span class="k">return</span> <span class="n">T</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">categorical_crossentropy</span><span class="p">(</span><span class="n">network_output</span><span class="p">,</span> <span class="n">truth</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractCategoricalModel.custom_unlabeled_outputs"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.AbstractCategoricalModel.custom_unlabeled_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">custom_unlabeled_outputs</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">network_output</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">theano</span> <span class="kn">import</span> <span class="n">tensor</span> <span class="k">as</span> <span class="n">T</span>  <span class="c1"># NOQA</span>

        <span class="c1"># Network outputs define category probabilities</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">network_output</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">preds</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;predictions&#39;</span>
        <span class="n">confs</span> <span class="o">=</span> <span class="n">probs</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">confs</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;confidences&#39;</span>
        <span class="n">unlabeled_outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">preds</span><span class="p">,</span> <span class="n">confs</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">unlabeled_outputs</span></div>

<div class="viewcode-block" id="AbstractCategoricalModel.custom_labeled_outputs"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.AbstractCategoricalModel.custom_labeled_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">custom_labeled_outputs</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">network_output</span><span class="p">,</span> <span class="n">y_batch</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">theano</span> <span class="kn">import</span> <span class="n">tensor</span> <span class="k">as</span> <span class="n">T</span>  <span class="c1"># NOQA</span>

        <span class="n">probs</span> <span class="o">=</span> <span class="n">network_output</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">preds</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;predictions&#39;</span>
        <span class="n">is_success</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">y_batch</span><span class="p">)</span>
        <span class="n">accuracy</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">is_success</span><span class="p">)</span>
        <span class="n">accuracy</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;accuracy&#39;</span>
        <span class="n">labeled_outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">preds</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">labeled_outputs</span></div></div>


<div class="viewcode-block" id="AbstractVectorModel"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.AbstractVectorModel">[docs]</a><span class="nd">@ut</span><span class="o">.</span><span class="n">reloadable_class</span>
<span class="k">class</span> <span class="nc">AbstractVectorModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; base model for catagory classifiers &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># BaseModel.__init__(model, **kwargs)</span>
        <span class="c1"># HACKING</span>
        <span class="c1"># &lt;Prototype code to fix reload errors&gt;</span>
        <span class="c1"># this_class_now = ut.fix_super_reload_error(AbstractVectorModel, model)</span>
        <span class="n">this_class_now</span> <span class="o">=</span> <span class="n">AbstractVectorModel</span>
        <span class="c1"># super(AbstractVectorModel, model).__init__(**kwargs)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">this_class_now</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># &lt;/Prototype code to fix reload errors&gt;</span>

        <span class="n">model</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># categorical models have a concept of accuracy</span>
        <span class="c1"># model.requested_headers += [&#39;valid_acc&#39;, &#39;test_acc&#39;]</span>
        <span class="n">model</span><span class="o">.</span><span class="n">requested_headers</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;valid_acc&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="AbstractVectorModel.init_output_dims"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.AbstractVectorModel.init_output_dims">[docs]</a>    <span class="k">def</span> <span class="nf">init_output_dims</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">output_dims</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[model] model.output_dims = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">output_dims</span><span class="p">,))</span></div>

    <span class="c1"># def loss_function(model, network_output, truth):</span>
    <span class="c1">#     from theano import tensor as T  # NOQA</span>
    <span class="c1">#     return T.nnet.binary_crossentropy(network_output, truth)</span>

<div class="viewcode-block" id="AbstractVectorModel.loss_function"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.AbstractVectorModel.loss_function">[docs]</a>    <span class="k">def</span> <span class="nf">loss_function</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">network_output</span><span class="p">,</span> <span class="n">truth</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">theano</span> <span class="kn">import</span> <span class="n">tensor</span> <span class="k">as</span> <span class="n">T</span>  <span class="c1"># NOQA</span>

        <span class="k">return</span> <span class="n">T</span><span class="o">.</span><span class="n">nnet</span><span class="o">.</span><span class="n">binary_crossentropy</span><span class="p">(</span><span class="n">network_output</span><span class="p">,</span> <span class="n">truth</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractVectorModel.custom_unlabeled_outputs"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.AbstractVectorModel.custom_unlabeled_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">custom_unlabeled_outputs</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">network_output</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">theano</span> <span class="kn">import</span> <span class="n">tensor</span> <span class="k">as</span> <span class="n">T</span>  <span class="c1"># NOQA</span>

        <span class="c1"># Network outputs define category probabilities</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">network_output</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">probs</span><span class="o">.</span><span class="n">round</span><span class="p">()</span>
        <span class="n">preds</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;predictions&#39;</span>
        <span class="n">confs</span> <span class="o">=</span> <span class="n">probs</span>
        <span class="n">confs</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;confidences&#39;</span>
        <span class="n">unlabeled_outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">preds</span><span class="p">,</span> <span class="n">confs</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">unlabeled_outputs</span></div>

<div class="viewcode-block" id="AbstractVectorModel.custom_labeled_outputs"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.AbstractVectorModel.custom_labeled_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">custom_labeled_outputs</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">network_output</span><span class="p">,</span> <span class="n">y_batch</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">theano</span> <span class="kn">import</span> <span class="n">tensor</span> <span class="k">as</span> <span class="n">T</span>  <span class="c1"># NOQA</span>

        <span class="n">probs</span> <span class="o">=</span> <span class="n">network_output</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">probs</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">()</span>
        <span class="n">preds</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;predictions&#39;</span>
        <span class="n">is_success</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">y_batch</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">is_success</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">is_success</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">is_success</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">is_success</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">is_success</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
        <span class="n">accuracy</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">is_success</span><span class="p">)</span>
        <span class="n">accuracy</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;accuracy&#39;</span>
        <span class="n">labeled_outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">preds</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">labeled_outputs</span></div></div>


<div class="viewcode-block" id="AbstractVectorVectorModel"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.AbstractVectorVectorModel">[docs]</a><span class="nd">@ut</span><span class="o">.</span><span class="n">reloadable_class</span>
<span class="k">class</span> <span class="nc">AbstractVectorVectorModel</span><span class="p">(</span><span class="n">AbstractVectorModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; base model for catagory classifiers &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># BaseModel.__init__(model, **kwargs)</span>
        <span class="c1"># HACKING</span>
        <span class="c1"># &lt;Prototype code to fix reload errors&gt;</span>
        <span class="c1"># this_class_now = ut.fix_super_reload_error(AbstractVectorModel, model)</span>
        <span class="n">this_class_now</span> <span class="o">=</span> <span class="n">AbstractVectorVectorModel</span>
        <span class="c1"># super(AbstractVectorModel, model).__init__(**kwargs)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">this_class_now</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="AbstractVectorVectorModel.custom_labeled_outputs"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.AbstractVectorVectorModel.custom_labeled_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">custom_labeled_outputs</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">network_output</span><span class="p">,</span> <span class="n">y_batch</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">theano</span> <span class="kn">import</span> <span class="n">tensor</span> <span class="k">as</span> <span class="n">T</span>  <span class="c1"># NOQA</span>

        <span class="n">probs</span> <span class="o">=</span> <span class="n">network_output</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">probs</span><span class="o">.</span><span class="n">round</span><span class="p">()</span>
        <span class="n">preds</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;predictions&#39;</span>
        <span class="n">is_success</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">y_batch</span><span class="p">)</span>
        <span class="n">accuracy</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">is_success</span><span class="p">)</span>
        <span class="n">accuracy</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;accuracy&#39;</span>
        <span class="n">labeled_outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">preds</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">labeled_outputs</span></div></div>


<div class="viewcode-block" id="report_error"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.report_error">[docs]</a><span class="k">def</span> <span class="nf">report_error</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING:&#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span></div>


<span class="c1"># def evaluate_layer_list(network_layers_def, verbose=None):</span>
<span class="c1">#    r&quot;&quot;&quot;</span>
<span class="c1">#    compiles a sequence of partial functions into a network</span>
<span class="c1">#    &quot;&quot;&quot;</span>
<span class="c1">#    if verbose is None:</span>
<span class="c1">#        verbose = VERBOSE_CNN</span>
<span class="c1">#    total = len(network_layers_def)</span>
<span class="c1">#    network_layers = []</span>
<span class="c1">#    if verbose:</span>
<span class="c1">#        print(&#39;Evaluting List of %d Layers&#39; % (total,))</span>
<span class="c1">#    layer_fn_iter = iter(network_layers_def)</span>
<span class="c1">#    try:</span>
<span class="c1">#        with ut.Indenter(&#39; &#39; * 4, enabled=verbose):</span>
<span class="c1">#            next_args = tuple()</span>
<span class="c1">#            for count, layer_fn in enumerate(layer_fn_iter, start=1):</span>
<span class="c1">#                if verbose:</span>
<span class="c1">#                    print(&#39;Evaluating layer %d/%d (%s) &#39; %</span>
<span class="c1">#                          (count, total, ut.get_funcname(layer_fn), ))</span>
<span class="c1">#                with ut.Timer(verbose=False) as tt:</span>
<span class="c1">#                    layer = layer_fn(*next_args)</span>
<span class="c1">#                next_args = (layer,)</span>
<span class="c1">#                network_layers.append(layer)</span>
<span class="c1">#                if verbose:</span>
<span class="c1">#                    print(&#39;  * took %.4fs&#39; % (tt.toc(),))</span>
<span class="c1">#                    print(&#39;  * layer = %r&#39; % (layer,))</span>
<span class="c1">#                    if hasattr(layer, &#39;input_shape&#39;):</span>
<span class="c1">#                        print(&#39;  * layer.input_shape = %r&#39; % (</span>
<span class="c1">#                            layer.input_shape,))</span>
<span class="c1">#                    if hasattr(layer, &#39;shape&#39;):</span>
<span class="c1">#                        print(&#39;  * layer.shape = %r&#39; % (</span>
<span class="c1">#                            layer.shape,))</span>
<span class="c1">#                    print(&#39;  * layer.output_shape = %r&#39; % (</span>
<span class="c1">#                        layer.output_shape,))</span>
<span class="c1">#    except Exception as ex:</span>
<span class="c1">#        keys = [&#39;layer_fn&#39;, &#39;layer_fn.func&#39;, &#39;layer_fn.args&#39;,</span>
<span class="c1">#                &#39;layer_fn.keywords&#39;, &#39;layer_fn.__dict__&#39;, &#39;layer&#39;, &#39;count&#39;]</span>
<span class="c1">#        ut.printex(ex, (&#39;Error building layers.\n&#39; &#39;layer.name=%r&#39;) % (layer),</span>
<span class="c1">#                   keys=keys)</span>
<span class="c1">#        raise</span>
<span class="c1">#    return network_layers</span>


<div class="viewcode-block" id="testdata_model_with_history"><a class="viewcode-back" href="../../../wbia_cnn.models.html#wbia_cnn.models.abstract_models.testdata_model_with_history">[docs]</a><span class="k">def</span> <span class="nf">testdata_model_with_history</span><span class="p">():</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">BaseModel</span><span class="p">()</span>
    <span class="c1"># make a dummy history</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">output_dims</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rand</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">/</span> <span class="mi">10</span>

    <span class="k">def</span> <span class="nf">dummy_epoch_dict</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">expit</span>

        <span class="n">mean_loss</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">num</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">frac</span> <span class="o">=</span> <span class="n">num</span> <span class="o">/</span> <span class="n">total_epochs</span>
        <span class="n">epoch_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;epoch_num&#39;</span><span class="p">:</span> <span class="n">num</span><span class="p">,</span>
            <span class="s1">&#39;learn_loss&#39;</span><span class="p">:</span> <span class="n">mean_loss</span> <span class="o">+</span> <span class="n">rand</span><span class="p">(),</span>
            <span class="s1">&#39;learn_loss_reg&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">mean_loss</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">rand</span><span class="p">()</span> <span class="o">*</span> <span class="n">num</span> <span class="o">+</span> <span class="n">rand</span><span class="p">())),</span>
            <span class="s1">&#39;learn_loss_std&#39;</span><span class="p">:</span> <span class="n">rand</span><span class="p">(),</span>
            <span class="s1">&#39;valid_loss&#39;</span><span class="p">:</span> <span class="n">mean_loss</span> <span class="o">-</span> <span class="n">rand</span><span class="p">(),</span>
            <span class="s1">&#39;valid_loss_std&#39;</span><span class="p">:</span> <span class="n">rand</span><span class="p">(),</span>
            <span class="s1">&#39;valid_acc&#39;</span><span class="p">:</span> <span class="n">expit</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">frac</span> <span class="o">+</span> <span class="n">rand</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
            <span class="s1">&#39;valid_acc_std&#39;</span><span class="p">:</span> <span class="n">rand</span><span class="p">(),</span>
            <span class="s1">&#39;learn_acc&#39;</span><span class="p">:</span> <span class="n">expit</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">frac</span> <span class="o">+</span> <span class="n">rand</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
            <span class="s1">&#39;learn_acc_std&#39;</span><span class="p">:</span> <span class="n">rand</span><span class="p">(),</span>
            <span class="s1">&#39;valid_precision&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">output_dims</span><span class="p">)],</span>
            <span class="s1">&#39;valid_recall&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">output_dims</span><span class="p">)],</span>
            <span class="s1">&#39;learn_precision&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">output_dims</span><span class="p">)],</span>
            <span class="s1">&#39;learn_recall&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">output_dims</span><span class="p">)],</span>
            <span class="s1">&#39;param_update_mags&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;C0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">()),</span>
                <span class="s1">&#39;F1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">rng</span><span class="o">.</span><span class="n">rand</span><span class="p">()),</span>
            <span class="p">},</span>
            <span class="s1">&#39;learn_state&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">},</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">epoch_info</span>

    <span class="k">def</span> <span class="nf">dummy_get_all_layer_info</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;param_infos&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;C0&#39;</span><span class="p">,</span> <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;trainable&#39;</span><span class="p">]}]},</span>
            <span class="p">{</span><span class="s1">&#39;param_infos&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;F1&#39;</span><span class="p">,</span> <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;trainable&#39;</span><span class="p">]}]},</span>
        <span class="p">]</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">inject_func_as_method</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">dummy_get_all_layer_info</span><span class="p">,</span> <span class="s1">&#39;get_all_layer_info&#39;</span><span class="p">,</span> <span class="n">allow_override</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">epoch</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">eralens</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">total_epochs</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">eralens</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">era_length</span> <span class="ow">in</span> <span class="n">eralens</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">_new_era</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">era_length</span><span class="p">):</span>
            <span class="n">epoch_info</span> <span class="o">=</span> <span class="n">dummy_epoch_dict</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">_record_epoch</span><span class="p">(</span><span class="n">epoch_info</span><span class="p">)</span>
            <span class="n">epoch</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">model</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia_cnn.abstract_models</span>
<span class="sd">        python -m wbia_cnn.abstract_models --allexamples</span>
<span class="sd">        python -m wbia_cnn.abstract_models --allexamples --noface --nosrc</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>

    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>  <span class="c1"># for win32</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>  <span class="c1"># NOQA</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">doctest_funcs</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">wbia-cnn</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../wbia_cnn.html">wbia_cnn package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  <li><a href="../../wbia_cnn.html">wbia_cnn</a><ul>
  <li><a href="../models.html">wbia_cnn.models</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Wild Me.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>