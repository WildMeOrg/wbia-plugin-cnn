<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>wbia_cnn._plugin &mdash; wbia-cnn 4.0.1.dev0+dirty documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> wbia-cnn
          </a>
              <div class="version">
                4.0.1.dev0+dirty
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../wbia_cnn.html">wbia_cnn package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">wbia-cnn</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
          <li><a href="../wbia_cnn.html">wbia_cnn</a> &raquo;</li>
      <li>wbia_cnn._plugin</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for wbia_cnn._plugin</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">tests a test set of data using a specified, pre-trained model and weights</span>

<span class="sd">python -c &quot;import wbia_cnn&quot;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">wbia_cnn</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">wbia_cnn</span> <span class="kn">import</span> <span class="n">_plugin_grabmodels</span> <span class="k">as</span> <span class="n">grabmodels</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">wbia.constants</span> <span class="k">as</span> <span class="nn">const</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">zip</span><span class="p">,</span> <span class="nb">range</span>

<span class="nb">print</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">inject2</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>


<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">wbia.control.controller_inject</span> <span class="kn">import</span> <span class="n">make_ibs_register_decorator</span>
    <span class="kn">from</span> <span class="nn">wbia.constants</span> <span class="kn">import</span> <span class="n">VIEWTEXT_TO_YAW_RADIANS</span>

    <span class="n">CLASS_INJECT_KEY</span><span class="p">,</span> <span class="n">register_ibs_method</span> <span class="o">=</span> <span class="n">make_ibs_register_decorator</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">register_ibs_method</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">identity</span>
    <span class="k">raise</span>


<div class="viewcode-block" id="convert_species_viewpoint"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn._plugin.convert_species_viewpoint">[docs]</a><span class="k">def</span> <span class="nf">convert_species_viewpoint</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="n">viewpoint</span><span class="p">):</span>
    <span class="n">species_mapping</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;ZEBRA_PLAINS&#39;</span><span class="p">:</span> <span class="s1">&#39;zebra_plains&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ZEBRA_GREVYS&#39;</span><span class="p">:</span> <span class="s1">&#39;zebra_grevys&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ELEPHANT_SAVANNA&#39;</span><span class="p">:</span> <span class="s1">&#39;elephant_savanna&#39;</span><span class="p">,</span>
        <span class="s1">&#39;GIRAFFE_RETICULATED&#39;</span><span class="p">:</span> <span class="s1">&#39;giraffe_reticulated&#39;</span><span class="p">,</span>
        <span class="s1">&#39;GIRAFFE_MASAI&#39;</span><span class="p">:</span> <span class="s1">&#39;giraffe_masai&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">viewpoint_list</span> <span class="o">=</span> <span class="n">VIEWTEXT_TO_YAW_RADIANS</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">viewpoint_mapping</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;LEFT&#39;</span><span class="p">:</span> <span class="n">viewpoint_list</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
        <span class="s1">&#39;FRONT_LEFT&#39;</span><span class="p">:</span> <span class="n">viewpoint_list</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
        <span class="s1">&#39;FRONT&#39;</span><span class="p">:</span> <span class="n">viewpoint_list</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="s1">&#39;FRONT_RIGHT&#39;</span><span class="p">:</span> <span class="n">viewpoint_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="s1">&#39;RIGHT&#39;</span><span class="p">:</span> <span class="n">viewpoint_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s1">&#39;BACK_RIGHT&#39;</span><span class="p">:</span> <span class="n">viewpoint_list</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
        <span class="s1">&#39;BACK&#39;</span><span class="p">:</span> <span class="n">viewpoint_list</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
        <span class="s1">&#39;BACK_LEFT&#39;</span><span class="p">:</span> <span class="n">viewpoint_list</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="n">species_</span> <span class="o">=</span> <span class="n">species_mapping</span><span class="p">[</span><span class="n">species</span><span class="p">]</span>
    <span class="n">viewpoint_</span> <span class="o">=</span> <span class="n">viewpoint_mapping</span><span class="p">[</span><span class="n">viewpoint</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">species_</span><span class="p">,</span> <span class="n">viewpoint_</span></div>


<div class="viewcode-block" id="convert_label"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn._plugin.convert_label">[docs]</a><span class="k">def</span> <span class="nf">convert_label</span><span class="p">(</span><span class="n">label</span><span class="p">):</span>
    <span class="n">species</span><span class="p">,</span> <span class="n">viewpoint</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
    <span class="n">species</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">viewpoint</span> <span class="o">=</span> <span class="n">viewpoint</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">species_</span><span class="p">,</span> <span class="n">viewpoint_</span> <span class="o">=</span> <span class="n">convert_species_viewpoint</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="n">viewpoint</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">species_</span><span class="p">,</span> <span class="n">viewpoint_</span></div>


<div class="viewcode-block" id="get_neuralnet_dir"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn._plugin.get_neuralnet_dir">[docs]</a><span class="nd">@register_ibs_method</span>
<span class="k">def</span> <span class="nf">get_neuralnet_dir</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="n">nets_dir</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unixjoin</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_cachedir</span><span class="p">(),</span> <span class="n">ibs</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">PATH_NAMES</span><span class="o">.</span><span class="n">nets</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nets_dir</span></div>


<div class="viewcode-block" id="get_verified_aid_pairs"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn._plugin.get_verified_aid_pairs">[docs]</a><span class="nd">@register_ibs_method</span>
<span class="k">def</span> <span class="nf">get_verified_aid_pairs</span><span class="p">(</span><span class="n">ibs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn._plugin import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import wbia</span>
<span class="sd">        &gt;&gt;&gt; ibs = wbia.opendb(&#39;NNP_Master3&#39;, allow_newdir=True)</span>
<span class="sd">        &gt;&gt;&gt; verified_aid1_list, verified_aid2_list = get_verified_aid_pairs(ibs)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Grab marked hard cases</span>
    <span class="n">am_rowids</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">_get_all_annotmatch_rowids</span><span class="p">()</span>
    <span class="n">remove_photobombs</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">remove_photobombs</span><span class="p">:</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annotmatch_is_photobomb</span><span class="p">(</span><span class="n">am_rowids</span><span class="p">)</span>
        <span class="n">am_rowids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filterfalse_items</span><span class="p">(</span><span class="n">am_rowids</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
    <span class="n">verified_aid1_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annotmatch_aid1</span><span class="p">(</span><span class="n">am_rowids</span><span class="p">)</span>
    <span class="n">verified_aid2_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annotmatch_aid2</span><span class="p">(</span><span class="n">am_rowids</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">verified_aid1_list</span><span class="p">,</span> <span class="n">verified_aid2_list</span></div>


<div class="viewcode-block" id="generate_thumbnail_class_list"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn._plugin.generate_thumbnail_class_list">[docs]</a><span class="nd">@register_ibs_method</span>
<span class="k">def</span> <span class="nf">generate_thumbnail_class_list</span><span class="p">(</span>
    <span class="n">ibs</span><span class="p">,</span> <span class="n">thumbnail_list</span><span class="p">,</span> <span class="n">nInput</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">classifier_weight_filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>

    <span class="c1"># Load chips and resize to the target</span>
    <span class="n">data_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">192</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Define model and load weights</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[wbia_cnn] Loading model...&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nInput</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nInput</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">thumbnail_list</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Warning passed in generator without specifying nInput hint&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Explicitly evaluating generator&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;type(chip_list) = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">thumbnail_list</span><span class="p">),))</span>
            <span class="n">thumbnail_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">thumbnail_list</span><span class="p">)</span>
            <span class="n">nInput</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">thumbnail_list</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ClassifierModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">classifier_weight_filepath</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;v3_zebra&#39;</span><span class="p">]:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span><span class="s1">&#39;classifier_v3_zebra&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">classifier_weight_filepath</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;coco_zebra&#39;</span><span class="p">]:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span><span class="s1">&#39;classifier_coco_zebra&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">classifier_weight_filepath</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;megan1.1&#39;</span><span class="p">]:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;classifier_cameratrap_megan_v1&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">classifier_weight_filepath</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;megan1.2&#39;</span><span class="p">]:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;classifier_cameratrap_megan_v2&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">classifier_weight_filepath</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;megan1.3&#39;</span><span class="p">]:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;classifier_cameratrap_megan_v3&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">classifier_weight_filepath</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;megan1.4&#39;</span><span class="p">]:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;classifier_cameratrap_megan_v4&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">classifier_weight_filepath</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;megan1.5&#39;</span><span class="p">]:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;classifier_cameratrap_megan_v5&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">classifier_weight_filepath</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;megan1.6&#39;</span><span class="p">]:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;classifier_cameratrap_megan_v6&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">classifier_weight_filepath</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;megan2.1&#39;</span><span class="p">]:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;classifier_cameratrap_megan2_v1&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">classifier_weight_filepath</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;megan2.2&#39;</span><span class="p">]:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;classifier_cameratrap_megan2_v2&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">classifier_weight_filepath</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;megan2.3&#39;</span><span class="p">]:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;classifier_cameratrap_megan2_v3&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">classifier_weight_filepath</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;megan2.4&#39;</span><span class="p">]:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;classifier_cameratrap_megan2_v4&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">classifier_weight_filepath</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;megan2.5&#39;</span><span class="p">]:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;classifier_cameratrap_megan2_v5&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">classifier_weight_filepath</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;megan2.6&#39;</span><span class="p">]:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;classifier_cameratrap_megan2_v6&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">classifier_weight_filepath</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ryan.wbia_cnn.v1&#39;</span><span class="p">]:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;classifier_cameratrap_ryan_cnn_v1&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">classifier_weight_filepath</span><span class="p">):</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">classifier_weight_filepath</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Classifier does not have a valid trained model&#39;</span><span class="p">)</span>

    <span class="n">model_state_fpath</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_model_state_fpath</span><span class="p">(</span><span class="n">fpath</span><span class="o">=</span><span class="n">weights_path</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[model] loading model state from: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model_state_fpath</span><span class="p">,))</span>
    <span class="n">model_state</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">load_cPkl</span><span class="p">(</span><span class="n">model_state_fpath</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">model_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">output_dims</span> <span class="o">=</span> <span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;output_dims&#39;</span><span class="p">]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">data_params</span> <span class="o">=</span> <span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;data_params&#39;</span><span class="p">]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_fix_center_mean_std</span><span class="p">()</span>

    <span class="n">model</span><span class="o">.</span><span class="n">init_arch</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span>
    <span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="s1">&#39;whiten_on&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">model</span><span class="o">.</span><span class="n">best_results</span> <span class="o">=</span> <span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;best_results&#39;</span><span class="p">]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">set_all_param_values</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">best_results</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">])</span>

    <span class="c1"># Create the Theano primitives</span>
    <span class="c1"># create theano symbolic expressions that define the network</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[wbia_cnn] --- COMPILING SYMBOLIC THEANO FUNCTIONS ---&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[model] creating Theano primitives...&#39;</span><span class="p">)</span>
    <span class="n">theano_predict</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">build_predict_func</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[wbia_cnn] Performing inference...&#39;</span><span class="p">)</span>
    <span class="n">test_results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">process_batch</span><span class="p">(</span><span class="n">theano_predict</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">thumbnail_list</span><span class="p">))</span>

    <span class="n">prediction_list</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">test_results</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">])</span>
    <span class="n">confidence_list</span> <span class="o">=</span> <span class="n">test_results</span><span class="p">[</span><span class="s1">&#39;confidences&#39;</span><span class="p">]</span>

    <span class="n">result_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">confidence_list</span><span class="p">,</span> <span class="n">prediction_list</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">result_list</span></div>


<div class="viewcode-block" id="generate_thumbnail_class2_list"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn._plugin.generate_thumbnail_class2_list">[docs]</a><span class="nd">@register_ibs_method</span>
<span class="k">def</span> <span class="nf">generate_thumbnail_class2_list</span><span class="p">(</span>
    <span class="n">ibs</span><span class="p">,</span> <span class="n">thumbnail_list</span><span class="p">,</span> <span class="n">nInput</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">classifier_two_weight_filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>

    <span class="c1"># Load chips and resize to the target</span>
    <span class="n">data_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">192</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Define model and load weights</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[wbia_cnn] Loading model...&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nInput</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nInput</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">thumbnail_list</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Warning passed in generator without specifying nInput hint&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Explicitly evaluating generator&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;type(chip_list) = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">thumbnail_list</span><span class="p">),))</span>
            <span class="n">thumbnail_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">thumbnail_list</span><span class="p">)</span>
            <span class="n">nInput</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">thumbnail_list</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Classifier2Model</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">classifier_two_weight_filepath</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;v3&#39;</span><span class="p">]:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span><span class="s1">&#39;classifier2_v3&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">classifier_two_weight_filepath</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;candidacy&#39;</span><span class="p">]:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span><span class="s1">&#39;classifier2_candidacy&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">classifier_two_weight_filepath</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ggr2&#39;</span><span class="p">]:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span><span class="s1">&#39;classifier2_ggr2&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">classifier_two_weight_filepath</span><span class="p">):</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">classifier_two_weight_filepath</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Classifier does not have a valid trained model&#39;</span><span class="p">)</span>

    <span class="n">model_state_fpath</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_model_state_fpath</span><span class="p">(</span><span class="n">fpath</span><span class="o">=</span><span class="n">weights_path</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[model] loading model state from: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model_state_fpath</span><span class="p">,))</span>
    <span class="n">model_state</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">load_cPkl</span><span class="p">(</span><span class="n">model_state_fpath</span><span class="p">)</span>

    <span class="n">category_list</span> <span class="o">=</span> <span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;category_list&#39;</span><span class="p">]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">model_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">output_dims</span> <span class="o">=</span> <span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;output_dims&#39;</span><span class="p">]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">data_params</span> <span class="o">=</span> <span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;data_params&#39;</span><span class="p">]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_fix_center_mean_std</span><span class="p">()</span>

    <span class="n">model</span><span class="o">.</span><span class="n">init_arch</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span>
    <span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="s1">&#39;whiten_on&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">model</span><span class="o">.</span><span class="n">best_results</span> <span class="o">=</span> <span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;best_results&#39;</span><span class="p">]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">set_all_param_values</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">best_results</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">])</span>

    <span class="c1"># Create the Theano primitives</span>
    <span class="c1"># create theano symbolic expressions that define the network</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[wbia_cnn] --- COMPILING SYMBOLIC THEANO FUNCTIONS ---&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[model] creating Theano primitives...&#39;</span><span class="p">)</span>
    <span class="n">theano_predict</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">build_predict_func</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[wbia_cnn] Performing inference...&#39;</span><span class="p">)</span>
    <span class="n">test_results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">process_batch</span><span class="p">(</span><span class="n">theano_predict</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">thumbnail_list</span><span class="p">))</span>

    <span class="n">confidences_list</span> <span class="o">=</span> <span class="n">test_results</span><span class="p">[</span><span class="s1">&#39;confidences&#39;</span><span class="p">]</span>
    <span class="n">confidences_list</span><span class="p">[</span><span class="n">confidences_list</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">confidences_list</span><span class="p">[</span><span class="n">confidences_list</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">confidence_dict_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">category_list</span><span class="p">,</span> <span class="n">confidence_list</span><span class="p">))</span> <span class="k">for</span> <span class="n">confidence_list</span> <span class="ow">in</span> <span class="n">confidences_list</span>
    <span class="p">]</span>

    <span class="c1"># zipped = zip(thumbnail_list, confidence_dict_list)</span>
    <span class="c1"># for index, (thumbnail, confidence_dict) in enumerate(zipped):</span>
    <span class="c1">#     logger.info(index)</span>
    <span class="c1">#     y = []</span>
    <span class="c1">#     for key in confidence_dict:</span>
    <span class="c1">#         y.append(&#39;%s-%0.04f&#39; % (key, confidence_dict[key], ))</span>
    <span class="c1">#     y = &#39;;&#39;.join(y)</span>
    <span class="c1">#     image_path = &#39;/home/jason/Desktop/batch2/image-%s-%s.png&#39;</span>
    <span class="c1">#     cv2.imwrite(image_path % (index, y), thumbnail)</span>

    <span class="n">predictions_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">confidence_dict</span> <span class="k">if</span> <span class="n">confidence_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">confidence_dict</span> <span class="ow">in</span> <span class="n">confidence_dict_list</span>
    <span class="p">]</span>

    <span class="n">result_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">confidence_dict_list</span><span class="p">,</span> <span class="n">predictions_list</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">result_list</span></div>


<div class="viewcode-block" id="generate_thumbnail_aoi2_list"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn._plugin.generate_thumbnail_aoi2_list">[docs]</a><span class="nd">@register_ibs_method</span>
<span class="k">def</span> <span class="nf">generate_thumbnail_aoi2_list</span><span class="p">(</span>
    <span class="n">ibs</span><span class="p">,</span>
    <span class="n">thumbnail_list</span><span class="p">,</span>
    <span class="n">bbox_list</span><span class="p">,</span>
    <span class="n">size_list</span><span class="p">,</span>
    <span class="n">nInput</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">aoi_two_weight_filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="c1"># Load chips and resize to the target</span>
    <span class="n">data_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">192</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Define model and load weights</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[wbia_cnn] Loading model...&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nInput</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nInput</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">thumbnail_list</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Warning passed in generator without specifying nInput hint&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Explicitly evaluating generator&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;type(chip_list) = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">thumbnail_list</span><span class="p">),))</span>
            <span class="n">thumbnail_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">thumbnail_list</span><span class="p">)</span>
            <span class="n">nInput</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">thumbnail_list</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">AoI2Model</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">aoi_two_weight_filepath</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;candidacy&#39;</span><span class="p">]:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span><span class="s1">&#39;aoi2_candidacy&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">aoi_two_weight_filepath</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ggr2&#39;</span><span class="p">]:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span><span class="s1">&#39;aoi2_ggr2&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">aoi_two_weight_filepath</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hammerhead&#39;</span><span class="p">]:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span><span class="s1">&#39;aoi2_hammerhead&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">aoi_two_weight_filepath</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;jaguar&#39;</span><span class="p">]:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span><span class="s1">&#39;aoi2_jaguar&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">aoi_two_weight_filepath</span><span class="p">):</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">aoi_two_weight_filepath</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;AoI2 does not have a valid trained model&#39;</span><span class="p">)</span>

    <span class="n">model_state_fpath</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_model_state_fpath</span><span class="p">(</span><span class="n">fpath</span><span class="o">=</span><span class="n">weights_path</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[model] loading model state from: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model_state_fpath</span><span class="p">,))</span>
    <span class="n">model_state</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">load_cPkl</span><span class="p">(</span><span class="n">model_state_fpath</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">model_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">output_dims</span> <span class="o">=</span> <span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;output_dims&#39;</span><span class="p">]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">data_params</span> <span class="o">=</span> <span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;data_params&#39;</span><span class="p">]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_fix_center_mean_std</span><span class="p">()</span>

    <span class="n">model</span><span class="o">.</span><span class="n">init_arch</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span>
    <span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="s1">&#39;whiten_on&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">model</span><span class="o">.</span><span class="n">best_results</span> <span class="o">=</span> <span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;best_results&#39;</span><span class="p">]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">set_all_param_values</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">best_results</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">])</span>

    <span class="c1"># Create the Theano primitives</span>
    <span class="c1"># create theano symbolic expressions that define the network</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[wbia_cnn] --- COMPILING SYMBOLIC THEANO FUNCTIONS ---&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[model] creating Theano primitives...&#39;</span><span class="p">)</span>
    <span class="n">theano_predict</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">build_predict_func</span><span class="p">()</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">192</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">data_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">thumbnail</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">thumbnail_list</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">size_list</span><span class="p">):</span>
        <span class="n">xtl</span><span class="p">,</span> <span class="n">ytl</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">bbox</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">size</span>
        <span class="n">w</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="n">xbr</span> <span class="o">=</span> <span class="n">xtl</span> <span class="o">+</span> <span class="n">width</span>
        <span class="n">ybr</span> <span class="o">=</span> <span class="n">ytl</span> <span class="o">+</span> <span class="n">height</span>
        <span class="n">xtl</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">xtl</span> <span class="o">/</span> <span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="n">data_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">ytl</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">ytl</span> <span class="o">/</span> <span class="n">h</span><span class="p">)</span> <span class="o">*</span> <span class="n">data_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">xbr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">xbr</span> <span class="o">/</span> <span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="n">data_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">ybr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">ybr</span> <span class="o">/</span> <span class="n">h</span><span class="p">)</span> <span class="o">*</span> <span class="n">data_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">mask_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">mask_</span><span class="p">[</span><span class="n">ytl</span><span class="p">:</span><span class="n">ybr</span><span class="p">,</span> <span class="n">xtl</span><span class="p">:</span><span class="n">xbr</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">thumbnail</span><span class="p">,</span> <span class="n">mask_</span><span class="p">))</span>
        <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[wbia_cnn] Performing inference...&#39;</span><span class="p">)</span>
    <span class="n">test_results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">process_batch</span><span class="p">(</span><span class="n">theano_predict</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_list</span><span class="p">))</span>

    <span class="n">confidence_list</span> <span class="o">=</span> <span class="n">test_results</span><span class="p">[</span><span class="s1">&#39;confidences&#39;</span><span class="p">]</span>
    <span class="n">prediction_list</span> <span class="o">=</span> <span class="n">test_results</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
    <span class="n">prediction_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;positive&#39;</span> <span class="k">if</span> <span class="n">prediction</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;negative&#39;</span> <span class="k">for</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="n">prediction_list</span>
    <span class="p">]</span>

    <span class="n">result_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">confidence_list</span><span class="p">,</span> <span class="n">prediction_list</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">result_list</span></div>


<div class="viewcode-block" id="generate_chip_label_list"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn._plugin.generate_chip_label_list">[docs]</a><span class="nd">@register_ibs_method</span>
<span class="k">def</span> <span class="nf">generate_chip_label_list</span><span class="p">(</span>
    <span class="n">ibs</span><span class="p">,</span> <span class="n">chip_list</span><span class="p">,</span> <span class="n">nInput</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labeler_weight_filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>

    <span class="c1"># Load chips and resize to the target</span>
    <span class="n">data_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Define model and load weights</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[wbia_cnn] Loading model...&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nInput</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nInput</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chip_list</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Warning passed in generator without specifying nInput hint&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Explicitly evaluating generator&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;type(chip_list) = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">chip_list</span><span class="p">),))</span>
            <span class="n">chip_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chip_list</span><span class="p">)</span>
            <span class="n">nInput</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chip_list</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">LabelerModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">labeler_weight_filepath</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;v3&#39;</span><span class="p">]:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span><span class="s1">&#39;labeler_v3&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">labeler_weight_filepath</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;v1&#39;</span><span class="p">]:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span><span class="s1">&#39;labeler_v1&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">labeler_weight_filepath</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cheetah&#39;</span><span class="p">]:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span><span class="s1">&#39;labeler_cheetah_v0&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">labeler_weight_filepath</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;lynx&#39;</span><span class="p">,</span> <span class="s1">&#39;lynx_pardinus&#39;</span><span class="p">]:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span><span class="s1">&#39;labeler_lynx_v2&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">labeler_weight_filepath</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;candidacy&#39;</span><span class="p">]:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span><span class="s1">&#39;labeler_candidacy&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">labeler_weight_filepath</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;jaguar&#39;</span><span class="p">,</span> <span class="s1">&#39;jaguar_v2&#39;</span><span class="p">]:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span><span class="s1">&#39;labeler_jaguar_v2&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">labeler_weight_filepath</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;manta&#39;</span><span class="p">]:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span><span class="s1">&#39;labeler_manta&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">labeler_weight_filepath</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;dorsal&#39;</span><span class="p">,</span> <span class="s1">&#39;hendrik_dorsal&#39;</span><span class="p">]:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span><span class="s1">&#39;labeler_hendrik_dorsal&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">labeler_weight_filepath</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;seaturtle&#39;</span><span class="p">]:</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span><span class="s1">&#39;labeler_seaturtle_v2&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">labeler_weight_filepath</span><span class="p">):</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">labeler_weight_filepath</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Labeler does not have a valid trained model&#39;</span><span class="p">)</span>

    <span class="n">model_state_fpath</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_model_state_fpath</span><span class="p">(</span><span class="n">fpath</span><span class="o">=</span><span class="n">weights_path</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[model] loading model state from: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model_state_fpath</span><span class="p">,))</span>
    <span class="n">model_state</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">load_cPkl</span><span class="p">(</span><span class="n">model_state_fpath</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">model_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;encoder&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">output_dims</span> <span class="o">=</span> <span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;output_dims&#39;</span><span class="p">]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">data_params</span> <span class="o">=</span> <span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;data_params&#39;</span><span class="p">]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_fix_center_mean_std</span><span class="p">()</span>

    <span class="n">model</span><span class="o">.</span><span class="n">best_results</span> <span class="o">=</span> <span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;best_results&#39;</span><span class="p">]</span>

    <span class="n">model</span><span class="o">.</span><span class="n">init_arch</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span>
    <span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="s1">&#39;whiten_on&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">model</span><span class="o">.</span><span class="n">set_all_param_values</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">best_results</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">])</span>

    <span class="c1"># Create the Theano primitives</span>
    <span class="c1"># create theano symbolic expressions that define the network</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[wbia_cnn] --- COMPILING SYMBOLIC THEANO FUNCTIONS ---&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[model] creating Theano primitives...&#39;</span><span class="p">)</span>
    <span class="n">theano_predict</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">build_predict_func</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[wbia_cnn] Performing inference...&#39;</span><span class="p">)</span>
    <span class="n">test_results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">process_batch</span><span class="p">(</span><span class="n">theano_predict</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">chip_list</span><span class="p">))</span>

    <span class="n">class_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
    <span class="n">prediction_list</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">test_results</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">])</span>
    <span class="n">confidence_list</span> <span class="o">=</span> <span class="n">test_results</span><span class="p">[</span><span class="s1">&#39;confidences&#39;</span><span class="p">]</span>
    <span class="n">probability_list</span> <span class="o">=</span> <span class="n">test_results</span><span class="p">[</span><span class="s1">&#39;network_output_determ&#39;</span><span class="p">]</span>

    <span class="n">class_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="nb">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">class_list</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">prediction_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="nb">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span>
            <span class="n">prediction_list</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">species_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">viewpoint_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="n">prediction_list</span><span class="p">:</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">prediction</span><span class="p">:</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="n">species</span><span class="p">,</span> <span class="n">viewpoint</span> <span class="o">=</span> <span class="n">prediction</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">species</span> <span class="o">=</span> <span class="n">prediction</span>
            <span class="n">viewpoint</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ignore&#39;</span><span class="p">:</span>
            <span class="n">species</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN</span>
        <span class="n">species_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">species</span><span class="p">)</span>
        <span class="n">viewpoint_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">viewpoint</span><span class="p">)</span>

    <span class="n">quality_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">QUAL_UNKNOWN</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">prediction_list</span><span class="p">)</span>
    <span class="n">orientation_list</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">prediction_list</span><span class="p">)</span>

    <span class="n">probability_dict_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">probability</span> <span class="ow">in</span> <span class="n">probability_list</span><span class="p">:</span>
        <span class="n">probability_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">class_</span><span class="p">:</span> <span class="n">prob</span> <span class="k">for</span> <span class="n">class_</span><span class="p">,</span> <span class="n">prob</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">class_list</span><span class="p">,</span> <span class="n">probability</span><span class="p">)}</span>
        <span class="n">probability_dict_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">probability_dict</span><span class="p">)</span>

    <span class="n">result_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="nb">zip</span><span class="p">(</span>
            <span class="n">confidence_list</span><span class="p">,</span>
            <span class="n">species_list</span><span class="p">,</span>
            <span class="n">viewpoint_list</span><span class="p">,</span>
            <span class="n">quality_list</span><span class="p">,</span>
            <span class="n">orientation_list</span><span class="p">,</span>
            <span class="n">probability_dict_list</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">result_list</span></div>


<div class="viewcode-block" id="detect_annot_zebra_background_mask"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn._plugin.detect_annot_zebra_background_mask">[docs]</a><span class="nd">@register_ibs_method</span>
<span class="k">def</span> <span class="nf">detect_annot_zebra_background_mask</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config2_</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid_list (int):  list of annotation ids</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: mask_list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Read the data</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[wbia_cnn] Loading chips...&#39;</span><span class="p">)</span>
    <span class="n">chip_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_chips</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">config2_</span><span class="o">=</span><span class="n">config2_</span><span class="p">)</span>
    <span class="n">mask_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">generate_species_background</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">chip_list</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="n">species</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">mask_list</span></div>


<div class="viewcode-block" id="detect_annot_whale_fluke_background_mask"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn._plugin.detect_annot_whale_fluke_background_mask">[docs]</a><span class="nd">@register_ibs_method</span>
<span class="k">def</span> <span class="nf">detect_annot_whale_fluke_background_mask</span><span class="p">(</span>
    <span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="s1">&#39;whale_fluke&#39;</span><span class="p">,</span> <span class="n">config2_</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid_list (int):  list of annotation ids</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: mask_list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Read the data</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[wbia_cnn] Loading chips...&#39;</span><span class="p">)</span>
    <span class="n">chip_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_chips</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">config2_</span><span class="o">=</span><span class="n">config2_</span><span class="p">)</span>
    <span class="n">mask_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">generate_species_background</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">chip_list</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="n">species</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">mask_list</span></div>


<div class="viewcode-block" id="generate_species_background_mask"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn._plugin.generate_species_background_mask">[docs]</a><span class="nd">@register_ibs_method</span>
<span class="k">def</span> <span class="nf">generate_species_background_mask</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">chip_fpath_list</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid_list (int):  list of annotation ids</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: species_viewpoint_list</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia_cnn._plugin --exec-generate_species_background_mask --show --db PZ_Master1</span>
<span class="sd">        python -m wbia_cnn --tf generate_species_background_mask --show --db PZ_Master1 --aid 9970</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; import wbia_cnn</span>
<span class="sd">        &gt;&gt;&gt; import wbia</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn._plugin import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = wbia.opendb(defaultdb=&#39;testdb1&#39;, allow_newdir=True)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ut.get_argval((&#39;--aids&#39;, &#39;--aid&#39;), type_=list, default=ibs.get_valid_aids()[0:2])</span>
<span class="sd">        &gt;&gt;&gt; chip_fpath_list = ibs.get_annot_chip_fpath(aid_list)</span>
<span class="sd">        &gt;&gt;&gt; species = ibs.const.TEST_SPECIES.ZEB_PLAIN</span>
<span class="sd">        &gt;&gt;&gt; mask_list = generate_species_background_mask(ibs, chip_fpath_list, species)</span>
<span class="sd">        &gt;&gt;&gt; mask_list = list(mask_list)</span>
<span class="sd">        &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">        &gt;&gt;&gt; from wbia import plottool as pt</span>
<span class="sd">        &gt;&gt;&gt; iteract_obj = pt.interact_multi_image.MultiImageInteraction(mask_list, nPerPage=4)</span>
<span class="sd">        &gt;&gt;&gt; #pt.imshow(mask_list[0])</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>

<span class="sd">        #&gt;&gt;&gt; from wbia_cnn.draw_results import *  # NOQA</span>
<span class="sd">        #&gt;&gt;&gt; from wbia_cnn import ingest_data</span>
<span class="sd">        #&gt;&gt;&gt; data, labels = ingest_data.testdata_patchmatch2()</span>
<span class="sd">        #&gt;&gt;&gt; flat_metadata = {&#39;fs&#39;: np.arange(len(labels))}</span>
<span class="sd">        #&gt;&gt;&gt; result = interact_siamsese_data_patches(labels, data, flat_metadata)</span>
<span class="sd">        #&gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Read the data</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[wbia_cnn] Loading chips...&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

    <span class="n">nInput</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chip_fpath_list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">bufgen2</span><span class="p">(</span><span class="n">_iter</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">nInput</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">nTotal</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">nInput</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">nInput</span> <span class="o">/</span> <span class="n">size</span><span class="p">))</span>
        <span class="n">chunk_iter</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ichunks</span><span class="p">(</span><span class="n">_iter</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
        <span class="n">chunk_iter_</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgressIter</span><span class="p">(</span><span class="n">chunk_iter</span><span class="p">,</span> <span class="n">nTotal</span><span class="o">=</span><span class="n">nTotal</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunk_iter_</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">item</span>

    <span class="n">chip_list</span> <span class="o">=</span> <span class="n">bufgen2</span><span class="p">(</span>
        <span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span> <span class="k">for</span> <span class="n">fpath</span> <span class="ow">in</span> <span class="n">chip_fpath_list</span><span class="p">),</span>
        <span class="n">lbl</span><span class="o">=</span><span class="s1">&#39;loading chip chunk&#39;</span><span class="p">,</span>
        <span class="n">nInput</span><span class="o">=</span><span class="n">nInput</span><span class="p">,</span>
        <span class="n">adjust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">time_thresh</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># mask_list = list(generate_species_background(ibs, chip_list, species=species, nInput=nInput))</span>
    <span class="n">mask_gen</span> <span class="o">=</span> <span class="n">generate_species_background</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">chip_list</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="n">species</span><span class="p">,</span> <span class="n">nInput</span><span class="o">=</span><span class="n">nInput</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mask_gen</span></div>


<div class="viewcode-block" id="generate_species_background"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn._plugin.generate_species_background">[docs]</a><span class="nd">@register_ibs_method</span>
<span class="k">def</span> <span class="nf">generate_species_background</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">chip_list</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nInput</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TODO: Use this as the primary function</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia_cnn._plugin --exec-generate_species_background --db PZ_MTEST --species=zebra_plains --show</span>
<span class="sd">        python -m wbia_cnn._plugin --exec-generate_species_background --db GZ_Master1 --species=zebra_grevys --save cnn_detect_results_gz.png --diskshow --clipwhite</span>
<span class="sd">        python -m wbia_cnn._plugin --exec-generate_species_background --db PZ_Master1 --species=zebra_plains --save cnn_detect_results_pz.png --diskshow --clipwhite</span>
<span class="sd">        python -m wbia_cnn._plugin --exec-generate_species_background --db PZ_Master1 --show</span>
<span class="sd">        python -m wbia_cnn._plugin --exec-generate_species_background --db GZ_Master1 --show</span>
<span class="sd">        python -m wbia_cnn._plugin --exec-generate_species_background --db GIRM_Master1 --show --species=giraffe_masai</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; import wbia_cnn</span>
<span class="sd">        &gt;&gt;&gt; import wbia</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn._plugin import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; ibs = wbia.opendb(defaultdb=&#39;testdb1&#39;, allow_newdir=True)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()[0:8]</span>
<span class="sd">        &gt;&gt;&gt; species = ut.get_argval(&#39;--species&#39;, type_=str, default=&#39;zebra_plains&#39;)</span>
<span class="sd">        &gt;&gt;&gt; config2_ = None</span>
<span class="sd">        &gt;&gt;&gt; nInput = len(aid_list)</span>
<span class="sd">        &gt;&gt;&gt; chip_iter = ibs.get_annot_chips(aid_list, verbose=True, config2_=config2_, eager=False)</span>
<span class="sd">        &gt;&gt;&gt; mask_iter = generate_species_background(ibs, chip_iter, species=species, nInput=nInput)</span>
<span class="sd">        &gt;&gt;&gt; mask_list = list(mask_iter)</span>
<span class="sd">        &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">        &gt;&gt;&gt; from wbia import plottool as pt</span>
<span class="sd">        &gt;&gt;&gt; import vtool as vt</span>
<span class="sd">        &gt;&gt;&gt; chip_list = ibs.get_annot_chips(aid_list, verbose=True, config2_=config2_, eager=True)</span>
<span class="sd">        &gt;&gt;&gt; stacked_list = [vt.stack_images(chip, mask)[0] for chip, mask in  zip(chip_list, mask_list)]</span>
<span class="sd">        &gt;&gt;&gt; iteract_obj = pt.interact_multi_image.MultiImageInteraction(stacked_list, nPerPage=4)</span>
<span class="sd">        &gt;&gt;&gt; iteract_obj.start()</span>
<span class="sd">        &gt;&gt;&gt; #hough_cpath = ibs.get_annot_probchip_fpath(aid_list, config2_=config2_)</span>
<span class="sd">        &gt;&gt;&gt; #iteract_obj2 = pt.interact_multi_image.MultiImageInteraction(hough_cpath, nPerPage=4)</span>
<span class="sd">        &gt;&gt;&gt; #pt.imshow(mask_list[0])</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>

<span class="sd">    Ignore:</span>
<span class="sd">        #&gt;&gt;&gt; from wbia_cnn.draw_results import *  # NOQA</span>
<span class="sd">        #&gt;&gt;&gt; from wbia_cnn import ingest_data</span>
<span class="sd">        #&gt;&gt;&gt; data, labels = ingest_data.testdata_patchmatch2()</span>
<span class="sd">        #&gt;&gt;&gt; flat_metadata = {&#39;fs&#39;: np.arange(len(labels))}</span>
<span class="sd">        #&gt;&gt;&gt; result = interact_siamsese_data_patches(labels, data, flat_metadata)</span>
<span class="sd">        #&gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">species</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># species = &#39;zebra_plains&#39;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;must specify a species for the background detector&#39;</span><span class="p">)</span>

    <span class="c1"># Load chips and resize to the target</span>
    <span class="n">data_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="c1"># Define model and load weights</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[wbia_cnn] Loading model...&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nInput</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nInput</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chip_list</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Warning passed in generator without specifying nInput hint&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Explicitly evaluating generator&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;type(chip_list) = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">chip_list</span><span class="p">),))</span>
            <span class="n">chip_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chip_list</span><span class="p">)</span>
            <span class="n">nInput</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chip_list</span><span class="p">)</span>

    <span class="c1"># batch_size = int(min(128, 2 ** np.floor(np.log2(nInput))))</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">NEW</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">species</span><span class="p">)</span>

    <span class="n">candidacy_species_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;giraffe_masai&#39;</span><span class="p">,</span>
        <span class="s1">&#39;giraffe_reticulated&#39;</span><span class="p">,</span>
        <span class="c1"># &#39;turtle_sea&#39;,</span>
        <span class="s1">&#39;whale_fluke&#39;</span><span class="p">,</span>
        <span class="s1">&#39;zebra_grevys&#39;</span><span class="p">,</span>
        <span class="s1">&#39;zebra_plains&#39;</span><span class="p">,</span>
        <span class="s1">&#39;giraffa_tippelskirchi&#39;</span><span class="p">,</span>
        <span class="s1">&#39;giraffa_camelopardalis_reticulata&#39;</span><span class="p">,</span>
        <span class="s1">&#39;megaptera_novaeangliae&#39;</span><span class="p">,</span>
        <span class="s1">&#39;equus_grevyi&#39;</span><span class="p">,</span>
        <span class="s1">&#39;equus_quagga&#39;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">CANDIDACY</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">CANDIDACY</span> <span class="o">=</span> <span class="n">CANDIDACY</span> <span class="ow">and</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">candidacy_species_list</span>

    <span class="k">if</span> <span class="n">CANDIDACY</span><span class="p">:</span>
        <span class="n">species_list</span> <span class="o">=</span> <span class="n">candidacy_species_list</span>
        <span class="k">assert</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">species_list</span>

        <span class="k">if</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;giraffa_tippelskirchi&#39;</span><span class="p">]:</span>
            <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;giraffe_masai&#39;</span>
        <span class="k">if</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;giraffa_camelopardalis_reticulata&#39;</span><span class="p">]:</span>
            <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;giraffe_reticulated&#39;</span>
        <span class="k">if</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;megaptera_novaeangliae&#39;</span><span class="p">]:</span>
            <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;whale_fluke&#39;</span>
        <span class="k">if</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;equus_grevyi&#39;</span><span class="p">]:</span>
            <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;zebra_grevys&#39;</span>
        <span class="k">if</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;equus_quagga&#39;</span><span class="p">]:</span>
            <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;zebra_plains&#39;</span>

        <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;background_candidacy_&#39;</span> <span class="o">+</span> <span class="n">species</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;zebra_plains&#39;</span><span class="p">,</span> <span class="s1">&#39;equus_quagga&#39;</span><span class="p">,</span> <span class="s1">&#39;zebra_grevys&#39;</span><span class="p">,</span> <span class="s1">&#39;equus_grevyi&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">NEW</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s1">&#39;zebra_plains&#39;</span><span class="p">,</span>
                <span class="s1">&#39;equus_quagga&#39;</span><span class="p">,</span>
                <span class="s1">&#39;zebra_grevys&#39;</span><span class="p">,</span>
                <span class="s1">&#39;equus_grevyi&#39;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">,</span> <span class="n">num_output</span><span class="o">=</span><span class="mi">3</span>
            <span class="p">)</span>
            <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
                <span class="s1">&#39;background_zebra_plains_grevys&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">canvas_key</span> <span class="o">=</span> <span class="n">species</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;zebra_plains&#39;</span><span class="p">,</span> <span class="s1">&#39;equus_quagga&#39;</span><span class="p">]</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
            <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
                <span class="s1">&#39;background_zebra_plains&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">canvas_key</span> <span class="o">=</span> <span class="s1">&#39;positive&#39;</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;zebra_mountain&#39;</span><span class="p">,</span> <span class="s1">&#39;equus_zebra&#39;</span><span class="p">]:</span>
        <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;zebra_mountain&#39;</span>  <span class="c1"># Misspelled from zebra_mountain during training</span>
        <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;background_zebra_mountain_v0&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;giraffe_masai&#39;</span><span class="p">,</span> <span class="s1">&#39;giraffa_tippelskirchi&#39;</span><span class="p">]:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;background_giraffe_masai&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="s1">&#39;giraffe_masai&#39;</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s1">&#39;whale_fluke&#39;</span><span class="p">,</span>
        <span class="s1">&#39;whale_humpback&#39;</span><span class="p">,</span>
        <span class="s1">&#39;megaptera_novaeangliae&#39;</span><span class="p">,</span>
        <span class="c1"># &#39;physeter_macrocephalus&#39;,</span>
    <span class="p">]:</span>
        <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;whale_fluke&#39;</span>
        <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;background_candidacy_whale_fluke&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># species = &#39;whale_fluke&#39;</span>
        <span class="c1"># model = models.BackgroundModel(batch_size=batch_size, data_shape=data_shape)</span>
        <span class="c1"># weights_path = grabmodels.ensure_model(&#39;background_whale_fluke&#39;, redownload=False)</span>
        <span class="c1"># canvas_key = species</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;lynx&#39;</span><span class="p">,</span> <span class="s1">&#39;lynx_pardinus&#39;</span><span class="p">]:</span>
        <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;lynx&#39;</span>
        <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span><span class="s1">&#39;background_lynx_v3&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cheetah&#39;</span><span class="p">,</span> <span class="s1">&#39;acinonyx_jubatus&#39;</span><span class="p">]:</span>
        <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;cheetah&#39;</span>
        <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span><span class="s1">&#39;background_cheetah_v2&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hyaena&#39;</span><span class="p">,</span> <span class="s1">&#39;hyaena_hyaena&#39;</span><span class="p">]:</span>
        <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;hyaena&#39;</span>
        <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span><span class="s1">&#39;background_hyaena_v0&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;jaguar&#39;</span><span class="p">,</span> <span class="s1">&#39;panthera_onca&#39;</span><span class="p">]:</span>
        <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;jaguar&#39;</span>
        <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span><span class="s1">&#39;background_jaguar_v2&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s1">&#39;manta_ray_giant&#39;</span><span class="p">,</span>
        <span class="s1">&#39;mobula_birostris&#39;</span><span class="p">,</span>
        <span class="s1">&#39;manta_birostris&#39;</span><span class="p">,</span>
        <span class="s1">&#39;mobula_alfredi&#39;</span><span class="p">,</span>
    <span class="p">]:</span>
        <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;manta&#39;</span>
        <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span><span class="s1">&#39;background_manta&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;skunk_spotted&#39;</span><span class="p">,</span> <span class="s1">&#39;spilogale_gracilis&#39;</span><span class="p">]:</span>
        <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;skunk_spotted&#39;</span>
        <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;background_skunk_spotted_v1&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;right_whale_head&#39;</span><span class="p">,</span> <span class="s1">&#39;eubalaena_australis&#39;</span><span class="p">,</span> <span class="s1">&#39;eubalaena_glacialis&#39;</span><span class="p">]:</span>
        <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;right_whale_head&#39;</span>
        <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;background_right_whale_head_v0&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s1">&#39;whale_orca&#39;</span><span class="p">,</span>
        <span class="s1">&#39;whale_orca+fin_dorsal&#39;</span><span class="p">,</span>
        <span class="s1">&#39;orcinus_orca&#39;</span><span class="p">,</span>
        <span class="s1">&#39;orcinus_orca+fin_dorsal&#39;</span><span class="p">,</span>
    <span class="p">]:</span>
        <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;whale_orca&#39;</span>
        <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span><span class="s1">&#39;background_orca_v0&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s1">&#39;whale_sperm&#39;</span><span class="p">,</span>
        <span class="s1">&#39;whale_sperm+fluke&#39;</span><span class="p">,</span>
        <span class="s1">&#39;physeter_macrocephalus&#39;</span><span class="p">,</span>
        <span class="s1">&#39;physeter_macrocephalus+fluke&#39;</span><span class="p">,</span>
    <span class="p">]:</span>
        <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;whale_sperm+fluke&#39;</span>
        <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;background_whale_sperm_v0&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;seadragon_leafy&#39;</span><span class="p">,</span> <span class="s1">&#39;phycodurus_eques&#39;</span><span class="p">]:</span>
        <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;seadragon_leafy&#39;</span>
        <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;background_seadragon_leafy_v1&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;seadragon_weedy&#39;</span><span class="p">,</span> <span class="s1">&#39;phyllopteryx_taeniolatus&#39;</span><span class="p">]:</span>
        <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;seadragon_weedy&#39;</span>
        <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;background_seadragon_weedy_v1&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;seadragon_leafy+head&#39;</span><span class="p">,</span> <span class="s1">&#39;phycodurus_eques+head&#39;</span><span class="p">]:</span>
        <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;seadragon_leafy+head&#39;</span>
        <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;background_seadragon_leafy_head_v1&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;seadragon_weedy+head&#39;</span><span class="p">,</span> <span class="s1">&#39;phyllopteryx_taeniolatus+head&#39;</span><span class="p">]:</span>
        <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;seadragon_weedy+head&#39;</span>
        <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;background_seadragon_weedy_head_v1&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># elif OLD and species in [&#39;turtle_green&#39;, &#39;turtle_green+head&#39;, &#39;turtle_hawksbill&#39;, &#39;turtle_hawksbill+head&#39;]:</span>
    <span class="c1">#     LEGACY = False</span>
    <span class="c1">#     species = &#39;turtle_sea&#39;</span>
    <span class="c1">#     confidence_thresh = 0.2</span>
    <span class="c1">#     model = models.BackgroundModel(batch_size=batch_size, data_shape=data_shape)</span>
    <span class="c1">#     weights_path = grabmodels.ensure_model(&#39;background_candidacy_turtle_sea&#39;, redownload=False)</span>
    <span class="c1">#     canvas_key = 1</span>

    <span class="c1"># elif species in [&#39;turtle_green&#39;, &#39;chelonia_mydas&#39;]:</span>
    <span class="c1">#     LEGACY = False</span>
    <span class="c1">#     species = &#39;turtle_green&#39;</span>
    <span class="c1">#     confidence_thresh = 0.2</span>
    <span class="c1">#     model = models.BackgroundModel(batch_size=batch_size, data_shape=data_shape)</span>
    <span class="c1">#     weights_path = grabmodels.ensure_model(&#39;background_turtle_green_v1&#39;, redownload=False)</span>
    <span class="c1">#     canvas_key = 1</span>
    <span class="c1"># elif species in [&#39;turtle_hawksbill&#39;, &#39;eretmochelys_imbricata&#39;]:</span>
    <span class="c1">#     LEGACY = False</span>
    <span class="c1">#     species = &#39;turtle_hawksbill&#39;</span>
    <span class="c1">#     confidence_thresh = 0.2</span>
    <span class="c1">#     model = models.BackgroundModel(batch_size=batch_size, data_shape=data_shape)</span>
    <span class="c1">#     weights_path = grabmodels.ensure_model(&#39;background_turtle_hawksbill_v1&#39;, redownload=False)</span>
    <span class="c1">#     canvas_key = 1</span>
    <span class="c1"># elif species in [&#39;turtle_green+head&#39;, &#39;chelonia_mydas+head&#39;]:</span>
    <span class="c1">#     LEGACY = False</span>
    <span class="c1">#     species = &#39;turtle_green+head&#39;</span>
    <span class="c1">#     confidence_thresh = 0.2</span>
    <span class="c1">#     model = models.BackgroundModel(batch_size=batch_size, data_shape=data_shape)</span>
    <span class="c1">#     weights_path = grabmodels.ensure_model(&#39;background_turtle_green_head_v1&#39;, redownload=False)</span>
    <span class="c1">#     canvas_key = 1</span>
    <span class="c1"># elif species in [&#39;turtle_hawksbill+head&#39;, &#39;eretmochelys_imbricata+head&#39;]:</span>
    <span class="c1">#     LEGACY = False</span>
    <span class="c1">#     species = &#39;turtle_hawksbill+head&#39;</span>
    <span class="c1">#     confidence_thresh = 0.2</span>
    <span class="c1">#     model = models.BackgroundModel(batch_size=batch_size, data_shape=data_shape)</span>
    <span class="c1">#     weights_path = grabmodels.ensure_model(&#39;background_turtle_hawksbill_head_v1&#39;, redownload=False)</span>
    <span class="c1">#     canvas_key = 1</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s1">&#39;turtle_sea&#39;</span><span class="p">,</span>
        <span class="s1">&#39;chelonioidea&#39;</span><span class="p">,</span>
        <span class="s1">&#39;turtle_sea+head&#39;</span><span class="p">,</span>
        <span class="s1">&#39;chelonioidea+head&#39;</span><span class="p">,</span>
        <span class="s1">&#39;turtle_green&#39;</span><span class="p">,</span>
        <span class="s1">&#39;chelonia_mydas&#39;</span><span class="p">,</span>
        <span class="s1">&#39;turtle_green+head&#39;</span><span class="p">,</span>
        <span class="s1">&#39;chelonia_mydas+head&#39;</span><span class="p">,</span>
        <span class="s1">&#39;turtle_hawksbill&#39;</span><span class="p">,</span>
        <span class="s1">&#39;eretmochelys_imbricata&#39;</span><span class="p">,</span>
        <span class="s1">&#39;turtle_hawksbill+head&#39;</span><span class="p">,</span>
        <span class="s1">&#39;eretmochelys_imbricata+head&#39;</span><span class="p">,</span>
        <span class="s1">&#39;turtle_oliveridley&#39;</span><span class="p">,</span>
        <span class="s1">&#39;lepidochelys_olivacea&#39;</span><span class="p">,</span>
        <span class="s1">&#39;turtle_oliveridley+head&#39;</span><span class="p">,</span>
        <span class="s1">&#39;lepidochelys_olivacea+head&#39;</span><span class="p">,</span>
        <span class="s1">&#39;turtle_asian&#39;</span><span class="p">,</span>
    <span class="p">]:</span>
        <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;seaturtle&#39;</span>
        <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;background_sea_turtle_v4&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s1">&#39;spotted_eagle_ray&#39;</span><span class="p">,</span>
        <span class="s1">&#39;aetobatus_narinari&#39;</span><span class="p">,</span>
    <span class="p">]:</span>
        <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;spotted_eagle_ray&#39;</span>
        <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;background_spotted_eagle_ray_v0&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s1">&#39;yellow_bellied_toad&#39;</span><span class="p">,</span>
        <span class="s1">&#39;bombina_variegata&#39;</span><span class="p">,</span>
    <span class="p">]:</span>
        <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;yellow_bellied_toad&#39;</span>
        <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;background_yellow_bellied_toad_v0&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;dolphin_spotted&#39;</span><span class="p">,</span> <span class="s1">&#39;stenella_frontalis&#39;</span><span class="p">]:</span>
        <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;dolphin_spotted&#39;</span>
        <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;background_dolphin_spotted&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;leopard&#39;</span><span class="p">,</span> <span class="s1">&#39;panthera_pardus&#39;</span><span class="p">]:</span>
        <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;leopard&#39;</span>
        <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span><span class="s1">&#39;background_leopard_v0&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;snow_leopard&#39;</span><span class="p">,</span> <span class="s1">&#39;panthera_uncia&#39;</span><span class="p">]:</span>
        <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;snow_leopard&#39;</span>
        <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;background_snow_leopard_v0&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s1">&#39;wild_dog&#39;</span><span class="p">,</span>
        <span class="s1">&#39;wild_dog_dark&#39;</span><span class="p">,</span>
        <span class="s1">&#39;wild_dog_light&#39;</span><span class="p">,</span>
        <span class="s1">&#39;wild_dog_puppy&#39;</span><span class="p">,</span>
        <span class="s1">&#39;wild_dog_standard&#39;</span><span class="p">,</span>
        <span class="s1">&#39;wild_dog_tan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;lycaon_pictus&#39;</span><span class="p">,</span>
    <span class="p">]:</span>
        <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;wild_dog&#39;</span>
        <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span><span class="s1">&#39;background_wilddog_v0&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s1">&#39;dolphin_spotted+dorsal&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dolphin_spotted+fin_dorsal&#39;</span><span class="p">,</span>
        <span class="s1">&#39;stenella_frontalis+dorsal&#39;</span><span class="p">,</span>
        <span class="s1">&#39;stenella_frontalis+fin_dorsal&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dolphin_bottlenose+dorsal&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dolphin_bottlenose+fin_dorsal&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tursiops_truncatus+dorsal&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tursiops_truncatus+fin_dorsal&#39;</span><span class="p">,</span>
    <span class="p">]:</span>
        <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;dolphin_spotted+fin_dorsal&#39;</span>
        <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;background_dolphin_spotted_fin_dorsal&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;whale_humpback+fin_dorsal&#39;</span><span class="p">,</span> <span class="s1">&#39;physeter_macrocephalus+fin_dorsal&#39;</span><span class="p">]:</span>
        <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;whale_humpback+fin_dorsal&#39;</span>
        <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;background_humpback_dorsal&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gray_whale&#39;</span><span class="p">,</span> <span class="s1">&#39;whale_grey&#39;</span><span class="p">,</span> <span class="s1">&#39;gray_whale+fluke&#39;</span><span class="p">,</span> <span class="s1">&#39;whale_grey+fluke&#39;</span><span class="p">]:</span>
        <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;whale_grey&#39;</span>
        <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;background_whale_grey_v0&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;beluga_whale&#39;</span><span class="p">,</span> <span class="s1">&#39;whale_beluga&#39;</span><span class="p">,</span> <span class="s1">&#39;delphinapterus_leucas&#39;</span><span class="p">]:</span>
        <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;whale_beluga&#39;</span>
        <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;background_whale_beluga_v0&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s1">&#39;mediterranean_monk_seal&#39;</span><span class="p">,</span>
        <span class="s1">&#39;grey_seal&#39;</span><span class="p">,</span>
        <span class="s1">&#39;grey_seal_unknown&#39;</span><span class="p">,</span>
        <span class="s1">&#39;grey_seal_male&#39;</span><span class="p">,</span>
        <span class="s1">&#39;grey_seal_femaleyoung&#39;</span><span class="p">,</span>
        <span class="s1">&#39;grey_seal_pup&#39;</span><span class="p">,</span>
        <span class="s1">&#39;harbour_seal&#39;</span><span class="p">,</span>
        <span class="s1">&#39;hawaiian_monk_seal&#39;</span><span class="p">,</span>
        <span class="s1">&#39;monachus_monachus&#39;</span><span class="p">,</span>
        <span class="s1">&#39;phoca_vitulina&#39;</span><span class="p">,</span>
        <span class="s1">&#39;halichoerus_grypus&#39;</span><span class="p">,</span>
        <span class="s1">&#39;monachus_schauinslandi&#39;</span><span class="p">,</span>
    <span class="p">]:</span>
        <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;seals&#39;</span>
        <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span><span class="s1">&#39;background_seals_v0&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s1">&#39;grouper_nassau&#39;</span><span class="p">,</span>
        <span class="s1">&#39;grouper_tiger&#39;</span><span class="p">,</span>
        <span class="s1">&#39;grouper_nassau_bicolor&#39;</span><span class="p">,</span>
        <span class="s1">&#39;epinephelus_striatus&#39;</span><span class="p">,</span>
    <span class="p">]:</span>
        <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;grouper_nassau&#39;</span>
        <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;background_grouper_nassau_v0&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s1">&#39;salamandra_salamandra&#39;</span><span class="p">,</span>
        <span class="s1">&#39;salamandra_salamandra_larvae&#39;</span><span class="p">,</span>
        <span class="s1">&#39;salanader_fire&#39;</span><span class="p">,</span>
        <span class="s1">&#39;salanader_fire_larvae&#39;</span><span class="p">,</span>
    <span class="p">]:</span>
        <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;salanader_fire&#39;</span>
        <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span><span class="s1">&#39;salanader_fire_v0&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;salamandra_salamandra_adult&#39;</span><span class="p">,</span> <span class="s1">&#39;salanader_fire_adult&#39;</span><span class="p">]:</span>
        <span class="n">LEGACY</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;salanader_fire_adult&#39;</span>
        <span class="n">confidence_thresh</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BackgroundModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
        <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span>
            <span class="s1">&#39;salanader_fire_adult_v0&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">canvas_key</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;species </span><span class="si">%r</span><span class="s1"> key does not have a trained model&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">species</span><span class="p">,))</span>

    <span class="k">if</span> <span class="n">LEGACY</span><span class="p">:</span>
        <span class="n">old_weights_fpath</span> <span class="o">=</span> <span class="n">weights_path</span>
        <span class="n">model</span><span class="o">.</span><span class="n">load_old_weights_kw2</span><span class="p">(</span><span class="n">old_weights_fpath</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model_state_fpath</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_model_state_fpath</span><span class="p">(</span><span class="n">fpath</span><span class="o">=</span><span class="n">weights_path</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[model] loading model state from: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model_state_fpath</span><span class="p">,))</span>
        <span class="n">model_state</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">load_cPkl</span><span class="p">(</span><span class="n">model_state_fpath</span><span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">output_dims</span> <span class="o">=</span> <span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;output_dims&#39;</span><span class="p">]</span>
        <span class="n">model</span><span class="o">.</span><span class="n">data_params</span> <span class="o">=</span> <span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;data_params&#39;</span><span class="p">]</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_fix_center_mean_std</span><span class="p">()</span>

        <span class="n">model</span><span class="o">.</span><span class="n">best_results</span> <span class="o">=</span> <span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;best_results&#39;</span><span class="p">]</span>

        <span class="n">model</span><span class="o">.</span><span class="n">init_arch</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span>
        <span class="n">model</span><span class="o">.</span><span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;center_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;center_mean&#39;</span><span class="p">])</span>
        <span class="n">model</span><span class="o">.</span><span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;center_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">data_params</span><span class="p">[</span><span class="s1">&#39;center_std&#39;</span><span class="p">])</span>
        <span class="n">model</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="s1">&#39;whiten_on&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">model</span><span class="o">.</span><span class="n">set_all_param_values</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">best_results</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">])</span>

    <span class="c1"># Create the Theano primitives</span>
    <span class="c1"># create theano symbolic expressions that define the network</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[wbia_cnn] --- COMPILING SYMBOLIC THEANO FUNCTIONS ---&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[model] creating Theano primitives...&#39;</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">build_predict_func</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[wbia_cnn] Performing inference...&#39;</span><span class="p">)</span>

    <span class="n">_iter</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgressIter</span><span class="p">(</span>
        <span class="n">chip_list</span><span class="p">,</span>
        <span class="n">nTotal</span><span class="o">=</span><span class="n">nInput</span><span class="p">,</span>
        <span class="n">lbl</span><span class="o">=</span><span class="n">species</span> <span class="o">+</span> <span class="s1">&#39; fgdetect&#39;</span><span class="p">,</span>
        <span class="n">adjust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">freq</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">time_thresh</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">chip</span> <span class="ow">in</span> <span class="n">_iter</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">LEGACY</span><span class="p">:</span>
                <span class="n">samples</span><span class="p">,</span> <span class="n">canvas_dict</span> <span class="o">=</span> <span class="n">test_convolutional</span><span class="p">(</span>
                    <span class="n">model</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">confidence_thresh</span><span class="o">=</span><span class="n">confidence_thresh</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">samples</span><span class="p">,</span> <span class="n">canvas_dict</span> <span class="o">=</span> <span class="n">test_convolutional</span><span class="p">(</span>
                    <span class="n">model</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">confidence_thresh</span><span class="o">=</span><span class="n">confidence_thresh</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">NEW</span> <span class="ow">and</span> <span class="n">LEGACY</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">255</span> <span class="o">-</span> <span class="n">canvas_dict</span><span class="p">[</span><span class="s1">&#39;negative&#39;</span><span class="p">],</span> <span class="n">canvas_dict</span><span class="p">[</span><span class="n">canvas_key</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">canvas_dict</span><span class="p">[</span><span class="n">canvas_key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">printex</span><span class="p">(</span>
                <span class="n">ex</span><span class="p">,</span>
                <span class="p">(</span><span class="s1">&#39;Error running convnet with &#39;</span> <span class="s1">&#39;chip.shape=</span><span class="si">%r</span><span class="s1">, chip.dtype=</span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">chip</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">chip</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">yield</span> <span class="n">mask</span></div>


<div class="viewcode-block" id="test_convolutional"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn._plugin.test_convolutional">[docs]</a><span class="k">def</span> <span class="nf">test_convolutional</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">image</span><span class="p">,</span>
    <span class="n">patch_size</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
    <span class="n">stride</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
    <span class="n">padding</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">confidence_thresh</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Using a network, test an entire image full convolutionally</span>

<span class="sd">    This function will test an entire image full convolutionally (or a close</span>
<span class="sd">    approximation of full convolutionally).  The CUDA framework and driver is a</span>
<span class="sd">    limiting factor for how large an image can be given to a network for full</span>
<span class="sd">    convolutional inference.  As a result, we implement a non-overlapping (or</span>
<span class="sd">    little overlapping) patch extraction approximation that processes the entire</span>
<span class="sd">    image within a single batch or very few batches.  This is an extremely</span>
<span class="sd">    efficient process for processing an image with a CNN.</span>

<span class="sd">    The patches are given a slight overlap in order to smooth the effects of</span>
<span class="sd">    boundary conditions, which are seen on every patch.  We also mirror the</span>
<span class="sd">    border of each patch and add an additional amount of padding to cater to the</span>
<span class="sd">    architecture&#39;s receptive field reduction.</span>

<span class="sd">    See :func:`utils.extract_patches_stride` for patch extraction behavior.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (Model): the network to use to perform feedforward inference</span>
<span class="sd">        image (numpy.ndarray): the image passed in to make a coreresponding</span>
<span class="sd">            sized dictionarf of response maps</span>
<span class="sd">        patch_size (int, tuple of int, optional): the size of the patches</span>
<span class="sd">            extracted across the image, passed in as a 2-tuple of (width,</span>
<span class="sd">            height).  Defaults to (200, 200).</span>
<span class="sd">        stride (int, tuple of int, optional): the stride of the patches</span>
<span class="sd">            extracted across the image.  Defaults to [patch_size - padding].</span>
<span class="sd">        padding (int, optional): the mirrored padding added to every patch</span>
<span class="sd">            during testing, which can be used to offset the effects of the</span>
<span class="sd">            receptive field reduction in the network.  Defaults to 32.</span>
<span class="sd">        **kwargs: arbitrary keyword arguments, passed to</span>
<span class="sd">            :func:`model.test()`</span>

<span class="sd">    Returns:</span>
<span class="sd">        samples, canvas_dict (tuple of int and dict): the number of total</span>
<span class="sd">            samples used to generate the response map and the actual response</span>
<span class="sd">            maps themselves as a dictionary.  The dictionary uses the class</span>
<span class="sd">            labels as the strings and the numpy array image as the values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">wbia_cnn</span> <span class="kn">import</span> <span class="n">utils</span>
    <span class="kn">import</span> <span class="nn">cv2</span>

    <span class="k">def</span> <span class="nf">_add_pad</span><span class="p">(</span><span class="n">data_</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">data_padded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">data_</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="s1">&#39;reflect&#39;</span><span class="p">,</span> <span class="n">reflect_type</span><span class="o">=</span><span class="s1">&#39;even&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">data_</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">data_padded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">data_</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">_</span><span class="p">],</span> <span class="n">padding</span><span class="p">,</span> <span class="s1">&#39;reflect&#39;</span><span class="p">,</span> <span class="n">reflect_type</span><span class="o">=</span><span class="s1">&#39;even&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">data_padded</span>

    <span class="k">def</span> <span class="nf">_resize_target</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">target_height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_width</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">cv2</span>

        <span class="k">assert</span> <span class="n">target_height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">target_width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">target_height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">target_width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">target_height</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">target_width</span>
        <span class="k">elif</span> <span class="n">target_height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">target_height</span>
            <span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="n">height</span><span class="p">)</span> <span class="o">*</span> <span class="n">h</span>
        <span class="k">elif</span> <span class="n">target_width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">target_width</span>
            <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="n">width</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LANCZOS4</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="c1"># Start timer</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">tic</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[harness] Loading the testing data (convolutional)...&#39;</span><span class="p">)</span>
    <span class="c1"># Try to get the image&#39;s shape</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">original_shape</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="n">w</span> <span class="ow">and</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">:</span>
        <span class="n">original_shape</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">_resize_target</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">target_height</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="n">h</span> <span class="ow">and</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">:</span>
        <span class="n">original_shape</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">_resize_target</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">target_width</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>

    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># GLOBAL_LIMIT = min(256, w, h)</span>
    <span class="c1"># HACK, this only works for square data shapes</span>
    <span class="n">GLOBAL_LIMIT</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">data_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Inference</span>
    <span class="k">if</span> <span class="n">patch_size</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
        <span class="n">patch_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">GLOBAL_LIMIT</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">padding</span><span class="p">,</span> <span class="n">GLOBAL_LIMIT</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">padding</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">stride</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
        <span class="n">psx</span><span class="p">,</span> <span class="n">psy</span> <span class="o">=</span> <span class="n">patch_size</span>
        <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="n">psx</span> <span class="o">-</span> <span class="n">padding</span><span class="p">,</span> <span class="n">psy</span> <span class="o">-</span> <span class="n">padding</span><span class="p">)</span>
    <span class="n">_tup</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">extract_patches_stride</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">patch_size</span><span class="p">,</span> <span class="n">stride</span><span class="p">)</span>
    <span class="n">data_list</span><span class="p">,</span> <span class="n">coord_list</span> <span class="o">=</span> <span class="n">_tup</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">samples</span>
    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">label_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">confidence_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">theano_predict</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">build_predict_func</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">samples</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">)</span>
        <span class="n">data_list_segment</span> <span class="o">=</span> <span class="n">data_list</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
        <span class="c1"># coord_list_segment = coord_list[start: end]</span>

        <span class="c1"># Augment the data_list by adding a reflected pad</span>
        <span class="n">data_list_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">_add_pad</span><span class="p">(</span><span class="n">data_</span><span class="p">)</span> <span class="k">for</span> <span class="n">data_</span> <span class="ow">in</span> <span class="n">data_list_segment</span><span class="p">])</span>

        <span class="c1"># batchiter_kw = dict(</span>
        <span class="c1">#    fix_output=False,</span>
        <span class="c1">#    showprog=True,</span>
        <span class="c1">#    spatial=True</span>
        <span class="c1"># )</span>
        <span class="c1"># test_results = model._predict(data_list_)</span>
        <span class="n">test_results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">process_batch</span><span class="p">(</span><span class="n">theano_predict</span><span class="p">,</span> <span class="n">data_list_</span><span class="p">,</span> <span class="n">unwrap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># test_results2 = batch.process_batch(model, data_list_, None,</span>
        <span class="c1">#                                   theano_predict, **batchiter_kw)</span>
        <span class="c1"># label_list.extend(test_results[&#39;labeled_predictions&#39;])</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">encoder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">labeled_predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span>
                <span class="n">test_results</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">labeled_predictions</span> <span class="o">=</span> <span class="n">test_results</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
        <span class="n">label_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">labeled_predictions</span><span class="p">)</span>
        <span class="n">confidence_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">test_results</span><span class="p">[</span><span class="s1">&#39;confidences&#39;</span><span class="p">])</span>
        <span class="n">start</span> <span class="o">+=</span> <span class="n">batch_size</span>

    <span class="c1"># Get all of the labels for the data, inheritted from the model</span>
    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">encoder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># python2 backwards compatibility</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">label_list_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">classes_</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label_list_</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
        <span class="n">label_list_</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span>
                <span class="n">label_list_</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">label_list_</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">output_dims</span><span class="p">))</span>
    <span class="c1"># Create a dictionary of canvases</span>
    <span class="n">canvas_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">label_list_</span><span class="p">:</span>
        <span class="n">canvas_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>  <span class="c1"># We want float precision</span>
    <span class="c1"># Construct the canvases using the forward inference results</span>
    <span class="n">label_list_</span> <span class="o">=</span> <span class="n">label_list_</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># logger.info(&#39;[harness] Labels: %r&#39; %(label_list_, ))</span>
    <span class="n">zipped</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="n">coord_list</span><span class="p">,</span> <span class="n">label_list</span><span class="p">,</span> <span class="n">confidence_list</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">label_list_</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">coord</span><span class="p">,</span> <span class="n">label_</span><span class="p">,</span> <span class="n">confidence</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">coord</span>
            <span class="c1"># Get label and apply to confidence</span>
            <span class="n">confidence_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">confidence</span><span class="p">)</span>

            <span class="c1"># OLD</span>
            <span class="c1"># confidence_[label_ != label] = 0</span>

            <span class="c1"># NEW</span>
            <span class="c1"># if isinstance(label_, np.ndarray):</span>
            <span class="c1">#     flip_index = (label_ != label).astype(np.int)</span>
            <span class="c1"># else:</span>
            <span class="c1">#     flip_index = int(label_ != label)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">):</span>
                <span class="c1"># fix for python3, can&#39;t compare numpy byte arrays with</span>
                <span class="c1"># unicode.</span>
                <span class="n">label2_</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">label2_</span> <span class="o">=</span> <span class="n">label</span>
            <span class="n">flip_index</span> <span class="o">=</span> <span class="n">label_</span> <span class="o">!=</span> <span class="n">label2_</span>
            <span class="n">confidence_</span><span class="p">[</span><span class="n">flip_index</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">confidence_</span><span class="p">[</span><span class="n">flip_index</span><span class="p">]</span>
            <span class="n">confidence_</span><span class="p">[</span><span class="n">confidence_</span> <span class="o">&lt;=</span> <span class="n">confidence_thresh</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">confidence_</span> <span class="o">*=</span> <span class="mf">255.0</span>

            <span class="c1"># Blow up canvas</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">confidence_</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
            <span class="c1"># Get the current values</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">canvas_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span>
            <span class="c1"># Where the current canvas is zero (most of it), make it mask</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="n">current</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="n">current</span><span class="p">[</span><span class="n">flags</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">flags</span><span class="p">]</span>
            <span class="c1"># Average the current with the mask, which address overlapping areas</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">mask</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">current</span>
            <span class="c1"># Aggregate</span>
            <span class="n">canvas_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>
        <span class="c1"># Blur</span>
        <span class="c1"># FIXME: Should this postprocessing step applied here?</span>
        <span class="c1"># There is postprocessing in ibeis/algos/preproc/preproc_probchip.py</span>
        <span class="n">ksize</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="p">(</span><span class="n">ksize</span><span class="p">,</span> <span class="n">ksize</span><span class="p">)</span>
        <span class="n">canvas_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">blur</span><span class="p">(</span><span class="n">canvas_dict</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">kernel</span><span class="p">)</span>
    <span class="c1"># Cast all images to uint8</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">label_list_</span><span class="p">:</span>
        <span class="n">canvas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">canvas_dict</span><span class="p">[</span><span class="n">label</span><span class="p">])</span>
        <span class="n">canvas</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">original_shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">canvas</span> <span class="o">=</span> <span class="n">_resize_target</span><span class="p">(</span>
                <span class="n">canvas</span><span class="p">,</span> <span class="n">target_height</span><span class="o">=</span><span class="n">original_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">target_width</span><span class="o">=</span><span class="n">original_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="n">canvas_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">canvas</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="c1"># End timer</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">toc</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[harness] Interface took </span><span class="si">%s</span><span class="s1"> seconds...&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">duration</span><span class="p">,))</span>
    <span class="c1"># Return the canvas dict</span>
    <span class="k">return</span> <span class="n">samples</span><span class="p">,</span> <span class="n">canvas_dict</span></div>


<div class="viewcode-block" id="fix_annot_species_viewpoint_quality_cnn"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn._plugin.fix_annot_species_viewpoint_quality_cnn">[docs]</a><span class="nd">@register_ibs_method</span>
<span class="k">def</span> <span class="nf">fix_annot_species_viewpoint_quality_cnn</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">min_conf</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid_list (int):  list of annotation ids</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">cv2</span>

    <span class="c1"># Load chips and resize to the target</span>
    <span class="n">data_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">96</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="c1"># Define model and load weights</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loading model...&#39;</span><span class="p">)</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)))))</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ViewpointModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
    <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span><span class="s1">&#39;viewpoint&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">old_weights_fpath</span> <span class="o">=</span> <span class="n">weights_path</span>
    <span class="n">model</span><span class="o">.</span><span class="n">load_old_weights_kw</span><span class="p">(</span><span class="n">old_weights_fpath</span><span class="p">)</span>
    <span class="c1"># Read the data</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">data_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loading chips...&#39;</span><span class="p">)</span>
    <span class="n">chip_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_chips</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Resizing chips...&#39;</span><span class="p">)</span>
    <span class="n">chip_list_resized</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LANCZOS4</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">chip</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgressIter</span><span class="p">(</span><span class="n">chip_list</span><span class="p">,</span> <span class="n">lbl</span><span class="o">=</span><span class="s1">&#39;resizing chips&#39;</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="c1"># Build data for network</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">chip_list_resized</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="c1"># Predict on the data and convert labels to IBEIS namespace</span>
    <span class="n">test_outputs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict2</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">label_list</span> <span class="o">=</span> <span class="n">test_outputs</span><span class="p">[</span><span class="s1">&#39;labeled_predictions&#39;</span><span class="p">]</span>
    <span class="n">conf_list</span> <span class="o">=</span> <span class="n">test_outputs</span><span class="p">[</span><span class="s1">&#39;confidences&#39;</span><span class="p">]</span>
    <span class="n">species_viewpoint_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">convert_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">label_list</span><span class="p">]</span>
    <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">species_viewpoint_list</span><span class="p">,</span> <span class="n">conf_list</span><span class="p">)</span>
    <span class="n">skipped_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="n">viewpoint</span><span class="p">),</span> <span class="n">conf</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">conf</span> <span class="o">&gt;=</span> <span class="n">min_conf</span><span class="p">:</span>
            <span class="n">species_</span> <span class="o">=</span> <span class="n">species</span>
            <span class="n">viewpoint_</span> <span class="o">=</span> <span class="n">viewpoint</span>
            <span class="n">quality_</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">QUAL_GOOD</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">skipped_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
            <span class="n">species_</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN</span>
            <span class="n">viewpoint_</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">quality_</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">QUAL_UNKNOWN</span>

        <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_species</span><span class="p">([</span><span class="n">aid</span><span class="p">],</span> <span class="p">[</span><span class="n">species_</span><span class="p">])</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_yaw_texts</span><span class="p">([</span><span class="n">aid</span><span class="p">],</span> <span class="p">[</span><span class="n">viewpoint_</span><span class="p">])</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">set_annot_quality_texts</span><span class="p">([</span><span class="n">aid</span><span class="p">],</span> <span class="p">[</span><span class="n">quality_</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">skipped_list</span></div>


<div class="viewcode-block" id="detect_annot_species_viewpoint_cnn"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn._plugin.detect_annot_species_viewpoint_cnn">[docs]</a><span class="nd">@register_ibs_method</span>
<span class="k">def</span> <span class="nf">detect_annot_species_viewpoint_cnn</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid_list (int):  list of annotation ids</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: species_viewpoint_list</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia_cnn._plugin --exec-detect_annot_species_viewpoint_cnn</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn._plugin import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import wbia</span>
<span class="sd">        &gt;&gt;&gt; ibs = wbia.opendb(defaultdb=&#39;testdb1&#39;, allow_newdir=True)</span>
<span class="sd">        &gt;&gt;&gt; aid_list = ibs.get_valid_aids()</span>
<span class="sd">        &gt;&gt;&gt; species_viewpoint_list = detect_annot_species_viewpoint_cnn(ibs, aid_list)</span>
<span class="sd">        &gt;&gt;&gt; result = (&#39;species_viewpoint_list = %s&#39; % (str(species_viewpoint_list),))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">cv2</span>

    <span class="c1"># Load chips and resize to the target</span>
    <span class="n">data_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">96</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="c1"># Define model and load weights</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loading model...&#39;</span><span class="p">)</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)))))</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ViewpointModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
    <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span><span class="s1">&#39;viewpoint&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">old_weights_fpath</span> <span class="o">=</span> <span class="n">weights_path</span>
    <span class="n">model</span><span class="o">.</span><span class="n">load_old_weights_kw</span><span class="p">(</span><span class="n">old_weights_fpath</span><span class="p">)</span>
    <span class="c1"># Read the data</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">data_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loading chips...&#39;</span><span class="p">)</span>
    <span class="n">chip_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_chips</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Resizing chips...&#39;</span><span class="p">)</span>
    <span class="n">chip_list_resized</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LANCZOS4</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">chip</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgressIter</span><span class="p">(</span><span class="n">chip_list</span><span class="p">,</span> <span class="n">lbl</span><span class="o">=</span><span class="s1">&#39;resizing chips&#39;</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="c1"># Build data for network</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">chip_list_resized</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="c1"># Predict on the data and convert labels to IBEIS namespace</span>
    <span class="n">test_outputs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict2</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">label_list</span> <span class="o">=</span> <span class="n">test_outputs</span><span class="p">[</span><span class="s1">&#39;labeled_predictions&#39;</span><span class="p">]</span>
    <span class="n">species_viewpoint_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">convert_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">label_list</span><span class="p">]</span>
    <span class="c1"># pred_list, label_list, conf_list = test.test_data(X_test, y_test, model, weights_path)</span>
    <span class="c1"># species_viewpoint_list = [ convert_label(label) for label in label_list ]</span>
    <span class="k">return</span> <span class="n">species_viewpoint_list</span></div>


<div class="viewcode-block" id="validate_annot_species_viewpoint_cnn"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn._plugin.validate_annot_species_viewpoint_cnn">[docs]</a><span class="nd">@register_ibs_method</span>
<span class="k">def</span> <span class="nf">validate_annot_species_viewpoint_cnn</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        aid_list (int):  list of annotation ids</span>
<span class="sd">        verbose (bool):  verbosity flag(default = False)</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (bad_species_list, bad_viewpoint_list)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Load chips and metadata</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">viewpoint_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_yaw_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">species_viewpoint_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">detect_annot_species_viewpoint_cnn</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="c1"># Find all bad</span>
    <span class="n">bad_species_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bad_viewpoint_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">species_list</span><span class="p">,</span> <span class="n">viewpoint_list</span><span class="p">,</span> <span class="n">species_viewpoint_list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">viewpoint</span><span class="p">,</span> <span class="p">(</span><span class="n">species_</span><span class="p">,</span> <span class="n">viewpoint_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">species</span> <span class="o">!=</span> <span class="n">species_</span><span class="p">:</span>
            <span class="n">bad_species_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">aid</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">species_</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">viewpoint</span> <span class="o">!=</span> <span class="n">viewpoint_</span><span class="p">:</span>
            <span class="n">bad_viewpoint_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">aid</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">viewpoint</span><span class="p">,</span> <span class="n">viewpoint_</span><span class="p">))</span>
            <span class="k">continue</span>
    <span class="c1"># Print bad if verbose</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Found conflicting species:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">bad_species</span> <span class="ow">in</span> <span class="n">bad_species_list</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;    AID </span><span class="si">%4d</span><span class="s1"> (</span><span class="si">%r</span><span class="s1">) should be </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">bad_species</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Found conflicting viewpoints:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">bad_viewpoint</span> <span class="ow">in</span> <span class="n">bad_viewpoint_list</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;    AID </span><span class="si">%4d</span><span class="s1"> (</span><span class="si">%r</span><span class="s1">, </span><span class="si">%r</span><span class="s1">) should be </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">bad_viewpoint</span><span class="p">)</span>
    <span class="c1"># Return bad</span>
    <span class="k">return</span> <span class="n">bad_species_list</span><span class="p">,</span> <span class="n">bad_viewpoint_list</span></div>


<span class="k">def</span> <span class="nf">_suggest_random_candidate_regions</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">min_size</span><span class="p">,</span> <span class="n">num_candidates</span><span class="o">=</span><span class="mi">2000</span><span class="p">):</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">h</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="n">w</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span> <span class="o">=</span> <span class="n">min_size</span>

    <span class="k">def</span> <span class="nf">_candidate</span><span class="p">():</span>
        <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span> <span class="o">&lt;</span> <span class="n">min_x</span> <span class="ow">or</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span> <span class="o">&lt;</span> <span class="n">min_y</span><span class="p">:</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>
            <span class="n">y0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">x0</span> <span class="o">&gt;</span> <span class="n">x1</span><span class="p">:</span>
                <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span> <span class="o">=</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x0</span>
            <span class="k">if</span> <span class="n">y0</span> <span class="o">&gt;</span> <span class="n">y1</span><span class="p">:</span>
                <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y0</span>
        <span class="k">return</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span>

    <span class="n">candidate_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">_candidate</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_candidates</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">candidate_list</span>


<span class="k">def</span> <span class="nf">_suggest_bing_candidate_regions</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">image_path_list</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_dedictify</span><span class="p">(</span><span class="n">dict_list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[[</span><span class="n">d_</span><span class="p">[</span><span class="s1">&#39;minx&#39;</span><span class="p">],</span> <span class="n">d_</span><span class="p">[</span><span class="s1">&#39;miny&#39;</span><span class="p">],</span> <span class="n">d_</span><span class="p">[</span><span class="s1">&#39;maxx&#39;</span><span class="p">],</span> <span class="n">d_</span><span class="p">[</span><span class="s1">&#39;maxy&#39;</span><span class="p">]]</span> <span class="k">for</span> <span class="n">d_</span> <span class="ow">in</span> <span class="n">dict_list</span><span class="p">]</span>

    <span class="kn">from</span> <span class="nn">pybing</span> <span class="kn">import</span> <span class="n">BING_Detector</span>

    <span class="n">detector</span> <span class="o">=</span> <span class="n">BING_Detector</span><span class="p">()</span>
    <span class="n">results_list</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="n">image_path_list</span><span class="p">)</span>
    <span class="n">result_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">_dedictify</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">results</span> <span class="ow">in</span> <span class="n">results_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">result_list</span>


<div class="viewcode-block" id="non_max_suppression_fast"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn._plugin.non_max_suppression_fast">[docs]</a><span class="k">def</span> <span class="nf">non_max_suppression_fast</span><span class="p">(</span><span class="n">box_list</span><span class="p">,</span> <span class="n">conf_list</span><span class="p">,</span> <span class="n">overlapThresh</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Python version of Malisiewicz&#39;s Matlab code:</span>
<span class="sd">    https://github.com/quantombone/exemplarsvm</span>

<span class="sd">    NOTE: This is adapted from Pedro Felzenszwalb&#39;s version (nms.m),</span>
<span class="sd">    but an inner loop has been eliminated to significantly speed it</span>
<span class="sd">    up in the case of a large number of boxes</span>

<span class="sd">    Reference: https://github.com/rbgirshick/rcnn/blob/master/nms/nms.m</span>
<span class="sd">    Reference: http://www.pyimagesearch.com/2015/02/16/faster-non-maximum-suppression-python/</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># if there are no boxes, return an empty list</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">box_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># Convert to Numpy</span>
    <span class="n">box_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">box_list</span><span class="p">)</span>
    <span class="n">conf_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">conf_list</span><span class="p">)</span>

    <span class="c1"># if the bounding boxes integers, convert them to floats --</span>
    <span class="c1"># this is important since we&#39;ll be doing a bunch of divisions</span>
    <span class="k">if</span> <span class="n">box_list</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span>
        <span class="n">box_list</span> <span class="o">=</span> <span class="n">box_list</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>

    <span class="c1"># initialize the list of picked indexes</span>
    <span class="n">pick</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># grab the coordinates of the bounding boxes</span>
    <span class="c1"># Our boxes are stored as y1, y2, x1, x2 to be in-line with OpenCV indexing</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">box_list</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">box_list</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">box_list</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">box_list</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">conf_list</span>

    <span class="c1"># compute the area of the bounding boxes and sort the bounding</span>
    <span class="c1"># boxes by the bottom-right y-coordinate of the bounding box</span>
    <span class="n">area</span> <span class="o">=</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="c1"># keep looping while some indexes still remain in the indexes</span>
    <span class="c1"># list</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># grab the last index in the indexes list and add the</span>
        <span class="c1"># index value to the list of picked indexes</span>
        <span class="n">last</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">idxs</span><span class="p">[</span><span class="n">last</span><span class="p">]</span>
        <span class="n">pick</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># find the largest (x, y) coordinates for the start of</span>
        <span class="c1"># the bounding box and the smallest (x, y) coordinates</span>
        <span class="c1"># for the end of the bounding box</span>
        <span class="n">xx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">x1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x1</span><span class="p">[</span><span class="n">idxs</span><span class="p">[:</span><span class="n">last</span><span class="p">]])</span>
        <span class="n">yy1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">y1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y1</span><span class="p">[</span><span class="n">idxs</span><span class="p">[:</span><span class="n">last</span><span class="p">]])</span>
        <span class="n">xx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">x2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x2</span><span class="p">[</span><span class="n">idxs</span><span class="p">[:</span><span class="n">last</span><span class="p">]])</span>
        <span class="n">yy2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">y2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y2</span><span class="p">[</span><span class="n">idxs</span><span class="p">[:</span><span class="n">last</span><span class="p">]])</span>

        <span class="c1"># compute the width and height of the bounding box</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xx2</span> <span class="o">-</span> <span class="n">xx1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">yy2</span> <span class="o">-</span> <span class="n">yy1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># compute the ratio of overlap</span>
        <span class="n">overlap</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span> <span class="o">/</span> <span class="n">area</span><span class="p">[</span><span class="n">idxs</span><span class="p">[:</span><span class="n">last</span><span class="p">]]</span>

        <span class="c1"># delete all indexes from the index list that have</span>
        <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
            <span class="n">idxs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="n">last</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">overlap</span> <span class="o">&gt;</span> <span class="n">overlapThresh</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="p">)</span>

    <span class="c1"># return only the bounding boxes that were picked using the</span>
    <span class="c1"># integer data type</span>
    <span class="k">return</span> <span class="n">pick</span></div>


<div class="viewcode-block" id="detect_image_cnn"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn._plugin.detect_image_cnn">[docs]</a><span class="nd">@register_ibs_method</span>
<span class="k">def</span> <span class="nf">detect_image_cnn</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">confidence</span><span class="o">=</span><span class="mf">0.90</span><span class="p">,</span> <span class="n">extraction</span><span class="o">=</span><span class="s1">&#39;bing&#39;</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        gid (?):</span>
<span class="sd">        confidence (float): (default = 0.9)</span>
<span class="sd">        extraction (str): (default = &#39;bing&#39;)</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia_cnn._plugin --exec-detect_image_cnn</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn._plugin import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn._plugin import _suggest_random_candidate_regions, _suggest_bing_candidate_regions  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import wbia</span>
<span class="sd">        &gt;&gt;&gt; ibs = wbia.opendb(defaultdb=&#39;testdb1&#39;, allow_newdir=True)</span>
<span class="sd">        &gt;&gt;&gt; gid = 1</span>
<span class="sd">        &gt;&gt;&gt; confidence = 0.9</span>
<span class="sd">        &gt;&gt;&gt; extraction = &#39;bing&#39;</span>
<span class="sd">        &gt;&gt;&gt; result = detect_image_cnn(ibs, gid, confidence, extraction)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">cv2</span>

    <span class="c1"># Load chips and resize to the target</span>
    <span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="mi">96</span><span class="p">,</span> <span class="mi">96</span><span class="p">)</span>
    <span class="n">targetx</span><span class="p">,</span> <span class="n">targety</span> <span class="o">=</span> <span class="n">target</span>
    <span class="c1"># gid = gid_list[random.randint(0, len(gid_list))]</span>
    <span class="c1"># gid = gid_list[0]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Detecting with gid=</span><span class="si">%r</span><span class="s1">...&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gid</span><span class="p">,))</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_images</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
    <span class="n">rects</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Querrying for candidate regions...&#39;</span><span class="p">)</span>
    <span class="n">image_path</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_paths</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">extraction</span> <span class="o">==</span> <span class="s1">&#39;random&#39;</span><span class="p">:</span>
        <span class="n">candidate_list</span> <span class="o">=</span> <span class="n">_suggest_random_candidate_regions</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">candidate_list</span> <span class="o">=</span> <span class="n">_suggest_bing_candidate_regions</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="p">[</span><span class="n">image_path</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Num candidates: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">candidate_list</span><span class="p">),))</span>
    <span class="n">chip_list_resized</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Extracting candidate regions...&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">candidate_list</span><span class="p">:</span>
        <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">candidate</span>
        <span class="n">chip</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">y0</span><span class="p">:</span><span class="n">y1</span><span class="p">,</span> <span class="n">x0</span><span class="p">:</span><span class="n">x1</span><span class="p">]</span>
        <span class="n">chip</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LANCZOS4</span><span class="p">)</span>
        <span class="n">chip_list_resized</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span>
        <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># cv2.rectangle(rects, (x0, y0), (x1, y1), color)</span>
        <span class="n">mx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">my</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">rects</span><span class="p">,</span> <span class="p">(</span><span class="n">x0</span> <span class="o">+</span> <span class="n">mx</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">my</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># cv2.imshow(&#39;&#39;, rects)</span>
    <span class="c1"># cv2.waitKey(0)</span>
    <span class="c1"># cv2.destroyAllWindows()</span>

    <span class="c1"># Build data for network</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">chip_list_resized</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="c1"># Define model and load weights</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loading model...&#39;</span><span class="p">)</span>
    <span class="n">data_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">96</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="c1"># Define model and load weights</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loading model...&#39;</span><span class="p">)</span>
    <span class="c1"># batch_size = int(min(128, 2 ** np.floor(np.log2(len(chip_list_resized)))))</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ViewpointModel</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">data_shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
    <span class="n">weights_path</span> <span class="o">=</span> <span class="n">grabmodels</span><span class="o">.</span><span class="n">ensure_model</span><span class="p">(</span><span class="s1">&#39;viewpoint&#39;</span><span class="p">,</span> <span class="n">redownload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">old_weights_fpath</span> <span class="o">=</span> <span class="n">weights_path</span>
    <span class="n">model</span><span class="o">.</span><span class="n">load_old_weights_kw</span><span class="p">(</span><span class="n">old_weights_fpath</span><span class="p">)</span>

    <span class="c1"># Predict on the data and convert labels to IBEIS namespace</span>
    <span class="n">test_outputs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict2</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">conf_list</span> <span class="o">=</span> <span class="n">test_outputs</span><span class="p">[</span><span class="s1">&#39;confidences&#39;</span><span class="p">]</span>
    <span class="n">label_list</span> <span class="o">=</span> <span class="n">test_outputs</span><span class="p">[</span><span class="s1">&#39;labeled_predictions&#39;</span><span class="p">]</span>
    <span class="n">pred_list</span> <span class="o">=</span> <span class="n">test_outputs</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
    <span class="c1"># pred_list, label_list, conf_list = test.test_data(X_test, y_test, model, weights_path)</span>
    <span class="n">species_viewpoint_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">convert_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">label_list</span><span class="p">]</span>

    <span class="n">num_all_candidates</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">conf_list</span><span class="p">)</span>
    <span class="n">index_list</span> <span class="o">=</span> <span class="n">non_max_suppression_fast</span><span class="p">(</span><span class="n">candidate_list</span><span class="p">,</span> <span class="n">conf_list</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Surviving candidates: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index_list</span><span class="p">,))</span>
    <span class="n">num_supressed_candidates</span> <span class="o">=</span> <span class="n">num_all_candidates</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">index_list</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Supressed: </span><span class="si">%d</span><span class="s1"> candidates&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_supressed_candidates</span><span class="p">,))</span>

    <span class="n">candidate_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">candidate_list</span><span class="p">,</span> <span class="n">index_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">pred_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">pred_list</span><span class="p">,</span> <span class="n">index_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">species_viewpoint_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">species_viewpoint_list</span><span class="p">,</span> <span class="n">index_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">conf_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">conf_list</span><span class="p">,</span> <span class="n">index_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">values</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">candidate_list</span><span class="p">,</span> <span class="n">pred_list</span><span class="p">,</span> <span class="n">species_viewpoint_list</span><span class="p">,</span> <span class="n">conf_list</span><span class="p">)</span>
    <span class="n">rects</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">color_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;giraffe&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="s1">&#39;giraffe_masai&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="s1">&#39;zebra_plains&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
        <span class="s1">&#39;zebra_grevys&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="s1">&#39;elephant_savanna&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="n">skipped</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">candidate</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">species_viewpoint</span><span class="p">,</span> <span class="n">conf</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
        <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span>
        <span class="n">species</span><span class="p">,</span> <span class="n">viewpoint</span> <span class="o">=</span> <span class="n">species_viewpoint</span>
        <span class="k">if</span> <span class="n">conf</span> <span class="o">&lt;</span> <span class="n">confidence</span><span class="p">:</span>
            <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="si">%r</span><span class="s1"> Found </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">) at </span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="o">%</span> <span class="p">(</span>
                <span class="n">candidate</span><span class="p">,</span>
                <span class="n">pred</span><span class="p">,</span>
                <span class="n">species</span><span class="p">,</span>
                <span class="n">viewpoint</span><span class="p">,</span>
                <span class="n">conf</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">color_dict</span><span class="p">[</span><span class="n">species</span><span class="p">]</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">rects</span><span class="p">,</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">),</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="n">color</span><span class="p">)</span>
        <span class="c1"># mx = int((x1 - x0) * 0.5)</span>
        <span class="c1"># my = int((y1 - y0) * 0.5)</span>
        <span class="c1"># cv2.circle(rects, (x0 + mx, y0 + my), 5, color, -1)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;Skipped [ </span><span class="si">%d</span><span class="s1"> / </span><span class="si">%d</span><span class="s1"> ]&#39;</span>
        <span class="o">%</span> <span class="p">(</span>
            <span class="n">skipped</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">rects</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_siam_l2_model"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn._plugin.get_siam_l2_model">[docs]</a><span class="k">def</span> <span class="nf">get_siam_l2_model</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    model.show_weights_image()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model_url</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;https://wildbookiarepository.azureedge.net/models/siaml2_128_model_state.pkl&#39;</span>
    <span class="p">)</span>
    <span class="n">model_dpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_app_resource_dir</span><span class="p">(</span><span class="s1">&#39;wbia_cnn&#39;</span><span class="p">,</span> <span class="s1">&#39;models&#39;</span><span class="p">)</span>
    <span class="n">model_fpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">grab_file_url</span><span class="p">(</span><span class="n">model_url</span><span class="p">,</span> <span class="n">download_dir</span><span class="o">=</span><span class="n">model_dpath</span><span class="p">)</span>
    <span class="n">model_state</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">load_cPkl</span><span class="p">(</span><span class="n">model_fpath</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">wbia_cnn</span>

    <span class="n">wbia_cnn</span><span class="o">.</span><span class="n">models</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SiameseL2</span><span class="p">(</span>
        <span class="n">input_shape</span><span class="o">=</span><span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;input_shape&#39;</span><span class="p">],</span>
        <span class="n">arch_tag</span><span class="o">=</span><span class="n">model_state</span><span class="p">[</span><span class="s1">&#39;arch_tag&#39;</span><span class="p">],</span>
        <span class="n">autoinit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">load_model_state</span><span class="p">(</span><span class="n">fpath</span><span class="o">=</span><span class="n">model_fpath</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span></div>


<div class="viewcode-block" id="generate_siam_l2_128_feats"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn._plugin.generate_siam_l2_128_feats">[docs]</a><span class="k">def</span> <span class="nf">generate_siam_l2_128_feats</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">cid_list</span><span class="p">,</span> <span class="n">config2_</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        cid_list (list):</span>
<span class="sd">        config2_ (dict): (default = None)</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia_cnn._plugin --test-generate_siam_l2_128_feats</span>
<span class="sd">        python -m wbia_cnn._plugin --test-generate_siam_l2_128_feats --db PZ_Master0</span>

<span class="sd">    SeeAlso:</span>
<span class="sd">        ~/code/ibeis/ibeis/algo/preproc/preproc_feat.py</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn._plugin import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import wbia</span>
<span class="sd">        &gt;&gt;&gt; ibs = wbia.opendb(defaultdb=&#39;testdb1&#39;, allow_newdir=True)</span>
<span class="sd">        &gt;&gt;&gt; cid_list = ibs.depc_annot.get_rowids(&#39;chips&#39;, ibs.get_valid_aids())</span>
<span class="sd">        &gt;&gt;&gt; config2_ = None</span>
<span class="sd">        &gt;&gt;&gt; # megahack</span>
<span class="sd">        &gt;&gt;&gt; cfg = Config.FeatureConfig() # fixme</span>
<span class="sd">        &gt;&gt;&gt; config2_ = dict(feat_type=&#39;hesaff+siam128&#39;,</span>
<span class="sd">        &gt;&gt;&gt;                 feat_cfgstr=cfg.feat_cfg.get_cfgstr().replace(&#39;sift&#39;, &#39;siam128&#39;),</span>
<span class="sd">        &gt;&gt;&gt;                 hesaff_params=cfg.feat_cfg.get_hesaff_params())</span>
<span class="sd">        &gt;&gt;&gt; featgen = generate_siam_l2_128_feats(ibs, cid_list, config2_)</span>
<span class="sd">        &gt;&gt;&gt; result = ut.depth_profile(list(featgen))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># hack because we need the old features</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">get_siam_l2_model</span><span class="p">()</span>
    <span class="n">colorspace</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span> <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>  <span class="c1"># &#39;bgr&#39;</span>
    <span class="n">patch_size</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">config2_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Get config from config2_ object</span>
        <span class="c1"># logger.info(&#39;id(config2_) = &#39; + str(id(config2_)))</span>
        <span class="n">feat_cfgstr</span> <span class="o">=</span> <span class="n">config2_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;feat_cfgstr&#39;</span><span class="p">)</span>
        <span class="n">hesaff_params</span> <span class="o">=</span> <span class="n">config2_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hesaff_params&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">feat_cfgstr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">hesaff_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="kc">False</span>
    <span class="n">hack_config2_</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">feat_type</span><span class="o">=</span><span class="s1">&#39;hesaff+sift&#39;</span><span class="p">,</span>
        <span class="n">feat_cfgstr</span><span class="o">=</span><span class="n">feat_cfgstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;siam128&#39;</span><span class="p">,</span> <span class="s1">&#39;sift&#39;</span><span class="p">),</span>
        <span class="n">hesaff_params</span><span class="o">=</span><span class="n">hesaff_params</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating siam128 features for </span><span class="si">%d</span><span class="s1"> chips&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cid_list</span><span class="p">),))</span>
    <span class="n">BATCHED</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">BATCHED</span><span class="p">:</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_chip_feat_rowid</span><span class="p">(</span><span class="n">cid_list</span><span class="p">,</span> <span class="n">config2_</span><span class="o">=</span><span class="n">hack_config2_</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cid_batch</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgressIter</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">ichunks</span><span class="p">(</span><span class="n">cid_list</span><span class="p">,</span> <span class="mi">128</span><span class="p">)),</span> <span class="n">lbl</span><span class="o">=</span><span class="s1">&#39;siam128 chip chunk&#39;</span>
        <span class="p">):</span>
            <span class="n">sift_fid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_chip_feat_rowid</span><span class="p">(</span><span class="n">cid_batch</span><span class="p">,</span> <span class="n">config2_</span><span class="o">=</span><span class="n">hack_config2_</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Reading keypoints&#39;</span><span class="p">)</span>
            <span class="n">kpts_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_feat_kpts</span><span class="p">(</span><span class="n">sift_fid_list</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Reading chips&#39;</span><span class="p">)</span>
            <span class="n">chip_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">convert_image_list_colorspace</span><span class="p">(</span>
                <span class="n">ibs</span><span class="o">.</span><span class="n">get_chips</span><span class="p">(</span><span class="n">cid_batch</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">colorspace</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Warping patches&#39;</span><span class="p">)</span>
            <span class="n">warped_patches_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">vt</span><span class="o">.</span><span class="n">get_warped_patches</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">kpts</span><span class="p">,</span> <span class="n">patch_size</span><span class="o">=</span><span class="n">patch_size</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">chip</span><span class="p">,</span> <span class="n">kpts</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">chip_list</span><span class="p">,</span> <span class="n">kpts_list</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">flat_list</span><span class="p">,</span> <span class="n">cumlen_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">invertible_flatten2</span><span class="p">(</span><span class="n">warped_patches_list</span><span class="p">)</span>
            <span class="n">stacked_patches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">flat_list</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

            <span class="n">test_outputs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict2</span><span class="p">(</span><span class="n">X_test</span><span class="o">=</span><span class="n">stacked_patches</span><span class="p">)</span>
            <span class="n">network_output_determ</span> <span class="o">=</span> <span class="n">test_outputs</span><span class="p">[</span><span class="s1">&#39;network_output_determ&#39;</span><span class="p">]</span>
            <span class="c1"># network_output_determ.min()</span>
            <span class="c1"># network_output_determ.max()</span>
            <span class="n">siam128_vecs_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unflatten2</span><span class="p">(</span><span class="n">network_output_determ</span><span class="p">,</span> <span class="n">cumlen_list</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">cid</span><span class="p">,</span> <span class="n">kpts</span><span class="p">,</span> <span class="n">vecs</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cid_batch</span><span class="p">,</span> <span class="n">kpts_list</span><span class="p">,</span> <span class="n">siam128_vecs_list</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">cid</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">kpts</span><span class="p">),</span> <span class="n">kpts</span><span class="p">,</span> <span class="n">vecs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sift_fid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_chip_feat_rowid</span><span class="p">(</span>
            <span class="n">cid_list</span><span class="p">,</span> <span class="n">config2_</span><span class="o">=</span><span class="n">hack_config2_</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>  <span class="c1"># NOQA</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Reading keypoints&#39;</span><span class="p">)</span>
        <span class="n">kpts_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_feat_kpts</span><span class="p">(</span><span class="n">sift_fid_list</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Reading chips&#39;</span><span class="p">)</span>
        <span class="n">chip_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">convert_image_list_colorspace</span><span class="p">(</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">get_chips</span><span class="p">(</span><span class="n">cid_list</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">colorspace</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Warping patches&#39;</span><span class="p">)</span>
        <span class="n">warped_patches_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">vt</span><span class="o">.</span><span class="n">get_warped_patches</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">kpts</span><span class="p">,</span> <span class="n">patch_size</span><span class="o">=</span><span class="n">patch_size</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">chip</span><span class="p">,</span> <span class="n">kpts</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">chip_list</span><span class="p">,</span> <span class="n">kpts_list</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">flat_list</span><span class="p">,</span> <span class="n">cumlen_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">invertible_flatten2</span><span class="p">(</span><span class="n">warped_patches_list</span><span class="p">)</span>
        <span class="n">stacked_patches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">flat_list</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="n">test_outputs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict2</span><span class="p">(</span><span class="n">X_test</span><span class="o">=</span><span class="n">stacked_patches</span><span class="p">)</span>
        <span class="n">network_output_determ</span> <span class="o">=</span> <span class="n">test_outputs</span><span class="p">[</span><span class="s1">&#39;network_output_determ&#39;</span><span class="p">]</span>
        <span class="c1"># network_output_determ.min()</span>
        <span class="c1"># network_output_determ.max()</span>
        <span class="n">siam128_vecs_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unflatten2</span><span class="p">(</span><span class="n">network_output_determ</span><span class="p">,</span> <span class="n">cumlen_list</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">cid</span><span class="p">,</span> <span class="n">kpts</span><span class="p">,</span> <span class="n">vecs</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cid_list</span><span class="p">,</span> <span class="n">kpts_list</span><span class="p">,</span> <span class="n">siam128_vecs_list</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">cid</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">kpts</span><span class="p">),</span> <span class="n">kpts</span><span class="p">,</span> <span class="n">vecs</span></div>


<div class="viewcode-block" id="extract_siam128_vecs"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn._plugin.extract_siam128_vecs">[docs]</a><span class="k">def</span> <span class="nf">extract_siam128_vecs</span><span class="p">(</span><span class="n">chip_list</span><span class="p">,</span> <span class="n">kpts_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Duplicate testing func for vtool</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">get_siam_l2_model</span><span class="p">()</span>
    <span class="n">colorspace</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span> <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>  <span class="c1"># &#39;bgr&#39;</span>
    <span class="n">patch_size</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">chip_list_</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">convert_image_list_colorspace</span><span class="p">(</span><span class="n">chip_list</span><span class="p">,</span> <span class="n">colorspace</span><span class="p">)</span>

    <span class="n">warped_patches_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">vt</span><span class="o">.</span><span class="n">get_warped_patches</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">kpts</span><span class="p">,</span> <span class="n">patch_size</span><span class="o">=</span><span class="n">patch_size</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">chip</span><span class="p">,</span> <span class="n">kpts</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">chip_list_</span><span class="p">,</span> <span class="n">kpts_list</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">flat_list</span><span class="p">,</span> <span class="n">cumlen_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">invertible_flatten2</span><span class="p">(</span><span class="n">warped_patches_list</span><span class="p">)</span>
    <span class="n">stacked_patches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">flat_list</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">stacked_patches</span>
    <span class="n">test_outputs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict2</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">network_output_determ</span> <span class="o">=</span> <span class="n">test_outputs</span><span class="p">[</span><span class="s1">&#39;network_output_determ&#39;</span><span class="p">]</span>
    <span class="c1"># network_output_determ.min()</span>
    <span class="c1"># network_output_determ.max()</span>
    <span class="n">siam128_vecs_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unflatten2</span><span class="p">(</span><span class="n">network_output_determ</span><span class="p">,</span> <span class="n">cumlen_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">siam128_vecs_list</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia_cnn._plugin</span>
<span class="sd">        python -m wbia_cnn._plugin --allexamples</span>
<span class="sd">        python -m wbia_cnn._plugin --allexamples --noface --nosrc</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>

    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>  <span class="c1"># for win32</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>  <span class="c1"># NOQA</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">doctest_funcs</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Wild Me.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>