<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>wbia_cnn.ingest_wbia &mdash; wbia-cnn 4.0.1.dev0+dirty documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> wbia-cnn
          </a>
              <div class="version">
                4.0.1.dev0+dirty
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../wbia_cnn.html">wbia_cnn package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">wbia-cnn</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
          <li><a href="../wbia_cnn.html">wbia_cnn</a> &raquo;</li>
      <li>wbia_cnn.ingest_wbia</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for wbia_cnn.ingest_wbia</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">zip</span><span class="p">,</span> <span class="nb">map</span><span class="p">,</span> <span class="nb">range</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">wbia</span> <span class="kn">import</span> <span class="n">dtool</span>

<span class="kn">from</span> <span class="nn">wbia_cnn</span> <span class="kn">import</span> <span class="n">draw_results</span>  <span class="c1"># NOQA</span>

<span class="nb">print</span><span class="p">,</span> <span class="n">rrr</span><span class="p">,</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">inject2</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>


<span class="n">FIX_HASH</span> <span class="o">=</span> <span class="kc">True</span>


<div class="viewcode-block" id="get_aidpairs_partmatch"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.ingest_wbia.get_aidpairs_partmatch">[docs]</a><span class="k">def</span> <span class="nf">get_aidpairs_partmatch</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">acfg_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia_cnn.ingest_wbia --exec-get_aidpairs_partmatch</span>

<span class="sd">    SeeAlso:</span>
<span class="sd">        extract_annotpair_training_chips</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn.ingest_wbia import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import wbia</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = wbia.opendb(defaultdb=&#39;PZ_Master1&#39;, allow_newdir=True)</span>
<span class="sd">        &gt;&gt;&gt; #ibs = wbia.opendb(defaultdb=&#39;PZ_MTEST&#39;, allow_newdir=True)</span>
<span class="sd">        &gt;&gt;&gt; #ibs = wbia.opendb(defaultdb=&#39;PZ_FlankHack&#39;, allow_newdir=True)</span>
<span class="sd">        &gt;&gt;&gt; acfg_name = ut.get_argval((&#39;--aidcfg&#39;, &#39;--acfg&#39;, &#39;-a&#39;),</span>
<span class="sd">        ...                             type_=str,</span>
<span class="sd">        ...                             default=&#39;ctrl:pername=None,excluderef=False,contributor_contains=FlankHack&#39;)</span>
<span class="sd">        &gt;&gt;&gt; aid_pairs, label_list, flat_metadata = get_aidpairs_partmatch(ibs, acfg_name)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;NEW WAY OF FILTERING&#39;</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">wbia.expt</span> <span class="kn">import</span> <span class="n">experiment_helpers</span>

    <span class="n">acfg_list</span><span class="p">,</span> <span class="n">expanded_aids_list</span> <span class="o">=</span> <span class="n">experiment_helpers</span><span class="o">.</span><span class="n">get_annotcfg_list</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="p">[</span><span class="n">acfg_name</span><span class="p">])</span>
    <span class="c1"># acfg = acfg_list[0]</span>
    <span class="n">expanded_aids</span> <span class="o">=</span> <span class="n">expanded_aids_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">qaid_list</span><span class="p">,</span> <span class="n">daid_list</span> <span class="o">=</span> <span class="n">expanded_aids</span>
    <span class="n">available_aids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">([</span><span class="n">qaid_list</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">]))</span>
    <span class="n">tup</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">partition_annots_into_corresponding_groups</span><span class="p">(</span><span class="n">qaid_list</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">)</span>
    <span class="n">aids1_list</span><span class="p">,</span> <span class="n">aids2_list</span><span class="p">,</span> <span class="n">other_aids1</span><span class="p">,</span> <span class="n">other_aids2</span> <span class="o">=</span> <span class="n">tup</span>
    <span class="n">multiton_aids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">aids1_list</span> <span class="o">+</span> <span class="n">aids2_list</span><span class="p">))</span>
    <span class="c1"># singletons = ut.flatten(other_aids2 + other_aids1)</span>

    <span class="n">ibs</span><span class="o">.</span><span class="n">print_annotconfig_stats</span><span class="p">(</span><span class="n">qaid_list</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">,</span> <span class="n">bigstr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Positive Examples</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Sampling positive examples&#39;</span><span class="p">)</span>
    <span class="n">nested_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">itertools</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">iprod</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aids1_list</span><span class="p">,</span> <span class="n">aids2_list</span><span class="p">)))</span>
    <span class="p">)</span>
    <span class="n">pos_aid_pairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">nested_pairs</span><span class="p">)</span>
    <span class="c1"># Filter Self</span>
    <span class="n">flag_list</span> <span class="o">=</span> <span class="n">pos_aid_pairs</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">pos_aid_pairs</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">pos_aid_pairs</span> <span class="o">=</span> <span class="n">pos_aid_pairs</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">flag_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Filter bad viewpoints</span>
    <span class="n">TAU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">_np_get_annot_yaws</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">accepts_numpy</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_yaws_asfloat</span><span class="o">.</span><span class="n">im_func</span><span class="p">)</span>
    <span class="n">yaw_pairs</span> <span class="o">=</span> <span class="n">_np_get_annot_yaws</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">pos_aid_pairs</span><span class="p">)</span>
    <span class="n">yawdist</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">ori_distance</span><span class="p">(</span><span class="n">yaw_pairs</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yaw_pairs</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">flag_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">yawdist</span><span class="p">),</span> <span class="n">yawdist</span> <span class="o">&lt;</span> <span class="n">TAU</span> <span class="o">/</span> <span class="mf">8.0</span><span class="p">)</span>
    <span class="n">pos_aid_pairs</span> <span class="o">=</span> <span class="n">pos_aid_pairs</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">flag_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># pos_aid_pairs = vt.unique_rows(pos_aid_pairs)  # should be unncessary</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">unique_rows</span><span class="p">(</span><span class="n">pos_aid_pairs</span><span class="p">))</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_aid_pairs</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;pos_aid_pairs.shape = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pos_aid_pairs</span><span class="o">.</span><span class="n">shape</span><span class="p">,))</span>

    <span class="c1"># Hard Negative Examples</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Sampling hard negative examples&#39;</span><span class="p">)</span>
    <span class="n">num_hard_neg_per_aid</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_aid_pairs</span><span class="p">)</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="n">multiton_aids</span><span class="p">))</span>
    <span class="n">cfgdict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;affine_invariance&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;fg_on&#39;</span><span class="p">:</span> <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">WIN32</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">qreq_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">new_query_request</span><span class="p">(</span><span class="n">qaid_list</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">,</span> <span class="n">cfgdict</span><span class="o">=</span><span class="n">cfgdict</span><span class="p">)</span>
    <span class="n">cm_list</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
    <span class="n">hardneg_aids1</span> <span class="o">=</span> <span class="p">[[</span><span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">]</span> <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="p">(</span><span class="n">cm_list</span><span class="p">)]</span>
    <span class="n">hardneg_aids2</span> <span class="o">=</span> <span class="p">[</span><span class="n">cm</span><span class="o">.</span><span class="n">get_top_gf_aids</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">ntop</span><span class="o">=</span><span class="n">num_hard_neg_per_aid</span><span class="p">)</span> <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">cm_list</span><span class="p">]</span>
    <span class="n">hardneg_aid_pairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">iprod</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="n">hardneg_aids1</span><span class="p">,</span> <span class="n">hardneg_aids2</span><span class="p">)))</span>
    <span class="p">)</span>

    <span class="c1"># Random Negative Examples</span>
    <span class="c1"># TODO: may be able to say not a match from viewpoint?</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Sampling random negative examples&#39;</span><span class="p">)</span>
    <span class="n">num_rand_neg_per_aid</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_aid_pairs</span><span class="p">)</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span><span class="n">multiton_aids</span><span class="p">))</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">randneg_aid_pairs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">neg_aid_pool</span> <span class="o">=</span> <span class="n">available_aids</span>
    <span class="n">neg_nid_pool</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">(</span><span class="n">neg_aid_pool</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">nid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">neg_aid_pool</span><span class="p">,</span> <span class="n">neg_nid_pool</span><span class="p">):</span>
        <span class="n">is_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">not_equal</span><span class="p">(</span><span class="n">neg_nid_pool</span><span class="p">,</span> <span class="n">nid</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">is_valid</span> <span class="o">/</span> <span class="p">(</span><span class="n">is_valid</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">chosen</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">neg_aid_pool</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_rand_neg_per_aid</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
        <span class="n">chosen_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">iprod</span><span class="p">([</span><span class="n">aid</span><span class="p">],</span> <span class="n">chosen</span><span class="p">))</span>
        <span class="n">randneg_aid_pairs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">chosen_pairs</span><span class="p">)</span>
    <span class="n">randneg_aid_pairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">randneg_aid_pairs</span><span class="p">)</span>

    <span class="c1"># Concatenate both types of negative examples</span>
    <span class="c1"># logger.info(&#39;Building negative examples&#39;)</span>
    <span class="c1"># _neg_aid_pairs = np.vstack((hardneg_aid_pairs, randneg_aid_pairs))</span>
    <span class="c1"># neg_aid_pairs = vt.unique_rows(_neg_aid_pairs)</span>

    <span class="c1"># Unsure Examples</span>
    <span class="c1"># TODO: use quality and viewoint labelings to determine this</span>
    <span class="c1"># as well as metadata from the annotmatch table</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;hardneg_aid_pairs.shape = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hardneg_aid_pairs</span><span class="o">.</span><span class="n">shape</span><span class="p">,))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;randneg_aid_pairs.shape = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">randneg_aid_pairs</span><span class="o">.</span><span class="n">shape</span><span class="p">,))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;pos_aid_pairs.shape = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pos_aid_pairs</span><span class="o">.</span><span class="n">shape</span><span class="p">,))</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Building labels&#39;</span><span class="p">)</span>
    <span class="n">const</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">const</span>
    <span class="n">unflat_pairs</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos_aid_pairs</span><span class="p">,</span> <span class="n">hardneg_aid_pairs</span><span class="p">,</span> <span class="n">randneg_aid_pairs</span><span class="p">)</span>
    <span class="n">type_labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">REVIEW</span><span class="o">.</span><span class="n">MATCH</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">REVIEW</span><span class="o">.</span><span class="n">NON_MATCH</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">REVIEW</span><span class="o">.</span><span class="n">NON_MATCH</span><span class="p">)</span>
    <span class="n">type_meta_labels</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="s1">&#39;hardneg&#39;</span><span class="p">,</span> <span class="s1">&#39;randneg&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_expand</span><span class="p">(</span><span class="n">type_list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[[</span><span class="n">item</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span> <span class="k">for</span> <span class="n">pairs</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">unflat_pairs</span><span class="p">,</span> <span class="n">type_list</span><span class="p">)]</span>

    <span class="n">_aid_pairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">unflat_pairs</span><span class="p">)</span>
    <span class="n">_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">_expand</span><span class="p">(</span><span class="n">type_labels</span><span class="p">))</span>

    <span class="n">flat_metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;meta_label&#39;</span><span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">_expand</span><span class="p">(</span><span class="n">type_meta_labels</span><span class="p">))}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Filtering Duplicates&#39;</span><span class="p">)</span>
    <span class="n">nonunique_flags</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">nonunique_row_flags</span><span class="p">(</span><span class="n">_aid_pairs</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Filtered </span><span class="si">%d</span><span class="s1"> duplicate pairs&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nonunique_flags</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Nonunique stats:&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">flat_metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">nonunique_flags</span><span class="p">)))</span>
    <span class="n">unique_flags</span> <span class="o">=</span> <span class="o">~</span><span class="n">nonunique_flags</span>
    <span class="c1"># Do filtering</span>
    <span class="n">aid_pairs</span> <span class="o">=</span> <span class="n">_aid_pairs</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">unique_flags</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">label_list</span> <span class="o">=</span> <span class="n">_labels</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">unique_flags</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">flat_metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">flat_metadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">unique_flags</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Final Stats&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">flat_metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>

    <span class="n">groupsizes</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">vt</span><span class="o">.</span><span class="n">group_indices</span><span class="p">(</span><span class="n">aid_pairs</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">print_dict</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">groupsizes</span><span class="p">),</span> <span class="s1">&#39;groupsize freq&#39;</span><span class="p">)</span>
    <span class="n">flat_metadata</span><span class="p">[</span><span class="s1">&#39;aid_pairs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aid_pairs</span>
    <span class="k">return</span> <span class="n">aid_pairs</span><span class="p">,</span> <span class="n">label_list</span><span class="p">,</span> <span class="n">flat_metadata</span></div>


<div class="viewcode-block" id="extract_annotpair_training_chips"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.ingest_wbia.extract_annotpair_training_chips">[docs]</a><span class="k">def</span> <span class="nf">extract_annotpair_training_chips</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid_pairs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia_cnn.ingest_wbia extract_annotpair_training_chips --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn.ingest_wbia import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import wbia</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; if False:</span>
<span class="sd">        &gt;&gt;&gt;     ibs = wbia.opendb(defaultdb=&#39;PZ_Master1&#39;, allow_newdir=True)</span>
<span class="sd">        &gt;&gt;&gt;     acfg_name = ut.get_argval((&#39;--aidcfg&#39;, &#39;--acfg&#39;, &#39;-a&#39;),</span>
<span class="sd">        &gt;&gt;&gt;                                 type_=str,</span>
<span class="sd">        &gt;&gt;&gt;                                 default=&#39;ctrl:pername=None,excluderef=False,contributor_contains=FlankHack&#39;)</span>
<span class="sd">        &gt;&gt;&gt; else:</span>
<span class="sd">        &gt;&gt;&gt;     ibs = wbia.opendb(defaultdb=&#39;PZ_MTEST&#39;, allow_newdir=True)</span>
<span class="sd">        &gt;&gt;&gt;     acfg_name = ut.get_argval((&#39;--aidcfg&#39;, &#39;--acfg&#39;, &#39;-a&#39;),</span>
<span class="sd">        &gt;&gt;&gt;                                  type_=str,</span>
<span class="sd">        &gt;&gt;&gt;                                  default=&#39;ctrl:pername=None,excluderef=False,index=0:20:2&#39;)</span>
<span class="sd">        &gt;&gt;&gt; #ibs = wbia.opendb(defaultdb=&#39;PZ_FlankHack&#39;, allow_newdir=True)</span>
<span class="sd">        &gt;&gt;&gt; aid_pairs, label_list, flat_metadata = get_aidpairs_partmatch(ibs, acfg_name)</span>
<span class="sd">        &gt;&gt;&gt; s = slice(2, len(aid_pairs), len(aid_pairs) // ut.get_argval(&#39;--x&#39;, type_=int, default=8))</span>
<span class="sd">        &gt;&gt;&gt; #aid_pairs = aid_pairs[s]</span>
<span class="sd">        &gt;&gt;&gt; #label_list = label_list[s]</span>
<span class="sd">        &gt;&gt;&gt; #flat_metadata = dict([(key, val[s]) for key, val in flat_metadata.items()])</span>
<span class="sd">        &gt;&gt;&gt; rchip1_list, rchip2_list = extract_annotpair_training_chips(ibs, aid_pairs)</span>
<span class="sd">        &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn import draw_results  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; interact = draw_results.interact_patches(label_list, (rchip1_list, rchip2_list), flat_metadata, chunck_sizes=(2, 2), ibs=ibs)</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO extract chips in a sane manner</span>
    <span class="kn">import</span> <span class="nn">wbia.algo.hots.vsone_pipeline</span>
    <span class="kn">import</span> <span class="nn">cv2</span>

    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">part_chip_width</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;part_chip_width&#39;</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
    <span class="n">part_chip_height</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;part_chip_height&#39;</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
    <span class="n">colorspace</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;colorspace&#39;</span><span class="p">,</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;unhandled arguments </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">,)</span>

    <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">part_chip_width</span><span class="p">,</span> <span class="n">part_chip_height</span><span class="p">)</span>

    <span class="c1"># cfgdict = {}</span>
    <span class="kn">import</span> <span class="nn">wbia.control.IBEISControl</span>
    <span class="kn">import</span> <span class="nn">wbia.algo.hots.query_request</span>

    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">wbia</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">IBEISControl</span><span class="o">.</span><span class="n">IBEISController</span><span class="p">)</span>
    <span class="n">qreq_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">new_query_request</span><span class="p">(</span><span class="n">aid_pairs</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span> <span class="n">aid_pairs</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">qreq_</span><span class="p">,</span> <span class="n">wbia</span><span class="o">.</span><span class="n">algo</span><span class="o">.</span><span class="n">hots</span><span class="o">.</span><span class="n">query_request</span><span class="o">.</span><span class="n">QueryRequest</span><span class="p">)</span>
    <span class="n">qconfig2_</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">extern_query_config2</span>
    <span class="n">dconfig2_</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">extern_data_config2</span>

    <span class="k">def</span> <span class="nf">compute_alignment</span><span class="p">(</span><span class="n">pair_metadata</span><span class="p">,</span> <span class="n">qreq_</span><span class="o">=</span><span class="n">qreq_</span><span class="p">):</span>
        <span class="n">annot1</span> <span class="o">=</span> <span class="n">pair_metadata</span><span class="p">[</span><span class="s1">&#39;annot1&#39;</span><span class="p">]</span>
        <span class="n">annot2</span> <span class="o">=</span> <span class="n">pair_metadata</span><span class="p">[</span><span class="s1">&#39;annot2&#39;</span><span class="p">]</span>
        <span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span> <span class="o">=</span> <span class="n">annot1</span><span class="p">[</span><span class="s1">&#39;aid&#39;</span><span class="p">],</span> <span class="n">annot2</span><span class="p">[</span><span class="s1">&#39;aid&#39;</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Computing alignment aidpair=(</span><span class="si">%r</span><span class="s1">, </span><span class="si">%r</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">))</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">wbia</span><span class="o">.</span><span class="n">algo</span><span class="o">.</span><span class="n">hots</span><span class="o">.</span><span class="n">vsone_pipeline</span><span class="o">.</span><span class="n">vsone_single</span><span class="p">(</span>
            <span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">,</span> <span class="n">qreq_</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">fm</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;RAT+SV&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fm</span>
        <span class="n">match</span><span class="o">.</span><span class="n">match_metadata</span><span class="p">[</span><span class="s1">&#39;fm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fm</span>
        <span class="n">match</span><span class="o">.</span><span class="n">match_metadata</span><span class="p">[</span><span class="s1">&#39;annot1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">clear_stored</span><span class="p">([</span><span class="s1">&#39;vecs&#39;</span><span class="p">,</span> <span class="s1">&#39;kpts&#39;</span><span class="p">])</span>
        <span class="n">match</span><span class="o">.</span><span class="n">match_metadata</span><span class="p">[</span><span class="s1">&#39;annot2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">clear_stored</span><span class="p">([</span><span class="s1">&#39;dlen_sqrd&#39;</span><span class="p">,</span> <span class="s1">&#39;vecs&#39;</span><span class="p">,</span> <span class="s1">&#39;kpts&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">match_metadata</span>

    <span class="k">def</span> <span class="nf">make_warped_chips</span><span class="p">(</span><span class="n">pair_metadata</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">):</span>
        <span class="n">match_metadata</span> <span class="o">=</span> <span class="n">pair_metadata</span><span class="p">[</span><span class="s1">&#39;match_metadata&#39;</span><span class="p">]</span>
        <span class="n">annot1</span> <span class="o">=</span> <span class="n">pair_metadata</span><span class="p">[</span><span class="s1">&#39;annot1&#39;</span><span class="p">]</span>
        <span class="n">annot2</span> <span class="o">=</span> <span class="n">pair_metadata</span><span class="p">[</span><span class="s1">&#39;annot2&#39;</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Warping Chips aidpair=(</span><span class="si">%r</span><span class="s1">, </span><span class="si">%r</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">annot1</span><span class="p">[</span><span class="s1">&#39;aid&#39;</span><span class="p">],</span> <span class="n">annot2</span><span class="p">[</span><span class="s1">&#39;aid&#39;</span><span class="p">]))</span>
        <span class="n">rchip1</span> <span class="o">=</span> <span class="n">annot1</span><span class="p">[</span><span class="s1">&#39;rchip&#39;</span><span class="p">]</span>
        <span class="n">rchip2</span> <span class="o">=</span> <span class="n">annot2</span><span class="p">[</span><span class="s1">&#39;rchip&#39;</span><span class="p">]</span>
        <span class="n">warped</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">warped</span><span class="p">:</span>
            <span class="n">H1</span> <span class="o">=</span> <span class="n">match_metadata</span><span class="p">[</span><span class="s1">&#39;H_RAT&#39;</span><span class="p">]</span>
            <span class="n">fm</span> <span class="o">=</span> <span class="n">match_metadata</span><span class="p">[</span><span class="s1">&#39;fm&#39;</span><span class="p">]</span>
            <span class="c1"># logger.info(&#39;WARPING&#39;)</span>
            <span class="c1"># Initial Warping</span>
            <span class="n">kpts1_m</span> <span class="o">=</span> <span class="n">annot1</span><span class="p">[</span><span class="s1">&#39;kpts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">kpts2_m</span> <span class="o">=</span> <span class="n">annot2</span><span class="p">[</span><span class="s1">&#39;kpts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># kpts1_mt = vt.transform_kpts_xys(H1, kpts1_m)</span>

            <span class="n">wh2</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">get_size</span><span class="p">(</span><span class="n">rchip2</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;force off&#39;</span><span class="p">)</span>
                <span class="p">(</span><span class="n">minx1</span><span class="p">,</span> <span class="n">maxx1</span><span class="p">,</span> <span class="n">miny1</span><span class="p">,</span> <span class="n">maxy1</span><span class="p">)</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">get_kpts_image_extent</span><span class="p">(</span><span class="n">kpts2_m</span><span class="p">)</span>
                <span class="p">(</span><span class="n">minx2</span><span class="p">,</span> <span class="n">maxx2</span><span class="p">,</span> <span class="n">miny2</span><span class="p">,</span> <span class="n">maxy2</span><span class="p">)</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">get_kpts_image_extent</span><span class="p">(</span><span class="n">kpts1_m</span><span class="p">)</span>
                <span class="p">(</span><span class="n">tl_xy1</span><span class="p">,</span> <span class="n">br_xy1</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">minx1</span><span class="p">,</span> <span class="n">miny1</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">maxx1</span><span class="p">,</span> <span class="n">maxy1</span><span class="p">))</span>
                <span class="p">(</span><span class="n">tl_xy2</span><span class="p">,</span> <span class="n">br_xy2</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">minx2</span><span class="p">,</span> <span class="n">miny2</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">maxx2</span><span class="p">,</span> <span class="n">maxy2</span><span class="p">))</span>
                <span class="n">tl_xy1_t</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">transform_points_with_homography</span><span class="p">(</span><span class="n">H1</span><span class="p">,</span> <span class="n">tl_xy1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
                <span class="n">br_xy1_t</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">transform_points_with_homography</span><span class="p">(</span><span class="n">H1</span><span class="p">,</span> <span class="n">br_xy1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
                <span class="n">tl_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">tl_xy2</span><span class="p">,</span> <span class="n">tl_xy1_t</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">br_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">br_xy2</span><span class="p">,</span> <span class="n">br_xy1_t</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">tl_xy</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">br_xy</span> <span class="o">=</span> <span class="n">wh2</span>
            <span class="n">rchip1_t</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">warpHomog</span><span class="p">(</span><span class="n">rchip1</span><span class="p">,</span> <span class="n">H1</span><span class="p">,</span> <span class="n">wh2</span><span class="p">)</span> <span class="k">if</span> <span class="n">H1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">rchip1</span>

            <span class="c1"># Cropping to remove parts of the image that (probably) cannot match</span>
            <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">isfill</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">get_pixel_dist</span><span class="p">(</span><span class="n">rchip1_t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="n">rowslice</span><span class="p">,</span> <span class="n">colslice</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">get_crop_slices</span><span class="p">(</span><span class="n">isfill</span><span class="p">)</span>
                <span class="c1"># crop just based on blackness</span>
                <span class="c1"># rchip1_crop = rchip1_t[rowslice, colslice]</span>
                <span class="c1"># rchip2_crop = rchip2[rowslice, colslice]</span>
                <span class="c1"># crop based on keypoint match locations</span>
                <span class="n">rowslice_</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span>
                    <span class="nb">max</span><span class="p">(</span><span class="n">rowslice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">tl_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">min</span><span class="p">(</span><span class="n">rowslice</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">br_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="p">)</span>
                <span class="n">colslice_</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span>
                    <span class="nb">max</span><span class="p">(</span><span class="n">colslice</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">tl_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">min</span><span class="p">(</span><span class="n">colslice</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">br_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="p">)</span>
                <span class="n">rchip1_crop</span> <span class="o">=</span> <span class="n">rchip1_t</span><span class="p">[</span><span class="n">rowslice_</span><span class="p">,</span> <span class="n">colslice_</span><span class="p">]</span>
                <span class="n">rchip2_crop</span> <span class="o">=</span> <span class="n">rchip2</span><span class="p">[</span><span class="n">rowslice_</span><span class="p">,</span> <span class="n">colslice_</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rchip1_crop</span> <span class="o">=</span> <span class="n">rchip1_t</span>
                <span class="n">rchip2_crop</span> <span class="o">=</span> <span class="n">rchip2</span>
            <span class="n">rchip1</span> <span class="o">=</span> <span class="n">rchip1_crop</span>
            <span class="n">rchip2</span> <span class="o">=</span> <span class="n">rchip2_crop</span>
            <span class="c1"># Make sure match_metadata doesn&#39;t take up too much memory</span>
            <span class="n">match_metadata</span><span class="o">.</span><span class="n">clear_evaluated</span><span class="p">()</span>
        <span class="c1"># Resize to fit into a neural network</span>
        <span class="n">rchip1_sz</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">rchip1</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LANCZOS4</span><span class="p">)</span>
        <span class="n">rchip2_sz</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">rchip2</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LANCZOS4</span><span class="p">)</span>
        <span class="c1"># hack</span>
        <span class="n">rchip1_sz</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">convert_image_list_colorspace</span><span class="p">([</span><span class="n">rchip1_sz</span><span class="p">],</span> <span class="n">colorspace</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">rchip2_sz</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">convert_image_list_colorspace</span><span class="p">([</span><span class="n">rchip2_sz</span><span class="p">],</span> <span class="n">colorspace</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">rchip1_sz</span><span class="p">,</span> <span class="n">rchip2_sz</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">make_lazy_resize_funcs</span><span class="p">(</span><span class="n">pair_metadata</span><span class="p">):</span>
        <span class="n">tmp_meta</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">LazyDict</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">tmp_meta</span><span class="p">[</span><span class="s1">&#39;warped_chips&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">make_warped_chips</span><span class="p">,</span> <span class="n">pair_metadata</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">lazy_rchip1_sz</span><span class="p">(</span><span class="n">tmp_meta</span><span class="o">=</span><span class="n">tmp_meta</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">tmp_meta</span><span class="p">[</span><span class="s1">&#39;warped_chips&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">lazy_rchip2_sz</span><span class="p">(</span><span class="n">tmp_meta</span><span class="o">=</span><span class="n">tmp_meta</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">tmp_meta</span><span class="p">[</span><span class="s1">&#39;warped_chips&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">lazy_rchip1_sz</span><span class="p">,</span> <span class="n">lazy_rchip2_sz</span>

    <span class="c1"># Compute alignments</span>

    <span class="n">pairmetadata_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgIter</span><span class="p">(</span><span class="n">aid_pairs</span><span class="p">,</span> <span class="n">lbl</span><span class="o">=</span><span class="s1">&#39;Align Info&#39;</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">pair_metadata</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_pair_lazy_dict</span><span class="p">(</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">,</span> <span class="n">qconfig2_</span><span class="p">,</span> <span class="n">dconfig2_</span><span class="p">)</span>
        <span class="n">pair_metadata</span><span class="p">[</span><span class="s1">&#39;match_metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">compute_alignment</span><span class="p">,</span> <span class="n">pair_metadata</span><span class="p">)</span>
        <span class="n">pairmetadata_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pair_metadata</span><span class="p">)</span>

    <span class="c1"># Warp the Chips</span>

    <span class="n">rchip1_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">LazyList</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">rchip2_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">LazyList</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">pair_metadata</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgIter</span><span class="p">(</span>
        <span class="n">pairmetadata_list</span><span class="p">,</span> <span class="n">lbl</span><span class="o">=</span><span class="s1">&#39;Building Warped Chips&#39;</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
        <span class="c1"># rchip1_sz, rchip2_sz = make_warped_chips(pair_metadata)</span>
        <span class="n">rchip1_sz</span><span class="p">,</span> <span class="n">rchip2_sz</span> <span class="o">=</span> <span class="n">make_lazy_resize_funcs</span><span class="p">(</span><span class="n">pair_metadata</span><span class="p">)</span>
        <span class="n">rchip1_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rchip1_sz</span><span class="p">)</span>
        <span class="n">rchip2_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rchip2_sz</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rchip1_list</span><span class="p">,</span> <span class="n">rchip2_list</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    from wbia import plottool as pt</span>
<span class="sd">    pt.imshow(vt.stack_images(rchip1, rchip2)[0])</span>
<span class="sd">    pt.imshow(vt.stack_images(rchip1_sz, rchip2_sz)[0])</span>
<span class="sd">    &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="get_aidpair_patchmatch_training_data"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.ingest_wbia.get_aidpair_patchmatch_training_data">[docs]</a><span class="k">def</span> <span class="nf">get_aidpair_patchmatch_training_data</span><span class="p">(</span>
    <span class="n">ibs</span><span class="p">,</span>
    <span class="n">aid1_list</span><span class="p">,</span>
    <span class="n">aid2_list</span><span class="p">,</span>
    <span class="n">kpts1_m_list</span><span class="p">,</span>
    <span class="n">kpts2_m_list</span><span class="p">,</span>
    <span class="n">fm_list</span><span class="p">,</span>
    <span class="n">metadata_lists</span><span class="p">,</span>
    <span class="n">patch_size</span><span class="p">,</span>
    <span class="n">colorspace</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    FIXME: errors on get_aidpairs_and_matches(ibs, 1)</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia_cnn.ingest_wbia --test-get_aidpair_patchmatch_training_data --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn.ingest_wbia import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import wbia</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = wbia.opendb(defaultdb=&#39;PZ_MTEST&#39;, allow_newdir=True)</span>
<span class="sd">        &gt;&gt;&gt; tup = get_aidpairs_and_matches(ibs, 6)</span>
<span class="sd">        &gt;&gt;&gt; (aid1_list, aid2_list, kpts1_m_list, kpts2_m_list, fm_list, metadata_lists) = tup</span>
<span class="sd">        &gt;&gt;&gt; pmcfg = PatchMetricDataConfig()</span>
<span class="sd">        &gt;&gt;&gt; patch_size = pmcfg[&#39;patch_size&#39;]</span>
<span class="sd">        &gt;&gt;&gt; colorspace = pmcfg[&#39;colorspace&#39;]</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; tup = get_aidpair_patchmatch_training_data(ibs, aid1_list,</span>
<span class="sd">        &gt;&gt;&gt;     aid2_list, kpts1_m_list, kpts2_m_list, fm_list, metadata_lists,</span>
<span class="sd">        &gt;&gt;&gt;     patch_size, colorspace)</span>
<span class="sd">        &gt;&gt;&gt; aid1_list_, aid2_list_, warped_patch1_list, warped_patch2_list, flat_metadata = tup</span>
<span class="sd">        &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">        &gt;&gt;&gt; label_list = get_aidpair_training_labels(ibs, aid1_list_, aid2_list_)</span>
<span class="sd">        &gt;&gt;&gt; draw_results.interact_patches(label_list, (warped_patch1_list, warped_patch2_list), flat_metadata)</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Flatten to only apply chip operations once</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_aidpair_patchmatch_training_data num_pairs = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aid1_list</span><span class="p">)))</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid1_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid2_list</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid1_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">kpts1_m_list</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid1_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">kpts2_m_list</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid1_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">fm_list</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;geting_unflat_chips&#39;</span><span class="p">)</span>
    <span class="n">flat_unique</span><span class="p">,</span> <span class="n">reconstruct_tup</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">inverable_unique_two_lists</span><span class="p">(</span><span class="n">aid1_list</span><span class="p">,</span> <span class="n">aid2_list</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;grabbing </span><span class="si">%d</span><span class="s1"> unique chips&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flat_unique</span><span class="p">)))</span>
    <span class="n">chip_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_chips</span><span class="p">(</span><span class="n">flat_unique</span><span class="p">)</span>  <span class="c1"># TODO config2_</span>
    <span class="c1"># convert to approprate colorspace</span>
    <span class="n">chip_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">convert_image_list_colorspace</span><span class="p">(</span><span class="n">chip_list</span><span class="p">,</span> <span class="n">colorspace</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">print_object_size</span><span class="p">(</span><span class="n">chip_list</span><span class="p">,</span> <span class="s1">&#39;chip_list&#39;</span><span class="p">)</span>
    <span class="n">chip1_list</span><span class="p">,</span> <span class="n">chip2_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">uninvert_unique_two_lists</span><span class="p">(</span><span class="n">chip_list</span><span class="p">,</span> <span class="n">reconstruct_tup</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;warping&#39;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">PatchExtractCache</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patch_size</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">patch_size</span> <span class="o">=</span> <span class="n">patch_size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache_</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">idcache_find_misses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_list</span><span class="p">,</span> <span class="n">cache_</span><span class="p">):</span>
            <span class="c1"># Generalize?</span>
            <span class="n">val_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">cache_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">id_</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">id_list</span><span class="p">]</span>
            <span class="n">ismiss_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">val_list</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">val_list</span><span class="p">,</span> <span class="n">ismiss_list</span>

        <span class="k">def</span> <span class="nf">idcache_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ismiss_list</span><span class="p">,</span> <span class="n">miss_vals</span><span class="p">,</span> <span class="n">id_list</span><span class="p">,</span> <span class="n">val_list</span><span class="p">,</span> <span class="n">cache_</span><span class="p">):</span>
            <span class="c1"># Generalize?</span>
            <span class="n">miss_indices</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">list_where</span><span class="p">(</span><span class="n">ismiss_list</span><span class="p">)</span>
            <span class="n">miss_ids</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">id_list</span><span class="p">,</span> <span class="n">ismiss_list</span><span class="p">)</span>
            <span class="c1"># overwrite missed output</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">miss_indices</span><span class="p">,</span> <span class="n">miss_vals</span><span class="p">):</span>
                <span class="n">val_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="c1"># cache save</span>
            <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">miss_ids</span><span class="p">,</span> <span class="n">miss_vals</span><span class="p">):</span>
                <span class="n">cache_</span><span class="p">[</span><span class="n">id_</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="k">def</span> <span class="nf">cacheget_wraped_patches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">fxs</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">kpts</span><span class="p">):</span>
            <span class="c1"># +-- Custom ids</span>
            <span class="n">id_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">aid</span><span class="p">,</span> <span class="n">fx</span><span class="p">)</span> <span class="k">for</span> <span class="n">fx</span> <span class="ow">in</span> <span class="n">fxs</span><span class="p">]</span>
            <span class="c1"># L__</span>
            <span class="n">val_list</span><span class="p">,</span> <span class="n">ismiss_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">idcache_find_misses</span><span class="p">(</span><span class="n">id_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">ismiss_list</span><span class="p">):</span>
                <span class="c1"># +-- Custom evaluate misses</span>
                <span class="n">kpts_miss</span> <span class="o">=</span> <span class="n">kpts</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">ismiss_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">miss_vals</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">get_warped_patches</span><span class="p">(</span>
                    <span class="n">chip</span><span class="p">,</span> <span class="n">kpts_miss</span><span class="p">,</span> <span class="n">patch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">patch_size</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># L__</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">idcache_save</span><span class="p">(</span><span class="n">ismiss_list</span><span class="p">,</span> <span class="n">miss_vals</span><span class="p">,</span> <span class="n">id_list</span><span class="p">,</span> <span class="n">val_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">val_list</span>

    <span class="n">fx1_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">fm</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">fm</span> <span class="ow">in</span> <span class="n">fm_list</span><span class="p">]</span>
    <span class="n">fx2_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">fm</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">fm</span> <span class="ow">in</span> <span class="n">fm_list</span><span class="p">]</span>
    <span class="n">warp_iter1</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgIter</span><span class="p">(</span>
        <span class="nb">zip</span><span class="p">(</span><span class="n">aid1_list</span><span class="p">,</span> <span class="n">fx1_list</span><span class="p">,</span> <span class="n">chip1_list</span><span class="p">,</span> <span class="n">kpts1_m_list</span><span class="p">),</span>
        <span class="n">nTotal</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">kpts1_m_list</span><span class="p">),</span>
        <span class="n">lbl</span><span class="o">=</span><span class="s1">&#39;warp1&#39;</span><span class="p">,</span>
        <span class="n">adjust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">warp_iter2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgIter</span><span class="p">(</span>
        <span class="nb">zip</span><span class="p">(</span><span class="n">aid2_list</span><span class="p">,</span> <span class="n">fx2_list</span><span class="p">,</span> <span class="n">chip2_list</span><span class="p">,</span> <span class="n">kpts2_m_list</span><span class="p">),</span>
        <span class="n">nTotal</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">kpts2_m_list</span><span class="p">),</span>
        <span class="n">lbl</span><span class="o">=</span><span class="s1">&#39;warp2&#39;</span><span class="p">,</span>
        <span class="n">adjust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">pec</span> <span class="o">=</span> <span class="n">PatchExtractCache</span><span class="p">(</span><span class="n">patch_size</span><span class="o">=</span><span class="n">patch_size</span><span class="p">)</span>
    <span class="n">warped_patches1_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="n">itertools</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">pec</span><span class="o">.</span><span class="n">cacheget_wraped_patches</span><span class="p">,</span> <span class="n">warp_iter1</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">warped_patches2_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="n">itertools</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">pec</span><span class="o">.</span><span class="n">cacheget_wraped_patches</span><span class="p">,</span> <span class="n">warp_iter2</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="c1"># warp_iter1 = ut.ProgIter(zip(chip1_list, kpts1_m_list),</span>
    <span class="c1">#                             nTotal=len(kpts1_m_list), lbl=&#39;warp1&#39;,</span>
    <span class="c1">#                             adjust=True)</span>
    <span class="c1"># warp_iter2 = ut.ProgIter(zip(chip2_list, kpts2_m_list),</span>
    <span class="c1">#                             nTotal=len(kpts2_m_list), lbl=&#39;warp2&#39;,</span>
    <span class="c1">#                             adjust=True)</span>
    <span class="c1"># warped_patches1_list = [vt.get_warped_patches(chip1, kpts1, patch_size=patch_size)[0]</span>
    <span class="c1">#                        for chip1, kpts1 in warp_iter1]</span>
    <span class="c1"># warped_patches2_list = [vt.get_warped_patches(chip2, kpts2, patch_size=patch_size)[0]</span>
    <span class="c1">#                        for chip2, kpts2 in warp_iter2]</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">print_object_size</span><span class="p">(</span><span class="n">warped_patches1_list</span><span class="p">,</span> <span class="s1">&#39;warped_patches1_list&#39;</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">print_object_size</span><span class="p">(</span><span class="n">warped_patches2_list</span><span class="p">,</span> <span class="s1">&#39;warped_patches2_list&#39;</span><span class="p">)</span>
    <span class="n">len1_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">fm_list</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">warped_patches1_list</span><span class="p">)</span> <span class="o">==</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">warped_patches2_list</span><span class="p">),</span> <span class="s1">&#39;bug&#39;</span>
    <span class="k">assert</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">warped_patches1_list</span><span class="p">)</span> <span class="o">==</span> <span class="n">len1_list</span><span class="p">,</span> <span class="s1">&#39;bug&#39;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;flattening&#39;</span><span class="p">)</span>
    <span class="n">aid1_list_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">([[</span><span class="n">aid1</span><span class="p">]</span> <span class="o">*</span> <span class="n">len1</span> <span class="k">for</span> <span class="n">len1</span><span class="p">,</span> <span class="n">aid1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">len1_list</span><span class="p">,</span> <span class="n">aid1_list</span><span class="p">)])</span>
    <span class="p">)</span>
    <span class="n">aid2_list_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">([[</span><span class="n">aid2</span><span class="p">]</span> <span class="o">*</span> <span class="n">len1</span> <span class="k">for</span> <span class="n">len1</span><span class="p">,</span> <span class="n">aid2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">len1_list</span><span class="p">,</span> <span class="n">aid2_list</span><span class="p">)])</span>
    <span class="p">)</span>
    <span class="c1"># Flatten metadata</span>
    <span class="n">flat_metadata</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">metadata_lists</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="n">flat_metadata</span><span class="p">[</span><span class="s1">&#39;aid_pairs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">aid1_list_</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">aid2_list_</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">])</span>
    <span class="p">)</span>
    <span class="n">flat_metadata</span><span class="p">[</span><span class="s1">&#39;fm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">fm_list</span><span class="p">)</span>
    <span class="n">flat_metadata</span><span class="p">[</span><span class="s1">&#39;kpts1_m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">kpts1_m_list</span><span class="p">)</span>
    <span class="n">flat_metadata</span><span class="p">[</span><span class="s1">&#39;kpts2_m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">kpts2_m_list</span><span class="p">)</span>

    <span class="c1"># flat_metadata = ut.map_dict_vals(np.array, flat_metadata)</span>

    <span class="n">warped_patch1_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">warped_patches1_list</span><span class="p">)</span>
    <span class="n">warped_patch2_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">warped_patches2_list</span><span class="p">)</span>
    <span class="c1"># del warped_patches1_list</span>
    <span class="c1"># del warped_patches2_list</span>
    <span class="k">return</span> <span class="n">aid1_list_</span><span class="p">,</span> <span class="n">aid2_list_</span><span class="p">,</span> <span class="n">warped_patch1_list</span><span class="p">,</span> <span class="n">warped_patch2_list</span><span class="p">,</span> <span class="n">flat_metadata</span></div>


<div class="viewcode-block" id="flatten_patch_data"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.ingest_wbia.flatten_patch_data">[docs]</a><span class="k">def</span> <span class="nf">flatten_patch_data</span><span class="p">(</span>
    <span class="n">ibs</span><span class="p">,</span> <span class="n">aid1_list</span><span class="p">,</span> <span class="n">aid2_list</span><span class="p">,</span> <span class="n">kpts1_m_list</span><span class="p">,</span> <span class="n">kpts2_m_list</span><span class="p">,</span> <span class="n">fm_list</span><span class="p">,</span> <span class="n">metadata_lists</span>
<span class="p">):</span>
    <span class="c1"># TODO; rectify</span>
    <span class="n">len1_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">fm_list</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;flattening&#39;</span><span class="p">)</span>
    <span class="n">aid1_list_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">([[</span><span class="n">aid1</span><span class="p">]</span> <span class="o">*</span> <span class="n">len1</span> <span class="k">for</span> <span class="n">len1</span><span class="p">,</span> <span class="n">aid1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">len1_list</span><span class="p">,</span> <span class="n">aid1_list</span><span class="p">)])</span>
    <span class="p">)</span>
    <span class="n">aid2_list_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">([[</span><span class="n">aid2</span><span class="p">]</span> <span class="o">*</span> <span class="n">len1</span> <span class="k">for</span> <span class="n">len1</span><span class="p">,</span> <span class="n">aid2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">len1_list</span><span class="p">,</span> <span class="n">aid2_list</span><span class="p">)])</span>
    <span class="p">)</span>
    <span class="c1"># Flatten metadata</span>
    <span class="n">flat_metadata</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">metadata_lists</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="n">flat_metadata</span><span class="p">[</span><span class="s1">&#39;aid_pairs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">aid1_list_</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">aid2_list_</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">])</span>
    <span class="p">)</span>
    <span class="n">flat_metadata</span><span class="p">[</span><span class="s1">&#39;fm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">fm_list</span><span class="p">)</span>
    <span class="n">flat_metadata</span><span class="p">[</span><span class="s1">&#39;kpts1_m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">kpts1_m_list</span><span class="p">)</span>
    <span class="n">flat_metadata</span><span class="p">[</span><span class="s1">&#39;kpts2_m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">kpts2_m_list</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">get_aidpair_training_labels</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid1_list_</span><span class="p">,</span> <span class="n">aid2_list_</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aid1_list_</span><span class="p">,</span> <span class="n">aid2_list_</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">flat_metadata</span></div>
    <span class="c1"># TEMP</span>


<div class="viewcode-block" id="get_patchmetric_training_data_and_labels"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.ingest_wbia.get_patchmetric_training_data_and_labels">[docs]</a><span class="k">def</span> <span class="nf">get_patchmetric_training_data_and_labels</span><span class="p">(</span>
    <span class="n">ibs</span><span class="p">,</span>
    <span class="n">aid1_list</span><span class="p">,</span>
    <span class="n">aid2_list</span><span class="p">,</span>
    <span class="n">kpts1_m_list</span><span class="p">,</span>
    <span class="n">kpts2_m_list</span><span class="p">,</span>
    <span class="n">fm_list</span><span class="p">,</span>
    <span class="n">metadata_lists</span><span class="p">,</span>
    <span class="n">patch_size</span><span class="p">,</span>
    <span class="n">colorspace</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Notes:</span>
<span class="sd">        # FIXME: THERE ARE INCORRECT CORRESPONDENCES LABELED AS CORRECT THAT</span>
<span class="sd">        # NEED MANUAL CORRECTION EITHER THROUGH EXPLICIT LABLEING OR</span>
<span class="sd">        # SEGMENTATION MASKS</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia_cnn.ingest_wbia --test-get_patchmetric_training_data_and_labels --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn.ingest_wbia import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import wbia</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = wbia.opendb(defaultdb=&#39;PZ_MTEST&#39;, allow_newdir=True)</span>
<span class="sd">        &gt;&gt;&gt; (aid1_list, aid2_list, kpts1_m_list, kpts2_m_list, fm_list, metadata_lists) = get_aidpairs_and_matches(ibs, 10, 3)</span>
<span class="sd">        &gt;&gt;&gt; pmcfg = PatchMetricDataConfig()</span>
<span class="sd">        &gt;&gt;&gt; patch_size = pmcfg[&#39;patch_size&#39;]</span>
<span class="sd">        &gt;&gt;&gt; colorspace = pmcfg[&#39;colorspace&#39;]</span>
<span class="sd">        &gt;&gt;&gt; data, labels, flat_metadata = get_patchmetric_training_data_and_labels(ibs,</span>
<span class="sd">        ...     aid1_list, aid2_list, kpts1_m_list, kpts2_m_list, fm_list,</span>
<span class="sd">        ...     metadata_lists, patch_size, colorspace)</span>
<span class="sd">        &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">        &gt;&gt;&gt; draw_results.interact_siamsese_data_patches(labels, data)</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># To the removal of unknown pairs before computing the data</span>

    <span class="n">tup</span> <span class="o">=</span> <span class="n">get_aidpair_patchmatch_training_data</span><span class="p">(</span>
        <span class="n">ibs</span><span class="p">,</span>
        <span class="n">aid1_list</span><span class="p">,</span>
        <span class="n">aid2_list</span><span class="p">,</span>
        <span class="n">kpts1_m_list</span><span class="p">,</span>
        <span class="n">kpts2_m_list</span><span class="p">,</span>
        <span class="n">fm_list</span><span class="p">,</span>
        <span class="n">metadata_lists</span><span class="p">,</span>
        <span class="n">patch_size</span><span class="p">,</span>
        <span class="n">colorspace</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="p">(</span><span class="n">aid1_list_</span><span class="p">,</span> <span class="n">aid2_list_</span><span class="p">,</span> <span class="n">warped_patch1_list</span><span class="p">,</span> <span class="n">warped_patch2_list</span><span class="p">,</span> <span class="n">flat_metadata</span><span class="p">)</span> <span class="o">=</span> <span class="n">tup</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">get_aidpair_training_labels</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid1_list_</span><span class="p">,</span> <span class="n">aid2_list_</span><span class="p">)</span>
    <span class="n">img_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">warped_patch1_list</span><span class="p">,</span> <span class="n">warped_patch2_list</span><span class="p">)))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img_list</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">img_list</span>
    <span class="c1"># data_per_label = 2</span>
    <span class="k">assert</span> <span class="n">labels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="kn">from</span> <span class="nn">wbia</span> <span class="kn">import</span> <span class="n">const</span>

    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">labels</span> <span class="o">!=</span> <span class="n">const</span><span class="o">.</span><span class="n">REVIEW</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">flat_metadata</span></div>


<div class="viewcode-block" id="mark_inconsistent_viewpoints"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.ingest_wbia.mark_inconsistent_viewpoints">[docs]</a><span class="k">def</span> <span class="nf">mark_inconsistent_viewpoints</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid1_list</span><span class="p">,</span> <span class="n">aid2_list</span><span class="p">):</span>
    <span class="n">yaw1_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">replace_nones</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_yaws</span><span class="p">(</span><span class="n">aid2_list</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span>
    <span class="n">yaw2_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">replace_nones</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_yaws</span><span class="p">(</span><span class="n">aid1_list</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span>
    <span class="n">yawdist_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">ori_distance</span><span class="p">(</span><span class="n">yaw1_list</span><span class="p">,</span> <span class="n">yaw2_list</span><span class="p">)</span>
    <span class="n">TAU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">isinconsistent_list</span> <span class="o">=</span> <span class="n">yawdist_list</span> <span class="o">&gt;</span> <span class="n">TAU</span> <span class="o">/</span> <span class="mi">8</span>
    <span class="k">return</span> <span class="n">isinconsistent_list</span></div>


<div class="viewcode-block" id="get_aidpair_training_labels"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.ingest_wbia.get_aidpair_training_labels">[docs]</a><span class="k">def</span> <span class="nf">get_aidpair_training_labels</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid1_list_</span><span class="p">,</span> <span class="n">aid2_list_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns:</span>
<span class="sd">        ndarray: true in positions of matching, and false in positions of not matching</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn.ingest_wbia import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import wbia</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = wbia.opendb(defaultdb=&#39;PZ_MTEST&#39;, allow_newdir=True)</span>
<span class="sd">        &gt;&gt;&gt; tup = get_aidpairs_and_matches(ibs)</span>
<span class="sd">        &gt;&gt;&gt; (aid1_list, aid2_list) = tup[0:2]</span>
<span class="sd">        &gt;&gt;&gt; aid1_list = aid1_list[0:min(100, len(aid1_list))]</span>
<span class="sd">        &gt;&gt;&gt; aid2_list = aid2_list[0:min(100, len(aid2_list))]</span>
<span class="sd">        &gt;&gt;&gt; # execute function</span>
<span class="sd">        &gt;&gt;&gt; labels = get_aidpair_training_labels(ibs, aid1_list, aid2_list)</span>
<span class="sd">        &gt;&gt;&gt; result = (&#39;labels = %s&#39; % (ut.numpy_str(labels, threshold=10),))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        labels = np.array([1, 0, 0, ..., 0, 1, 0], dtype=np.int32)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">truth_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_aidpair_truths</span><span class="p">(</span><span class="n">aid1_list_</span><span class="p">,</span> <span class="n">aid2_list_</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">truth_list</span>
    <span class="c1"># Mark different viewpoints as unknown for training</span>
    <span class="n">isinconsistent_list</span> <span class="o">=</span> <span class="n">mark_inconsistent_viewpoints</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid1_list_</span><span class="p">,</span> <span class="n">aid2_list_</span><span class="p">)</span>
    <span class="n">labels</span><span class="p">[</span><span class="n">isinconsistent_list</span><span class="p">]</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">REVIEW</span><span class="o">.</span><span class="n">UNKNOWN</span>
    <span class="k">return</span> <span class="n">labels</span></div>


<span class="c1"># Estimate how big the patches will be</span>
<div class="viewcode-block" id="estimate_data_bytes"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.ingest_wbia.estimate_data_bytes">[docs]</a><span class="k">def</span> <span class="nf">estimate_data_bytes</span><span class="p">(</span><span class="n">num_data</span><span class="p">,</span> <span class="n">item_shape</span><span class="p">):</span>
    <span class="n">data_per_label</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">dtype_bytes</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">estimated_bytes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">item_shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_data</span> <span class="o">*</span> <span class="n">data_per_label</span> <span class="o">*</span> <span class="n">dtype_bytes</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Estimated data size: &#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">byte_str2</span><span class="p">(</span><span class="n">estimated_bytes</span><span class="p">))</span></div>


<span class="c1"># class NewConfigBase(object):</span>
<span class="c1">#    def __init__(self, **kwargs):</span>
<span class="c1">#        self.update(**kwargs)</span>

<span class="c1">#    def update(self, **kwargs):</span>
<span class="c1">#        self.__dict__.update(**kwargs)</span>
<span class="c1">#        ut.update_existing(self.__dict__, kwargs)</span>
<span class="c1">#        unhandled_keys = set(kwargs.keys()) - set(self.__dict__.keys())</span>
<span class="c1">#        if len(unhandled_keys) &gt; 0:</span>
<span class="c1">#            raise AssertionError(</span>
<span class="c1">#                &#39;[ConfigBaseError] unhandled_keys=%r&#39; % (unhandled_keys,))</span>

<span class="c1">#    def kw(self):</span>
<span class="c1">#        return ut.KwargsWrapper(self)</span>


<div class="viewcode-block" id="PartMatchDataConfig"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.ingest_wbia.PartMatchDataConfig">[docs]</a><span class="k">class</span> <span class="nc">PartMatchDataConfig</span><span class="p">(</span><span class="n">dtool</span><span class="o">.</span><span class="n">Config</span><span class="p">):</span>
    <span class="n">_param_info_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="s1">&#39;part_chip_width&#39;</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="s1">&#39;part_chip_height&#39;</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="s1">&#39;colorspace&#39;</span><span class="p">,</span> <span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="s1">&#39;bgr&#39;</span><span class="p">,</span> <span class="s1">&#39;lab&#39;</span><span class="p">]),</span>
    <span class="p">]</span>
    <span class="c1"># def __init__(pmcfg, **kwargs):</span>
    <span class="c1">#    #pmcfg.part_chip_width = 256</span>
    <span class="c1">#    #pmcfg.part_chip_height = 128</span>
    <span class="c1">#    #pmcfg.colorspace = &#39;gray&#39;</span>
    <span class="c1">#    super(PartMatchDataConfig, pmcfg).__init__(**kwargs)</span>

    <span class="c1"># def get_cfgstr(pmcfg):</span>
    <span class="c1">#    cfgstr_list = [</span>
    <span class="c1">#        &#39;sz=(%d,%d)&#39; % (pmcfg.part_chip_width, pmcfg.part_chip_height),</span>
    <span class="c1">#    ]</span>
    <span class="c1">#    cfgstr_list.append(pmcfg.colorspace)</span>
    <span class="c1">#    return &#39;,&#39;.join(cfgstr_list)</span>

<div class="viewcode-block" id="PartMatchDataConfig.get_data_shape"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.ingest_wbia.PartMatchDataConfig.get_data_shape">[docs]</a>    <span class="k">def</span> <span class="nf">get_data_shape</span><span class="p">(</span><span class="n">pmcfg</span><span class="p">):</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">pmcfg</span><span class="o">.</span><span class="n">colorspace</span> <span class="o">==</span> <span class="s1">&#39;gray&#39;</span> <span class="k">else</span> <span class="mi">3</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">pmcfg</span><span class="p">[</span><span class="s1">&#39;part_chip_height&#39;</span><span class="p">],</span> <span class="n">pmcfg</span><span class="p">[</span><span class="s1">&#39;part_chip_width&#39;</span><span class="p">],</span> <span class="n">channels</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="PatchMetricDataConfig"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.ingest_wbia.PatchMetricDataConfig">[docs]</a><span class="k">class</span> <span class="nc">PatchMetricDataConfig</span><span class="p">(</span><span class="n">dtool</span><span class="o">.</span><span class="n">Config</span><span class="p">):</span>
    <span class="n">_param_info_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="s1">&#39;patch_size&#39;</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="s1">&#39;colorspace&#39;</span><span class="p">,</span> <span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">valid_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="s1">&#39;bgr&#39;</span><span class="p">,</span> <span class="s1">&#39;lab&#39;</span><span class="p">]),</span>
    <span class="p">]</span>
    <span class="c1"># def __init__(pmcfg, **kwargs):</span>
    <span class="c1">#    #pmcfg.patch_size = 64</span>
    <span class="c1">#    #pmcfg.colorspace = &#39;bgr&#39;</span>
    <span class="c1">#    #pmcfg.colorspace = &#39;gray&#39;</span>
    <span class="c1">#    super(PatchMetricDataConfig, pmcfg).__init__(**kwargs)</span>
    <span class="c1"># def get_cfgstr(pmcfg):</span>
    <span class="c1">#    cfgstr_list = [</span>
    <span class="c1">#        &#39;patch_size=%d&#39; % (pmcfg.patch_size,),</span>
    <span class="c1">#    ]</span>
    <span class="c1">#    #if pmcfg.colorspace != &#39;bgr&#39;:</span>
    <span class="c1">#    cfgstr_list.append(pmcfg.colorspace)</span>
    <span class="c1">#    return &#39;,&#39;.join(cfgstr_list)</span>

<div class="viewcode-block" id="PatchMetricDataConfig.get_data_shape"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.ingest_wbia.PatchMetricDataConfig.get_data_shape">[docs]</a>    <span class="k">def</span> <span class="nf">get_data_shape</span><span class="p">(</span><span class="n">pmcfg</span><span class="p">):</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">pmcfg</span><span class="p">[</span><span class="s1">&#39;colorspace&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;gray&#39;</span> <span class="k">else</span> <span class="mi">3</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">pmcfg</span><span class="p">[</span><span class="s1">&#39;patch_size&#39;</span><span class="p">],</span> <span class="n">pmcfg</span><span class="p">[</span><span class="s1">&#39;patch_size&#39;</span><span class="p">],</span> <span class="n">channels</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="cached_part_match_training_data_fpaths"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.ingest_wbia.cached_part_match_training_data_fpaths">[docs]</a><span class="k">def</span> <span class="nf">cached_part_match_training_data_fpaths</span><span class="p">(</span>
    <span class="n">ibs</span><span class="p">,</span> <span class="n">aid_pairs</span><span class="p">,</span> <span class="n">label_list</span><span class="p">,</span> <span class="n">flat_metadata</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia_cnn --tf netrun --db PZ_MTEST \</span>
<span class="sd">                --acfg ctrl:pername=None,excluderef=False --ensuredata \</span>
<span class="sd">                --show --datatype=siam-part \</span>
<span class="sd">                --nocache-train --nocache-cnn</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">NOCACHE_TRAIN</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--nocache-train&#39;</span><span class="p">)</span>

    <span class="n">pmcfg</span> <span class="o">=</span> <span class="n">PartMatchDataConfig</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">data_shape</span> <span class="o">=</span> <span class="n">pmcfg</span><span class="o">.</span><span class="n">get_data_shape</span><span class="p">()</span>

    <span class="n">semantic_uuids1</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_semantic_uuids</span><span class="p">(</span><span class="n">aid_pairs</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">semantic_uuids2</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_semantic_uuids</span><span class="p">(</span><span class="n">aid_pairs</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">aidpair_hashstr_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">hashstr27</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="n">semantic_uuids1</span><span class="p">,</span> <span class="n">semantic_uuids2</span><span class="p">)))</span>
    <span class="n">training_dname</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">hashstr_arr27</span><span class="p">(</span>
        <span class="n">aidpair_hashstr_list</span><span class="p">,</span> <span class="n">pathsafe</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lbl</span><span class="o">=</span><span class="s1">&#39;part_match&#39;</span>
    <span class="p">)</span>

    <span class="n">nets_dir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_neuralnet_dir</span><span class="p">()</span>
    <span class="n">training_dpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unixjoin</span><span class="p">(</span><span class="n">nets_dir</span><span class="p">,</span> <span class="n">training_dname</span><span class="p">)</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">nets_dir</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">training_dpath</span><span class="p">)</span>
    <span class="n">view_train_dir</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--vtd&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">view_train_dir</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">view_directory</span><span class="p">(</span><span class="n">training_dpath</span><span class="p">)</span>

    <span class="n">cfgstr</span> <span class="o">=</span> <span class="n">pmcfg</span><span class="o">.</span><span class="n">get_cfgstr</span><span class="p">()</span>
    <span class="n">data_fpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unixjoin</span><span class="p">(</span><span class="n">training_dpath</span><span class="p">,</span> <span class="s1">&#39;data_&#39;</span> <span class="o">+</span> <span class="n">cfgstr</span> <span class="o">+</span> <span class="s1">&#39;.hdf5&#39;</span><span class="p">)</span>
    <span class="n">labels_fpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unixjoin</span><span class="p">(</span><span class="n">training_dpath</span><span class="p">,</span> <span class="s1">&#39;labels_&#39;</span> <span class="o">+</span> <span class="n">cfgstr</span> <span class="o">+</span> <span class="s1">&#39;.hdf5&#39;</span><span class="p">)</span>
    <span class="n">metadata_fpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unixjoin</span><span class="p">(</span><span class="n">training_dpath</span><span class="p">,</span> <span class="s1">&#39;metadata_&#39;</span> <span class="o">+</span> <span class="n">cfgstr</span> <span class="o">+</span> <span class="s1">&#39;.hdf5&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">NOCACHE_TRAIN</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">checkpath</span><span class="p">(</span><span class="n">data_fpath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">checkpath</span><span class="p">(</span><span class="n">labels_fpath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">checkpath</span><span class="p">(</span><span class="n">metadata_fpath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="n">estimate_data_bytes</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aid_pairs</span><span class="p">),</span> <span class="n">pmcfg</span><span class="o">.</span><span class="n">get_data_shape</span><span class="p">())</span>
        <span class="c1"># Extract the data and labels</span>
        <span class="n">rchip1_list</span><span class="p">,</span> <span class="n">rchip2_list</span> <span class="o">=</span> <span class="n">extract_annotpair_training_chips</span><span class="p">(</span>
            <span class="n">ibs</span><span class="p">,</span> <span class="n">aid_pairs</span><span class="p">,</span> <span class="o">**</span><span class="n">pmcfg</span>
        <span class="p">)</span>

        <span class="n">datagen_</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rchip1_list</span><span class="p">,</span> <span class="n">rchip2_list</span><span class="p">)</span>
        <span class="n">datagen</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgIter</span><span class="p">(</span>
            <span class="n">datagen_</span><span class="p">,</span> <span class="n">nTotal</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">rchip1_list</span><span class="p">),</span> <span class="n">lbl</span><span class="o">=</span><span class="s1">&#39;Evaluating&#39;</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">datagen</span><span class="p">)))</span>

        <span class="n">flat_metadata</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">map_dict_vals</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">flat_metadata</span><span class="p">)</span>

        <span class="c1"># img_list = ut.flatten(list(zip(rchip1_list,</span>
        <span class="c1">#                               rchip2_list)))</span>
        <span class="c1"># data = np.array(img_list)</span>
        <span class="c1"># del img_list</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">label_list</span>
        <span class="c1"># data_per_label = 2</span>
        <span class="k">assert</span> <span class="n">labels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="c1"># data, labels, flat_metadata</span>
        <span class="c1"># Save the data to cache</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">assert_eq</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pmcfg</span><span class="p">[</span><span class="s1">&#39;part_chip_height&#39;</span><span class="p">])</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">assert_eq</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">pmcfg</span><span class="p">[</span><span class="s1">&#39;part_chip_width&#39;</span><span class="p">])</span>
        <span class="c1"># TODO; save metadata</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[write_part_data] np.shape(data) = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">data</span><span class="p">),))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[write_part_labels] np.shape(labels) = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">labels</span><span class="p">),))</span>
        <span class="c1"># TODO hdf5 for large data</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">save_hdf5</span><span class="p">(</span><span class="n">data_fpath</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">save_hdf5</span><span class="p">(</span><span class="n">labels_fpath</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">save_hdf5</span><span class="p">(</span><span class="n">metadata_fpath</span><span class="p">,</span> <span class="n">flat_metadata</span><span class="p">)</span>
        <span class="c1"># ut.save_cPkl(data_fpath, data)</span>
        <span class="c1"># ut.save_cPkl(labels_fpath, labels)</span>
        <span class="c1"># ut.save_cPkl(metadata_fpath, flat_metadata)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;data and labels cache hit&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data_fpath</span><span class="p">,</span> <span class="n">labels_fpath</span><span class="p">,</span> <span class="n">metadata_fpath</span><span class="p">,</span> <span class="n">training_dpath</span><span class="p">,</span> <span class="n">data_shape</span></div>


<div class="viewcode-block" id="cached_patchmetric_training_data_fpaths"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.ingest_wbia.cached_patchmetric_training_data_fpaths">[docs]</a><span class="k">def</span> <span class="nf">cached_patchmetric_training_data_fpaths</span><span class="p">(</span>
    <span class="n">ibs</span><span class="p">,</span>
    <span class="n">aid1_list</span><span class="p">,</span>
    <span class="n">aid2_list</span><span class="p">,</span>
    <span class="n">kpts1_m_list</span><span class="p">,</span>
    <span class="n">kpts2_m_list</span><span class="p">,</span>
    <span class="n">fm_list</span><span class="p">,</span>
    <span class="n">metadata_lists</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    todo use size in cfgstrings</span>
<span class="sd">    kwargs is used for PatchMetricDataConfig</span>

<span class="sd">    from wbia_cnn.ingest_wbia import *</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>

    <span class="n">pmcfg</span> <span class="o">=</span> <span class="n">PatchMetricDataConfig</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">data_shape</span> <span class="o">=</span> <span class="n">pmcfg</span><span class="o">.</span><span class="n">get_data_shape</span><span class="p">()</span>

    <span class="n">NOCACHE_TRAIN</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">((</span><span class="s1">&#39;--nocache-train&#39;</span><span class="p">,</span> <span class="s1">&#39;--nocache-cnn&#39;</span><span class="p">))</span>

    <span class="n">semantic_uuids1</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_semantic_uuids</span><span class="p">(</span><span class="n">aid1_list</span><span class="p">)</span>
    <span class="n">semantic_uuids2</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_semantic_uuids</span><span class="p">(</span><span class="n">aid2_list</span><span class="p">)</span>
    <span class="n">aidpair_hashstr_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">hashstr27</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="n">semantic_uuids1</span><span class="p">,</span> <span class="n">semantic_uuids2</span><span class="p">)))</span>
    <span class="n">training_dname</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">hashstr_arr27</span><span class="p">(</span>
        <span class="n">aidpair_hashstr_list</span><span class="p">,</span> <span class="n">pathsafe</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lbl</span><span class="o">=</span><span class="s1">&#39;patchmatch&#39;</span>
    <span class="p">)</span>

    <span class="n">nets_dir</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_neuralnet_dir</span><span class="p">()</span>
    <span class="n">training_dpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unixjoin</span><span class="p">(</span><span class="n">nets_dir</span><span class="p">,</span> <span class="n">training_dname</span><span class="p">)</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">nets_dir</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">training_dpath</span><span class="p">)</span>
    <span class="n">view_train_dir</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_argflag</span><span class="p">(</span><span class="s1">&#39;--vtd&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">view_train_dir</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">view_directory</span><span class="p">(</span><span class="n">training_dpath</span><span class="p">)</span>

    <span class="n">fm_hashstr</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">hashstr_arr27</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">fm_list</span><span class="p">),</span> <span class="n">pathsafe</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lbl</span><span class="o">=</span><span class="s1">&#39;fm&#39;</span><span class="p">)</span>
    <span class="n">cfgstr</span> <span class="o">=</span> <span class="n">fm_hashstr</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">pmcfg</span><span class="o">.</span><span class="n">get_cfgstr</span><span class="p">()</span>
    <span class="n">data_fpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unixjoin</span><span class="p">(</span><span class="n">training_dpath</span><span class="p">,</span> <span class="s1">&#39;data_</span><span class="si">%s</span><span class="s1">.hdf5&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cfgstr</span><span class="p">,))</span>
    <span class="n">labels_fpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unixjoin</span><span class="p">(</span><span class="n">training_dpath</span><span class="p">,</span> <span class="s1">&#39;labels_</span><span class="si">%s</span><span class="s1">.hdf5&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cfgstr</span><span class="p">,))</span>
    <span class="n">metadata_fpath</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unixjoin</span><span class="p">(</span><span class="n">training_dpath</span><span class="p">,</span> <span class="s1">&#39;metadata_</span><span class="si">%s</span><span class="s1">.hdf5&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cfgstr</span><span class="p">,))</span>

    <span class="k">if</span> <span class="n">NOCACHE_TRAIN</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">checkpath</span><span class="p">(</span><span class="n">data_fpath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">checkpath</span><span class="p">(</span><span class="n">labels_fpath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">ut</span><span class="o">.</span><span class="n">checkpath</span><span class="p">(</span><span class="n">metadata_fpath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="n">estimate_data_bytes</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">fm_list</span><span class="p">))),</span> <span class="n">pmcfg</span><span class="o">.</span><span class="n">get_data_shape</span><span class="p">())</span>
        <span class="c1"># Extract the data and labels</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">flat_metadata</span> <span class="o">=</span> <span class="n">get_patchmetric_training_data_and_labels</span><span class="p">(</span>
            <span class="n">ibs</span><span class="p">,</span>
            <span class="n">aid1_list</span><span class="p">,</span>
            <span class="n">aid2_list</span><span class="p">,</span>
            <span class="n">kpts1_m_list</span><span class="p">,</span>
            <span class="n">kpts2_m_list</span><span class="p">,</span>
            <span class="n">fm_list</span><span class="p">,</span>
            <span class="n">metadata_lists</span><span class="p">,</span>
            <span class="o">**</span><span class="n">pmcfg</span>
        <span class="p">)</span>
        <span class="c1"># Save the data to cache</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">assert_eq</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pmcfg</span><span class="p">[</span><span class="s1">&#39;patch_size&#39;</span><span class="p">])</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">assert_eq</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">pmcfg</span><span class="p">[</span><span class="s1">&#39;patch_size&#39;</span><span class="p">])</span>
        <span class="c1"># TODO; save metadata</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[write_data_and_labels] np.shape(data) = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">data</span><span class="p">),))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[write_data_and_labels] np.shape(labels) = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">labels</span><span class="p">),))</span>
        <span class="c1"># TODO hdf5 for large data</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">save_hdf5</span><span class="p">(</span><span class="n">data_fpath</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">save_hdf5</span><span class="p">(</span><span class="n">labels_fpath</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">save_hdf5</span><span class="p">(</span><span class="n">metadata_fpath</span><span class="p">,</span> <span class="n">flat_metadata</span><span class="p">)</span>
        <span class="c1"># ut.save_cPkl(data_fpath, data)</span>
        <span class="c1"># ut.save_cPkl(labels_fpath, labels)</span>
        <span class="c1"># ut.save_cPkl(metadata_fpath, flat_metadata)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;data and labels cache hit&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data_fpath</span><span class="p">,</span> <span class="n">labels_fpath</span><span class="p">,</span> <span class="n">metadata_fpath</span><span class="p">,</span> <span class="n">training_dpath</span><span class="p">,</span> <span class="n">data_shape</span></div>


<div class="viewcode-block" id="remove_unknown_training_pairs"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.ingest_wbia.remove_unknown_training_pairs">[docs]</a><span class="k">def</span> <span class="nf">remove_unknown_training_pairs</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid1_list</span><span class="p">,</span> <span class="n">aid2_list</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">aid1_list</span><span class="p">,</span> <span class="n">aid2_list</span></div>


<div class="viewcode-block" id="get_aidpairs_and_matches"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.ingest_wbia.get_aidpairs_and_matches">[docs]</a><span class="k">def</span> <span class="nf">get_aidpairs_and_matches</span><span class="p">(</span>
    <span class="n">ibs</span><span class="p">,</span>
    <span class="n">max_examples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">num_top</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">controlled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">min_featweight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">acfg_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets data for training a patch match network.</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        max_examples (None): (default = None)</span>
<span class="sd">        num_top (int): (default = 3)</span>
<span class="sd">        controlled (bool): (default = True)</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple : patchmatch_tup = (aid1_list, aid2_list, kpts1_m_list,</span>
<span class="sd">        kpts2_m_list, fm_list, metadata_lists)</span>
<span class="sd">        aid pairs and matching keypoint pairs as well as the original index</span>
<span class="sd">        of the feature matches</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia_cnn.ingest_wbia get_aidpairs_and_matches --show</span>
<span class="sd">        python -m wbia_cnn.ingest_wbia --test-get_aidpairs_and_matches --db PZ_Master0</span>
<span class="sd">        python -m wbia_cnn.ingest_wbia --test-get_aidpairs_and_matches --db PZ_Master1 --acfg default --show</span>
<span class="sd">        python -m wbia_cnn.ingest_wbia --test-get_aidpairs_and_matches --db PZ_MTEST --acfg ctrl:qindex=0:10 --show</span>
<span class="sd">        python -m wbia_cnn.ingest_wbia --test-get_aidpairs_and_matches --db NNP_Master3</span>

<span class="sd">        python -m wbia_cnn.ingest_wbia --test-get_aidpairs_and_matches --db PZ_MTEST \</span>
<span class="sd">        --acfg default:is_known=True,qmin_pername=2,view=primary,species=primary,minqual=ok --show</span>

<span class="sd">        python -m wbia_cnn.ingest_wbia --test-get_aidpairs_and_matches --db PZ_Master1 \</span>
<span class="sd">        --acfg default:is_known=True,qmin_pername=2,view=primary,species=primary,minqual=ok --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn.ingest_wbia import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import wbia</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = wbia.opendb(defaultdb=&#39;PZ_MTEST&#39;, allow_newdir=True)</span>
<span class="sd">        &gt;&gt;&gt; acfg_name = ut.get_argval((&#39;--aidcfg&#39;, &#39;--acfg&#39;, &#39;-a&#39;, &#39;--acfg-name&#39;),</span>
<span class="sd">        &gt;&gt;&gt;                             type_=str,</span>
<span class="sd">        &gt;&gt;&gt;                             default=&#39;ctrl:qindex=0:10&#39;)</span>
<span class="sd">        &gt;&gt;&gt; max_examples = None</span>
<span class="sd">        &gt;&gt;&gt; num_top = None</span>
<span class="sd">        &gt;&gt;&gt; controlled = True</span>
<span class="sd">        &gt;&gt;&gt; min_featweight = .99</span>
<span class="sd">        &gt;&gt;&gt; patchmatch_tup = get_aidpairs_and_matches(</span>
<span class="sd">        &gt;&gt;&gt;     ibs, max_examples=max_examples, num_top=num_top,</span>
<span class="sd">        &gt;&gt;&gt;     controlled=controlled, min_featweight=min_featweight,</span>
<span class="sd">        &gt;&gt;&gt;     acfg_name=acfg_name)</span>
<span class="sd">        &gt;&gt;&gt; (aid1_list, aid2_list, kpts1_m_list, kpts2_m_list, fm_list, metadata_lists) = patchmatch_tup</span>
<span class="sd">        &gt;&gt;&gt; ut.quit_if_noshow()</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;Visualizing&#39;)</span>
<span class="sd">        &gt;&gt;&gt; # Visualize feature scores</span>
<span class="sd">        &gt;&gt;&gt; tup = flatten_patch_data(</span>
<span class="sd">        &gt;&gt;&gt;     ibs, aid1_list, aid2_list, kpts1_m_list, kpts2_m_list, fm_list,</span>
<span class="sd">        &gt;&gt;&gt;     metadata_lists)</span>
<span class="sd">        &gt;&gt;&gt; labels, flat_metadata = tup[2:]</span>
<span class="sd">        &gt;&gt;&gt; fs = flat_metadata[&#39;fs&#39;]</span>
<span class="sd">        &gt;&gt;&gt; encoder = vt.ScoreNormalizer(adjust=1)</span>
<span class="sd">        &gt;&gt;&gt; encoder.fit(fs, labels)</span>
<span class="sd">        &gt;&gt;&gt; encoder.visualize(bin_width=.001, fnum=None)</span>
<span class="sd">        &gt;&gt;&gt; # Visualize parent matches</span>
<span class="sd">        &gt;&gt;&gt; _iter = list(zip(aid1_list, aid2_list, kpts1_m_list, kpts2_m_list, fm_list))</span>
<span class="sd">        &gt;&gt;&gt; _iter = ut.InteractiveIter(_iter, display_item=False)</span>
<span class="sd">        &gt;&gt;&gt; from wbia import plottool as pt</span>
<span class="sd">        &gt;&gt;&gt; import wbia.viz</span>
<span class="sd">        &gt;&gt;&gt; for aid1, aid2, kpts1, kpts2, fm in _iter:</span>
<span class="sd">        &gt;&gt;&gt;     pt.reset()</span>
<span class="sd">        &gt;&gt;&gt;     print(&#39;aid2 = %r&#39; % (aid2,))</span>
<span class="sd">        &gt;&gt;&gt;     print(&#39;aid1 = %r&#39; % (aid1,))</span>
<span class="sd">        &gt;&gt;&gt;     print(&#39;len(fm) = %r&#39; % (len(fm),))</span>
<span class="sd">        &gt;&gt;&gt;     wbia.viz.viz_matches.show_matches2(ibs, aid1, aid2, fm=None, kpts1=kpts1, kpts2=kpts2)</span>
<span class="sd">        &gt;&gt;&gt;     pt.update()</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">get_query_results</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">acfg_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;NEW WAY OF FILTERING&#39;</span><span class="p">)</span>
            <span class="kn">from</span> <span class="nn">wbia.expt</span> <span class="kn">import</span> <span class="n">experiment_helpers</span>

            <span class="n">acfg_list</span><span class="p">,</span> <span class="n">expanded_aids_list</span> <span class="o">=</span> <span class="n">experiment_helpers</span><span class="o">.</span><span class="n">get_annotcfg_list</span><span class="p">(</span>
                <span class="n">ibs</span><span class="p">,</span> <span class="p">[</span><span class="n">acfg_name</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="c1"># acfg = acfg_list[0]</span>
            <span class="n">expanded_aids</span> <span class="o">=</span> <span class="n">expanded_aids_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">qaid_list</span><span class="p">,</span> <span class="n">daid_list</span> <span class="o">=</span> <span class="n">expanded_aids</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;OLD WAY OF FILTERING&#39;</span><span class="p">)</span>
            <span class="kn">from</span> <span class="nn">wbia.other</span> <span class="kn">import</span> <span class="n">ibsfuncs</span>

            <span class="k">if</span> <span class="n">controlled</span><span class="p">:</span>
                <span class="c1"># TODO: use acfg config</span>
                <span class="n">qaid_list</span> <span class="o">=</span> <span class="n">ibsfuncs</span><span class="o">.</span><span class="n">get_two_annots_per_name_and_singletons</span><span class="p">(</span>
                    <span class="n">ibs</span><span class="p">,</span> <span class="n">onlygt</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="n">daid_list</span> <span class="o">=</span> <span class="n">ibsfuncs</span><span class="o">.</span><span class="n">get_two_annots_per_name_and_singletons</span><span class="p">(</span>
                    <span class="n">ibs</span><span class="p">,</span> <span class="n">onlygt</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">qaid_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_valid_aids</span><span class="p">()</span>
                <span class="c1"># from wbia.algo.hots import chip_match</span>
                <span class="n">qaid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span>
                    <span class="n">qaid_list</span><span class="p">,</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_has_groundtruth</span><span class="p">(</span><span class="n">qaid_list</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">daid_list</span> <span class="o">=</span> <span class="n">qaid_list</span>
                <span class="k">if</span> <span class="n">max_examples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">daid_list</span> <span class="o">=</span> <span class="n">daid_list</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_examples</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">daid_list</span><span class="p">))]</span>

        <span class="k">if</span> <span class="n">max_examples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">qaid_list</span> <span class="o">=</span> <span class="n">qaid_list</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_examples</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">qaid_list</span><span class="p">))]</span>

        <span class="n">cfgdict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;affine_invariance&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;fg_on&#39;</span><span class="p">:</span> <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">WIN32</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">print_annotconfig_stats</span><span class="p">(</span><span class="n">qaid_list</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">,</span> <span class="n">bigstr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">qreq_</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">new_query_request</span><span class="p">(</span><span class="n">qaid_list</span><span class="p">,</span> <span class="n">daid_list</span><span class="p">,</span> <span class="n">cfgdict</span><span class="o">=</span><span class="n">cfgdict</span><span class="p">)</span>
        <span class="n">cm_list</span> <span class="o">=</span> <span class="n">qreq_</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">cm_list</span><span class="p">,</span> <span class="n">qreq_</span>

    <span class="n">cm_list</span><span class="p">,</span> <span class="n">qreq_</span> <span class="o">=</span> <span class="n">get_query_results</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_matchdata1</span><span class="p">():</span>
        <span class="c1"># TODO: rectify with code in viz_nearest_descriptors to compute the flat lists</span>
        <span class="c1"># Get aid pairs and feature matches</span>
        <span class="k">if</span> <span class="n">num_top</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">aids2_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">cm</span><span class="o">.</span><span class="n">get_top_aids</span><span class="p">()</span> <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">cm_list</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aids2_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">cm</span><span class="o">.</span><span class="n">get_top_aids</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="n">num_top</span><span class="p">]</span> <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">cm_list</span><span class="p">]</span>
        <span class="n">aids1_list</span> <span class="o">=</span> <span class="p">[[</span><span class="n">cm</span><span class="o">.</span><span class="n">qaid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">aids2</span><span class="p">)</span> <span class="k">for</span> <span class="n">cm</span><span class="p">,</span> <span class="n">aids2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cm_list</span><span class="p">,</span> <span class="n">aids2_list</span><span class="p">)]</span>
        <span class="n">aid1_list_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">aids1_list</span><span class="p">))</span>
        <span class="n">aid2_list_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">aids2_list</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">take_qres_list_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
            <span class="n">attrs_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">dict_take</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span> <span class="n">aids2</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">cm</span><span class="p">,</span> <span class="n">aids2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cm_list</span><span class="p">,</span> <span class="n">aids2_list</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">attr_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">attrs_list</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">attr_list</span>

        <span class="n">fm_list_all</span> <span class="o">=</span> <span class="n">take_qres_list_attr</span><span class="p">(</span><span class="n">attr</span><span class="o">=</span><span class="s1">&#39;aid2_fm&#39;</span><span class="p">)</span>
        <span class="n">metadata_all</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">filtkey_lists</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unique_unordered</span><span class="p">([</span><span class="nb">tuple</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">filtkey_list</span><span class="p">)</span> <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">cm_list</span><span class="p">])</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtkey_lists</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;multiple fitlers used in this query&#39;</span>
        <span class="n">filtkey_list</span> <span class="o">=</span> <span class="n">filtkey_lists</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fsv_list</span> <span class="o">=</span> <span class="n">take_qres_list_attr</span><span class="p">(</span><span class="s1">&#39;aid2_fsv&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filtkey_list</span><span class="p">):</span>
            <span class="n">metadata_all</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fsv</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">fsv</span> <span class="ow">in</span> <span class="n">fsv_list</span><span class="p">]</span>
        <span class="n">metadata_all</span><span class="p">[</span><span class="s1">&#39;fs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">take_qres_list_attr</span><span class="p">(</span><span class="s1">&#39;aid2_fs&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">neg_aid_pool</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">([</span><span class="n">aid1_list_all</span><span class="p">,</span> <span class="n">aid2_list_all</span><span class="p">]))</span>
            <span class="n">randneg_aid1</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">randneg_aid2</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">randneg_fm</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rand_meta</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">metadata_all</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
            <span class="n">neg_nid_pool</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_nids</span><span class="p">(</span><span class="n">neg_aid_pool</span><span class="p">))</span>
            <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">num_rand_neg_per_aid</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">num_rand_fm</span> <span class="o">=</span> <span class="mi">30</span>
            <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgIter</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">neg_aid_pool</span><span class="p">,</span> <span class="n">neg_nid_pool</span><span class="p">)),</span> <span class="s1">&#39;sample aid rand&#39;</span>
            <span class="p">):</span>
                <span class="c1"># is_valid = get_badtag_flags(ibs, [aid] * len(neg_aid_pool), neg_aid_pool)</span>
                <span class="n">is_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">not_equal</span><span class="p">(</span><span class="n">neg_nid_pool</span><span class="p">,</span> <span class="n">nid</span><span class="p">)</span>
                <span class="c1"># is_valid = np.logical_and(, is_valid)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">is_valid</span> <span class="o">/</span> <span class="p">(</span><span class="n">is_valid</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
                <span class="n">chosen</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
                    <span class="n">neg_aid_pool</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_rand_neg_per_aid</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span>
                <span class="p">)</span>
                <span class="c1"># chosen_pairs = list(ut.iprod([aid], chosen))</span>
                <span class="n">randneg_aid1</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">aid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">chosen</span><span class="p">))</span>
                <span class="n">randneg_aid2</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">chosen</span><span class="p">)</span>

            <span class="n">neg_fws1</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_fgweights</span><span class="p">(</span>
                <span class="n">randneg_aid1</span><span class="p">,</span> <span class="n">config2_</span><span class="o">=</span><span class="n">qreq_</span><span class="o">.</span><span class="n">get_internal_query_config2</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">neg_fws2</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_fgweights</span><span class="p">(</span>
                <span class="n">randneg_aid2</span><span class="p">,</span> <span class="n">config2_</span><span class="o">=</span><span class="n">qreq_</span><span class="o">.</span><span class="n">get_internal_data_config2</span><span class="p">()</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">fw1</span><span class="p">,</span> <span class="n">fw2</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgIter</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">neg_fws1</span><span class="p">,</span> <span class="n">neg_fws2</span><span class="p">)),</span> <span class="s1">&#39;sample fm rand&#39;</span><span class="p">):</span>
                <span class="n">valid_fx1s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fw1</span> <span class="o">&gt;</span> <span class="n">min_featweight</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valid_fx2s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fw2</span> <span class="o">&gt;</span> <span class="n">min_featweight</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">num_rand_fm</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_fx1s</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_fx2s</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">chosen_fx1</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">valid_fx1s</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">chosen_fx2</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">valid_fx2s</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">fm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">chosen_fx1</span><span class="p">,</span> <span class="n">chosen_fx2</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
                <span class="n">randneg_fm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fm</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">rand_meta</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">rand_meta</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">fm</span><span class="p">)))</span>

            <span class="n">prev_total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">fm_list_all</span><span class="p">))</span>
            <span class="n">adding</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">randneg_fm</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;prev_total = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prev_total</span><span class="p">,))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;adding     = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">adding</span><span class="p">,))</span>

            <span class="n">metadata_all</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_isect_combine</span><span class="p">(</span><span class="n">metadata_all</span><span class="p">,</span> <span class="n">rand_meta</span><span class="p">)</span>
            <span class="n">fm_list_all</span> <span class="o">=</span> <span class="n">fm_list_all</span> <span class="o">+</span> <span class="n">randneg_fm</span>
            <span class="n">aid1_list_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aid1_list_all</span><span class="p">,</span> <span class="n">randneg_aid1</span><span class="p">)</span>
            <span class="n">aid2_list_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aid2_list_all</span><span class="p">,</span> <span class="n">randneg_aid2</span><span class="p">)</span>

        <span class="c1"># extract metadata (like feature scores and whatnot)</span>
        <span class="k">return</span> <span class="n">aid1_list_all</span><span class="p">,</span> <span class="n">aid2_list_all</span><span class="p">,</span> <span class="n">fm_list_all</span><span class="p">,</span> <span class="n">metadata_all</span>

    <span class="k">def</span> <span class="nf">get_badtag_flags</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid1_list</span><span class="p">,</span> <span class="n">aid2_list</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">wbia</span> <span class="kn">import</span> <span class="n">tag_funcs</span>

        <span class="n">tag_filter_kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">has_none</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;photobomb&#39;</span><span class="p">,</span> <span class="s1">&#39;scenerymatch&#39;</span><span class="p">,</span> <span class="s1">&#39;joincase&#39;</span><span class="p">,</span> <span class="s1">&#39;splitcase&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">am_rowids1</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annotmatch_rowid_from_undirected_superkey</span><span class="p">(</span>
            <span class="n">aid1_list</span><span class="p">,</span> <span class="n">aid2_list</span>
        <span class="p">)</span>
        <span class="n">am_rowids2</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annotmatch_rowid_from_undirected_superkey</span><span class="p">(</span>
            <span class="n">aid2_list</span><span class="p">,</span> <span class="n">aid1_list</span>
        <span class="p">)</span>
        <span class="n">case_tags1</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annotmatch_case_tags</span><span class="p">(</span><span class="n">am_rowids1</span><span class="p">)</span>
        <span class="n">case_tags2</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annotmatch_case_tags</span><span class="p">(</span><span class="n">am_rowids2</span><span class="p">)</span>
        <span class="n">flags1</span> <span class="o">=</span> <span class="n">tag_funcs</span><span class="o">.</span><span class="n">filterflags_general_tags</span><span class="p">(</span><span class="n">case_tags1</span><span class="p">,</span> <span class="o">**</span><span class="n">tag_filter_kw</span><span class="p">)</span>
        <span class="n">flags2</span> <span class="o">=</span> <span class="n">tag_funcs</span><span class="o">.</span><span class="n">filterflags_general_tags</span><span class="p">(</span><span class="n">case_tags2</span><span class="p">,</span> <span class="o">**</span><span class="n">tag_filter_kw</span><span class="p">)</span>
        <span class="n">flags_tag</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">and_lists</span><span class="p">(</span><span class="n">flags1</span><span class="p">,</span> <span class="n">flags2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">flags_tag</span>

    <span class="k">def</span> <span class="nf">get_matchdata2</span><span class="p">():</span>
        <span class="n">aid1_list_all</span><span class="p">,</span> <span class="n">aid2_list_all</span><span class="p">,</span> <span class="n">fm_list_all</span><span class="p">,</span> <span class="n">metadata_all</span> <span class="o">=</span> <span class="n">get_matchdata1</span><span class="p">()</span>
        <span class="c1"># Filter out bad training examples</span>
        <span class="c1"># (we are currently in annot-vs-annot format, not yet in patch-vs-patch)</span>
        <span class="n">labels_all</span> <span class="o">=</span> <span class="n">get_aidpair_training_labels</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid1_list_all</span><span class="p">,</span> <span class="n">aid2_list_all</span><span class="p">)</span>
        <span class="n">has_gt</span> <span class="o">=</span> <span class="n">labels_all</span> <span class="o">!=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">REVIEW</span><span class="o">.</span><span class="n">UNKNOWN</span>
        <span class="n">nonempty</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">fm</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">fm</span> <span class="ow">in</span> <span class="n">fm_list_all</span><span class="p">]</span>
        <span class="c1"># Filter pairs bad pairs of aids</span>
        <span class="c1"># using case tags</span>

        <span class="n">flags_tag</span> <span class="o">=</span> <span class="n">get_badtag_flags</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">aid1_list_all</span><span class="p">,</span> <span class="n">aid2_list_all</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">filtered_infostr</span><span class="p">(</span><span class="n">flags_tag</span><span class="p">,</span> <span class="s1">&#39;annots&#39;</span><span class="p">,</span> <span class="s1">&#39;tag filters&#39;</span><span class="p">))</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">and_lists</span><span class="p">(</span><span class="n">flags_tag</span><span class="p">,</span> <span class="n">flags_tag</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="n">MIN_TD</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span>  <span class="c1"># 5 minutes at least</span>
        <span class="n">timedelta_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_pair_timdelta</span><span class="p">(</span><span class="n">aid1_list_all</span><span class="p">,</span> <span class="n">aid2_list_all</span><span class="p">))</span>
        <span class="c1"># isnan = np.isnan(timedelta_list)</span>
        <span class="n">gf_tdflags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
            <span class="n">labels_all</span> <span class="o">==</span> <span class="n">ibs</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">REVIEW</span><span class="o">.</span><span class="n">MATCH</span><span class="p">,</span> <span class="n">timedelta_list</span> <span class="o">&gt;</span> <span class="n">MIN_TD</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">filtered_infostr</span><span class="p">(</span><span class="n">gf_tdflags</span><span class="p">,</span> <span class="s1">&#39;gf annots&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">))</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">and_lists</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">gf_tdflags</span><span class="p">)</span>
        <span class="c1"># Remove small time deltas</span>
        <span class="c1"># --</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">filtered_infostr</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="s1">&#39;total invalid annots&#39;</span><span class="p">))</span>
        <span class="n">isvalid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">has_gt</span><span class="p">,</span> <span class="n">nonempty</span><span class="p">),</span> <span class="n">flags</span><span class="p">)</span>
        <span class="n">aid1_list_uneq</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">aid1_list_all</span><span class="p">,</span> <span class="n">isvalid</span><span class="p">)</span>
        <span class="n">aid2_list_uneq</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">aid2_list_all</span><span class="p">,</span> <span class="n">isvalid</span><span class="p">)</span>
        <span class="n">labels_uneq</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">labels_all</span><span class="p">,</span> <span class="n">isvalid</span><span class="p">)</span>
        <span class="n">fm_list_uneq</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">fm_list_all</span><span class="p">,</span> <span class="n">isvalid</span><span class="p">)</span>
        <span class="n">metadata_uneq</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">isvalid</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">metadata_all</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">aid1_list_uneq</span><span class="p">,</span> <span class="n">aid2_list_uneq</span><span class="p">,</span> <span class="n">labels_uneq</span><span class="p">,</span> <span class="n">fm_list_uneq</span><span class="p">,</span> <span class="n">metadata_uneq</span>

    <span class="k">def</span> <span class="nf">get_matchdata3</span><span class="p">():</span>
        <span class="c1"># Filters in place</span>
        <span class="p">(</span>
            <span class="n">aid1_list_uneq</span><span class="p">,</span>
            <span class="n">aid2_list_uneq</span><span class="p">,</span>
            <span class="n">labels_uneq</span><span class="p">,</span>
            <span class="n">fm_list_uneq</span><span class="p">,</span>
            <span class="n">metadata_uneq</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">get_matchdata2</span><span class="p">()</span>

        <span class="c1"># min_featweight = None</span>
        <span class="k">if</span> <span class="n">min_featweight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;filter by featweight&#39;</span><span class="p">)</span>
            <span class="c1"># Remove feature matches where the foreground weight is under a threshold</span>
            <span class="n">flags_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">ut</span><span class="o">.</span><span class="n">ProgIter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aid1_list_uneq</span><span class="p">)),</span> <span class="s1">&#39;filt fw&#39;</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">aid1</span> <span class="o">=</span> <span class="n">aid1_list_uneq</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="n">aid2</span> <span class="o">=</span> <span class="n">aid2_list_uneq</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="n">fm</span> <span class="o">=</span> <span class="n">fm_list_uneq</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="n">fgweight1</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_fgweights</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">aid1</span><span class="p">],</span> <span class="n">config2_</span><span class="o">=</span><span class="n">qreq_</span><span class="o">.</span><span class="n">get_internal_query_config2</span><span class="p">()</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="n">fm</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">fgweight2</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_fgweights</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">aid2</span><span class="p">],</span> <span class="n">config2_</span><span class="o">=</span><span class="n">qreq_</span><span class="o">.</span><span class="n">get_internal_data_config2</span><span class="p">()</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="n">fm</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">flags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">fgweight1</span> <span class="o">&gt;</span> <span class="n">min_featweight</span><span class="p">,</span> <span class="n">fgweight2</span> <span class="o">&gt;</span> <span class="n">min_featweight</span>
                <span class="p">)</span>
                <span class="n">flags_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="n">ut</span><span class="o">.</span><span class="n">filtered_infostr</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">flags_list</span><span class="p">),</span> <span class="s1">&#39;feat matches&#39;</span><span class="p">,</span> <span class="s1">&#39;featweight&#39;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">fm_list_uneq2</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">zipcompress_safe</span><span class="p">(</span><span class="n">fm_list_uneq</span><span class="p">,</span> <span class="n">flags_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">metadata_uneq2</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="n">vt</span><span class="o">.</span><span class="n">zipcompress_safe</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">flags_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">metadata_uneq</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fm_list_uneq2</span> <span class="o">=</span> <span class="n">fm_list_uneq</span>
            <span class="n">metadata_uneq2</span> <span class="o">=</span> <span class="n">metadata_uneq</span>

        <span class="k">return</span> <span class="n">aid1_list_uneq</span><span class="p">,</span> <span class="n">aid2_list_uneq</span><span class="p">,</span> <span class="n">labels_uneq</span><span class="p">,</span> <span class="n">fm_list_uneq2</span><span class="p">,</span> <span class="n">metadata_uneq2</span>

    <span class="k">def</span> <span class="nf">equalize_flat_flags</span><span class="p">(</span><span class="n">flat_labels</span><span class="p">,</span> <span class="n">flat_scores</span><span class="p">):</span>
        <span class="n">labelhist</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_hist</span><span class="p">(</span><span class="n">flat_labels</span><span class="p">)</span>
        <span class="c1"># Print input distribution of labels</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;[ingest_wbia] original label histogram = </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_str</span><span class="p">(</span><span class="n">labelhist</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[ingest_wbia] total = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">labelhist</span><span class="o">.</span><span class="n">values</span><span class="p">()))))</span>

        <span class="n">pref_method</span> <span class="o">=</span> <span class="s1">&#39;rand&#39;</span>
        <span class="c1"># pref_method = &#39;scores&#39;</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">pref_rand</span><span class="p">(</span><span class="n">type_indicies</span><span class="p">,</span> <span class="n">min_</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">type_indicies</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">min_</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">pref_first</span><span class="p">(</span><span class="n">type_indicies</span><span class="p">,</span> <span class="n">min_</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">type_indicies</span><span class="p">[:</span><span class="n">min_</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">pref_scores</span><span class="p">(</span><span class="n">type_indicies</span><span class="p">,</span> <span class="n">min_</span><span class="p">,</span> <span class="n">flat_scores</span><span class="o">=</span><span class="n">flat_scores</span><span class="p">):</span>
            <span class="n">sortx</span> <span class="o">=</span> <span class="n">flat_scores</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">type_indicies</span><span class="p">)</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">type_indicies</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">sortx</span><span class="p">[:</span><span class="n">min_</span><span class="p">])</span>

        <span class="n">sample_func</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rand&#39;</span><span class="p">:</span> <span class="n">pref_rand</span><span class="p">,</span> <span class="s1">&#39;scores&#39;</span><span class="p">:</span> <span class="n">pref_scores</span><span class="p">,</span> <span class="s1">&#39;first&#39;</span><span class="p">:</span> <span class="n">pref_first</span><span class="p">}[</span>
            <span class="n">pref_method</span>
        <span class="p">]</span>

        <span class="c1"># Figure out how much of each label needs to be removed</span>
        <span class="c1"># record the indicies that will not be filtered in keep_indicies_list</span>
        <span class="n">allowed_ratio</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">PHI</span> <span class="o">*</span> <span class="mf">0.8</span>
        <span class="c1"># allowed_ratio = 1.0</span>
        <span class="c1"># Find the maximum and minimum number of labels over all types</span>
        <span class="n">true_max_</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">labelhist</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">true_min_</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">labelhist</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="c1"># Allow for some window around the minimum</span>
        <span class="n">min_</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">true_min_</span> <span class="o">*</span> <span class="n">allowed_ratio</span><span class="p">),</span> <span class="n">true_max_</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Equalizing label distribution with method=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pref_method</span><span class="p">,))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Allowing at most </span><span class="si">%d</span><span class="s1"> labels of a type&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">min_</span><span class="p">,))</span>
        <span class="n">key_list</span><span class="p">,</span> <span class="n">type_indicies_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">group_indices</span><span class="p">(</span><span class="n">flat_labels</span><span class="p">)</span>
        <span class="c1"># type_indicies_list = [np.where(flat_labels == key)[0]</span>
        <span class="c1">#                      for key in six.iterkeys(labelhist)]</span>
        <span class="n">keep_indicies_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">type_indicies</span> <span class="ow">in</span> <span class="n">type_indicies_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">min_</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">type_indicies</span><span class="p">):</span>
                <span class="n">keep_indicies</span> <span class="o">=</span> <span class="n">type_indicies</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">keep_indicies</span> <span class="o">=</span> <span class="n">sample_func</span><span class="p">(</span><span class="n">type_indicies</span><span class="p">,</span> <span class="n">min_</span><span class="p">)</span>
            <span class="n">keep_indicies_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">keep_indicies</span><span class="p">)</span>
        <span class="c1"># Create a flag for each flat label (patch-pair)</span>
        <span class="n">flat_keep_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">keep_indicies_list</span><span class="p">)</span>
        <span class="n">flat_flag_list</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">index_to_boolmask</span><span class="p">(</span><span class="n">flat_keep_idxs</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">flat_labels</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">flat_flag_list</span>

    <span class="k">def</span> <span class="nf">equalize_labels</span><span class="p">():</span>
        <span class="p">(</span>
            <span class="n">aid1_list_uneq</span><span class="p">,</span>
            <span class="n">aid2_list_uneq</span><span class="p">,</span>
            <span class="n">labels_uneq</span><span class="p">,</span>
            <span class="n">fm_list_uneq2</span><span class="p">,</span>
            <span class="n">metadata_uneq2</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">get_matchdata3</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;flattening&#39;</span><span class="p">)</span>
        <span class="c1"># Find out how many examples each source holds</span>
        <span class="n">len1_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">fm_list_uneq2</span><span class="p">))</span>
        <span class="c1"># Expand source labels so one exists for each datapoint</span>
        <span class="n">flat_labels</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">label</span><span class="p">]</span> <span class="o">*</span> <span class="n">len1</span> <span class="k">for</span> <span class="n">len1</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">len1_list</span><span class="p">,</span> <span class="n">labels_uneq</span><span class="p">)]</span>
        <span class="p">)</span>
        <span class="n">flat_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">flat_labels</span><span class="p">)</span>
        <span class="n">flat_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">metadata_uneq2</span><span class="p">[</span><span class="s1">&#39;fs&#39;</span><span class="p">])</span>
        <span class="n">flat_flag_list</span> <span class="o">=</span> <span class="n">equalize_flat_flags</span><span class="p">(</span><span class="n">flat_labels</span><span class="p">,</span> <span class="n">flat_scores</span><span class="p">)</span>

        <span class="c1"># Unflatten back into source-vs-source pairs (annot-vs-annot)</span>
        <span class="n">flags_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">unflatten2</span><span class="p">(</span><span class="n">flat_flag_list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">len1_list</span><span class="p">))</span>

        <span class="k">assert</span> <span class="n">ut</span><span class="o">.</span><span class="n">depth_profile</span><span class="p">(</span><span class="n">flags_list</span><span class="p">)</span> <span class="o">==</span> <span class="n">ut</span><span class="o">.</span><span class="n">depth_profile</span><span class="p">(</span><span class="n">metadata_uneq2</span><span class="p">[</span><span class="s1">&#39;fs&#39;</span><span class="p">])</span>

        <span class="n">fm_list_</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">zipcompress_safe</span><span class="p">(</span><span class="n">fm_list_uneq2</span><span class="p">,</span> <span class="n">flags_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">metadata_</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">vt</span><span class="o">.</span><span class="n">zipcompress_safe</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">flags_list</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">metadata_uneq2</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># remove empty aids</span>
        <span class="n">isnonempty_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">fm</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">fm</span> <span class="ow">in</span> <span class="n">fm_list_</span><span class="p">]</span>
        <span class="n">fm_list_eq</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">fm_list_</span><span class="p">,</span> <span class="n">isnonempty_list</span><span class="p">)</span>
        <span class="n">aid1_list_eq</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">aid1_list_uneq</span><span class="p">,</span> <span class="n">isnonempty_list</span><span class="p">)</span>
        <span class="n">aid2_list_eq</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">aid2_list_uneq</span><span class="p">,</span> <span class="n">isnonempty_list</span><span class="p">)</span>
        <span class="n">labels_eq</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">labels_uneq</span><span class="p">,</span> <span class="n">isnonempty_list</span><span class="p">)</span>
        <span class="n">metadata_eq</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="p">[(</span><span class="n">key</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">isnonempty_list</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">metadata_</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="p">)</span>

        <span class="c1"># PRINT NEW LABEL STATS</span>
        <span class="n">len1_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">fm_list_eq</span><span class="p">))</span>
        <span class="n">flat_labels_eq</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">label</span><span class="p">]</span> <span class="o">*</span> <span class="n">len1</span> <span class="k">for</span> <span class="n">len1</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">len1_list</span><span class="p">,</span> <span class="n">labels_eq</span><span class="p">)]</span>
        <span class="p">)</span>
        <span class="n">labelhist_eq</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">flat_labels_eq</span><span class="p">,</span> <span class="n">flat_labels_eq</span><span class="p">))</span>
        <span class="p">}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;[ingest_wbia] equalized label histogram = </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_str</span><span class="p">(</span><span class="n">labelhist_eq</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[ingest_wbia] total = </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">labelhist_eq</span><span class="o">.</span><span class="n">values</span><span class="p">()))))</span>
        <span class="c1"># --</span>
        <span class="k">return</span> <span class="n">aid1_list_eq</span><span class="p">,</span> <span class="n">aid2_list_eq</span><span class="p">,</span> <span class="n">fm_list_eq</span><span class="p">,</span> <span class="n">labels_eq</span><span class="p">,</span> <span class="n">metadata_eq</span>

    <span class="c1"># EQUALIZE_LABELS = True</span>
    <span class="c1"># if EQUALIZE_LABELS:</span>
    <span class="n">aid1_list_eq</span><span class="p">,</span> <span class="n">aid2_list_eq</span><span class="p">,</span> <span class="n">fm_list_eq</span><span class="p">,</span> <span class="n">labels_eq</span><span class="p">,</span> <span class="n">metadata_eq</span> <span class="o">=</span> <span class="n">equalize_labels</span><span class="p">()</span>

    <span class="c1"># Convert annot-vs-annot pairs into raw feature-vs-feature pairs</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Building feature indicies&#39;</span><span class="p">)</span>

    <span class="n">fx1_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">fm</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">fm</span> <span class="ow">in</span> <span class="n">fm_list_eq</span><span class="p">]</span>
    <span class="n">fx2_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">fm</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">fm</span> <span class="ow">in</span> <span class="n">fm_list_eq</span><span class="p">]</span>
    <span class="c1"># Hack: use the ibeis cache to make quick lookups</span>
    <span class="c1"># with ut.Timer(&#39;Reading keypoint sets (caching unique keypoints)&#39;):</span>
    <span class="c1">#    ibs.get_annot_kpts(list(set(aid1_list_eq + aid2_list_eq)),</span>
    <span class="c1">#                       config2_=qreq_.get_internal_query_config2())</span>
    <span class="k">with</span> <span class="n">ut</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="s1">&#39;Reading keypoint sets from cache&#39;</span><span class="p">):</span>
        <span class="n">kpts1_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_kpts</span><span class="p">(</span>
            <span class="n">aid1_list_eq</span><span class="p">,</span> <span class="n">config2_</span><span class="o">=</span><span class="n">qreq_</span><span class="o">.</span><span class="n">get_internal_query_config2</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">kpts2_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_kpts</span><span class="p">(</span>
            <span class="n">aid2_list_eq</span><span class="p">,</span> <span class="n">config2_</span><span class="o">=</span><span class="n">qreq_</span><span class="o">.</span><span class="n">get_internal_query_config2</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="c1"># Save some memory</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">print_cachestats_str</span><span class="p">()</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">clear_table_cache</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">FEATURE_TABLE</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Taking matching keypoints&#39;</span><span class="p">)</span>
    <span class="n">kpts1_m_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">kpts1</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fx1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">kpts1</span><span class="p">,</span> <span class="n">fx1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kpts1_list</span><span class="p">,</span> <span class="n">fx1_list</span><span class="p">)]</span>
    <span class="n">kpts2_m_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">kpts2</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fx2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">kpts2</span><span class="p">,</span> <span class="n">fx2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kpts2_list</span><span class="p">,</span> <span class="n">fx2_list</span><span class="p">)]</span>

    <span class="p">(</span><span class="n">aid1_list</span><span class="p">,</span> <span class="n">aid2_list</span><span class="p">,</span> <span class="n">fm_list</span><span class="p">,</span> <span class="n">metadata_lists</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">aid1_list_eq</span><span class="p">,</span>
        <span class="n">aid2_list_eq</span><span class="p">,</span>
        <span class="n">fm_list_eq</span><span class="p">,</span>
        <span class="n">metadata_eq</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># assert ut.get_list_column(ut.depth_profile(kpts1_m_list), 0) ==</span>
    <span class="c1"># ut.depth_profile(metadata_lists[&#39;fs&#39;])</span>
    <span class="n">patchmatch_tup</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">aid1_list</span><span class="p">,</span>
        <span class="n">aid2_list</span><span class="p">,</span>
        <span class="n">kpts1_m_list</span><span class="p">,</span>
        <span class="n">kpts2_m_list</span><span class="p">,</span>
        <span class="n">fm_list</span><span class="p">,</span>
        <span class="n">metadata_lists</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">patchmatch_tup</span></div>


<div class="viewcode-block" id="get_background_training_patches2"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.ingest_wbia.get_background_training_patches2">[docs]</a><span class="k">def</span> <span class="nf">get_background_training_patches2</span><span class="p">(</span>
    <span class="n">ibs</span><span class="p">,</span>
    <span class="n">target_species</span><span class="p">,</span>
    <span class="n">dest_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">patch_size</span><span class="o">=</span><span class="mi">48</span><span class="p">,</span>
    <span class="n">patch_size_min</span><span class="o">=</span><span class="mf">0.80</span><span class="p">,</span>
    <span class="n">patch_size_max</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span>
    <span class="n">annot_size</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">patience</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">patches_per_annotation</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
    <span class="n">global_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">train_gid_set</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">visualize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">visualize_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">tiles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">inside_boundary</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">purge</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">supercharge_negative_multiplier</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
    <span class="n">undercharge_negative_multiplier</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get data for bg</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">random</span>
    <span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">expanduser</span>
    <span class="kn">import</span> <span class="nn">cv2</span>

    <span class="k">def</span> <span class="nf">resize_target</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">target_height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_width</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">target_height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">target_width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">target_height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">target_width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">target_height</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">target_width</span>
        <span class="k">elif</span> <span class="n">target_height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">target_height</span>
            <span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="n">height</span><span class="p">)</span> <span class="o">*</span> <span class="n">h</span>
        <span class="k">elif</span> <span class="n">target_width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">target_width</span>
            <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="n">width</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LANCZOS4</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">point_inside</span><span class="p">(</span><span class="n">tup1</span><span class="p">,</span> <span class="n">tup2</span><span class="p">):</span>
        <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">tup1</span>
        <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span> <span class="o">=</span> <span class="n">tup2</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">w</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">h</span>
        <span class="k">return</span> <span class="n">x0</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">x1</span> <span class="ow">and</span> <span class="n">y0</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">&lt;=</span> <span class="n">y1</span>

    <span class="k">if</span> <span class="n">target_species</span> <span class="o">==</span> <span class="s1">&#39;turtle_sea&#39;</span><span class="p">:</span>
        <span class="n">target_species_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;turtle_green&#39;</span><span class="p">,</span>
            <span class="s1">&#39;turtle_green+head&#39;</span><span class="p">,</span>
            <span class="s1">&#39;turtle_hawksbill&#39;</span><span class="p">,</span>
            <span class="s1">&#39;turtle_hawksbill+head&#39;</span><span class="p">,</span>
            <span class="s1">&#39;turtle_oliveridley&#39;</span><span class="p">,</span>
            <span class="s1">&#39;turtle_oliveridley+head&#39;</span><span class="p">,</span>
            <span class="s1">&#39;turtle_sea&#39;</span><span class="p">,</span>
            <span class="s1">&#39;turtle_sea+head&#39;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="k">elif</span> <span class="n">target_species</span> <span class="o">==</span> <span class="s1">&#39;wild_dog&#39;</span><span class="p">:</span>
        <span class="n">target_species_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;____&#39;</span><span class="p">,</span>
            <span class="s1">&#39;wild_dog&#39;</span><span class="p">,</span>
            <span class="s1">&#39;wild_dog_dark&#39;</span><span class="p">,</span>
            <span class="s1">&#39;wild_dog_light&#39;</span><span class="p">,</span>
            <span class="s1">&#39;wild_dog_puppy&#39;</span><span class="p">,</span>
            <span class="s1">&#39;wild_dog_standard&#39;</span><span class="p">,</span>
            <span class="s1">&#39;wild_dog_tan&#39;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_species</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_species</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="n">target_species</span><span class="p">,</span> <span class="n">target_species_list</span> <span class="o">=</span> <span class="n">target_species</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_species_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">target_species_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">target_species</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">dest_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dest_path</span> <span class="o">=</span> <span class="n">expanduser</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">,</span> <span class="s1">&#39;Desktop&#39;</span><span class="p">,</span> <span class="s1">&#39;extracted&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">visualize_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">visualize_path</span> <span class="o">=</span> <span class="n">expanduser</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">,</span> <span class="s1">&#39;Desktop&#39;</span><span class="p">,</span> <span class="s1">&#39;visualize&#39;</span><span class="p">,</span> <span class="s1">&#39;background&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">purge</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">visualize_path</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">visualize_path</span><span class="p">)</span>

    <span class="n">dbname</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;background&#39;</span>
    <span class="n">dbname</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span>
    <span class="n">name_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dest_path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">raw_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">name_path</span><span class="p">,</span> <span class="s1">&#39;raw&#39;</span><span class="p">)</span>
    <span class="n">labels_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">name_path</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">dest_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">purge</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">dest_path</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">dest_path</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">raw_path</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">labels_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">train_gid_set</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">train_gid_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_gids</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_imgsetids_from_text</span><span class="p">(</span><span class="s1">&#39;TRAIN_SET&#39;</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
        <span class="n">train_gid_set</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">train_gid_set</span><span class="p">)</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">train_gid_set</span><span class="p">)</span>

    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">train_gid_set</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tiles</span><span class="p">:</span>
        <span class="n">bboxes_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_bboxes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">reference_tile_gid</span><span class="o">=</span><span class="n">gid</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">aid_list</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">train_gid_set</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bboxes_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_bboxes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span> <span class="k">for</span> <span class="n">aid_list</span> <span class="ow">in</span> <span class="n">aids_list</span><span class="p">]</span>
    <span class="n">species_list_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span> <span class="k">for</span> <span class="n">aid_list</span> <span class="ow">in</span> <span class="n">aids_list</span><span class="p">]</span>

    <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">train_gid_set</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">,</span> <span class="n">bboxes_list</span><span class="p">,</span> <span class="n">species_list_list</span><span class="p">)</span>
    <span class="n">label_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">global_positives</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">global_negatives</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">species_list</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_images</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>

        <span class="k">if</span> <span class="n">visualize</span><span class="p">:</span>
            <span class="n">canvas</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">canvas</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">gid</span><span class="p">,</span>
            <span class="n">global_positives</span><span class="p">,</span>
            <span class="n">global_negatives</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">label_list</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing GID: </span><span class="si">%r</span><span class="s1"> [ </span><span class="si">%r</span><span class="s1"> / </span><span class="si">%r</span><span class="s1"> = </span><span class="si">%r</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">AIDS  : </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid_list</span><span class="p">,))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">BBOXES: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bbox_list</span><span class="p">,))</span>

        <span class="k">if</span> <span class="n">global_limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">global_negatives</span> <span class="o">+</span> <span class="n">global_positives</span> <span class="o">&gt;=</span> <span class="n">global_limit</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">HIT GLOBAL LIMIT&#39;</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">bbox_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">aid_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
            <span class="n">bbox_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">species</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">species_list</span><span class="p">):</span>
            <span class="n">positives</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">negatives</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">species</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">target_species_list</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Skipping aid </span><span class="si">%r</span><span class="s1"> (bad species: </span><span class="si">%s</span><span class="s1">)&#39;</span>
                    <span class="o">%</span> <span class="p">(</span>
                        <span class="n">aid</span><span class="p">,</span>
                        <span class="n">species</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">aid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">xtl</span><span class="p">,</span> <span class="n">ytl</span><span class="p">,</span> <span class="n">w_</span><span class="p">,</span> <span class="n">h_</span> <span class="o">=</span> <span class="n">bbox</span>
                <span class="n">xbr</span><span class="p">,</span> <span class="n">ybr</span> <span class="o">=</span> <span class="n">xtl</span> <span class="o">+</span> <span class="n">w_</span><span class="p">,</span> <span class="n">ytl</span> <span class="o">+</span> <span class="n">h_</span>

                <span class="k">if</span> <span class="n">canvas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">canvas</span><span class="p">,</span> <span class="p">(</span><span class="n">xtl</span><span class="p">,</span> <span class="n">ytl</span><span class="p">),</span> <span class="p">(</span><span class="n">xbr</span><span class="p">,</span> <span class="n">ybr</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

                <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">w_</span><span class="p">,</span> <span class="n">h_</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">w_</span><span class="p">,</span> <span class="n">h_</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.25</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping aid </span><span class="si">%r</span><span class="s1"> (aspect ratio)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid</span><span class="p">,))</span>
                    <span class="k">continue</span>

                <span class="n">modifier</span> <span class="o">=</span> <span class="n">w_</span> <span class="o">/</span> <span class="n">annot_size</span>
                <span class="n">patch_size_</span> <span class="o">=</span> <span class="n">patch_size</span> <span class="o">*</span> <span class="n">modifier</span>
                <span class="n">patch_size_min_</span> <span class="o">=</span> <span class="n">patch_size_</span> <span class="o">*</span> <span class="n">patch_size_min</span>
                <span class="n">patch_size_max_</span> <span class="o">=</span> <span class="n">patch_size_</span> <span class="o">*</span> <span class="n">patch_size_max</span>

                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">patches_per_annotation</span><span class="p">):</span>
                    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">while</span> <span class="ow">not</span> <span class="n">found</span> <span class="ow">and</span> <span class="n">counter</span> <span class="o">&lt;</span> <span class="n">patience</span><span class="p">:</span>
                        <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">patch_size_random</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
                            <span class="n">patch_size_min_</span><span class="p">,</span> <span class="n">patch_size_max_</span>
                        <span class="p">)</span>
                        <span class="n">patch_size_final</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">patch_size_random</span><span class="p">))</span>

                        <span class="n">radius</span> <span class="o">=</span> <span class="n">patch_size_final</span> <span class="o">//</span> <span class="mi">2</span>

                        <span class="k">if</span> <span class="n">inside_boundary</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">patch_size_final</span> <span class="o">&gt;</span> <span class="n">w_</span> <span class="ow">or</span> <span class="n">patch_size_final</span> <span class="o">&gt;</span> <span class="n">h_</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                    <span class="s1">&#39;Skipping aid </span><span class="si">%r</span><span class="s1"> (patch_size_final too big)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid</span><span class="p">,)</span>
                                <span class="p">)</span>
                                <span class="k">continue</span>

                            <span class="n">centerx</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">xtl</span> <span class="o">+</span> <span class="n">radius</span><span class="p">,</span> <span class="n">xbr</span> <span class="o">-</span> <span class="n">radius</span><span class="p">)</span>
                            <span class="n">centery</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">ytl</span> <span class="o">+</span> <span class="n">radius</span><span class="p">,</span> <span class="n">ybr</span> <span class="o">-</span> <span class="n">radius</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">centerx</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">xtl</span><span class="p">,</span> <span class="n">xbr</span><span class="p">)</span>
                            <span class="n">centery</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">ytl</span><span class="p">,</span> <span class="n">ybr</span><span class="p">)</span>

                        <span class="n">x0</span> <span class="o">=</span> <span class="n">centerx</span> <span class="o">-</span> <span class="n">radius</span>
                        <span class="n">y0</span> <span class="o">=</span> <span class="n">centery</span> <span class="o">-</span> <span class="n">radius</span>
                        <span class="n">x1</span> <span class="o">=</span> <span class="n">centerx</span> <span class="o">+</span> <span class="n">radius</span>
                        <span class="n">y1</span> <span class="o">=</span> <span class="n">centery</span> <span class="o">+</span> <span class="n">radius</span>

                        <span class="k">if</span> <span class="n">x0</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">x0</span> <span class="o">&gt;=</span> <span class="n">w</span> <span class="ow">or</span> <span class="n">x1</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">x1</span> <span class="o">&gt;=</span> <span class="n">w</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping aid </span><span class="si">%r</span><span class="s1"> (bounds check, width)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid</span><span class="p">,))</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">y0</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">y0</span> <span class="o">&gt;=</span> <span class="n">w</span> <span class="ow">or</span> <span class="n">y1</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">y1</span> <span class="o">&gt;=</span> <span class="n">w</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping aid </span><span class="si">%r</span><span class="s1"> (bounds check, height)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid</span><span class="p">,))</span>
                            <span class="k">continue</span>

                        <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="c1"># Sanity checks</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">x1</span> <span class="o">&gt;</span> <span class="n">x0</span>
                        <span class="k">assert</span> <span class="n">y1</span> <span class="o">&gt;</span> <span class="n">y0</span>
                        <span class="k">if</span> <span class="n">inside_boundary</span><span class="p">:</span>
                            <span class="k">assert</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span> <span class="o">&gt;=</span> <span class="n">patch_size</span> <span class="o">//</span> <span class="mi">2</span>
                            <span class="k">assert</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span> <span class="o">&gt;=</span> <span class="n">patch_size</span> <span class="o">//</span> <span class="mi">2</span>
                        <span class="k">assert</span> <span class="n">x0</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">x0</span> <span class="o">&lt;</span> <span class="n">w</span> <span class="ow">and</span> <span class="n">x1</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">x1</span> <span class="o">&lt;</span> <span class="n">w</span>
                        <span class="k">assert</span> <span class="n">y0</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">y0</span> <span class="o">&lt;</span> <span class="n">h</span> <span class="ow">and</span> <span class="n">y1</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">y1</span> <span class="o">&lt;</span> <span class="n">h</span>
                    <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping aid </span><span class="si">%r</span><span class="s1"> (sanity check)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid</span><span class="p">,))</span>
                        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                        <span class="n">positives</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">canvas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">canvas</span><span class="p">,</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">),</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                        <span class="n">chip</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">y0</span><span class="p">:</span><span class="n">y1</span><span class="p">,</span> <span class="n">x0</span><span class="p">:</span><span class="n">x1</span><span class="p">]</span>
                        <span class="n">chip</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
                            <span class="n">chip</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">patch_size</span><span class="p">,</span> <span class="n">patch_size</span><span class="p">),</span>
                            <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LANCZOS4</span><span class="p">,</span>
                        <span class="p">)</span>

                        <span class="c1"># positive_category = &#39;%s&#39; % (species, )</span>
                        <span class="n">positive_category</span> <span class="o">=</span> <span class="s1">&#39;positive&#39;</span>
                        <span class="n">values</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">dbname</span><span class="p">,</span>
                            <span class="n">gid</span><span class="p">,</span>
                            <span class="n">positive_category</span><span class="p">,</span>
                            <span class="n">x0</span><span class="p">,</span>
                            <span class="n">y0</span><span class="p">,</span>
                            <span class="n">x1</span><span class="p">,</span>
                            <span class="n">y1</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">patch_filename</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_patch_gid_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_bbox_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">values</span>
                        <span class="p">)</span>
                        <span class="n">patch_filepath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">raw_path</span><span class="p">,</span> <span class="n">patch_filename</span><span class="p">)</span>
                        <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">patch_filepath</span><span class="p">,</span> <span class="n">chip</span><span class="p">)</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">patch_filename</span><span class="p">,</span> <span class="n">positive_category</span><span class="p">)</span>
                        <span class="n">label_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping aid </span><span class="si">%r</span><span class="s1"> (not found)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid</span><span class="p">,))</span>

                <span class="n">positives_</span> <span class="o">=</span> <span class="n">positives</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">modifier</span> <span class="o">=</span> <span class="mf">4.0</span>
                <span class="n">patch_size_</span> <span class="o">=</span> <span class="n">patch_size</span> <span class="o">*</span> <span class="n">modifier</span>
                <span class="n">patch_size_min_</span> <span class="o">=</span> <span class="n">patch_size_</span> <span class="o">*</span> <span class="n">patch_size_min</span>
                <span class="n">patch_size_max_</span> <span class="o">=</span> <span class="n">patch_size_</span> <span class="o">*</span> <span class="n">patch_size_max</span>
                <span class="n">positives_</span> <span class="o">=</span> <span class="n">patches_per_annotation</span>

            <span class="n">delta</span> <span class="o">=</span> <span class="n">global_positives</span> <span class="o">-</span> <span class="n">global_negatives</span>
            <span class="k">if</span> <span class="n">delta</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">patches_per_annotation</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;SUPERCHARGE NEGATIVES&#39;</span><span class="p">)</span>
                <span class="n">positives_</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">positives_</span> <span class="o">*</span> <span class="n">supercharge_negative_multiplier</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">delta</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">patches_per_annotation</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;UNDERCHARGE NEGATIVES&#39;</span><span class="p">)</span>
                <span class="n">positives_</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">positives_</span> <span class="o">*</span> <span class="n">undercharge_negative_multiplier</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">positives_</span><span class="p">):</span>
                <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">found</span> <span class="ow">and</span> <span class="n">counter</span> <span class="o">&lt;</span> <span class="n">patience</span><span class="p">:</span>
                    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">patch_size_random</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">patch_size_min_</span><span class="p">,</span> <span class="n">patch_size_max_</span><span class="p">)</span>
                    <span class="n">patch_size_final</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">patch_size_random</span><span class="p">))</span>

                    <span class="n">radius</span> <span class="o">=</span> <span class="n">patch_size_final</span> <span class="o">//</span> <span class="mi">2</span>

                    <span class="k">if</span> <span class="n">radius</span> <span class="o">&gt;=</span> <span class="n">w</span> <span class="o">//</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">radius</span> <span class="o">&gt;=</span> <span class="n">h</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">centerx</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">w</span> <span class="o">-</span> <span class="n">radius</span><span class="p">)</span>
                    <span class="n">centery</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">h</span> <span class="o">-</span> <span class="n">radius</span><span class="p">)</span>

                    <span class="n">inside</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">bbox</span> <span class="ow">in</span> <span class="n">bbox_list</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">bbox</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">point_inside</span><span class="p">((</span><span class="n">centerx</span><span class="p">,</span> <span class="n">centery</span><span class="p">),</span> <span class="n">bbox</span><span class="p">):</span>
                            <span class="n">inside</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>

                    <span class="k">if</span> <span class="n">inside</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">x0</span> <span class="o">=</span> <span class="n">centerx</span> <span class="o">-</span> <span class="n">radius</span>
                    <span class="n">y0</span> <span class="o">=</span> <span class="n">centery</span> <span class="o">-</span> <span class="n">radius</span>
                    <span class="n">x1</span> <span class="o">=</span> <span class="n">centerx</span> <span class="o">+</span> <span class="n">radius</span>
                    <span class="n">y1</span> <span class="o">=</span> <span class="n">centery</span> <span class="o">+</span> <span class="n">radius</span>

                    <span class="k">if</span> <span class="n">x0</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">x0</span> <span class="o">&gt;=</span> <span class="n">w</span> <span class="ow">or</span> <span class="n">x1</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">x1</span> <span class="o">&gt;=</span> <span class="n">w</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">y0</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">y0</span> <span class="o">&gt;=</span> <span class="n">w</span> <span class="ow">or</span> <span class="n">y1</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">y1</span> <span class="o">&gt;=</span> <span class="n">w</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># Sanity checks</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">x1</span> <span class="o">&gt;</span> <span class="n">x0</span>
                    <span class="k">assert</span> <span class="n">y1</span> <span class="o">&gt;</span> <span class="n">y0</span>
                    <span class="k">assert</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span> <span class="o">&gt;=</span> <span class="n">patch_size</span> <span class="o">//</span> <span class="mi">2</span>
                    <span class="k">assert</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span> <span class="o">&gt;=</span> <span class="n">patch_size</span> <span class="o">//</span> <span class="mi">2</span>
                    <span class="k">assert</span> <span class="n">x0</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">x0</span> <span class="o">&lt;</span> <span class="n">w</span> <span class="ow">and</span> <span class="n">x1</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">x1</span> <span class="o">&lt;</span> <span class="n">w</span>
                    <span class="k">assert</span> <span class="n">y0</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">y0</span> <span class="o">&lt;</span> <span class="n">h</span> <span class="ow">and</span> <span class="n">y1</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">y1</span> <span class="o">&lt;</span> <span class="n">h</span>
                <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                    <span class="n">negatives</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">canvas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">canvas</span><span class="p">,</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">),</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
                    <span class="n">chip</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">y0</span><span class="p">:</span><span class="n">y1</span><span class="p">,</span> <span class="n">x0</span><span class="p">:</span><span class="n">x1</span><span class="p">]</span>
                    <span class="n">chip</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
                        <span class="n">chip</span><span class="p">,</span> <span class="p">(</span><span class="n">patch_size</span><span class="p">,</span> <span class="n">patch_size</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LANCZOS4</span>
                    <span class="p">)</span>

                    <span class="n">values</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">dbname</span><span class="p">,</span>
                        <span class="n">gid</span><span class="p">,</span>
                        <span class="s1">&#39;negative&#39;</span><span class="p">,</span>
                        <span class="n">x0</span><span class="p">,</span>
                        <span class="n">y0</span><span class="p">,</span>
                        <span class="n">x1</span><span class="p">,</span>
                        <span class="n">y1</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">patch_filename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_patch_gid_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_bbox_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">values</span>
                    <span class="n">patch_filepath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">raw_path</span><span class="p">,</span> <span class="n">patch_filename</span><span class="p">)</span>
                    <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">patch_filepath</span><span class="p">,</span> <span class="n">chip</span><span class="p">)</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">patch_filename</span><span class="p">,</span> <span class="s1">&#39;negative&#39;</span><span class="p">)</span>
                    <span class="n">label_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

            <span class="n">global_positives</span> <span class="o">+=</span> <span class="n">positives</span>
            <span class="n">global_negatives</span> <span class="o">+=</span> <span class="n">negatives</span>

        <span class="k">if</span> <span class="n">canvas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">canvas_filename</span> <span class="o">=</span> <span class="s1">&#39;background_gid_</span><span class="si">%s</span><span class="s1">_species_</span><span class="si">%s</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">gid</span><span class="p">,</span>
                <span class="n">target_species</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">canvas_filepath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">visualize_path</span><span class="p">,</span> <span class="n">canvas_filename</span><span class="p">)</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">resize_target</span><span class="p">(</span><span class="n">canvas</span><span class="p">,</span> <span class="n">target_width</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">canvas_filepath</span><span class="p">,</span> <span class="n">canvas</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">global_positives</span><span class="p">,</span>
        <span class="n">global_negatives</span><span class="p">,</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">label_list</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Final Split: [ </span><span class="si">%r</span><span class="s1"> / </span><span class="si">%r</span><span class="s1"> = </span><span class="si">%r</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">labels_path</span><span class="p">,</span> <span class="s1">&#39;labels.csv&#39;</span><span class="p">),</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">labels</span><span class="p">:</span>
        <span class="n">label_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label_list</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">label_str</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">name_path</span></div>


<div class="viewcode-block" id="get_aoi_training_data"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.ingest_wbia.get_aoi_training_data">[docs]</a><span class="k">def</span> <span class="nf">get_aoi_training_data</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">dest_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_species_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">purge</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get data for bg</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">expanduser</span>

    <span class="k">if</span> <span class="n">dest_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dest_path</span> <span class="o">=</span> <span class="n">expanduser</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">,</span> <span class="s1">&#39;Desktop&#39;</span><span class="p">,</span> <span class="s1">&#39;extracted&#39;</span><span class="p">))</span>

    <span class="n">dbname</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;aoi&#39;</span>
    <span class="n">dbname</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span>
    <span class="n">name_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dest_path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">raw_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">name_path</span><span class="p">,</span> <span class="s1">&#39;raw&#39;</span><span class="p">)</span>
    <span class="n">labels_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">name_path</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">purge</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">name_path</span><span class="p">)</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">dest_path</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">name_path</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">raw_path</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">labels_path</span><span class="p">)</span>

    <span class="c1"># gid_list = ibs.get_valid_gids()</span>
    <span class="n">train_gid_set</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="nb">set</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_gids</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_imgsetids_from_text</span><span class="p">(</span><span class="s1">&#39;TRAIN_SET&#39;</span><span class="p">)))</span>
    <span class="p">)</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;algo&#39;</span><span class="p">:</span> <span class="s1">&#39;resnet&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">data_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">depc_image</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span>
        <span class="s1">&#39;features&#39;</span><span class="p">,</span> <span class="n">train_gid_set</span><span class="p">,</span> <span class="s1">&#39;vector&#39;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span>
    <span class="p">)</span>
    <span class="n">reviewed_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_reviewed</span><span class="p">(</span><span class="n">train_gid_set</span><span class="p">)</span>
    <span class="n">reviewed_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">train_gid_set</span><span class="p">)</span>
    <span class="n">size_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_sizes</span><span class="p">(</span><span class="n">train_gid_set</span><span class="p">)</span>
    <span class="n">bboxes_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_bboxes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span> <span class="k">for</span> <span class="n">aid_list</span> <span class="ow">in</span> <span class="n">aids_list</span><span class="p">]</span>
    <span class="n">species_list_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span> <span class="k">for</span> <span class="n">aid_list</span> <span class="ow">in</span> <span class="n">aids_list</span><span class="p">]</span>
    <span class="n">interest_list_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_interest</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span> <span class="k">for</span> <span class="n">aid_list</span> <span class="ow">in</span> <span class="n">aids_list</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">target_species_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">target_species_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">species_list_list</span><span class="p">)))</span>

    <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span>
        <span class="n">train_gid_set</span><span class="p">,</span>
        <span class="n">reviewed_list</span><span class="p">,</span>
        <span class="n">data_list</span><span class="p">,</span>
        <span class="n">aids_list</span><span class="p">,</span>
        <span class="n">size_list</span><span class="p">,</span>
        <span class="n">bboxes_list</span><span class="p">,</span>
        <span class="n">species_list_list</span><span class="p">,</span>
        <span class="n">interest_list_list</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">label_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span>
        <span class="n">gid</span><span class="p">,</span>
        <span class="n">reviewed</span><span class="p">,</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">aid_list</span><span class="p">,</span>
        <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span>
        <span class="n">bbox_list</span><span class="p">,</span>
        <span class="n">species_list</span><span class="p">,</span>
        <span class="n">interest_list</span><span class="p">,</span>
    <span class="p">)</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing GID: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gid</span><span class="p">,))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">AIDS  : </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid_list</span><span class="p">,))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">BBOXES: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bbox_list</span><span class="p">,))</span>

        <span class="k">if</span> <span class="n">reviewed</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span>
            <span class="k">continue</span>

        <span class="n">w</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>

        <span class="n">temp_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">aoi_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">species_list</span><span class="p">,</span> <span class="n">interest_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="p">(</span><span class="n">xtl</span><span class="p">,</span> <span class="n">ytl</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="n">species</span><span class="p">,</span> <span class="n">interest</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">species</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">target_species_list</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">interest</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">aoi_flag</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">interest</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">aoi_counter</span> <span class="o">+=</span> <span class="n">aoi_flag</span>

            <span class="n">temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">xtl</span> <span class="o">/</span> <span class="n">w</span><span class="p">,</span> <span class="n">ytl</span> <span class="o">/</span> <span class="n">h</span><span class="p">,</span> <span class="p">(</span><span class="n">xtl</span> <span class="o">+</span> <span class="n">width</span><span class="p">)</span> <span class="o">/</span> <span class="n">w</span><span class="p">,</span> <span class="p">(</span><span class="n">ytl</span> <span class="o">+</span> <span class="n">height</span><span class="p">)</span> <span class="o">/</span> <span class="n">h</span><span class="p">,</span> <span class="n">aoi_flag</span><span class="p">]</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">temp</span><span class="p">)))</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;^&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
            <span class="n">temp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">aoi_counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">values</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">dbname</span><span class="p">,</span>
            <span class="n">gid</span><span class="p">,</span>
            <span class="n">aid</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">feature_filename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_vgg_feature_gid_</span><span class="si">%s</span><span class="s1">_aid_</span><span class="si">%s</span><span class="s1">.npy&#39;</span> <span class="o">%</span> <span class="n">values</span>
        <span class="n">feature_filepath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">raw_path</span><span class="p">,</span> <span class="n">feature_filename</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">feature_filepath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">feature_file</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">feature_file</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_list</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">feature_filename</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
        <span class="n">label_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">labels_path</span><span class="p">,</span> <span class="s1">&#39;labels.csv&#39;</span><span class="p">),</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">labels</span><span class="p">:</span>
        <span class="n">label_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label_list</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">label_str</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">name_path</span></div>


<div class="viewcode-block" id="get_aoi2_training_data"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.ingest_wbia.get_aoi2_training_data">[docs]</a><span class="k">def</span> <span class="nf">get_aoi2_training_data</span><span class="p">(</span>
    <span class="n">ibs</span><span class="p">,</span>
    <span class="n">image_size</span><span class="o">=</span><span class="mi">192</span><span class="p">,</span>
    <span class="n">dest_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">target_species_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">train_gid_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">purge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get data for bg</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">expanduser</span><span class="p">,</span> <span class="n">exists</span>
    <span class="kn">import</span> <span class="nn">cv2</span>

    <span class="k">if</span> <span class="n">dest_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dest_path</span> <span class="o">=</span> <span class="n">expanduser</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">,</span> <span class="s1">&#39;Desktop&#39;</span><span class="p">,</span> <span class="s1">&#39;extracted&#39;</span><span class="p">))</span>

    <span class="n">dbname</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;aoi2&#39;</span>
    <span class="n">dbname</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span>
    <span class="n">name_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dest_path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">raw_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">name_path</span><span class="p">,</span> <span class="s1">&#39;raw&#39;</span><span class="p">)</span>
    <span class="n">labels_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">name_path</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cache</span> <span class="ow">and</span> <span class="n">exists</span><span class="p">(</span><span class="n">name_path</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using cached exported data&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">purge</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">name_path</span><span class="p">)</span>

        <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">dest_path</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">name_path</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">raw_path</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">labels_path</span><span class="p">)</span>

        <span class="c1"># gid_list = ibs.get_valid_gids()</span>
        <span class="k">if</span> <span class="n">train_gid_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">train_gid_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_gids</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_imgsetids_from_text</span><span class="p">(</span><span class="s1">&#39;TRAIN_SET&#39;</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="n">train_gid_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">train_gid_set</span><span class="p">)</span>
        <span class="c1"># reviewed_list = ibs.get_image_reviewed(train_gid_list)</span>
        <span class="n">reviewed_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_gid_list</span><span class="p">)</span>
        <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">train_gid_list</span><span class="p">)</span>
        <span class="n">size_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_sizes</span><span class="p">(</span><span class="n">train_gid_list</span><span class="p">)</span>
        <span class="n">bboxes_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_bboxes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span> <span class="k">for</span> <span class="n">aid_list</span> <span class="ow">in</span> <span class="n">aids_list</span><span class="p">]</span>
        <span class="n">species_list_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span> <span class="k">for</span> <span class="n">aid_list</span> <span class="ow">in</span> <span class="n">aids_list</span>
        <span class="p">]</span>
        <span class="n">interest_list_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_interest</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span> <span class="k">for</span> <span class="n">aid_list</span> <span class="ow">in</span> <span class="n">aids_list</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">target_species_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_species_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">species_list_list</span><span class="p">)))</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">image_size</span><span class="p">,</span> <span class="n">image_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">train_gid_list</span><span class="p">,</span>
            <span class="n">reviewed_list</span><span class="p">,</span>
            <span class="n">aids_list</span><span class="p">,</span>
            <span class="n">size_list</span><span class="p">,</span>
            <span class="n">bboxes_list</span><span class="p">,</span>
            <span class="n">species_list_list</span><span class="p">,</span>
            <span class="n">interest_list_list</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">label_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span>
            <span class="n">gid</span><span class="p">,</span>
            <span class="n">reviewed</span><span class="p">,</span>
            <span class="n">aid_list</span><span class="p">,</span>
            <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span>
            <span class="n">bbox_list</span><span class="p">,</span>
            <span class="n">species_list</span><span class="p">,</span>
            <span class="n">interest_list</span><span class="p">,</span>
        <span class="p">)</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing GID: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gid</span><span class="p">,))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">AIDS  : </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid_list</span><span class="p">,))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">BBOXES: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bbox_list</span><span class="p">,))</span>

            <span class="k">if</span> <span class="n">reviewed</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="n">w</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
            <span class="n">h</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>

            <span class="n">temp_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">aoi_counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">species_list</span><span class="p">,</span> <span class="n">interest_list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="p">(</span><span class="n">xtl</span><span class="p">,</span> <span class="n">ytl</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="n">species</span><span class="p">,</span> <span class="n">interest</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">species</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">target_species_list</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">interest</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">aoi_flag</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">interest</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">aoi_counter</span> <span class="o">+=</span> <span class="n">aoi_flag</span>

                <span class="n">temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">xtl</span> <span class="o">/</span> <span class="n">w</span><span class="p">,</span> <span class="n">ytl</span> <span class="o">/</span> <span class="n">h</span><span class="p">,</span> <span class="p">(</span><span class="n">xtl</span> <span class="o">+</span> <span class="n">width</span><span class="p">)</span> <span class="o">/</span> <span class="n">w</span><span class="p">,</span> <span class="p">(</span><span class="n">ytl</span> <span class="o">+</span> <span class="n">height</span><span class="p">)</span> <span class="o">/</span> <span class="n">h</span><span class="p">,</span> <span class="n">aoi_flag</span><span class="p">]</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">temp</span><span class="p">)))</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;^&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
                <span class="n">temp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># if aoi_counter == 0:</span>
            <span class="c1">#     continue</span>

            <span class="n">image</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_images</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
            <span class="n">image_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
                <span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="n">image_size</span><span class="p">,</span> <span class="n">image_size</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LANCZOS4</span>
            <span class="p">)</span>
            <span class="n">image_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">image_</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>

            <span class="n">values</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">dbname</span><span class="p">,</span>
                <span class="n">gid</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">patch_filename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_image_gid_</span><span class="si">%s</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">values</span>
            <span class="n">patch_filepath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">raw_path</span><span class="p">,</span> <span class="n">patch_filename</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">patch_filepath</span><span class="p">,</span> <span class="n">image_</span><span class="p">)</span>

            <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_list</span><span class="p">)</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">patch_filename</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
            <span class="n">label_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">labels_path</span><span class="p">,</span> <span class="s1">&#39;labels.csv&#39;</span><span class="p">),</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">labels</span><span class="p">:</span>
            <span class="n">label_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label_list</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">label_str</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">name_path</span></div>


<div class="viewcode-block" id="get_cnn_detector_training_images"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.ingest_wbia.get_cnn_detector_training_images">[docs]</a><span class="k">def</span> <span class="nf">get_cnn_detector_training_images</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">dest_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">image_size</span><span class="o">=</span><span class="mi">128</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">expanduser</span>
    <span class="kn">import</span> <span class="nn">cv2</span>

    <span class="k">def</span> <span class="nf">resize_target</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">target_height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_width</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">target_height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">target_width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">target_height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">target_width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">target_height</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">target_width</span>
        <span class="k">elif</span> <span class="n">target_height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">target_height</span>
            <span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="n">height</span><span class="p">)</span> <span class="o">*</span> <span class="n">h</span>
        <span class="k">elif</span> <span class="n">target_width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">target_width</span>
            <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="n">width</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span>

    <span class="n">dbname_mapping</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;ELPH_Master&#39;</span><span class="p">:</span> <span class="s1">&#39;elephant_savanna&#39;</span><span class="p">,</span>
        <span class="s1">&#39;GIR_Master&#39;</span><span class="p">:</span> <span class="s1">&#39;giraffe_reticulated&#39;</span><span class="p">,</span>
        <span class="s1">&#39;GZ_Master&#39;</span><span class="p">:</span> <span class="s1">&#39;zebra_grevys&#39;</span><span class="p">,</span>
        <span class="s1">&#39;NNP_MasterGIRM&#39;</span><span class="p">:</span> <span class="s1">&#39;giraffe_masai&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PZ_Master1&#39;</span><span class="p">:</span> <span class="s1">&#39;zebra_plains&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">dest_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dest_path</span> <span class="o">=</span> <span class="n">expanduser</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">,</span> <span class="s1">&#39;Desktop&#39;</span><span class="p">,</span> <span class="s1">&#39;extracted&#39;</span><span class="p">))</span>

    <span class="n">dbname</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span>
    <span class="n">positive_category</span> <span class="o">=</span> <span class="n">dbname_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dbname</span><span class="p">,</span> <span class="s1">&#39;positive&#39;</span><span class="p">)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;saliency_detector&#39;</span>
    <span class="n">dbname</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span>
    <span class="n">name_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dest_path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">raw_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">name_path</span><span class="p">,</span> <span class="s1">&#39;raw&#39;</span><span class="p">)</span>
    <span class="n">labels_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">name_path</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">)</span>

    <span class="c1"># ut.remove_dirs(dest_path)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">dest_path</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">raw_path</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">labels_path</span><span class="p">)</span>

    <span class="c1"># gid_list = ibs.get_valid_gids()</span>
    <span class="n">train_gid_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_gids</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_imgsetids_from_text</span><span class="p">(</span><span class="s1">&#39;TRAIN_SET&#39;</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">train_gid_set</span><span class="p">)</span>
    <span class="n">bboxes_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_bboxes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span> <span class="k">for</span> <span class="n">aid_list</span> <span class="ow">in</span> <span class="n">aids_list</span><span class="p">]</span>

    <span class="n">label_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">zipped_list</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">train_gid_set</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">,</span> <span class="n">bboxes_list</span><span class="p">)</span>
    <span class="n">global_bbox_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">bbox_list</span> <span class="ow">in</span> <span class="n">zipped_list</span><span class="p">:</span>

        <span class="c1"># if gid &gt; 20:</span>
        <span class="c1">#     continue</span>

        <span class="n">image</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_images</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
        <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">channels</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">gid</span><span class="p">,)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing GID: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">AIDS  : </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid_list</span><span class="p">,))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">BBOXES: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bbox_list</span><span class="p">,))</span>

        <span class="n">image_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
            <span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="n">image_size</span><span class="p">,</span> <span class="n">image_size</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LANCZOS4</span>
        <span class="p">)</span>

        <span class="n">values</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">dbname</span><span class="p">,</span>
            <span class="n">gid</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">patch_filename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_image_gid_</span><span class="si">%s</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">values</span>
        <span class="n">patch_filepath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">raw_path</span><span class="p">,</span> <span class="n">patch_filename</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">patch_filepath</span><span class="p">,</span> <span class="n">image_</span><span class="p">)</span>

        <span class="n">bbox_list_</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="p">(</span><span class="n">xtl</span><span class="p">,</span> <span class="n">ytl</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">):</span>
            <span class="n">xr</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">yr</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">h</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">xc</span> <span class="o">=</span> <span class="n">xtl</span> <span class="o">+</span> <span class="n">xr</span>
            <span class="n">yc</span> <span class="o">=</span> <span class="n">ytl</span> <span class="o">+</span> <span class="n">yr</span>

            <span class="c1"># Normalize to unit box</span>
            <span class="n">xr</span> <span class="o">/=</span> <span class="n">width</span>
            <span class="n">xc</span> <span class="o">/=</span> <span class="n">width</span>
            <span class="n">yr</span> <span class="o">/=</span> <span class="n">height</span>
            <span class="n">yc</span> <span class="o">/=</span> <span class="n">height</span>

            <span class="n">xr</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">xr</span><span class="p">))</span>
            <span class="n">xc</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">xc</span><span class="p">))</span>
            <span class="n">yr</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">yr</span><span class="p">))</span>
            <span class="n">yc</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">yc</span><span class="p">))</span>

            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">xc</span><span class="p">,</span>
                <span class="n">yc</span><span class="p">,</span>
                <span class="n">xr</span><span class="p">,</span>
                <span class="n">yr</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">bbox_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">args</span>
            <span class="n">bbox_list_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bbox_str</span><span class="p">)</span>
            <span class="n">global_bbox_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

            <span class="c1"># xtl_ = int((xc - xr) * image_size)</span>
            <span class="c1"># ytl_ = int((yc - yr) * image_size)</span>
            <span class="c1"># xbr_ = int((xc + xr) * image_size)</span>
            <span class="c1"># ybr_ = int((yc + yr) * image_size)</span>
            <span class="c1"># cv2.rectangle(image_, (xtl_, ytl_), (xbr_, ybr_), (0, 255, 0))</span>

        <span class="c1"># cv2.imshow(&#39;&#39;, image_)</span>
        <span class="c1"># cv2.waitKey(0)</span>

        <span class="n">aid_list_str</span> <span class="o">=</span> <span class="s1">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">))</span>
        <span class="n">bbox_list_str</span> <span class="o">=</span> <span class="s1">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">bbox_list_</span><span class="p">))</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">patch_filename</span><span class="p">,</span>
            <span class="n">positive_category</span><span class="p">,</span>
            <span class="n">aid_list_str</span><span class="p">,</span>
            <span class="n">bbox_list_str</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">label_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">labels_path</span><span class="p">,</span> <span class="s1">&#39;labels.csv&#39;</span><span class="p">),</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">labels</span><span class="p">:</span>
        <span class="n">label_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label_list</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">label_str</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">global_bbox_list</span></div>


<div class="viewcode-block" id="get_cnn_classifier_cameratrap_binary_training_images"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.ingest_wbia.get_cnn_classifier_cameratrap_binary_training_images">[docs]</a><span class="k">def</span> <span class="nf">get_cnn_classifier_cameratrap_binary_training_images</span><span class="p">(</span>
    <span class="n">ibs</span><span class="p">,</span>
    <span class="n">positive_imageset_id</span><span class="p">,</span>
    <span class="n">negative_imageset_id</span><span class="p">,</span>
    <span class="n">dest_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">image_size</span><span class="o">=</span><span class="mi">192</span><span class="p">,</span>
    <span class="n">purge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">skip_rate</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="n">skip_rate_pos</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="n">skip_rate_neg</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
<span class="p">):</span>
    <span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">expanduser</span>
    <span class="kn">import</span> <span class="nn">random</span>
    <span class="kn">import</span> <span class="nn">cv2</span>

    <span class="k">if</span> <span class="n">dest_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dest_path</span> <span class="o">=</span> <span class="n">expanduser</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">,</span> <span class="s1">&#39;Desktop&#39;</span><span class="p">,</span> <span class="s1">&#39;extracted&#39;</span><span class="p">))</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;classifier-cameratrap&#39;</span>
    <span class="n">dbname</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span>
    <span class="n">name_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dest_path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">raw_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">name_path</span><span class="p">,</span> <span class="s1">&#39;raw&#39;</span><span class="p">)</span>
    <span class="n">labels_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">name_path</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">purge</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">name_path</span><span class="p">)</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">name_path</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">raw_path</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">labels_path</span><span class="p">)</span>

    <span class="n">train_gid_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_gids</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_imgsetids_from_text</span><span class="p">(</span><span class="s1">&#39;TRAIN_SET&#39;</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="n">positive_gid_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_gids</span><span class="p">(</span><span class="n">positive_imageset_id</span><span class="p">))</span>
    <span class="n">negative_gid_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_gids</span><span class="p">(</span><span class="n">negative_imageset_id</span><span class="p">))</span>

    <span class="n">candidate_gid_set</span> <span class="o">=</span> <span class="n">positive_gid_set</span> <span class="o">|</span> <span class="n">negative_gid_set</span>
    <span class="n">candidate_gid_set</span> <span class="o">=</span> <span class="n">train_gid_set</span> <span class="o">&amp;</span> <span class="n">candidate_gid_set</span>

    <span class="n">label_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">gid</span> <span class="ow">in</span> <span class="n">candidate_gid_set</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">gid</span><span class="p">,)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing GID: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">skip_rate</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">skip_rate</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> Skipping - Sampling&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">gid</span> <span class="ow">in</span> <span class="n">positive_gid_set</span><span class="p">:</span>
            <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;positive&#39;</span>
        <span class="k">elif</span> <span class="n">gid</span> <span class="ow">in</span> <span class="n">negative_gid_set</span><span class="p">:</span>
            <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;negative&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> Skipping - No Label&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">skip_rate_pos</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
            <span class="ow">and</span> <span class="n">category</span> <span class="o">==</span> <span class="s1">&#39;positive&#39;</span>
            <span class="ow">and</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">skip_rate_pos</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> Skipping Positive&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">skip_rate_neg</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
            <span class="ow">and</span> <span class="n">category</span> <span class="o">==</span> <span class="s1">&#39;negative&#39;</span>
            <span class="ow">and</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">skip_rate_neg</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> Skipping Negative&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">image</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_images</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
        <span class="n">image_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
            <span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="n">image_size</span><span class="p">,</span> <span class="n">image_size</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LANCZOS4</span>
        <span class="p">)</span>

        <span class="n">values</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">dbname</span><span class="p">,</span>
            <span class="n">gid</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">patch_filename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_image_gid_</span><span class="si">%s</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">values</span>
        <span class="n">patch_filepath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">raw_path</span><span class="p">,</span> <span class="n">patch_filename</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">patch_filepath</span><span class="p">,</span> <span class="n">image_</span><span class="p">)</span>

        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">patch_filename</span><span class="p">,</span>
            <span class="n">category</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">label_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">labels_path</span><span class="p">,</span> <span class="s1">&#39;labels.csv&#39;</span><span class="p">),</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">labels</span><span class="p">:</span>
        <span class="n">label_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label_list</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">label_str</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">name_path</span></div>


<div class="viewcode-block" id="get_cnn_classifier_binary_training_images"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.ingest_wbia.get_cnn_classifier_binary_training_images">[docs]</a><span class="k">def</span> <span class="nf">get_cnn_classifier_binary_training_images</span><span class="p">(</span>
    <span class="n">ibs</span><span class="p">,</span>
    <span class="n">category_list</span><span class="p">,</span>
    <span class="n">dest_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">image_size</span><span class="o">=</span><span class="mi">192</span><span class="p">,</span>
    <span class="n">purge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">skip_rate</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="n">skip_rate_pos</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="n">skip_rate_neg</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
<span class="p">):</span>
    <span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">expanduser</span>
    <span class="kn">import</span> <span class="nn">random</span>
    <span class="kn">import</span> <span class="nn">cv2</span>

    <span class="k">if</span> <span class="n">dest_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dest_path</span> <span class="o">=</span> <span class="n">expanduser</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">,</span> <span class="s1">&#39;Desktop&#39;</span><span class="p">,</span> <span class="s1">&#39;extracted&#39;</span><span class="p">))</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;classifier-binary&#39;</span>
    <span class="n">dbname</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span>
    <span class="n">name_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dest_path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">raw_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">name_path</span><span class="p">,</span> <span class="s1">&#39;raw&#39;</span><span class="p">)</span>
    <span class="n">labels_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">name_path</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">purge</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">name_path</span><span class="p">)</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">name_path</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">raw_path</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">labels_path</span><span class="p">)</span>

    <span class="c1"># gid_list = ibs.get_valid_gids()</span>
    <span class="n">train_gid_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_gids</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_imgsetids_from_text</span><span class="p">(</span><span class="s1">&#39;TRAIN_SET&#39;</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">train_gid_set</span><span class="p">)</span>

    <span class="n">category_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">category_list</span><span class="p">)</span>

    <span class="n">species_set_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">set</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">))</span> <span class="k">for</span> <span class="n">aid_list_</span> <span class="ow">in</span> <span class="n">aids_list</span>
    <span class="p">]</span>

    <span class="n">label_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">species_set</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">train_gid_set</span><span class="p">,</span> <span class="n">species_set_list</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">gid</span><span class="p">,)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing GID: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">skip_rate</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">skip_rate</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> Skipping&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;positive&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">species_set</span> <span class="o">&amp;</span> <span class="n">category_set</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;negative&#39;</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">skip_rate_pos</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
            <span class="ow">and</span> <span class="n">category</span> <span class="o">==</span> <span class="s1">&#39;positive&#39;</span>
            <span class="ow">and</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">skip_rate_pos</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> Skipping Positive&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">skip_rate_neg</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
            <span class="ow">and</span> <span class="n">category</span> <span class="o">==</span> <span class="s1">&#39;negative&#39;</span>
            <span class="ow">and</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">skip_rate_neg</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> Skipping Negative&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">image</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_images</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
        <span class="n">image_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
            <span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="n">image_size</span><span class="p">,</span> <span class="n">image_size</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LANCZOS4</span>
        <span class="p">)</span>

        <span class="n">values</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">dbname</span><span class="p">,</span>
            <span class="n">gid</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">patch_filename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_image_gid_</span><span class="si">%s</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">values</span>
        <span class="n">patch_filepath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">raw_path</span><span class="p">,</span> <span class="n">patch_filename</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">patch_filepath</span><span class="p">,</span> <span class="n">image_</span><span class="p">)</span>

        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">patch_filename</span><span class="p">,</span>
            <span class="n">category</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">label_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">labels_path</span><span class="p">,</span> <span class="s1">&#39;labels.csv&#39;</span><span class="p">),</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">labels</span><span class="p">:</span>
        <span class="n">label_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label_list</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">label_str</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">name_path</span></div>


<div class="viewcode-block" id="get_cnn_classifier2_training_images"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.ingest_wbia.get_cnn_classifier2_training_images">[docs]</a><span class="k">def</span> <span class="nf">get_cnn_classifier2_training_images</span><span class="p">(</span>
    <span class="n">ibs</span><span class="p">,</span>
    <span class="n">category_set</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">category_mapping</span><span class="o">=</span><span class="p">{},</span>
    <span class="n">dest_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">train_gid_set</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">image_size</span><span class="o">=</span><span class="mi">192</span><span class="p">,</span>
    <span class="n">purge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">skip_rate</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
<span class="p">):</span>
    <span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">expanduser</span><span class="p">,</span> <span class="n">exists</span>
    <span class="kn">import</span> <span class="nn">random</span>
    <span class="kn">import</span> <span class="nn">cv2</span>

    <span class="k">if</span> <span class="n">dest_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dest_path</span> <span class="o">=</span> <span class="n">expanduser</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">,</span> <span class="s1">&#39;Desktop&#39;</span><span class="p">,</span> <span class="s1">&#39;extracted&#39;</span><span class="p">))</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;classifier2&#39;</span>
    <span class="n">dbname</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span>
    <span class="n">name_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dest_path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">raw_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">name_path</span><span class="p">,</span> <span class="s1">&#39;raw&#39;</span><span class="p">)</span>
    <span class="n">labels_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">name_path</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">train_gid_set</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">train_gid_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_gids</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_imgsetids_from_text</span><span class="p">(</span><span class="s1">&#39;TRAIN_SET&#39;</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">train_gid_set</span><span class="p">)</span>
    <span class="n">species_set_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">set</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">))</span> <span class="k">for</span> <span class="n">aid_list_</span> <span class="ow">in</span> <span class="n">aids_list</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">category_set</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">category_set</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">species_set_list</span><span class="p">)</span>
        <span class="n">category_set</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">category_set</span><span class="p">)</span>

    <span class="n">category_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">category_set</span><span class="p">)</span>
    <span class="n">category_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">category_set</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">cache</span> <span class="ow">and</span> <span class="n">exists</span><span class="p">(</span><span class="n">name_path</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using cached exported data&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">purge</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">name_path</span><span class="p">)</span>

        <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">name_path</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">raw_path</span><span class="p">)</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">labels_path</span><span class="p">)</span>

        <span class="n">label_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">species_set</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">train_gid_set</span><span class="p">,</span> <span class="n">species_set_list</span><span class="p">):</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">gid</span><span class="p">,)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing GID: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">skip_rate</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">skip_rate</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> Skipping&#39;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">species_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                <span class="p">[</span><span class="n">category_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="n">species</span><span class="p">)</span> <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">species_set</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="n">category_list_</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">category</span> <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">category_list</span> <span class="k">if</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">species_set</span>
            <span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">category_list_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> Skipping (Categories)&#39;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">image</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_images</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
            <span class="n">image_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
                <span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="n">image_size</span><span class="p">,</span> <span class="n">image_size</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LANCZOS4</span>
            <span class="p">)</span>

            <span class="n">values</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">dbname</span><span class="p">,</span>
                <span class="n">gid</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">patch_filename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_image_gid_</span><span class="si">%s</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">values</span>
            <span class="n">patch_filepath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">raw_path</span><span class="p">,</span> <span class="n">patch_filename</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">patch_filepath</span><span class="p">,</span> <span class="n">image_</span><span class="p">)</span>

            <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">category_list_</span><span class="p">)</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">patch_filename</span><span class="p">,</span>
                <span class="n">category</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">label_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">labels_path</span><span class="p">,</span> <span class="s1">&#39;labels.csv&#39;</span><span class="p">),</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">labels</span><span class="p">:</span>
            <span class="n">label_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label_list</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">label_str</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">labels_path</span><span class="p">,</span> <span class="s1">&#39;categories.csv&#39;</span><span class="p">),</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">categories</span><span class="p">:</span>
            <span class="n">category_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">category_list</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">categories</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">category_str</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">name_path</span><span class="p">,</span> <span class="n">category_list</span></div>


<div class="viewcode-block" id="get_cnn_labeler_training_images"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.ingest_wbia.get_cnn_labeler_training_images">[docs]</a><span class="k">def</span> <span class="nf">get_cnn_labeler_training_images</span><span class="p">(</span>
    <span class="n">ibs</span><span class="p">,</span>
    <span class="n">dest_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">image_size</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
    <span class="n">category_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">min_examples</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">category_mapping</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">viewpoint_mapping</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">purge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">skip_rate</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
<span class="p">):</span>
    <span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">expanduser</span>
    <span class="kn">import</span> <span class="nn">random</span>
    <span class="kn">import</span> <span class="nn">cv2</span>

    <span class="k">if</span> <span class="n">dest_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dest_path</span> <span class="o">=</span> <span class="n">expanduser</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">,</span> <span class="s1">&#39;Desktop&#39;</span><span class="p">,</span> <span class="s1">&#39;extracted&#39;</span><span class="p">))</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;labeler&#39;</span>
    <span class="n">dbname</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span>
    <span class="n">name_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dest_path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">raw_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">name_path</span><span class="p">,</span> <span class="s1">&#39;raw&#39;</span><span class="p">)</span>
    <span class="n">labels_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">name_path</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">purge</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">name_path</span><span class="p">)</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">name_path</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">raw_path</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">labels_path</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;category mapping = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">category_mapping</span><span class="p">),))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;viewpoint mapping = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">repr3</span><span class="p">(</span><span class="n">viewpoint_mapping</span><span class="p">),))</span>

    <span class="c1"># train_gid_set = ibs.get_valid_gids()</span>
    <span class="n">train_gid_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_gids</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_imgsetids_from_text</span><span class="p">(</span><span class="s1">&#39;TRAIN_SET&#39;</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">train_gid_set</span><span class="p">)</span>
    <span class="c1"># bboxes_list = [ ibs.get_annot_bboxes(aid_list) for aid_list in aids_list ]</span>
    <span class="c1"># aid_list = ibs.get_valid_aids()</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">aids_list</span><span class="p">)</span>
    <span class="c1"># import random</span>
    <span class="c1"># random.shuffle(aid_list)</span>
    <span class="c1"># aid_list = sorted(aid_list[:100])</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_species_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">category_mapping</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">species_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">category_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="n">species</span><span class="p">)</span> <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">species_list</span>
        <span class="p">]</span>
    <span class="n">species_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">species_list</span><span class="p">)</span>
    <span class="n">yaw_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_viewpoints</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">category_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">category_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">species_set</span><span class="p">))</span>
        <span class="n">undesired_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;unspecified_animal&#39;</span><span class="p">,</span>
            <span class="n">ibs</span><span class="o">.</span><span class="n">get_species_nice</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">const</span><span class="o">.</span><span class="n">UNKNOWN_SPECIES_ROWID</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">undesired_species</span> <span class="ow">in</span> <span class="n">undesired_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">undesired_species</span> <span class="ow">in</span> <span class="n">category_list</span><span class="p">:</span>
                <span class="n">category_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">undesired_species</span><span class="p">)</span>
    <span class="n">category_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">category_list</span><span class="p">)</span>

    <span class="c1"># Filter the tup_list based on the requested categories</span>
    <span class="n">tup_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">species_list</span><span class="p">,</span> <span class="n">yaw_list</span><span class="p">))</span>
    <span class="n">old_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tup_list</span><span class="p">)</span>
    <span class="n">tup_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span>
            <span class="n">aid</span><span class="p">,</span>
            <span class="n">species</span><span class="p">,</span>
            <span class="n">viewpoint_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">yaw</span><span class="p">,</span> <span class="n">yaw</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">yaw</span> <span class="ow">in</span> <span class="n">tup_list</span>
        <span class="k">if</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">category_set</span>
    <span class="p">]</span>
    <span class="n">new_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tup_list</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;Filtered annotations: keep </span><span class="si">%d</span><span class="s1"> / original </span><span class="si">%d</span><span class="s1">&#39;</span>
        <span class="o">%</span> <span class="p">(</span>
            <span class="n">new_len</span><span class="p">,</span>
            <span class="n">old_len</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Skip any annotations that are of the wanted category and don&#39;t have a specified viewpoint</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">seen_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">yaw_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">tup_list</span><span class="p">:</span>
        <span class="n">aid</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">yaw</span> <span class="o">=</span> <span class="n">tup</span>
        <span class="c1"># Keep track of the number of overall instances</span>
        <span class="k">if</span> <span class="n">species</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_dict</span><span class="p">:</span>
            <span class="n">seen_dict</span><span class="p">[</span><span class="n">species</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">seen_dict</span><span class="p">[</span><span class="n">species</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># Keep track of yaws that aren&#39;t None</span>
        <span class="k">if</span> <span class="n">yaw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">species</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">yaw_dict</span><span class="p">:</span>
                <span class="n">yaw_dict</span><span class="p">[</span><span class="n">species</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">yaw</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">yaw_dict</span><span class="p">[</span><span class="n">species</span><span class="p">]:</span>
                <span class="n">yaw_dict</span><span class="p">[</span><span class="n">species</span><span class="p">][</span><span class="n">yaw</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">yaw_dict</span><span class="p">[</span><span class="n">species</span><span class="p">][</span><span class="n">yaw</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Get the list of species that do not have enough viewpoint examples for training</span>
    <span class="n">invalid_seen_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
    <span class="n">invalid_yaw_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
    <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">seen_dict</span><span class="p">:</span>
        <span class="c1"># Check that the number of instances is above the min_examples</span>
        <span class="k">if</span> <span class="n">seen_dict</span><span class="p">[</span><span class="n">species</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_examples</span><span class="p">:</span>
            <span class="n">invalid_seen_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">species</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="c1"># If the species has viewpoints, check them as well</span>
        <span class="k">if</span> <span class="n">strict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">yaw_dict</span><span class="p">:</span>
                <span class="c1"># Check that all viewpoints exist</span>
                <span class="c1"># if len(yaw_dict[species]) &lt; 8:</span>
                <span class="c1">#     invalid_yaw_set.add(species)</span>
                <span class="c1">#     continue</span>
                <span class="c1"># Check that all viewpoints have a minimum number of instances</span>
                <span class="k">for</span> <span class="n">yaw</span> <span class="ow">in</span> <span class="n">yaw_dict</span><span class="p">[</span><span class="n">species</span><span class="p">]:</span>
                    <span class="c1"># assert yaw in ibs.const.VIEWTEXT_TO_YAW_RADIANS</span>
                    <span class="k">if</span> <span class="n">yaw_dict</span><span class="p">[</span><span class="n">species</span><span class="p">][</span><span class="n">yaw</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_examples</span><span class="p">:</span>
                        <span class="n">invalid_yaw_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">species</span><span class="p">)</span>
                        <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">invalid_yaw_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">species</span><span class="p">)</span>
                <span class="k">continue</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Null yaws: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">counter</span><span class="p">,))</span>
    <span class="n">valid_seen_set</span> <span class="o">=</span> <span class="n">category_set</span> <span class="o">-</span> <span class="n">invalid_seen_set</span>
    <span class="n">valid_yaw_set</span> <span class="o">=</span> <span class="n">valid_seen_set</span> <span class="o">-</span> <span class="n">invalid_yaw_set</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Requested categories:&#39;</span><span class="p">)</span>
    <span class="n">category_set</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">category_set</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">print_list</span><span class="p">(</span><span class="n">category_set</span><span class="p">)</span>
    <span class="c1"># logger.info(&#39;Invalid yaw categories:&#39;)</span>
    <span class="c1"># ut.print_list(sorted(invalid_yaw_set))</span>
    <span class="c1"># logger.info(&#39;Valid seen categories:&#39;)</span>
    <span class="c1"># ut.print_list(sorted(valid_seen_set))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Valid yaw categories:&#39;</span><span class="p">)</span>
    <span class="n">valid_yaw_set</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">valid_yaw_set</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">print_list</span><span class="p">(</span><span class="n">valid_yaw_set</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Invalid seen categories (could not fulfill request):&#39;</span><span class="p">)</span>
    <span class="n">invalid_seen_set</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">invalid_seen_set</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">print_list</span><span class="p">(</span><span class="n">invalid_seen_set</span><span class="p">)</span>

    <span class="n">skipped_yaw</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">skipped_seen</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">tup_list_</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">aid_list_</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">tup_list</span><span class="p">:</span>
        <span class="n">aid</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">yaw</span> <span class="o">=</span> <span class="n">tup</span>
        <span class="k">if</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">valid_yaw_set</span><span class="p">:</span>
            <span class="c1"># If the species is valid, but this specific annotation has no yaw, skip it</span>
            <span class="k">if</span> <span class="n">yaw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">skipped_yaw</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">species</span><span class="p">,</span>
                <span class="n">yaw</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">valid_seen_set</span><span class="p">:</span>
            <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">species</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">skipped_seen</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="n">tup_list_</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tup</span><span class="p">,</span> <span class="n">category</span><span class="p">))</span>
        <span class="n">aid_list_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;Skipped Yaw:  skipped </span><span class="si">%d</span><span class="s1"> / total </span><span class="si">%d</span><span class="s1">&#39;</span>
        <span class="o">%</span> <span class="p">(</span>
            <span class="n">skipped_yaw</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">tup_list</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;Skipped Seen: skipped </span><span class="si">%d</span><span class="s1"> / total </span><span class="si">%d</span><span class="s1">&#39;</span>
        <span class="o">%</span> <span class="p">(</span>
            <span class="n">skipped_seen</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">tup_list</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Precompute chips</span>
    <span class="n">ibs</span><span class="o">.</span><span class="n">compute_all_chips</span><span class="p">(</span><span class="n">aid_list_</span><span class="p">)</span>

    <span class="c1"># Get training data</span>
    <span class="n">label_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tup</span><span class="p">,</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">tup_list_</span><span class="p">:</span>
        <span class="n">aid</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">yaw</span> <span class="o">=</span> <span class="n">tup</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">aid</span><span class="p">,)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing AID: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">skip_rate</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">skip_rate</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> Skipping&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Compute data</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_chips</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="n">image_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
            <span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="n">image_size</span><span class="p">,</span> <span class="n">image_size</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LANCZOS4</span>
        <span class="p">)</span>

        <span class="n">values</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">dbname</span><span class="p">,</span>
            <span class="n">aid</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">patch_filename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_annot_aid_</span><span class="si">%s</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">values</span>
        <span class="n">patch_filepath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">raw_path</span><span class="p">,</span> <span class="n">patch_filename</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">patch_filepath</span><span class="p">,</span> <span class="n">image_</span><span class="p">)</span>

        <span class="c1"># Compute label</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">patch_filename</span><span class="p">,</span>
            <span class="n">category</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">label_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using labels for labeler training:&#39;</span><span class="p">)</span>
    <span class="n">label_list_</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tup_list_</span><span class="p">])</span>
    <span class="n">label_list_</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">label_list_</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">print_list</span><span class="p">(</span><span class="n">label_list_</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">labels_path</span><span class="p">,</span> <span class="s1">&#39;labels.csv&#39;</span><span class="p">),</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">labels</span><span class="p">:</span>
        <span class="n">label_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label_list</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">label_str</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">name_path</span></div>


<div class="viewcode-block" id="get_cnn_qualifier_training_images"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.ingest_wbia.get_cnn_qualifier_training_images">[docs]</a><span class="k">def</span> <span class="nf">get_cnn_qualifier_training_images</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">dest_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">image_size</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">purge</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span>
    <span class="kn">import</span> <span class="nn">cv2</span>

    <span class="k">if</span> <span class="n">dest_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dest_path</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">truepath</span><span class="p">(</span><span class="s1">&#39;~/Desktop/extracted&#39;</span><span class="p">)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;qualifier&#39;</span>
    <span class="n">dbname</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span>
    <span class="n">name_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dest_path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">raw_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">name_path</span><span class="p">,</span> <span class="s1">&#39;raw&#39;</span><span class="p">)</span>
    <span class="n">labels_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">name_path</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">purge</span><span class="p">:</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">name_path</span><span class="p">)</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">name_path</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">raw_path</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">labels_path</span><span class="p">)</span>

    <span class="c1"># gid_list = ibs.get_valid_gids()</span>
    <span class="n">train_gid_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_gids</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_imgsetids_from_text</span><span class="p">(</span><span class="s1">&#39;TRAIN_SET&#39;</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">train_gid_set</span><span class="p">)</span>
    <span class="c1"># bboxes_list = [ ibs.get_annot_bboxes(aid_list) for aid_list in aids_list ]</span>
    <span class="c1"># aid_list = ibs.get_valid_aids()</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">aids_list</span><span class="p">)</span>
    <span class="n">flag_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_reviewed</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>
    <span class="n">aid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">aid</span> <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">flag_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">flag</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Outputing a total of </span><span class="si">%d</span><span class="s1"> annotations&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">),))</span>
    <span class="c1"># import random</span>
    <span class="c1"># random.shuffle(aid_list)</span>
    <span class="c1"># aid_list = sorted(aid_list[:100])</span>
    <span class="n">quality_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_quality_texts</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span>

    <span class="n">label_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">quality</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">quality_list</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">aid</span><span class="p">,)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing AID: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span>

        <span class="n">image</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_chips</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span>
        <span class="n">image_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
            <span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="n">image_size</span><span class="p">,</span> <span class="n">image_size</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LANCZOS4</span>
        <span class="p">)</span>

        <span class="n">values</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">dbname</span><span class="p">,</span>
            <span class="n">aid</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">patch_filename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_annot_aid_</span><span class="si">%s</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">values</span>
        <span class="n">patch_filepath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">raw_path</span><span class="p">,</span> <span class="n">patch_filename</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">patch_filepath</span><span class="p">,</span> <span class="n">image_</span><span class="p">)</span>

        <span class="n">category</span> <span class="o">=</span> <span class="n">quality</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">patch_filename</span><span class="p">,</span>
            <span class="n">category</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">label_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">labels_path</span><span class="p">,</span> <span class="s1">&#39;labels.csv&#39;</span><span class="p">),</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">labels</span><span class="p">:</span>
        <span class="n">label_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label_list</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">label_str</span><span class="p">)</span></div>


<div class="viewcode-block" id="extract_orientation_chips"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.ingest_wbia.extract_orientation_chips">[docs]</a><span class="k">def</span> <span class="nf">extract_orientation_chips</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">gid_list</span><span class="p">,</span> <span class="n">image_size</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">cv2</span>

    <span class="k">def</span> <span class="nf">resize_target</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">target_height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_width</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">target_height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">target_width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">target_height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">target_width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">target_height</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">target_width</span>
        <span class="k">elif</span> <span class="n">target_height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">target_height</span>
            <span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="n">height</span><span class="p">)</span> <span class="o">*</span> <span class="n">h</span>
        <span class="k">elif</span> <span class="n">target_width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">target_width</span>
            <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="n">width</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LANCZOS4</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">vtool</span> <span class="kn">import</span> <span class="n">scaled_verts_from_bbox</span>

    <span class="n">dbname</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span>
    <span class="n">target_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">image_size</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">))</span>

    <span class="n">aids_list</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_image_aids</span><span class="p">(</span><span class="n">gid_list</span><span class="p">)</span>
    <span class="n">bboxes_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_bboxes</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span> <span class="k">for</span> <span class="n">aid_list</span> <span class="ow">in</span> <span class="n">aids_list</span><span class="p">]</span>
    <span class="n">thetas_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_annot_thetas</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span> <span class="k">for</span> <span class="n">aid_list</span> <span class="ow">in</span> <span class="n">aids_list</span><span class="p">]</span>

    <span class="n">zipped_list</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">gid_list</span><span class="p">,</span> <span class="n">aids_list</span><span class="p">,</span> <span class="n">bboxes_list</span><span class="p">,</span> <span class="n">thetas_list</span><span class="p">)</span>

    <span class="n">global_chip_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">global_theta_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">global_tag_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">gid</span><span class="p">,</span> <span class="n">aid_list</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span> <span class="ow">in</span> <span class="n">zipped_list</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">gid</span><span class="p">,)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing GID: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">AIDS  : </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid_list</span><span class="p">,))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">BBOXES: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bbox_list</span><span class="p">,))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">THETAS: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">theta_list</span><span class="p">,))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">get_images</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
            <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">channels</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>

            <span class="n">padding</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
            <span class="n">canvas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="p">(</span><span class="n">width</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">padding</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">padding</span><span class="p">,</span> <span class="n">channels</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">dtype</span>
            <span class="p">)</span>
            <span class="n">canvas</span><span class="p">[</span><span class="n">padding</span> <span class="p">:</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">height</span><span class="p">,</span> <span class="n">padding</span> <span class="p">:</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">width</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span>

            <span class="k">for</span> <span class="n">aid</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">theta</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aid_list</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">,</span> <span class="n">theta_list</span><span class="p">):</span>
                <span class="n">vert_list</span> <span class="o">=</span> <span class="n">scaled_verts_from_bbox</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">vert_list</span><span class="p">))</span>
                <span class="n">boxl</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span>
                <span class="n">boxr</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span>
                <span class="n">boxt</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y_vals</span><span class="p">)</span>
                <span class="n">boxb</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_vals</span><span class="p">)</span>

                <span class="n">boxx</span> <span class="o">=</span> <span class="n">boxr</span> <span class="o">-</span> <span class="n">boxl</span>
                <span class="n">boxy</span> <span class="o">=</span> <span class="n">boxb</span> <span class="o">-</span> <span class="n">boxt</span>
                <span class="n">target</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">boxx</span><span class="p">,</span> <span class="n">boxy</span><span class="p">)</span>

                <span class="n">deltax</span> <span class="o">=</span> <span class="n">target</span> <span class="o">-</span> <span class="n">boxx</span>
                <span class="n">deltay</span> <span class="o">=</span> <span class="n">target</span> <span class="o">-</span> <span class="n">boxy</span>
                <span class="n">deltar</span> <span class="o">=</span> <span class="p">(</span><span class="n">target</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">-</span> <span class="n">target</span> <span class="k">if</span> <span class="n">training</span> <span class="k">else</span> <span class="mf">0.0</span>

                <span class="c1"># Ignoring partial pixels, should be square</span>
                <span class="n">boxl</span> <span class="o">-=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">((</span><span class="n">deltax</span> <span class="o">+</span> <span class="n">deltar</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">))</span>
                <span class="n">boxr</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">((</span><span class="n">deltax</span> <span class="o">+</span> <span class="n">deltar</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">))</span>
                <span class="n">boxt</span> <span class="o">-=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">((</span><span class="n">deltay</span> <span class="o">+</span> <span class="n">deltar</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">))</span>
                <span class="n">boxb</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">((</span><span class="n">deltay</span> <span class="o">+</span> <span class="n">deltar</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">))</span>

                <span class="n">chip</span> <span class="o">=</span> <span class="n">canvas</span><span class="p">[</span>
                    <span class="n">padding</span> <span class="o">+</span> <span class="n">boxt</span> <span class="p">:</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">boxb</span><span class="p">,</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">boxl</span> <span class="p">:</span> <span class="n">padding</span> <span class="o">+</span> <span class="n">boxr</span>
                <span class="p">]</span>
                <span class="n">chip</span> <span class="o">=</span> <span class="n">resize_target</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">target_size</span><span class="p">,</span> <span class="n">target_size</span><span class="p">)</span>
                <span class="n">global_chip_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span>

                <span class="n">global_theta_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">theta</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>

                <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_chip_gid_</span><span class="si">%s</span><span class="s1">_aid_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">dbname</span><span class="p">,</span>
                    <span class="n">gid</span><span class="p">,</span>
                    <span class="n">aid</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">global_tag_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">global_chip_list</span><span class="p">,</span> <span class="n">global_theta_list</span><span class="p">,</span> <span class="n">global_tag_list</span></div>


<div class="viewcode-block" id="get_orientation_training_images"><a class="viewcode-back" href="../../wbia_cnn.html#wbia_cnn.ingest_wbia.get_orientation_training_images">[docs]</a><span class="k">def</span> <span class="nf">get_orientation_training_images</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">dest_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets data for training a patch match network.</span>

<span class="sd">    Args:</span>
<span class="sd">        ibs (IBEISController):  ibeis controller object</span>
<span class="sd">        max_examples (None): (default = None)</span>
<span class="sd">        num_top (int): (default = 3)</span>
<span class="sd">        controlled (bool): (default = True)</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple : patchmatch_tup = (aid1_list, aid2_list, kpts1_m_list,</span>
<span class="sd">        kpts2_m_list, fm_list, metadata_lists)</span>
<span class="sd">        aid pairs and matching keypoint pairs as well as the original index</span>
<span class="sd">        of the feature matches</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia_cnn.ingest_wbia --test-get_orientation_training_images --dbdir /Datasets/BACKGROUND/PZ_Master1</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from wbia_cnn.ingest_wbia import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import wbia</span>
<span class="sd">        &gt;&gt;&gt; # build test data</span>
<span class="sd">        &gt;&gt;&gt; ibs = wbia.opendb(defaultdb=&#39;PZ_MTEST&#39;, allow_newdir=True)</span>
<span class="sd">        &gt;&gt;&gt; get_orientation_training_images(ibs)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">expanduser</span>
    <span class="kn">import</span> <span class="nn">cv2</span>

    <span class="n">dbname_mapping</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;ELPH_Master&#39;</span><span class="p">:</span> <span class="s1">&#39;elephant_savanna&#39;</span><span class="p">,</span>
        <span class="s1">&#39;GIR_Master&#39;</span><span class="p">:</span> <span class="s1">&#39;giraffe_reticulated&#39;</span><span class="p">,</span>
        <span class="s1">&#39;GZ_Master&#39;</span><span class="p">:</span> <span class="s1">&#39;zebra_grevys&#39;</span><span class="p">,</span>
        <span class="s1">&#39;NNP_MasterGIRM&#39;</span><span class="p">:</span> <span class="s1">&#39;giraffe_masai&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PZ_Master1&#39;</span><span class="p">:</span> <span class="s1">&#39;zebra_plains&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">dest_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dest_path</span> <span class="o">=</span> <span class="n">expanduser</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">,</span> <span class="s1">&#39;Desktop&#39;</span><span class="p">,</span> <span class="s1">&#39;extracted&#39;</span><span class="p">))</span>

    <span class="n">dbname</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span>
    <span class="n">positive_category</span> <span class="o">=</span> <span class="n">dbname_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dbname</span><span class="p">,</span> <span class="s1">&#39;positive&#39;</span><span class="p">)</span>  <span class="c1"># NOQA</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;orientation&#39;</span>
    <span class="n">dbname</span> <span class="o">=</span> <span class="n">ibs</span><span class="o">.</span><span class="n">dbname</span>
    <span class="n">name_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dest_path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">raw_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">name_path</span><span class="p">,</span> <span class="s1">&#39;raw&#39;</span><span class="p">)</span>
    <span class="n">labels_path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">name_path</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">)</span>

    <span class="c1"># ut.remove_dirs(dest_path)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">dest_path</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">raw_path</span><span class="p">)</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">labels_path</span><span class="p">)</span>

    <span class="c1"># gid_list = ibs.get_valid_gids()</span>
    <span class="n">train_gid_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
        <span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_gids</span><span class="p">(</span><span class="n">ibs</span><span class="o">.</span><span class="n">get_imageset_imgsetids_from_text</span><span class="p">(</span><span class="s1">&#39;TRAIN_SET&#39;</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="n">extract_orientation_chips</span><span class="p">(</span><span class="n">ibs</span><span class="p">,</span> <span class="n">train_gid_set</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">label_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">zipped_list</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">vals</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">chip</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">zipped_list</span><span class="p">:</span>
        <span class="n">chip_filename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,)</span>
        <span class="n">chip_filepath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">raw_path</span><span class="p">,</span> <span class="n">chip_filename</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">chip_filepath</span><span class="p">,</span> <span class="n">chip</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">chip_filename</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
        <span class="n">label_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">labels_path</span><span class="p">,</span> <span class="s1">&#39;labels.csv&#39;</span><span class="p">),</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">labels</span><span class="p">:</span>
        <span class="n">label_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label_list</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">label_str</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python -m wbia_cnn.ingest_wbia</span>
<span class="sd">        python -m wbia_cnn.ingest_wbia --allexamples</span>
<span class="sd">        python -m wbia_cnn.ingest_wbia --allexamples --noface --nosrc</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">multiprocessing</span>

    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>  <span class="c1"># for win32</span>
    <span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>  <span class="c1"># NOQA</span>

    <span class="n">ut</span><span class="o">.</span><span class="n">doctest_funcs</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Wild Me.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>